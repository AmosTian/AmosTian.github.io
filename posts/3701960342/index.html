<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="学习视频：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV16a411j78Q&#x2F;?spm_id_from&#x3D;333.337.search-card.all.click&amp;vd_source&#x3D;260d5bbbf395fd4a9b3e978c7abde437  [TOC]"><meta property="og:type" content="article"><meta property="og:title" content="2.ceph集群部署"><meta property="og:url" content="https://amostian.github.io/posts/3701960342/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="学习视频：https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV16a411j78Q&#x2F;?spm_id_from&#x3D;333.337.search-card.all.click&amp;vd_source&#x3D;260d5bbbf395fd4a9b3e978c7abde437  [TOC]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231020162129750.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231020171033087.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231108150709863.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231020200318410.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231020200554951.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022112928488.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021110501138.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021144845914.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021111427267.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021155409180.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021155536179.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021155634243.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022193050105.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021192331126.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021170352538.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021171607107.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021190544275.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021190739618.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021193018559.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022131240812.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022131446761.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021204741269.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021205644091.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021233506160.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021234748243.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231021235858359.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022201652010.png"><meta property="og:image" content="https://amostian.github.io/posts/3701960342/image-20231022201808089.png"><meta property="article:published_time" content="2023-10-20T07:50:52.000Z"><meta property="article:modified_time" content="2024-04-11T02:30:40.571Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="分布式"><meta property="article:tag" content="分布式存储"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/3701960342/image-20231020162129750.png"><link rel="canonical" href="https://amostian.github.io/posts/3701960342/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>2.ceph集群部署 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">60</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">375</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/3701960342/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">2.ceph集群部署</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2023-10-20 15:50:52" itemprop="dateCreated datePublished" datetime="2023-10-20T15:50:52+08:00">2023-10-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2024-04-11 10:30:40" itemprop="dateModified" datetime="2024-04-11T10:30:40+08:00">2024-04-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">10.8k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>28 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>学习视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16a411j78Q/?spm_id_from=333.337.search-card.all.click&amp;vd_source=260d5bbbf395fd4a9b3e978c7abde437">https://www.bilibili.com/video/BV16a411j78Q/?spm_id_from=333.337.search-card.all.click&amp;vd_source=260d5bbbf395fd4a9b3e978c7abde437</a></p></blockquote><p>[TOC]</p><span id="more"></span><h2 id="2-0-ceph"><a href="#2-0-ceph" class="headerlink" title="2.0 ceph"></a>2.0 ceph</h2><h3 id="2-0-1-存储机制"><a href="#2-0-1-存储机制" class="headerlink" title="2.0.1 存储机制"></a>2.0.1 存储机制</h3><p>将待管理的数据流切分为一到多个固定大小的对象数据，并以其为原子单元完成数据存储</p><p>ceph通过内部的Crush机制，实时计算出一个文件应该存储到哪个存储对象中，从而实现快速查找对象的方式</p><p><img src="/posts/3701960342/image-20231020162129750.png" alt="image-20231020162129750"></p><h3 id="2-0-2-各组件的硬件需求"><a href="#2-0-2-各组件的硬件需求" class="headerlink" title="2.0.2 各组件的硬件需求"></a>2.0.2 各组件的硬件需求</h3><p>当涉及硬件时，底层硬件决定系统的上限。</p><p>Ceph的优点之一是支持异构硬件，Ceph集群可以运行在来自多个厂商的硬件上，不存在因为硬件问题被厂商锁定的情况。在创建Ceph的底层基础设施时，客户可以根据预算及性能需求自行使用任何硬件，对于硬件的选用拥有完全的自主权和决策权。</p><p><img src="/posts/3701960342/image-20231020171033087.png" alt="image-20231020171033087"></p><p>无论想向云平台提供Ceph对象存储和Ceph块设备服务、部署文件系统，或者将Ceph用于其他目的，所有的ceph集群部署都从设置每个Ceph节点网络开始</p><p>一个Ceph存储集群至少一个Ceph Monitor、Ceph Manager 和 Ceph OSD，如果有运行文件系统的客户端，还需要配置MDSs</p><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>Ceph的一些组件不是CPU依赖型</p><p><strong>monitor守护进程</strong> 对CPU是轻量依赖的，只负责保持集群的状态而不给用户提供任何数据</p><ul><li>不参与数据存储，不频繁利用内存，占用资源较少</li><li>单核CPU就可以完成，需要确保monitor有足够的内存、网络与磁盘空间</li><li>对于小集群，monitor可以与其他组件放在一起</li></ul><p><strong>OSD进程</strong> 需要大量的CPU资源（直接提供数据给客户端），需要进行一些数据处理</p><ul><li><p>CPU(1GHz)和内存(2GB)：建议在早期多配置内存和CPU资源，因为在JBOD系统中，可以随时为主机增加硬盘</p></li><li><p>建议双核CPU。若以纠删码的方式使用OSD，则需要四核处理器（纠删码需要大量计算）</p></li><li><p>当集群处于recovery状态时，OSD守护进程对处理器的占用很大</p><script type="math/tex;mode=display">\frac{CPU线程数\times CPU每线程占核数\times CPU时钟频率(GHz)}{OSD数}\ge 1</script></li></ul><p><strong>MDS守护进程</strong> 是CPU密集型。需要动态地分配负载</p><ul><li>建议四核CPU</li></ul><h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4><blockquote><p>当集群处于recovery状态时，内存消耗会明显增加</p></blockquote><p>monitor和元数据守护进程需要快速对外响应，必须有足够的内存处理</p><ul><li>从性能角度，为每个monitor和元数据守护进程必须大于2GB</li></ul><p>OSD不是内存密集型</p><ul><li><p>一般的工作负载情况下，每个OSD守护进程分配1GB内存就足够了</p></li><li><p>从性能角度，若OSD进程使用一整块磁盘，分配2GB。</p><p>若OSD使用多个磁盘，内存需求需要同步增加</p></li></ul><h4 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h4><p><strong>monitor硬件需求</strong></p><ul><li>若 日志信息(log) 存储在本地monitor节点，就要确保monitor节点上有 <strong>足够的磁盘空间</strong> 来存放日志文件</li></ul><p><strong>OSD硬件需求</strong> OSD是Ceph 中主要存储单元，需要配置足够的硬盘</p><ul><li><p>为集群节点中的每一块物理硬盘创建一个OSD进程</p><p>OSD支持灵活部署，可以为每块物理硬盘创建一个OSD，也可以为每个RAID创建OSD进程</p></li><li><p>硬盘容量越大，每GB的成本越低，内存也需要相应越大</p></li></ul><h4 id="网络需求"><a href="#网络需求" class="headerlink" title="网络需求"></a>网络需求</h4><p><strong>带宽</strong></p><blockquote><p>以太网、InfiniBand网络、10G网络或更高带宽的网络</p></blockquote><p>对于百TB级别的中等规模集群而言，1Gbit/s的网络也能正常工作。若考虑到未来的纵向扩展带来的工作负载(ROI/性能)，建议为数据和集群管理分别采用10Gbit/s的物理隔离网络</p><p>当集群规模较大，需要为多个客户端提供服务，则应有10G以上的带宽</p><p>对于几百TB的超大Ceph集群，需要400Gbit/s的带宽</p><p><strong>内外网络隔离</strong></p><blockquote><p>集群网络和客户端网络应该接在物理上隔离的交换机上：</p><ul><li>公共网络（客户端网络）允许客户端与Ceph集群通信并访问集群中存储的数据</li><li>内部网络（集群网络）负责集群内诸如复制、恢复、再平衡和心跳检查等需要高带宽的操作</li></ul></blockquote><p><img src="/posts/3701960342/image-20231108150709863.png" alt="image-20231108150709863"></p><p>大多数情况下，集群内部网络流量更大（Ceph的OSD节点在内部使用）：</p><ul><li>数据冗余备份：若对于一个客户端的写入动作，数据备份了N次，则Ceph集群需要写N次。所有的冗余数据基于集群网络在对等节点间进行传输</li><li>数据的恢复和再平衡</li></ul><p><strong>冗余配置</strong></p><p>在网络配置的各层采用冗余设计，如：网卡，端口，交换机和路由器</p><p>monitor硬件需求：1Gbit/s的双网卡</p><ul><li>网络级别的冗余对于monitor很重要，因为monitor节点间需要进行仲裁</li></ul><h4 id="MDS需求"><a href="#MDS需求" class="headerlink" title="MDS需求"></a>MDS需求</h4><p>相较于Ceph的monitor与OSD，Ceph MDS比较占资源。</p><p><strong>硬件需求</strong></p><ul><li>更强的CPU处理能力，四核或者更高</li><li>MDS依赖大量的数据缓存，需要更大的RAM资源</li></ul><h3 id="2-0-3-规划集群"><a href="#2-0-3-规划集群" class="headerlink" title="2.0.3 规划集群"></a>2.0.3 规划集群</h3><h4 id="限制条件"><a href="#限制条件" class="headerlink" title="限制条件"></a>限制条件</h4><p>Ceph的各种组件应该避免复用。组件角色复用会给集群的运维和性能带来很大的影响。可以避免集群运行带来的不稳定因素，在考虑安全性与可靠性的前提下，必须满足一些限制条件：</p><ul><li>至少配置3个monitor节点</li><li>每个节点至少配置3个OSD</li><li>至少配置两个manager节点</li><li>所有的OSD节点配置相同</li><li>若使用CephFS，至少配置2个配置完全相同的MDS节点</li><li>若使用Ceph 网关，至少配置2个不同的RGW节点</li></ul><h4 id="关于功能特性的备注"><a href="#关于功能特性的备注" class="headerlink" title="关于功能特性的备注"></a>关于功能特性的备注</h4><p>并不是支持所有的Ceph功能，即不是所有的功能都是稳定的，表中的几种指标及配置是经过企业落地实践校验的</p><div class="table-container"><table><thead><tr><th>特性</th><th>备注</th></tr></thead><tbody><tr><td>副本策略</td><td>SSD：支持2副本，最低1副本，副本数少，影响数据可靠性<br>HDD：支持3副本，最低2副本，副本数少，影响数据可靠性</td></tr><tr><td>纠删码</td><td>支持在RGW和RBD两种模式下使用，MDS不支持纠删码<br>K+M的支持配比：8+3，8+4，4+2<br>集群的存储节点最少为k+m+1</td></tr><tr><td>RGW多站点</td><td>多站点配置中不支持Indexless Bucket</td></tr><tr><td>Disk Size</td><td>最大容量12TB，不支持磁带</td></tr><tr><td>每个节点OSD数量</td><td>单节点最多配置36个OSD</td></tr><tr><td>单集群OSD数量</td><td>单集群最多配置2500个OSD</td></tr><tr><td>Snapshot</td><td>单个RBD镜像支持512个快照，快照不支持RGW</td></tr><tr><td>BlueStore</td><td>必须使用默认的分配器</td></tr></tbody></table></div><h4 id="服务器规划"><a href="#服务器规划" class="headerlink" title="服务器规划"></a>服务器规划</h4><p>在选型Ceph服务器时，必须确定Ceph的使用场景，不同的使用场景下有不同的配置考量，常见的Ceph使用场景有</p><ul><li>追求良好IOPS</li><li>追求良好的吞吐量</li><li>追求低成本、高容量</li></ul><h5 id="追求良好的IOPS"><a href="#追求良好的IOPS" class="headerlink" title="追求良好的IOPS"></a>追求良好的IOPS</h5><p>随着闪存使用的增加，企业越来越多地将IOPS敏感型工作负载依托在Ceph集群，以便提高私有云存储解决方案的性能。在此场景下，可以把MySQL、MariaDB或PostgreSQL托管在Ceph集群，以支持结构化数据</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个NVMe SSD使用6核或者每个非NVMe使用2核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>NVMe SSD</td></tr><tr><td>BlueStore WAL/DB</td><td>可与NVMe SSD分配两个OSD</td></tr><tr><td>磁盘控制器</td><td>PCIe</td></tr><tr><td>OSD进程数</td><td>每个NVMe分配2个OSD进程</td></tr><tr><td>网络</td><td>每2个OSD使用10GB带宽网络</td></tr></tbody></table></div><h5 id="追求良好吞吐量"><a href="#追求良好吞吐量" class="headerlink" title="追求良好吞吐量"></a>追求良好吞吐量</h5><p>Ceph集群通常可以存储半结构化数据，一般是顺序读写比较大的文件，需要提供很大的带宽。存储服务器上的磁盘可以使用SSD做日志加快HDD</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个HDD使用0.5核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>7200RPM的HDD、SATA、SAS</td></tr><tr><td>BlueStore WAL/DB</td><td>使用独立的NVMe SSD 或 SAS SSD作为加速盘</td></tr><tr><td>磁盘控制器</td><td>HBA（JBOD）</td></tr><tr><td>OSD进程数</td><td>每个HDD分配1个OSD进程</td></tr><tr><td>网络</td><td>每12个OSD使用10GB带宽网络</td></tr></tbody></table></div><h5 id="最求低成本、高容量场景"><a href="#最求低成本、高容量场景" class="headerlink" title="最求低成本、高容量场景"></a>最求低成本、高容量场景</h5><p>低成本和高容量的解决方案用于处理存储容量较大、存储时间较长的数据，且按块顺序读写。数据可以是结构化或半结构化。存储内容包括媒体文件、大数据分析文件和磁盘镜像备份等。为了获得更高的效益，OSD与日志通常都托管在HDD。</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个HDD使用0.5核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>NVMe SSD</td></tr><tr><td>BlueStore WAL/DB</td><td>可与HDD数据盘同步</td></tr><tr><td>磁盘控制器</td><td>HBA（JBOD）</td></tr><tr><td>OSD进程数</td><td>每个HDD分配1个OSD进程</td></tr><tr><td>网络</td><td>每两个OSD使用10GB带宽网络</td></tr></tbody></table></div><h2 id="2-1-Ceph-手动安装"><a href="#2-1-Ceph-手动安装" class="headerlink" title="2.1 Ceph 手动安装"></a>2.1 Ceph 手动安装</h2><h3 id="2-1-1-获取软件包"><a href="#2-1-1-获取软件包" class="headerlink" title="2.1.1 获取软件包"></a>2.1.1 获取软件包</h3><p>访问官网获取RPM包以及第三方库</p><p>通过添加Ceph安装包的存储库，使用包管理工具下载</p><ul><li>Dibian APT</li><li>RHEL：YUM<h4 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name=</span><br><span class="line">baseurl=&#123;ceph-release&#125;/&#123;distro&#125;</span><br><span class="line">ceph-release:有效的Cep发行版名称</span><br><span class="line">distro:Linux的发行版信息</span><br></pre></td></tr></table></figure><h3 id="2-1-2-安装依赖"><a href="#2-1-2-安装依赖" class="headerlink" title="2.1.2 安装依赖"></a>2.1.2 安装依赖</h3></li></ul><p>安装RHEL库</p><p>安装Ceph需要的第三方二进制文件</p><p>创建Ceph存储库文件用于描述Ceph版本</p><p>安装Ceph软件包</p><p>验证软件包是否安装成功</p><h3 id="2-1-3-部署Ceph集群"><a href="#2-1-3-部署Ceph集群" class="headerlink" title="2.1.3 部署Ceph集群"></a>2.1.3 部署Ceph集群</h3><ul><li>ceph.xxx.keyring：xxx级的密钥，负责同一集群的认证、各级对等节点间的相互认证</li></ul><h4 id="monitor部署"><a href="#monitor部署" class="headerlink" title="monitor部署"></a>monitor部署</h4><p>monmap负责集群中各组件关系的软件定义</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 为Ceph创建一个目录，且创建Ceph集群配置文件</span></span><br><span class="line">mkdir /etc/ceph</span><br><span class="line">touch /etc/ceph/ceph.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 为集群生成fsid</span></span><br><span class="line">uuidgen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.创建集群配置文件</span></span><br><span class="line">默认集群名称为ceph。配置文件名称为/etc/ceph/ceph.conf</span><br><span class="line">使用uuid作为配置文件中的fsid参数</span><br><span class="line">vim /etc/ceph/ceph.conf</span><br><span class="line">[mon.ceph-node2]</span><br><span class="line">mon_addr=</span><br><span class="line">host=ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 为集群创建密钥环，生成monitor的密钥</span></span><br><span class="line">ceph-authtool --creat-keyring /tmp/ceph.mon.keyring --gen-key -n mon. —-cap mon ‘allow *’</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 创建client.admin用户</span></span><br><span class="line">ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon ‘allow *’ --cap osd ‘allow *’ --cap mds ‘allow *’</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.将client.admin密钥添加到ceph.mon.keyring中</span></span><br><span class="line">ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 为第一个monitor生成monitor.map</span></span><br><span class="line">monmaptool --create --add &#123;hostname&#125; &#123;ip-address&#125; --fsid &#123;uuid&#125; /tmp/monmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 为monitor创建类似路径/cluster_name-monitor_node格式的目录</span></span><br><span class="line">mkdir /var/lib/ceph/mon/ceph-ceph-node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.填入第一个monitor守护进程信息</span></span><br><span class="line">ceph-mon --mkfs -i &#123;hostname&#125; --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">10.启动monitor服务</span></span><br><span class="line">service ceph start</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">11.查看Ceph集群状态及默认池</span></span><br><span class="line">ceph osd lspools</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">12. 将ceph.conf和ceph.client.admin.keyring 文件复制到ceph-node2,ceph-node3，让mon2,mon3可以发出集群命令</span></span><br><span class="line">scp /etc/ceph/ceph.* ceph-node2:/etc/ceph</span><br><span class="line">scp /etc/ceph/ceph.* ceph-node3:/etc/ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若上述步骤出现 Error Connecting to cluster的错误，需要为Ceph monitor守护进程关闭防火墙或修改防火墙规则</span></span><br></pre></td></tr></table></figure><h4 id="创建OSD"><a href="#创建OSD" class="headerlink" title="创建OSD"></a>创建OSD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 检查系统中的可用磁盘</span></span><br><span class="line">cep-disk list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. Ceph OSD基于GUID分区表(GPT)工作，需要将分区表改为GPT</span></span><br><span class="line">parted /dev/sdb mklabel GPT</span><br><span class="line">parted /dev/sdc mklabel GPT</span><br><span class="line">parted /dev/sdd mklabel GPT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 提供集群以及文件系统信息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph-disk prepare --cluster &#123;cluster-name&#125; --cluster-uuid &#123;fid&#125; --fs-type &#123;ext4/xfs/btrfs&#125; &#123;data-path&#125; [&#123;journal-path&#125;]</span></span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdb</span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdc</span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 激活OSD</span></span><br><span class="line">ceph-disk activate /dev/sdb</span><br><span class="line">ceph-disk activate /dev/sdc</span><br><span class="line">ceph-disk activate /dev/sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.激活OSD</span></span><br><span class="line">ceph -s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">硬盘的正常工作状态为 IN和UP</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 检查OSD树，给出关于OSD及其所在物理节点的信息</span></span><br><span class="line">ceph tree</span><br></pre></td></tr></table></figure><h4 id="扩展集群"><a href="#扩展集群" class="headerlink" title="扩展集群"></a>扩展集群</h4><p>为保证集群节点的高可靠和高可用，需要配置冗余节点</p><ul><li>$集群正常工作节点数&gt;\frac{n}{2}$ ，即推荐奇数个节点才能避免在其他系统上看到Ceph集群的脑裂状态</li></ul><p><strong>扩展monitor</strong><br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 登陆ceph-node2并创建目录</span></span><br><span class="line">mkdir -p /var/lib/ceph/mon/ceph-ceph-node2 /tmp/ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 编辑/etc/ceph/ceph.conf 文件，修改节点信息</span></span><br><span class="line">vim /etc/ceph/ceph.conf</span><br><span class="line">[mon.ceph-node2]</span><br><span class="line">mon_addr=</span><br><span class="line">host=ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 从Ceph集群中提取密钥环的信息</span></span><br><span class="line">ceph auth get mon. -o /tmp/ceph-node2/monkeyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 从Ceph集群中获取monitor map信息</span></span><br><span class="line">ceph mon getmap -o /tmp/ceph-node2/monmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 使用密钥和已有的monmap，构建一个新的集群</span></span><br><span class="line">ceph-mon -i ceph-node2 --mkfs --monmap /tmp/ceph-node2/monmap --keyring /tmp/ceph-node2/monkeyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.添加新的monitor到集群</span></span><br><span class="line">ceph mon add ceph-node2 [ip_address]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 检查集群状态，配置NTP以同步时间信息</span></span><br><span class="line">ceph -s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 添加ceph-node3作为第三个monitor</span></span><br></pre></td></tr></table></figure><p></p><h2 id="2-3-基于ceph-deploy搭建ceph集群"><a href="#2-3-基于ceph-deploy搭建ceph集群" class="headerlink" title="2.3 基于ceph-deploy搭建ceph集群"></a>2.3 基于ceph-deploy搭建ceph集群</h2><h3 id="2-3-0-环境准备"><a href="#2-3-0-环境准备" class="headerlink" title="2.3.0 环境准备"></a>2.3.0 环境准备</h3><h4 id="Ceph版本"><a href="#Ceph版本" class="headerlink" title="Ceph版本"></a>Ceph版本</h4><p>每个Ceph版本都有一个英文名称和一个数字形式的版本编号</p><p>x.0.z - 开发版</p><p>x.1.z - 候选版</p><p>x.2.z - 稳定、修正版</p><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/releases/">https://docs.ceph.com/en/latest/releases/</a></p><h4 id="Ceph的安装工具"><a href="#Ceph的安装工具" class="headerlink" title="Ceph的安装工具"></a>Ceph的安装工具</h4><p><img src="/posts/3701960342/image-20231020200318410.png" alt="image-20231020200318410"></p><ul><li>Cephadm方法基于docker安装</li><li>Rook</li></ul><p><img src="/posts/3701960342/image-20231020200554951.png" alt="image-20231020200554951"></p><p>ceph-ansible：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-ansible">https://github.com/ceph/ceph-ansible</a> #python</p><p>ceph-salt：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-salt">https://github.com/ceph/ceph-salt</a> #python</p><p>ceph-container：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-container">https://github.com/ceph/ceph-container</a> #shell</p><p>ceph-chef：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-chef">https://github.com/ceph/ceph-chef</a> #Ruby</p><p>cephadm： <a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/cephadm/">https://docs.ceph.com/en/latest/cephadm/</a> #ceph 官方在ceph 15 版本加入的ceph部署工具</p><p>ceph-deploy：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-deploy">https://github.com/ceph/ceph-deploy</a> #python</p><p>是一个ceph 官方维护的基于ceph-deploy 命令行部署ceph 集群的工具，基于ssh 执行可以sudo 权限的shell 命令以及一些python 脚本实现ceph 集群的部署和管理维护。</p><p>Ceph-deploy 只用于部署和管理ceph 集群，客户端需要访问ceph，需要部署客户端工具。</p><h4 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h4><p><strong>网络配置</strong></p><ul><li>公有网络public： 192.168.192.0/24</li><li>私有网络cluster：192.168.252.0/24</li></ul><p><strong>主机规划</strong></p><div class="table-container"><table><thead><tr><th>主机名</th><th>公有网络</th><th>私有网络</th><th>磁盘</th></tr></thead><tbody><tr><td>admin</td><td>192.168.192.130</td><td>\</td><td>sda</td></tr><tr><td>mon01</td><td>192.168.192.131</td><td>192.168.252.128</td><td>sda</td></tr><tr><td>mon02</td><td>192.168.192.132</td><td>192.168.252.129</td><td>sda</td></tr><tr><td>mon03</td><td>192.168.192.133</td><td>192.168.252.130</td><td>sda</td></tr><tr><td>mgr01</td><td>192.168.192.134</td><td>192.168.252.131</td><td>sda</td></tr><tr><td>mgr02</td><td>192.168.192.135</td><td>192.168.252.132</td><td>sda</td></tr><tr><td>store01</td><td>192.168.192.136</td><td>192.168.252.133</td><td>sda、sdb、sdc</td></tr><tr><td>store02</td><td>192.168.192.137</td><td>192.168.252.134</td><td>sda、sdb、sdc</td></tr><tr><td>store03</td><td>192.168.192.138</td><td>192.168.252.135</td><td>sda、sdb、sdc</td></tr></tbody></table></div><p>ceph集群角色很多，生产中资源少时，可以让一台主机结点运行多个角色，如：store01-0.3这三台主机可同时兼任mon/mgr角色</p><h4 id="硬件配置"><a href="#硬件配置" class="headerlink" title="硬件配置"></a>硬件配置</h4><p>硬件推荐 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/start/hardware-recommendations/">http://docs.ceph.org.cn/start/hardware-recommendations/</a></p><p>所有结点2C2G</p><p>存储结点3块硬盘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">硬盘</span></span><br><span class="line">sda 20GB</span><br><span class="line">sdb、sdc 20GB</span><br></pre></td></tr></table></figure><h4 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ens33：NAT网络 VMnet8 设定为192.168.192.0/24 网段</span><br><span class="line">ens37：仅主机 VMnet1 设定为192.168.252.0/24 网段，提供ceph集群网络</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231022112928488.png" alt="image-20231022112928488"></p><h4 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h4><p>对任何集群来说，时间同步非常重要</p><p>ceph要求默认各结点的时间误差不超过50ms</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><p>在所有虚拟机上安装并配置ntp（时间同步服务）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install ntp ntpdate -y</span><br><span class="line">ntpdate pool.ntp.org</span><br><span class="line">systemctl restart ntpdate.service</span><br><span class="line">systemctl restart ntpd.service</span><br><span class="line">systemctl enable ntpd.service</span><br><span class="line">systemctl enable ntpdate.service</span><br></pre></td></tr></table></figure><h4 id="防火墙与SELinux管理"><a href="#防火墙与SELinux管理" class="headerlink" title="防火墙与SELinux管理"></a>防火墙与SELinux管理</h4><p>确保为monitor的6789端口添加防火墙策略，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=6789/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=6800-7100/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --zone=public --list-alI</span><br></pre></td></tr></table></figure><p>若只是测试环境，可以关闭防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">ufw stop</span><br><span class="line">ufw disable</span><br><span class="line">防火墙在系统启动时自动禁用</span><br></pre></td></tr></table></figure><p>所有虚拟主机上禁用SELINUX</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i s&#x27;/SELINUX,*=*enforcing/SELINUX=disabled&#x27;/g /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2-3-1-节点间ssh-免密-认证"><a href="#2-3-1-节点间ssh-免密-认证" class="headerlink" title="2.3.1 节点间ssh(免密)认证"></a>2.3.1 节点间ssh(免密)认证</h3><h4 id="主机名和解析"><a href="#主机名和解析" class="headerlink" title="主机名和解析"></a>主机名和解析</h4><p>在所有主机下配置一下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">192.168.192.130 admin.wang.org admin</span><br><span class="line">192.168.192.131 mon01.wang.org mon01</span><br><span class="line">192.168.192.132 mon02.wang.org mon02</span><br><span class="line">192.168.192.133 mon03.wang.org mon03</span><br><span class="line">192.168.192.134 mgr01.wang.org mgr01</span><br><span class="line">192.168.192.135 mgr02.wang.org mgr02</span><br><span class="line">192.168.192.136 store01.wang.org store01</span><br><span class="line">192.168.192.137 store02.wang.org store02</span><br><span class="line">192.168.192.138 store03.wang.org store03</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021110501138.png" alt="image-20231021110501138"></p><p>随着生产中主机节点越来越多，通过手工定制主机名的方式不适合主机管理。在企业中，主机名相关信息，倾向于通过内网dns来进行管理</p><p>radosgw，需要通过泛域名解析的机制来实现更加强大的面向客户端的主机名解析管理体系</p><h4 id="实现基于ssh-key的验证"><a href="#实现基于ssh-key的验证" class="headerlink" title="实现基于ssh key的验证"></a>实现基于ssh key的验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许root用户远程登录</span></span><br><span class="line">vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021144845914.png" alt="image-20231021144845914"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启ssh服务进程</span></span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><p>创建脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#********************************************************************</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Author:            wangxiaochun</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">QQ:                29308620</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Date:              2021-05-08</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">FileName:          ssh_key_push.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">URL:               http://www.wangxiaochun.com</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Description:       多主机基于ssh key 互相验证</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Copyright (C):     2021 All rights reserved</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">********************************************************************</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前用户密码</span></span><br><span class="line">PASS=admin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置网段最小和最大的地址的尾数</span></span><br><span class="line">BEGIN=130</span><br><span class="line">END=138</span><br><span class="line"></span><br><span class="line">IP=`ip a s ens33 | awk -F&#x27;[ /]+&#x27; &#x27;NR==4&#123;print $3&#125;&#x27;`</span><br><span class="line">NET=$&#123;IP%.*&#125;.</span><br><span class="line"></span><br><span class="line">. /etc/os-release</span><br><span class="line"></span><br><span class="line">color () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=&quot;echo -en \\033[$&#123;RES_COL&#125;G&quot;</span><br><span class="line">    SETCOLOR_SUCCESS=&quot;echo -en \\033[1;32m&quot;</span><br><span class="line">    SETCOLOR_FAILURE=&quot;echo -en \\033[1;31m&quot;</span><br><span class="line">    SETCOLOR_WARNING=&quot;echo -en \\033[1;33m&quot;</span><br><span class="line">    SETCOLOR_NORMAL=&quot;echo -en \E[0m&quot;</span><br><span class="line">    echo -n &quot;$1&quot; &amp;&amp; $MOVE_TO_COL</span><br><span class="line">    echo -n &quot;[&quot;</span><br><span class="line">    if [ $2 = &quot;success&quot; -o $2 = &quot;0&quot; ] ;then</span><br><span class="line">        $&#123;SETCOLOR_SUCCESS&#125;</span><br><span class="line">        echo -n $&quot;  OK  &quot;    </span><br><span class="line">    elif [ $2 = &quot;failure&quot; -o $2 = &quot;1&quot;  ] ;then </span><br><span class="line">        $&#123;SETCOLOR_FAILURE&#125;</span><br><span class="line">        echo -n $&quot;FAILED&quot;</span><br><span class="line">    else</span><br><span class="line">        $&#123;SETCOLOR_WARNING&#125;</span><br><span class="line">        echo -n $&quot;WARNING&quot;</span><br><span class="line">    fi</span><br><span class="line">    $&#123;SETCOLOR_NORMAL&#125;</span><br><span class="line">    echo -n &quot;]&quot;</span><br><span class="line">    echo </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装sshpass</span></span><br><span class="line">install_sshpass() &#123;</span><br><span class="line">    if [[ $ID =~ centos|rocky|rhel ]];then</span><br><span class="line">        rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass</span><br><span class="line">    else</span><br><span class="line">        dpkg -l sshpass &amp;&gt; /dev/null || &#123; sudo apt update;sudo apt -y install sshpass; &#125;</span><br><span class="line">    fi</span><br><span class="line">	if [ $? -ne 0 ];then </span><br><span class="line">	    color &#x27;安装 sshpass 失败!&#x27; 1</span><br><span class="line">		exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scan_host() &#123;</span><br><span class="line">    [ -e ./SCANIP.log ] &amp;&amp; rm -f SCANIP.log</span><br><span class="line">    for((i=$BEGIN;i&lt;=&quot;$END&quot;;i++));do</span><br><span class="line">        ping -c 1 -w 1  $&#123;NET&#125;$i &amp;&gt; /dev/null  &amp;&amp; echo &quot;$&#123;NET&#125;$i&quot; &gt;&gt; SCANIP.log &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push_ssh_key() &#123;</span><br><span class="line">   	#生成ssh key </span><br><span class="line">    [ -e ~/.ssh/id_rsa ] || ssh-keygen -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line">    sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no root@$IP  &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    ip_list=(`sort -t . -k 4 -n  SCANIP.log`)</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        sshpass -p $PASS scp -o StrictHostKeyChecking=no -r ~/.ssh root@$&#123;ip&#125;: &amp;&gt;/dev/null</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    #把.ssh/known_hosts拷贝到所有主机，使它们第一次互相访问时不需要输入yes回车</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        scp ~/.ssh/known_hosts @$&#123;ip&#125;:.ssh/   &amp;&gt;/dev/null</span><br><span class="line">		color &quot;$ip&quot; 0</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_sshpass</span><br><span class="line">scan_host</span><br><span class="line">push_ssh_key</span><br></pre></td></tr></table></figure><p>导入脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@admin:/home/admin# sudo apt install lrzsz</span><br><span class="line"></span><br><span class="line">rz</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021111427267.png" alt="image-20231021111427267"></p><p>脚本执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ssh_key_push.sh</span><br></pre></td></tr></table></figure><h4 id="所有主机通过cephadm用户实现免密登录"><a href="#所有主机通过cephadm用户实现免密登录" class="headerlink" title="所有主机通过cephadm用户实现免密登录"></a>所有主机通过cephadm用户实现免密登录</h4><h5 id="为所有节点创建cephadm用户"><a href="#为所有节点创建cephadm用户" class="headerlink" title="为所有节点创建cephadm用户"></a>为所有节点创建cephadm用户</h5><p>接下来操作，基本都在 admin 这个管理节点的主机上运行，基于安全考虑不用root用户管理，倾向与用一个普通用户来操作</p><p>由于后续安装软件，涉及root用户权限，所以这个普通用户最好具备 sudo 的权限</p><p>此管理用户名称不能使用ceph名称，ceph后续会自动创建此用户</p><p><strong>方法1</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在所有主机上创建普通用户</span></span><br><span class="line">useradd -m -s /bin/bash cephadm</span><br><span class="line">echo cephadm:123456 / chpasswd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为用户配置root权限</span></span><br><span class="line">echo &quot;cephadm ALL = (root) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/cephadm</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephadm</span><br></pre></td></tr></table></figure><p><strong>方法2</strong></p><p>脚本实现批量创建用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用脚本实现批量创建用户</span></span><br><span class="line">cat &gt; create_cephadm.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定普通用户</span></span><br><span class="line">useradd -m -s /bin/bash cephadm</span><br><span class="line">echo cephadm:123456 | chpasswd</span><br><span class="line">echo &quot;cephadm ALL=(ALL) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/cephadm</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephadm</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">批量执行</span></span><br><span class="line">for i in &#123;130..138&#125;; do ssh root@192.168.192.$i bash &lt; create_cephadm.sh ; done</span><br></pre></td></tr></table></figure><p>检测是否创建用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll /etc/passwd</span><br><span class="line">cat /etc/sudoers.d/</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021155409180.png" alt="image-20231021155409180"></p><p><img src="/posts/3701960342/image-20231021155536179.png" alt="image-20231021155536179"></p><p><img src="/posts/3701960342/image-20231021155634243.png" alt="image-20231021155634243"></p><h4 id="跨主机免密登录"><a href="#跨主机免密登录" class="headerlink" title="跨主机免密登录"></a>跨主机免密登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">su - cephadm</span><br><span class="line">ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">跨主机密码认证</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将本地公钥复制给远程端，则本地可ssh访问远程也能够端</span></span><br><span class="line">PASS=123456</span><br><span class="line">for i in &#123;130..138&#125;;do</span><br><span class="line">	sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no cephadm@192.168.192.$i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">vim .bashrc</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231022193050105.png" alt="image-20231022193050105"></p><h3 id="2-3-2-为所有节点配置安装源"><a href="#2-3-2-为所有节点配置安装源" class="headerlink" title="2.3.2 为所有节点配置安装源"></a>2.3.2 为所有节点配置安装源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在管理节点准备脚本,注意以root身份执行</span></span><br><span class="line">[root@admin ~]cat &gt; ceph_repo.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为所有节点都会依赖于这些apt源信息，需要进行同步</span></span><br><span class="line">[root@admin ~]for i in &#123;130..138&#125;;do ssh -o StrictHostKeyChecking=no 192.168.192.$i bash &lt; ceph_repo.sh;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">去其他结点查看</span></span><br><span class="line">cat /etc/apt/sources.list.d/ceph.list</span><br></pre></td></tr></table></figure><h3 id="2-3-3-管理主机节点部署ceph的安装环境"><a href="#2-3-3-管理主机节点部署ceph的安装环境" class="headerlink" title="2.3.3 管理主机节点部署ceph的安装环境"></a>2.3.3 管理主机节点部署ceph的安装环境</h3><h4 id="admin节点主机安装ceph-deploy工具"><a href="#admin节点主机安装ceph-deploy工具" class="headerlink" title="admin节点主机安装ceph-deploy工具"></a>admin节点主机安装ceph-deploy工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">cephadm@admin:~$sudo apt-cache madison ceph-deploy # 查看版本</span><br><span class="line">cephadm@admin:~$sudo apt -y install ceph-deploy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证成功和查看版本</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --version</span><br><span class="line">2.0.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助手册</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --help</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">new：开始部署一个新的ceph 存储集群，并生成CLUSTER.conf 集群配置文件和keyring 认证文件。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">install: 在远程主机上安装ceph 相关的软件包, 可以通过--release 指定安装的版本。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rgw：管理RGW 守护程序(RADOSGW,对象存储网关)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mgr：管理MGR 守护程序(ceph-mgr,Ceph Manager DaemonCeph 管理器守护程序)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mds：管理MDS 守护程序(Ceph Metadata Server，ceph 源数据服务器)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon：管理MON 守护程序(ceph-mon,ceph 监视器)。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">gatherkeys：从指定的获取提供新节点验证keys，这些keys 会在添加新的MON/OSD/MD 加入的时候使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disk：管理远程主机磁盘。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd：在远程主机准备数据磁盘，即将指定远程主机的指定磁盘添加到ceph 集群作为osd 使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">repo： 远程主机仓库管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">admin：推送ceph集群配置文件和client.admin 认证文件到远程主机。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">config：将ceph.conf 配置文件推送到远程主机或从远程主机拷贝。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uninstall：从远端主机删除安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">urgedata：从/var/lib/ceph 删除ceph 数据,会删除/etc/ceph 下的内容。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">purge: 删除远端主机的安装包和所有数据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">forgetkeys：从本地主机删除所有的验证keyring, 包括client.admin, monitor, bootstrap 等认证文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pkg： 管理远端主机的安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calamari：安装并配置一个calamari web 节点，calamari 是一个web 监控平台。</span></span><br></pre></td></tr></table></figure><h3 id="2-3-4-创建集群并初始化"><a href="#2-3-4-创建集群并初始化" class="headerlink" title="2.3.4 创建集群并初始化"></a>2.3.4 创建集群并初始化</h3><p>初始化第一个mon节点，准备创建集群</p><blockquote><p>只是生成一些配置，并未做实际安装</p></blockquote><p>初始化第一个mon节点的命令格式为 <code>ceph-deploy new &#123;initial-monitor-node(s)&#125;</code></p><ul><li>mon01 即为第一个mon结点名称，其名称必须与节点当前实际使用的主机名称( <code>uname -n</code> ) 保持一致，即可以是短名称，也可以是长名称</li><li>但短名称会导致错误： ceph-deploy new: error: hostname: xxx is not resolvable</li><li>推荐使用完整写法：<code>hostname:fqdn</code> 如：<code>mon01:mon01.wang.org</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">首先在管理节点上以cephadm用户创建集群相关的配置文件目录</span></span><br><span class="line">cephadm@admin:~$mkdir ceph-cluster &amp;&amp; cd ceph-cluster</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行如下命令即可生成初始配置：</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy new --public-network 192.168.192.0/24 --cluster-network 192.168.252.0/24 mon01:mon01.wang.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.conf <span class="comment">#自动生成的配置文件</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph-deploy-ceph.log <span class="comment">#初始化日志</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.mon.keyring <span class="comment">#用于ceph mon 节点内部通讯认证的秘钥环文件</span></span></span><br><span class="line"></span><br><span class="line">cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = e9664a14-197f-4bfe-bc2e-e585ba02fa4c</span><br><span class="line">public_network = 192.168.192.0/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">可以用逗号做分割添加多个mon 节点</span></span><br><span class="line">mon_initial_members = mon01</span><br><span class="line">mon_host = 192.168.192.131</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果部署过程出现问题，需要清空</span></span><br><span class="line">ceph-deploy forgetkeys</span><br><span class="line">ceph-deploy purge mon0&#123;1,2,3&#125; mgr0&#123;1,2&#125; store0&#123;1,2,3&#125;</span><br><span class="line">ceph-deploy purgedata mon0&#123;1,2,3&#125; mgr0&#123;1,2&#125; store0&#123;1,2,3&#125;</span><br><span class="line">rm ceph.*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果想要一下子将所有的mon节点都部署出来，我们可以执行下面的命令</span></span><br><span class="line">ceph-deploy new --public-network 192.168.192.130/24 --cluster-network 192.168.252.0/24 mon01:mon01.wang.org mon02:mon02.wang.org mon03:mon03.wang.org</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021192331126.png" alt="image-20231021192331126"></p><p>没出这个问题</p><ul><li><p><img src="/posts/3701960342/image-20231021170352538.png" alt="image-20231021170352538"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">原因分析：因为 python3.8 已经没有这个方法了</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ dpkg -l python3</span><br><span class="line">期望状态=未知(u)/安装(i)/删除(r)/清除(p)/保持(h)</span><br><span class="line">| 状态=未安装(n)/已安装(i)/仅存配置(c)/仅解压缩(U)/配置失败(F)/不完全安装(H)/触发器等待</span><br><span class="line">(W)/触发器未决(T)</span><br><span class="line">|/ 错误?=(无)/须重装(R) (状态，错误：大写=故障)</span><br><span class="line">||/ 名称 版本 体系结构 描述</span><br><span class="line">+++-==============-==============-============-</span><br><span class="line">=========================================================================</span><br><span class="line">ii python3 3.8.2-0ubuntu2 amd64 interactive high-level objectoriented</span><br><span class="line">language (default python3 version)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解决方法：</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$sudo vim /usr/lib/python3/distpackages/ ceph_deploy/hosts/remotes.py</span><br><span class="line"></span><br><span class="line">def platform_information(_linux_distribution=None):</span><br><span class="line">	&quot;&quot;&quot; detect platform information from remote host &quot;&quot;&quot;</span><br><span class="line">	行首加#号注释下面两行</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">linux_distribution = _linux_distribution or platform.linux_distribution</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">distro, release, codename = linux_distribution()</span></span><br><span class="line">	</span><br><span class="line">	在上面两行下面添加下面6行</span><br><span class="line">	distro = release = codename = None</span><br><span class="line">	try:</span><br><span class="line">		linux_distribution = _linux_distribution or platform.linux_distribution</span><br><span class="line">		distro, release, codename = linux_distribution()</span><br><span class="line">	except AttributeError:</span><br><span class="line">		pass</span><br><span class="line">	.......</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021171607107.png" alt="image-20231021171607107"></p></li></ul><h3 id="2-3-5-mon节点安装软件"><a href="#2-3-5-mon节点安装软件" class="headerlink" title="2.3.5 mon节点安装软件"></a>2.3.5 mon节点安装软件</h3><p>初始化存储节点等于在存储节点安装了ceph 及ceph-rodsgw 安装包</p><ul><li>默认情况下，ceph-deploy会安装最新版本的ceph，若需要指定ceph版本，添加参数 <code>--release &#123;ceph-release-name&#125;</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令格式：</span></span><br><span class="line">ceph-deploy install &#123;ceph-node&#125; [&#123;ceph-node&#125; ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：这里主要是ceph的工作角色的的节点</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:使用ceph-deploy命令能够以远程的方式连入Ceph集群各节点完成程序包安装等操作</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般情况下，不推荐使用这种直接的方法来进行安装，效率太低，实际上也是在各节点上执行方法2</span></span><br><span class="line">ceph-deploy install mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">还有另外一种方法，手工在所有节点上安装ceph软件</span></span><br><span class="line">apt install -y ceph ceph-osd ceph-mds ceph-mon radosgw</span><br></pre></td></tr></table></figure><p>如：在mon01，02，03上安装mon相关的包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在mon节点安装mon组件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --no-adjust-repos --nogpgcheck --mon mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者直接在mon节点安装软件</span></span><br><span class="line">[root@mon01 ~] apt -y install ceph-mon</span><br></pre></td></tr></table></figure><p>安装完成后，发现创建了ceph用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动创建ceph用户</span></span><br><span class="line">[root@mon01 ~] getent passwd ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021190544275.png" alt="image-20231021190544275"></p><p>验证在mon 节点已经自动安装并启动了ceph-mon 服务，并且后期在ceph-deploy 节点初始化目录会生成一些bootstrap ceph mds/mgr/osd/rgw 等服务的keyring 认证文件，这些初始化文件拥有对ceph 集群的最高权限，所以一定要保存好。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看到mon01节点安装了ceph相关的包</span></span><br><span class="line">[root@mon01 ~] dpkg -l |grep ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动运行相关进程</span></span><br><span class="line">[root@mon01 ~] ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021190739618.png" alt="image-20231021190739618"></p><h3 id="2-2-6-部署mon节点——集群认证和管理"><a href="#2-2-6-部署mon节点——集群认证和管理" class="headerlink" title="2.2.6 部署mon节点——集群认证和管理"></a>2.2.6 部署mon节点——集群认证和管理</h3><h4 id="初始化mon节点生成配置信息并分发密钥"><a href="#初始化mon节点生成配置信息并分发密钥" class="headerlink" title="初始化mon节点生成配置信息并分发密钥"></a>初始化mon节点生成配置信息并分发密钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置初始化MON节点，并收集密钥</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf mon create-initial</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：为了避免因为认证方面导致的通信失败，推荐使用 --overwrite-conf 参数</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行之前，应该在ceph.conf中配置monitor信息</span></span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果是在一个现有的环境上部署业务，可以先推送基准配置文件</span></span><br><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br></pre></td></tr></table></figure><p>范例: 初始化 mon 节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf mon create-initial</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.client.admin.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-mds.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-mgr.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] keyring &#x27;ceph.mon.keyring&#x27; already exists</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-osd.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Storing ceph.bootstrap-rgw.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO  ] Destroy temp directory /tmp/tmpf0cb5m1s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成配置文件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ls</span><br><span class="line">ceph.bootstrap-mds.keyring 引导启动 mds的密钥文件</span><br><span class="line">ceph.bootstrap-mgr.keyring 引导启动 mgr的密钥文件</span><br><span class="line">ceph.bootstrap-osd.keyring 引导启动 osd的密钥文件</span><br><span class="line">ceph.bootstrap-rgw.keyring 引导启动 rgw的密钥文件</span><br><span class="line">ceph.client.admin.keyring ceph客户端和管理端通信的认证密钥，是最重要的</span><br><span class="line">ceph.conf</span><br><span class="line">ceph-deploy-ceph.log</span><br><span class="line">ceph.mon.keyring</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这里生成了一系列的与ceph集群相关的 认证文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：ceph.client.admin.keyring 拥有ceph集群的所有权限，一定不能有误。</span></span><br></pre></td></tr></table></figure><p>这时在mon01上启动了一些进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">到mon的节点上查看mon的自动开启相应的守护进程</span></span><br><span class="line">[root@mon01 ~]ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021193018559.png" alt="image-20231021193018559"></p><h4 id="推送密钥实现集群的管理"><a href="#推送密钥实现集群的管理" class="headerlink" title="推送密钥实现集群的管理"></a>推送密钥实现集群的管理</h4><p>为了后续的监控环境认证操作，在admin角色主机上，把配置文件和admin密钥拷贝到Ceph集群各监控角色节点mon</p><blockquote><p>若不在这些mon节点机器上管理集群，则不需要这一步</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#注意：原则上要求，所有mon节点上的 ceph.conf 内容必须一致，如果不一致的话，可以通过下面命令同步</span></span></span><br><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行集群的认证文件的拷贝动作</span></span><br><span class="line">ceph-deploy admin --help</span><br><span class="line">usage: ceph-deploy admin [-h] HOST [HOST ...]</span><br><span class="line"></span><br><span class="line">Push configuration and client.admin key to a remote host.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">	HOST 	host to configure for Ceph administration</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">	-h, --help show this help message and exit</span><br><span class="line"></span><br><span class="line">ceph-deploy admin mon01 mon02 mon03</span><br></pre></td></tr></table></figure><p>如：在mon节点实现集群管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拷贝前效果</span></span><br><span class="line">[root@mon01 ~] ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmpk0vsd0on</span><br><span class="line">root@mon02:/home/mon02# ls /etc/ceph</span><br><span class="line">ceph.conf  rbdmap  tmprm7hc0mf</span><br><span class="line">root@mon03:~# ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmp1mrnb7qm</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy admin mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看效果</span></span><br><span class="line">root@mon01:/home/mon01# ls /etc/ceph/</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmpk0vsd0on</span><br><span class="line">root@mon02:/home/mon02# ls /etc/ceph</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmprm7hc0mf</span><br><span class="line">root@mon03:~# ls /etc/ceph/</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmp1mrnb7qm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这里多了一个 ceph的客户端与服务端进行认证的密钥文件了。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.client.admin.keyring 主要用于ceph节点与管理端的一个通信认证。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果我们不做交互式操作的话，这个文件可以不用复制。</span></span><br><span class="line">root@mon01:/home/mon01# cat /etc/ceph/ceph.client.admin.keyring </span><br><span class="line">[client.admin]</span><br><span class="line">	key = AQAyrTRl2m24GBAAT5lAYOvgyOejaU4URoZCUw==</span><br><span class="line">	caps mds = &quot;allow *&quot;</span><br><span class="line">	caps mgr = &quot;allow *&quot;</span><br><span class="line">	caps mon = &quot;allow *&quot;</span><br><span class="line">root@mon02:/home/mon02# cat /etc/ceph/ceph.client.admin.keyring </span><br><span class="line">[client.admin]</span><br><span class="line">	key = AQAyrTRl2m24GBAAT5lAYOvgyOejaU4URoZCUw==</span><br><span class="line">	caps mds = &quot;allow *&quot;</span><br><span class="line">	caps mgr = &quot;allow *&quot;</span><br><span class="line">	caps mon = &quot;allow *&quot;</span><br><span class="line">	caps osd = &quot;allow *&quot;</span><br><span class="line">root@mon03:~# cat /etc/ceph/ceph.client.admin.keyring </span><br><span class="line">[client.admin]</span><br><span class="line">	key = AQAyrTRl2m24GBAAT5lAYOvgyOejaU4URoZCUw==</span><br><span class="line">	caps mds = &quot;allow *&quot;</span><br><span class="line">	caps mgr = &quot;allow *&quot;</span><br><span class="line">	caps mon = &quot;allow *&quot;</span><br><span class="line">	caps osd = &quot;allow *&quot;</span><br></pre></td></tr></table></figure><p>问题：虽然我们把认证文件传递给对应的监控角色主机了，但是我们的管理机是通过普通用户cephadm来进行交流的。而默认情况下，传递过去的认证文件，cephadm普通用户是无法正常访问的，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mon01 ~] ll /etc/ceph/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cephadm用户执行命令因文件权限会出错</span></span><br><span class="line">[root@mon01 ~] su - cephadm</span><br><span class="line">[cephadm@mon01 ~]$ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231022131240812.png" alt="image-20231022131240812"></p><p>需要在Ceph集群中需要运行ceph命令的节点上，以root用户的身份设定普通用户cephadm能够读取/etc/ceph/ceph.client.admin.keyring文件的权限。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mon01,02,03 ~] sudo apt install acl</span><br><span class="line">[root@mon01,02,03 ~] sudo setfacl -m u:cephadm:r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure><p>然后监控节点就可以自己来收集相关的数据了，比如我们在mon01上执行如下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mon01 ~] su - cephadm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看状态</span></span><br><span class="line">[cephadm@mon01 ~]$ceph -s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群状态不正常的原因，我们可以通过 ceph health命令来进行确认，效果如下</span></span><br><span class="line">[cephadm@mon01 ~]$ceph health</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231022131446761.png" alt="image-20231022131446761"></p><h4 id="部署集群的admin节点实现远程管理"><a href="#部署集群的admin节点实现远程管理" class="headerlink" title="部署集群的admin节点实现远程管理"></a>部署集群的admin节点实现远程管理</h4><p>在哪个主机上管理集群，就在哪个集群上安装 <code>ceph-common</code></p><p>当前的这些状态查看，只能到对应的节点主机上来进行，这个ceph命令是依赖于 ceph-common软件的。</p><p>其实为了方便集群的管理，一般会通过远程的方式来进行远程主机状态的查询。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.安装管理工具包</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$sudo apt -y install ceph-common</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动生成目录和配置文件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">rbdmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 推送配置和相关key文件到管理节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ceph-deploy admin admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证文件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmpzp2_08ah</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 一些文件因为权限问题无法复制，需要acl修改权限后复制</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$sudo apt install acl -y</span><br><span class="line">cephadm@admin:~/ceph-cluster$sudo setfacl -m u:cephadm:rw /etc/ceph/ceph.client.admin.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查效果</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     75c70a9d-790a-4859-9374-39159d37eca1</span><br><span class="line">    health: HEALTH_WARN</span><br><span class="line">            mon is allowing insecure global_id reclaim</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum mon01 (age 31m)</span><br><span class="line">    mgr: no daemons active</span><br><span class="line">    osd: 0 osds: 0 up, 0 in</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   0 pools, 0 pgs</span><br><span class="line">    objects: 0 objects, 0 B</span><br><span class="line">    usage:   0 B used, 0 B / 0 B avail</span><br><span class="line">    pgs:  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">消除 mon is allowing insecure global_id reclaim的报警信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph config set mon auth_allow_insecure_global_id_reclaim false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次查看没有告警信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><h3 id="2-2-7-部署mgr节点"><a href="#2-2-7-部署mgr节点" class="headerlink" title="2.2.7 部署mgr节点"></a>2.2.7 部署mgr节点</h3><p>Ceph-MGR工作的模式是事件驱动型的，简单来说，就是等待事件，事件来了则处理事件返回结果，又继续等待。<br>Ceph MGR 事自从 Ceph 12.2 依赖主推的功能之一，是负责 Ceph 集群管理的组件，它主要功能是把集群的一些指标暴露给外界使用。根据官方的架构原则上来说，mgr要有两个节点来进行工作。</p><p>对于测试环境其实一个就能够正常使用了,暂时先安装一个节点，后面再安装第二个节点。</p><h4 id="安装mgr相关软件"><a href="#安装mgr相关软件" class="headerlink" title="安装mgr相关软件"></a>安装mgr相关软件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在管理节点远程安装mgr软件到mgr节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mgr mgr01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mgr01节点手动安装软件</span></span><br><span class="line">[root@mgr01 ~] apt -y install ceph-mgr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">发现安装了相关包</span></span><br><span class="line">[root@mgr01 ~] dpkg -l | grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021204741269.png" alt="image-20231021204741269"></p><h4 id="配置Mgr节点启动ceph-mgr进程"><a href="#配置Mgr节点启动ceph-mgr进程" class="headerlink" title="配置Mgr节点启动ceph-mgr进程"></a>配置Mgr节点启动ceph-mgr进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建mgr节点并生成相关配置</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mgr create mgr01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动在mgr01节点生成配置文件和用户</span></span><br><span class="line">[root@mgr01 ~] ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmp8zt3kkj8</span><br><span class="line"></span><br><span class="line">[root@mgr01 ~] getent passwd ceph</span><br><span class="line">ceph:x:64045:64045:Ceph storage service:/var/lib/ceph:/usr/sbin/nologin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启相关进程</span></span><br><span class="line">[root@mgr01 ~] ps aux|grep ceph</span><br><span class="line">ceph       35476  0.0  0.5  24468 11532 ?        Ss   20:45   0:00 /usr/bin/python3 /usr/bin/ceph-crash</span><br><span class="line">ceph       43250  8.3  8.9 897816 176364 ?       Ssl  20:54   0:05 /usr/bin/ceph-mgr -f --cluster ceph --id mgr01 --setuser ceph --setgroup ceph</span><br><span class="line">root       43375  0.0  0.0  12000   720 pts/2    S+   20:55   0:00 grep --color=auto ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看集群状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这个时候，service上，多了一个mgr的服务，在mgr01节点上，服务状态是 active。</span></span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021205644091.png" alt="image-20231021205644091"></p><h3 id="2-2-8-部署-OSD-存储节点"><a href="#2-2-8-部署-OSD-存储节点" class="headerlink" title="2.2.8 部署 OSD 存储节点"></a>2.2.8 部署 OSD 存储节点</h3><p>要设置OSD环境，一般执行下面步骤：</p><ul><li>要知道对应的主机上有哪些磁盘可以提供给主机来进行正常的使用。</li><li>格式化磁盘(非必须)</li><li>ceph擦除磁盘上的数据</li><li>添加osd</li></ul><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有的存储节点主机都准备了两块额外的磁盘，</span></span><br><span class="line">[root@store01 ~] lsblk</span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0    7:0    0  63.3M  1 loop /snap/core20/1828</span><br><span class="line">loop1    7:1    0     4K  1 loop /snap/bare/5</span><br><span class="line">loop2    7:2    0  63.5M  1 loop /snap/core20/2015</span><br><span class="line">loop3    7:3    0 346.3M  1 loop /snap/gnome-3-38-2004/119</span><br><span class="line">loop4    7:4    0 349.7M  1 loop /snap/gnome-3-38-2004/143</span><br><span class="line">loop5    7:5    0  91.7M  1 loop /snap/gtk-common-themes/1535</span><br><span class="line">loop6    7:6    0    46M  1 loop /snap/snap-store/638</span><br><span class="line">loop7    7:7    0  49.9M  1 loop /snap/snapd/18357</span><br><span class="line">loop8    7:8    0  40.9M  1 loop /snap/snapd/20290</span><br><span class="line">sda      8:0    0    20G  0 disk </span><br><span class="line">├─sda1   8:1    0   512M  0 part /boot/efi</span><br><span class="line">├─sda2   8:2    0     1K  0 part </span><br><span class="line">└─sda5   8:5    0  19.5G  0 part /</span><br><span class="line">sdb      8:16   0    20G  0 disk </span><br><span class="line">sdc      8:32   0    20G  0 disk </span><br><span class="line">sr0     11:0    1   4.1G  0 rom  /media/store01/Ubuntu 20.04.6 LTS amd64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果不想查看大量无效设备的话，可以执行下面清理操作</span></span><br><span class="line">sudo apt autoremove --purge snapd -y</span><br></pre></td></tr></table></figure><h4 id="安装OSD存储结点相关软件"><a href="#安装OSD存储结点相关软件" class="headerlink" title="安装OSD存储结点相关软件"></a>安装OSD存储结点相关软件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 确认仓库配置</span></span><br><span class="line">[root@store01 ~] cat /etc/apt/sources.list.d/ceph.list</span><br><span class="line">deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific/ focal main wget -q -O- https://download.ceph.com/keys/release.asc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装OSD相关软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1: 在管理节点远程安装</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --release pacific --osd store01 </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2: 在OSD主机手动安装</span></span><br><span class="line">[root@store01 ~] apt -y install ceph-osd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 确认安装结果</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动生成用户ceph</span></span><br><span class="line">[root@store01 ~] tail -n1 /etc/passwd</span><br><span class="line">[root@store01 ~] dpkg -l |grep ceph</span><br><span class="line">ii ceph-base 16.2.14-1focal amd64 common ceph daemon libraries and management tools</span><br><span class="line">ii ceph-common 16.2.14-1focal amd64 common utilities to mount and interact with a ceph storage cluster</span><br><span class="line">ii ceph-osd 16.2.14-1focal amd64 OSD server for the ceph storage system</span><br><span class="line">ii libcephfs2 16.2.14-1focal amd64 Ceph distributed file system client library</span><br><span class="line">ii python3-ceph-argparse 16.2.14-1focal all Python 3 utility libraries for Ceph CLI</span><br><span class="line">ii python3-ceph-common 16.2.14-1focal all Python 3 utility libraries for Ceph</span><br><span class="line">ii python3-cephfs 16.2.14-1focal amd64 Python 3 libraries for the Ceph libcephfs library</span><br><span class="line"></span><br><span class="line">[root@store01 ~] ls /etc/ceph/</span><br><span class="line"></span><br><span class="line">[root@store01 ~] ps aux|grep ceph</span><br><span class="line">ceph       30953  0.0  0.6  24164 11940 ?        Ss   21:18   0:00 /usr/bin/python3.8 /usr/bin/ceph-crash</span><br><span class="line">store01    39320  0.0  0.0  12000   716 pts/1    S+   21:22   0:00 grep --color=auto ceph</span><br></pre></td></tr></table></figure><h4 id="查看所有可用的osd磁盘"><a href="#查看所有可用的osd磁盘" class="headerlink" title="查看所有可用的osd磁盘"></a>查看所有可用的osd磁盘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查并列出OSD节点上所有可用的磁盘的相关信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy disk list store01</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021233506160.png" alt="image-20231021233506160"></p><p>报错原因是 python 版本问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改375行,将 <span class="keyword">if</span> line.startswith(<span class="string">&#x27;Disk /&#x27;</span>): 更改为 <span class="keyword">if</span> line.startswith(b<span class="string">&#x27;Disk /&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只在<span class="string">&#x27;Disk前加一个字母 b 即可</span></span></span><br><span class="line">cephadm@admin:~$sudo vim +375 /usr/lib/python3/dist-packages/ceph_deploy/osd.py</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy disk list store01</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021234748243.png" alt="image-20231021234748243"></p><h5 id="清除OSD磁盘数据"><a href="#清除OSD磁盘数据" class="headerlink" title="清除OSD磁盘数据"></a>清除OSD磁盘数据</h5><p>在管理节点上使用ceph-deploy命令擦除计划专用于OSD磁盘上的所有分区表和数据以便用于OSD</p><p>注意: 如果硬盘是无数据的新硬盘此步骤可以不做</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk zap [-h] [--debug] [HOST] DISK [DISK ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">说明此操操作本质上就是执行<span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=disk bs=1M count=10</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$for i in &#123;1..3&#125;;do ceph-deploy disk zap store0$i /dev/sdb /dev/sdc;done</span><br></pre></td></tr></table></figure><h4 id="配置OSD存储结点"><a href="#配置OSD存储结点" class="headerlink" title="配置OSD存储结点"></a>配置OSD存储结点</h4><p>对于OSD的相关操作，可以通过 <code>ceph-deploy osd</code> 命令来进行，帮助信息如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">帮助显示：这里提示了两类的存储机制：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认情况下用的就是 bluestore类型</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于bluestore来说，它主要包括三类数据：</span></span><br><span class="line">--data /path/to/data #ceph 保存的对象数据</span><br><span class="line">--block-db /path/to/db-device #数据库,即为元数据</span><br><span class="line">--block-wal /path/to/wal-device #数据库的 wal 日志</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生产建议data和wal日志分别存放</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于filestore来说，它主要包括两类数据</span></span><br><span class="line">--data /path/to/data #ceph的文件数据</span><br><span class="line">--journal /path/to/journal #文件系统日志数据</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于 osd来说，它主要有两个动作：</span></span><br><span class="line">list 列出osd相关的信息</span><br><span class="line">create 创建osd设备</span><br></pre></td></tr></table></figure><p>如: 创建OSD存储所有信息都存储在一起</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf osd create store01 --data /dev/sdb</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看命令执行后的ceph的集群状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看osd状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph osd status</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231021235858359.png" alt="image-20231021235858359"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd list store01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看自动启动相关进程</span></span><br><span class="line">[root@store01 ~] ps aux|grep ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将第二块磁盘也加入OSD</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf osd create store01 --data /dev/sdc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">每个磁盘对应一个OSD进程</span></span><br><span class="line">[root@store01 ~] ps aux|grep ceph</span><br></pre></td></tr></table></figure><ul><li>每个磁盘生成对应的一个逻辑卷</li><li>每个osd磁盘生成一个service</li></ul><h4 id="添加后续所有OSD结点的磁盘"><a href="#添加后续所有OSD结点的磁盘" class="headerlink" title="添加后续所有OSD结点的磁盘"></a>添加后续所有OSD结点的磁盘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1: 在管理节点远程安装</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --release pacific --osd store02 store03</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2: 在OSD主机手动安装</span></span><br><span class="line">[root@store02 ~]#apt -y install ceph-osd</span><br><span class="line">[root@store03 ~]#apt -y install ceph-osd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">接下来通过批量操作的方式，将其他节点主机的磁盘都格式化</span></span><br><span class="line">for i in &#123;2..3&#125;;do</span><br><span class="line">	ceph-deploy --overwrite-conf osd create store0$i --data /dev/sdb</span><br><span class="line">	ceph-deploy --overwrite-conf osd create store0$i --data /dev/sdc</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="2-2-9-查看集群最终状态"><a href="#2-2-9-查看集群最终状态" class="headerlink" title="2.2.9 查看集群最终状态"></a>2.2.9 查看集群最终状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     75c70a9d-790a-4859-9374-39159d37eca1</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"> </span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum mon01 (age 4h)</span><br><span class="line">    mgr: mgr01(active, since 3h)</span><br><span class="line">    osd: 6 osds: 6 up (since 75s), 6 in (since 75s)</span><br><span class="line"> </span><br><span class="line">  data:</span><br><span class="line">    pools:   1 pools, 1 pgs</span><br><span class="line">    objects: 0 objects, 0 B</span><br><span class="line">    usage:   1.7 GiB used, 118 GiB / 120 GiB avail</span><br><span class="line">    pgs:     1 active+clean</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看管理配置完毕后的osd数量</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd list store0&#123;1..3&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph osd status</span><br></pre></td></tr></table></figure><h3 id="2-2-10-扩展高可用"><a href="#2-2-10-扩展高可用" class="headerlink" title="2.2.10 扩展高可用"></a>2.2.10 扩展高可用</h3><h4 id="实现mgr节点高可用"><a href="#实现mgr节点高可用" class="headerlink" title="实现mgr节点高可用"></a>实现mgr节点高可用</h4><p>当前只有一个Mgr节点主机,存在SPOF,添加新的Mgr节点实现高可用</p><p>Ceph Manager守护进程以Active/Standby模式运行，部署其它ceph-mgr守护程序可确保在Active节点或其上的ceph-mgr守护进程故障时，其中的一个Standby实例可以在不中断服务的情况下接管其任务。</p><p>注意:如果所有Mgr节点故障,将集群将无法正常工作</p><p>添加后续的Mgr节点命令格式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mgr create 节点名称</span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新mgr结点上安装mgr软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在管理节点远程在mgr02节点上安装Mgr软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mgr mgr02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mgr02节点手动安装软件</span></span><br><span class="line">[root@mgr02 ~]#apt -y install ceph-mgr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加第二个 Mgr节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mgr create mgr02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：mgr01节点就是主角色节点，mgr02是从角色节点。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭mgr01节点,mgr02节点自动成为active节点</span></span><br><span class="line">[root@mgr01 ~]#poweroff</span><br><span class="line">[root@admin ~]#ceph -s</span><br></pre></td></tr></table></figure><h4 id="扩展mon结点高可用"><a href="#扩展mon结点高可用" class="headerlink" title="扩展mon结点高可用"></a>扩展mon结点高可用</h4><p>当前只有一个mon结点主机，存在SPOF，添加新的mon结点实现高可用</p><p>如果 $n$ 个结点，至少需要保证 $\frac{n}{2}$ 个以上的健康mon结点，ceph集群才能正常使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先在新mon节点安装mon软件</span></span><br><span class="line">ceph-deploy install --mon mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加后续的mon节点命令</span></span><br><span class="line">ceph-deploy mon add mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果add换成destroy，则变成移除mon节点</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新的mon结点安装mon软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在mon02节点上安装mon软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mon02节点手动安装mon软件也可以</span></span><br><span class="line">[root@mon02 ~] apt -y install ceph-mon</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加在mon02节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 添加mon03节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon03</span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 修改ceph配置添加后续的Mon节点信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$vim ceph.conf</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步ceph配置文件到所有ceph节点主机</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf config push admin mon0&#123;1,2,3&#125; mgr0&#123;1,2&#125; store0&#123;1,2,3&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 重新生成初始化配置信息</span></span><br><span class="line">ceph-deploy --overwrite-conf mon create-initial</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：为了避免因为认证方面导致的通信失败，推荐使用 --overwrite-conf 参数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果是在一个现有的环境上部署业务，可以先推送基准配置文件</span></span><br><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/3701960342/image-20231022201652010.png" alt="image-20231022201652010"></p><p><img src="/posts/3701960342/image-20231022201808089.png" alt="image-20231022201808089"></p><h2 id="2-4-升级Ceph集群"><a href="#2-4-升级Ceph集群" class="headerlink" title="2.4 升级Ceph集群"></a>2.4 升级Ceph集群</h2><p>只需要安装升级Ceph安装包，依次升级安装</p><ol><li>monitor</li><li>MGR</li><li>OSD</li><li>MDS</li><li>RADOS网关</li></ol><p>升级完同一类型的守护进程后再升级其他类型，最后重启服务（通常不需要关闭存储服务）</p><ol><li><p>检查Ceph守护进程的当前版本</p><p><code>service ceph status</code></p></li><li><p>升级Ceph源至期望的版本（如firefly）</p><p>只需在 /etc/yum.repos.d/ceph.repo 文件中更新Ceph发行版的名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ceph]</span><br><span class="line">name=Ceph package for $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-noarch]</span><br><span class="line">name=Ceph noarch $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph nosource $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/SRMPS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br></pre></td></tr></table></figure></li><li><p>更新ceph软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update ceph</span><br></pre></td></tr></table></figure></li><li><p>重启monitor守护进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ceph restart mon osd</span><br></pre></td></tr></table></figure></li><li><p>检查monitor,osd守护进程版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ceph status mon osd</span><br></pre></td></tr></table></figure></li><li><p>检查monitor,osd守护进程状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mon osd stat</span><br></pre></td></tr></table></figure></li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/3701960342/" title="2.ceph集群部署">https://amostian.github.io/posts/3701960342/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tags"></i> 分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1168048166/" rel="prev" title="0.vmware安装虚拟机"><i class="fa fa-chevron-left"></i> 0.vmware安装虚拟机</a></div><div class="post-nav-item"><a href="/posts/2711382565/" rel="next" title="0.从存储系统变迁分析Ceph方案">0.从存储系统变迁分析Ceph方案 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-ceph"><span class="nav-text">2.0 ceph</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0-1-%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-text">2.0.1 存储机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0-2-%E5%90%84%E7%BB%84%E4%BB%B6%E7%9A%84%E7%A1%AC%E4%BB%B6%E9%9C%80%E6%B1%82"><span class="nav-text">2.0.2 各组件的硬件需求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU"><span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AD%98"><span class="nav-text">内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A3%81%E7%9B%98"><span class="nav-text">磁盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%9C%80%E6%B1%82"><span class="nav-text">网络需求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MDS%E9%9C%80%E6%B1%82"><span class="nav-text">MDS需求</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-0-3-%E8%A7%84%E5%88%92%E9%9B%86%E7%BE%A4"><span class="nav-text">2.0.3 规划集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6"><span class="nav-text">限制条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7%E7%9A%84%E5%A4%87%E6%B3%A8"><span class="nav-text">关于功能特性的备注</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E5%88%92"><span class="nav-text">服务器规划</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%BD%E6%B1%82%E8%89%AF%E5%A5%BD%E7%9A%84IOPS"><span class="nav-text">追求良好的IOPS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%BD%E6%B1%82%E8%89%AF%E5%A5%BD%E5%90%9E%E5%90%90%E9%87%8F"><span class="nav-text">追求良好吞吐量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%80%E6%B1%82%E4%BD%8E%E6%88%90%E6%9C%AC%E3%80%81%E9%AB%98%E5%AE%B9%E9%87%8F%E5%9C%BA%E6%99%AF"><span class="nav-text">最求低成本、高容量场景</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Ceph-%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="nav-text">2.1 Ceph 手动安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-%E8%8E%B7%E5%8F%96%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">2.1.1 获取软件包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85%E6%BA%90"><span class="nav-text">配置安装源</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-text">2.1.2 安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-%E9%83%A8%E7%BD%B2Ceph%E9%9B%86%E7%BE%A4"><span class="nav-text">2.1.3 部署Ceph集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor%E9%83%A8%E7%BD%B2"><span class="nav-text">monitor部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAOSD"><span class="nav-text">创建OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E9%9B%86%E7%BE%A4"><span class="nav-text">扩展集群</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%9F%BA%E4%BA%8Eceph-deploy%E6%90%AD%E5%BB%BAceph%E9%9B%86%E7%BE%A4"><span class="nav-text">2.3 基于ceph-deploy搭建ceph集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-0-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">2.3.0 环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph%E7%89%88%E6%9C%AC"><span class="nav-text">Ceph版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph%E7%9A%84%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7"><span class="nav-text">Ceph的安装工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E5%88%92"><span class="nav-text">规划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-text">硬件配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-text">网络配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-text">时间同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E4%B8%8ESELinux%E7%AE%A1%E7%90%86"><span class="nav-text">防火墙与SELinux管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E8%8A%82%E7%82%B9%E9%97%B4ssh-%E5%85%8D%E5%AF%86-%E8%AE%A4%E8%AF%81"><span class="nav-text">2.3.1 节点间ssh(免密)认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8D%E5%92%8C%E8%A7%A3%E6%9E%90"><span class="nav-text">主机名和解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8Essh-key%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="nav-text">实现基于ssh key的验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87cephadm%E7%94%A8%E6%88%B7%E5%AE%9E%E7%8E%B0%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">所有主机通过cephadm用户实现免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BA%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%88%9B%E5%BB%BAcephadm%E7%94%A8%E6%88%B7"><span class="nav-text">为所有节点创建cephadm用户</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">跨主机免密登录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E4%B8%BA%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85%E6%BA%90"><span class="nav-text">2.3.2 为所有节点配置安装源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-%E7%AE%A1%E7%90%86%E4%B8%BB%E6%9C%BA%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2ceph%E7%9A%84%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83"><span class="nav-text">2.3.3 管理主机节点部署ceph的安装环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#admin%E8%8A%82%E7%82%B9%E4%B8%BB%E6%9C%BA%E5%AE%89%E8%A3%85ceph-deploy%E5%B7%A5%E5%85%B7"><span class="nav-text">admin节点主机安装ceph-deploy工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2.3.4 创建集群并初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-5-mon%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="nav-text">2.3.5 mon节点安装软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-6-%E9%83%A8%E7%BD%B2mon%E8%8A%82%E7%82%B9%E2%80%94%E2%80%94%E9%9B%86%E7%BE%A4%E8%AE%A4%E8%AF%81%E5%92%8C%E7%AE%A1%E7%90%86"><span class="nav-text">2.2.6 部署mon节点——集群认证和管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96mon%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%B9%B6%E5%88%86%E5%8F%91%E5%AF%86%E9%92%A5"><span class="nav-text">初始化mon节点生成配置信息并分发密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A8%E9%80%81%E5%AF%86%E9%92%A5%E5%AE%9E%E7%8E%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-text">推送密钥实现集群的管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4%E7%9A%84admin%E8%8A%82%E7%82%B9%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="nav-text">部署集群的admin节点实现远程管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-7-%E9%83%A8%E7%BD%B2mgr%E8%8A%82%E7%82%B9"><span class="nav-text">2.2.7 部署mgr节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85mgr%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6"><span class="nav-text">安装mgr相关软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEMgr%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8ceph-mgr%E8%BF%9B%E7%A8%8B"><span class="nav-text">配置Mgr节点启动ceph-mgr进程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-8-%E9%83%A8%E7%BD%B2-OSD-%E5%AD%98%E5%82%A8%E8%8A%82%E7%82%B9"><span class="nav-text">2.2.8 部署 OSD 存储节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85OSD%E5%AD%98%E5%82%A8%E7%BB%93%E7%82%B9%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6"><span class="nav-text">安装OSD存储结点相关软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%8F%AF%E7%94%A8%E7%9A%84osd%E7%A3%81%E7%9B%98"><span class="nav-text">查看所有可用的osd磁盘</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B8%85%E9%99%A4OSD%E7%A3%81%E7%9B%98%E6%95%B0%E6%8D%AE"><span class="nav-text">清除OSD磁盘数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEOSD%E5%AD%98%E5%82%A8%E7%BB%93%E7%82%B9"><span class="nav-text">配置OSD存储结点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%90%8E%E7%BB%AD%E6%89%80%E6%9C%89OSD%E7%BB%93%E7%82%B9%E7%9A%84%E7%A3%81%E7%9B%98"><span class="nav-text">添加后续所有OSD结点的磁盘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-9-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E6%9C%80%E7%BB%88%E7%8A%B6%E6%80%81"><span class="nav-text">2.2.9 查看集群最终状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-10-%E6%89%A9%E5%B1%95%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">2.2.10 扩展高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0mgr%E8%8A%82%E7%82%B9%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">实现mgr节点高可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%B1%95mon%E7%BB%93%E7%82%B9%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">扩展mon结点高可用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%8D%87%E7%BA%A7Ceph%E9%9B%86%E7%BE%A4"><span class="nav-text">2.4 升级Ceph集群</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">375</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">60</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">78</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">959.3k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">40:22</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"live2d-widget-model-hijiki"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1})</script></body></html>