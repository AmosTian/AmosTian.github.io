<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="[TOC]"><meta property="og:type" content="article"><meta property="og:title" content="5.Ceph操作及管理"><meta property="og:url" content="https://amostian.github.io/posts/3125950576/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="[TOC]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231106093326016.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231110001821973.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107213320736.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107214400837.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107174927914.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107162139487.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231108095303503.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20240721155625856.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/70.jpeg"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231111005247522.png"><meta property="article:published_time" content="2024-04-11T02:33:39.139Z"><meta property="article:modified_time" content="2024-10-30T15:03:27.000Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="存储"><meta property="article:tag" content="分布式存储"><meta property="article:tag" content="Ceph"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/3125950576/image-20231106093326016.png"><link rel="canonical" href="https://amostian.github.io/posts/3125950576/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>5.Ceph操作及管理 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">65</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">82</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">218</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/3125950576/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">5.Ceph操作及管理</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2024-04-11 10:33:39" itemprop="dateCreated datePublished" datetime="2024-04-11T10:33:39+08:00">2024-04-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2024-10-30 23:03:27" itemprop="dateModified" datetime="2024-10-30T23:03:27+08:00">2024-10-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/Ceph/" itemprop="url" rel="index"><span itemprop="name">Ceph</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">10.8k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>26 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>[TOC]</p><span id="more"></span><h2 id="4-1-Ceph服务管理"><a href="#4-1-Ceph服务管理" class="headerlink" title="4.1 Ceph服务管理"></a>4.1 Ceph服务管理</h2><h3 id="4-1-1-sysinit"><a href="#4-1-1-sysinit" class="headerlink" title="4.1.1 sysinit"></a>4.1.1 sysinit</h3><h4 id="使用sysinit运行Ceph"><a href="#使用sysinit运行Ceph" class="headerlink" title="使用sysinit运行Ceph"></a>使用sysinit运行Ceph</h4><p>在 RedHat 以及一些旧版的Debian/Ubuntu发行版中，sysinit是一个传统的但被推荐用于管理Ceph守护进程的方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph [options] [command] [dameons]</span><br></pre></td></tr></table></figure><p>[options]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--verbose(-v)	: 用于记录详细日志</span><br><span class="line">--allhosts(-a)	: 在Ceph.conf提及的所有节点上执行命令，否则只在本节点上运行</span><br><span class="line">--conf(-c)		: 使用可选的配置文件</span><br></pre></td></tr></table></figure><p>[command]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">status	: 显示守护进程状态</span><br><span class="line">start	: 启动守护进程</span><br><span class="line">stop	: 停止守护进程</span><br><span class="line">restart	: 重启守护进程</span><br><span class="line">forcestop	: 强制进程关闭 类似与kill -9</span><br></pre></td></tr></table></figure><p>[dameons]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mon</span><br><span class="line">mgr</span><br><span class="line">osd</span><br><span class="line">mds</span><br><span class="line">ceph-radosgw</span><br></pre></td></tr></table></figure><h5 id="根据类型启动守护进程"><a href="#根据类型启动守护进程" class="headerlink" title="根据类型启动守护进程"></a>根据类型启动守护进程</h5><p>若要在本机启动monitor进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph start mon</span><br></pre></td></tr></table></figure><p>若在本地及远程主机上启动所有的monitor进程，添加 <code>-a</code> 选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start mon</span><br></pre></td></tr></table></figure><p>其他类型的进程同理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start osd</span><br><span class="line">/etc/init.d/ceph -a start mgr</span><br><span class="line">/etc/init.d/ceph -a start mds</span><br><span class="line">/etc/init.d/ceph -a start radosgw</span><br></pre></td></tr></table></figure><h5 id="根据类型停止守护进程"><a href="#根据类型停止守护进程" class="headerlink" title="根据类型停止守护进程"></a>根据类型停止守护进程</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a stop mon</span><br><span class="line">/etc/init.d/ceph -a stop osd</span><br><span class="line">/etc/init.d/ceph -a stop mgr</span><br><span class="line">/etc/init.d/ceph -a stop mds</span><br><span class="line">/etc/init.d/ceph -a stop radosgw</span><br></pre></td></tr></table></figure><h5 id="启动及停止所有守护进程"><a href="#启动及停止所有守护进程" class="headerlink" title="启动及停止所有守护进程"></a>启动及停止所有守护进程</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start</span><br><span class="line">/etc/init.d/ceph -a stop</span><br></pre></td></tr></table></figure><h5 id="启动停止指定进程"><a href="#启动停止指定进程" class="headerlink" title="启动停止指定进程"></a>启动停止指定进程</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start osd.0</span><br><span class="line"></span><br><span class="line">/etc/init.d/ceph -a status osd.0</span><br><span class="line"></span><br><span class="line">/etc/init.d/ceph -a stop osd.0</span><br></pre></td></tr></table></figure><h4 id="把Ceph作为服务运行"><a href="#把Ceph作为服务运行" class="headerlink" title="把Ceph作为服务运行"></a>把Ceph作为服务运行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ceph [options] [command] [dameons]</span><br></pre></td></tr></table></figure><p>[options]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--verbose(-v)	: 用于记录详细日志</span><br><span class="line">--allhosts(-a)	: 在Ceph.conf提及的所有节点上执行命令，否则只在本年级上运行</span><br><span class="line">--conf(-c)		: 使用可选的配置文件</span><br></pre></td></tr></table></figure><p>[command]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">status	: 显示守护进程状态</span><br><span class="line">start	: 启动守护进程</span><br><span class="line">stop	: 停止守护进程</span><br><span class="line">restart	: 重启守护进程</span><br><span class="line">forcestop	: 强制进程关闭 类似与kill -9</span><br></pre></td></tr></table></figure><p>[dameons]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mon</span><br><span class="line">mgr</span><br><span class="line">osd</span><br><span class="line">mds</span><br><span class="line">ceph-radosgw</span><br></pre></td></tr></table></figure><h3 id="4-1-2-systemctl"><a href="#4-1-2-systemctl" class="headerlink" title="4.1.2 systemctl"></a>4.1.2 systemctl</h3><p>开启、关闭、重启所有ceph服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl &#123; start | stop | restart&#125; ceph.target </span><br></pre></td></tr></table></figure><p>根据 进程 类型 开启、关闭 和 重启 ceph 服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon 进程</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mon.target </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mgr 进程</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mgr.target </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd 进程</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-osd.target </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rgw 进程</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-radosgw.target </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mds进程</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mds.target </span><br></pre></td></tr></table></figure><p>根据 进程 实例 开启、关闭 和 重启 所有 ceph 服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon 实例</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mon@&#123;mon_instance&#125;.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mgr 实例</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mgr@&#123;hostname&#125;.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd 实例</span></span><br><span class="line">systemctl start ceph-osd@$&#123;osd_id&#125;.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rgw 实例</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-radosgw@rgw.&#123;hostname&#125;.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mds 实例</span></span><br><span class="line">systemctl &#123; start | stop | restart&#125; ceph-mds@&#123;hostname&#125;.service</span><br></pre></td></tr></table></figure><h2 id="4-2-各服务的操作操作"><a href="#4-2-各服务的操作操作" class="headerlink" title="4.2 各服务的操作操作"></a>4.2 各服务的操作操作</h2><h4 id="mon"><a href="#mon" class="headerlink" title="mon"></a>mon</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ceph mon remove node1 # 删除一个mon 节点</span><br><span class="line">ceph-deploy mon destory &#123;hostname [hostname ...]&#125;</span><br><span class="line"></span><br><span class="line">添加mon注意先改配置目录配置文件，再推送到所有节点</span><br><span class="line">ceph mon add node1 node1_ip #添加一个mon节点  </span><br><span class="line">ceph-deploy mon create &#123;host-name [host-name]...&#125; </span><br><span class="line">ceph-deploy --overwrite-conf config push  node1 node2 node3</span><br></pre></td></tr></table></figure><h4 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ceph osd stat #查看osd状态</span><br><span class="line"></span><br><span class="line">ceph osd dump #osd的映射信息</span><br><span class="line"></span><br><span class="line">ceph osd tree#查看osd目录树</span><br><span class="line"></span><br><span class="line">ceph osd down 0   #down掉osd.0节点</span><br><span class="line"></span><br><span class="line">ceph osd rm 0#集群删除一个osd硬盘</span><br><span class="line"></span><br><span class="line">ceph osd crush remove osd.4#删除标记</span><br><span class="line"></span><br><span class="line">ceph osd getmaxosd#查看最大osd个数</span><br><span class="line"></span><br><span class="line">ceph osd setmaxosd 10#设置osd的个数</span><br><span class="line"></span><br><span class="line">ceph osd out osd.3#把一个osd节点逐出集群</span><br><span class="line"></span><br><span class="line">ceph osd in osd.3#把逐出的osd加入集群</span><br><span class="line"></span><br><span class="line">ceph osd pause#暂停osd （暂停后整个集群不再接收数据）</span><br><span class="line"></span><br><span class="line">ceph osd unpause#再次开启osd （开启后再次接收数据）</span><br><span class="line"></span><br><span class="line">ceph osd df # 查看osd的使用信息</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">要定位对象，只需要对象名和存储池名字即可，例如：</span></span><br><span class="line"></span><br><span class="line">ceph osd map &#123;poolname&#125; &#123;object-name&#125;</span><br></pre></td></tr></table></figure><h4 id="PG相关"><a href="#PG相关" class="headerlink" title="PG相关"></a>PG相关</h4><p><strong>查看PG组的映射信息</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看pg状态</span></span><br><span class="line">ceph pg stat</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看pg组的映射信息</span></span><br><span class="line">ceph pg dump </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者</span></span><br><span class="line">ceph pg ls</span><br></pre></td></tr></table></figure><p><strong>查看一个PG的map</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph pg map 7.1a</span><br></pre></td></tr></table></figure><p><strong>获取pg的详细信息</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph pg &#123;pg-id&#125; query</span><br></pre></td></tr></table></figure><p><strong>显示一个集群中的所有的pg统计</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph pg dump --format plain</span><br></pre></td></tr></table></figure><h4 id="mds"><a href="#mds" class="headerlink" title="mds"></a>mds</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ceph mds stat #查看msd状态</span><br><span class="line"></span><br><span class="line">ceph mds dump #msd的映射信息</span><br><span class="line"></span><br><span class="line">ceph mds rm 0 mds.node1#删除一个mds节点</span><br><span class="line"></span><br><span class="line">ceph-deploy mds create &#123;host-name&#125;[:&#123;daemon-name&#125;] [&#123;host-name&#125;[:&#123;daemon-name&#125;] ...]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看连接</span></span><br><span class="line">ceph tell mds.0 client ls  </span><br></pre></td></tr></table></figure><p>多MDS变成单MDS的方法：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bandaoyu/p/16752154.html#ceph%20mds">https://www.cnblogs.com/bandaoyu/p/16752154.html#ceph%20mds</a></p><p>更多MDS运维命令：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/fa96b66f2949">https://www.jianshu.com/p/fa96b66f2949</a></p><h4 id="rbd"><a href="#rbd" class="headerlink" title="rbd"></a>rbd</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bandaoyu/p/16752154.html#%E5%9D%97%E8%AE%BE%E5%A4%87%7Crbd%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4">https://www.cnblogs.com/bandaoyu/p/16752154.html#%E5%9D%97%E8%AE%BE%E5%A4%87%7Crbd%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4</a></p><h2 id="4-3-集群管理"><a href="#4-3-集群管理" class="headerlink" title="4.3 集群管理"></a>4.3 集群管理</h2><h3 id="4-3-1-池操作"><a href="#4-3-1-池操作" class="headerlink" title="4.3.1 池操作"></a>4.3.1 池操作</h3><h4 id="rados集群池查看"><a href="#rados集群池查看" class="headerlink" title="rados集群池查看"></a>rados集群池查看</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -s<span class="comment">#查看集群信息</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出中，“pgmap” 属性包含池数量和一些对象信息</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados lspools <span class="comment"># 查看池列表</span></span></span><br><span class="line">data</span><br><span class="line">rbd</span><br><span class="line">metadata</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados -p metada metadata <span class="built_in">ls</span> <span class="comment">#查看指定池中的对信息</span></span></span><br></pre></td></tr></table></figure><h4 id="查看ceph集群中的pool数量"><a href="#查看ceph集群中的pool数量" class="headerlink" title="查看ceph集群中的pool数量"></a>查看ceph集群中的pool数量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ceph osd lspools </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看集群中的存储池名称</span></span><br><span class="line">ceph osd pool ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看池的的详细信息</span></span><br><span class="line">ceph osd pool ls detail</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看池的IO情况</span></span><br><span class="line">ceph osd pool stats</span><br></pre></td></tr></table></figure><h4 id="池副本数"><a href="#池副本数" class="headerlink" title="池副本数"></a>池副本数</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ceph 池副本数</span></span><br><span class="line">ceph osd dump | grep size</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改已存在池的副本数</span></span><br><span class="line">ceph osd pool set &lt;poolname&gt; size|min_size &lt;val&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改默认的池副本数</span></span><br><span class="line">ceph config set global osd_pool_default_size/min_size &lt;val&gt;</span><br></pre></td></tr></table></figure><p><strong>在ceph集群中创建一个pool</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool create [池名] [PG数] [PGP数]</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这里的100指的是PG组:</span></span><br><span class="line">ceph osd pool create &lt;poolname&gt; &lt;num_pg&gt; &lt;num_pgs&gt;</span><br></pre></td></tr></table></figure><h4 id="删除池"><a href="#删除池" class="headerlink" title="删除池"></a>删除池</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改参数配置项允许删除池</span></span><br><span class="line">ceph config get mon.ceph01 mon_allow_pool_delete</span><br><span class="line">ceph config set global mon_allow_pool_delete true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool delete [池名] [池名] --yes-i-really-really-meant-it</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或</span></span><br><span class="line">vi /etc/ceph/ceph.conf</span><br><span class="line"></span><br><span class="line">[mon]</span><br><span class="line">mon allow pool delete = true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启ceph-mon服务：</span></span><br><span class="line">systemctl restart ceph-mon.target</span><br></pre></td></tr></table></figure><p>删除池时会删除所有该池的所有快照。</p><ul><li>如果为池手动增加了CRUSH规则集，在删除池后，需要手动删除该CRUSH规则集</li><li>如果为池的某个用户创建了一个权限，也需要删除该用户</li></ul><p>显示集群中pool的详细信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示集群中pool的详细信息</span></span><br><span class="line">rados df</span><br></pre></td></tr></table></figure><h4 id="显示集群中pool的详细信息"><a href="#显示集群中pool的详细信息" class="headerlink" title="显示集群中pool的详细信息"></a>显示集群中pool的详细信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool get &lt;pool_name&gt; pg_num</span><br></pre></td></tr></table></figure><h4 id="池属性查看与修改"><a href="#池属性查看与修改" class="headerlink" title="池属性查看与修改"></a>池属性查看与修改</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool get [池名] 属性名</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool <span class="built_in">set</span> [池名] [属性名] [属性值]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取现有PG 和 PGP</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool get data pg_num</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool get data pgp_num</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改PG和PGP</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool <span class="built_in">set</span> data pg_num 256</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool <span class="built_in">set</span> data pgp_num 256</span></span><br><span class="line"></span><br><span class="line">ceph osd pool set &lt;pool_name&gt; target_max_bytes 100000000000000#设置data池的最大存储空间为100T（默认是1T)</span><br><span class="line"></span><br><span class="line">ceph osd pool set &lt;pool_name&gt; size 3  #设置data池的副本数是3</span><br><span class="line"></span><br><span class="line">ceph osd pool set &lt;pool_name&gt; min_size 2 #设置data池能接受写操作的最小副本为2</span><br><span class="line"></span><br><span class="line">ceph osd pool set &lt;pool_name&gt; pg_num 100#设置一个pool的pg数量</span><br><span class="line"></span><br><span class="line">ceph osd pool set &lt;pool_name&gt; pgp_num 100#设置一个pool的pgp数量</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重命名池</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd pool rename [池名] [新池名]</span></span><br></pre></td></tr></table></figure><h3 id="4-3-2-rados操作"><a href="#4-3-2-rados操作" class="headerlink" title="4.3.2 rados操作"></a>4.3.2 rados操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ceph集群中有多少个pool （只是查看pool)</span></span><br><span class="line">rados lspools</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看存储池使用情况：多少个pool,每个pool容量及利用情况</span></span><br><span class="line">rados df   </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个pool，名字:<span class="built_in">test</span></span></span><br><span class="line">rados mkpool test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">testpool 中创建一个对象 testobject</span></span><br><span class="line">rados create testobject -p testpool</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除（<span class="built_in">test</span>存储池的）一个对象object</span> </span><br><span class="line">rados rm test-object-1 -p test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看存储池<span class="built_in">test</span>的对象</span></span><br><span class="line">rados -p test ls  </span><br></pre></td></tr></table></figure><h4 id="rados存储池快照"><a href="#rados存储池快照" class="headerlink" title="rados存储池快照"></a>rados存储池快照</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rados mkpool testpool</span><br><span class="line">rados -p testpool create testobject</span><br><span class="line">rados -p testpool ls</span><br><span class="line">rados -p testpool ls |more</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">存储池快照</span></span><br><span class="line">rados -p testpool mksnap testpoolsnap      </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储池快照查看</span></span><br><span class="line">rados -p testpool lssnap         </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除存储池快照</span></span><br><span class="line">rados -p testpool rmsnap testpoolsnap         </span><br></pre></td></tr></table></figure><h4 id="rados-上传一个文件到存储池"><a href="#rados-上传一个文件到存储池" class="headerlink" title="rados 上传一个文件到存储池"></a>rados 上传一个文件到存储池</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">cfg.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rados -p coolpool put cfg cfg.txt</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rados -p coolpool <span class="built_in">ls</span></span></span><br><span class="line">coolobject</span><br><span class="line">cfg</span><br></pre></td></tr></table></figure><h4 id="池中对象"><a href="#池中对象" class="headerlink" title="池中对象"></a>池中对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将指定文件转换为对象，并放入指定池中</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados -p [池名] put [对象名] [文件路径]</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">从池中移除对象</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados -p [池名] <span class="built_in">rm</span> [对象名]</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看池中对象</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados -p [池名] <span class="built_in">ls</span></span></span><br></pre></td></tr></table></figure><h4 id="池快照"><a href="#池快照" class="headerlink" title="池快照"></a>池快照</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建快照</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados mksnap [快照名] -p [池名]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看快照</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados lssnap-p [快照名]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定池的快照中指定对象</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados -p [池名] listsnaps [对象名]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">快照回滚</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rados rollback -p [池名] [对象名] [快照名]</span></span><br></pre></td></tr></table></figure><h3 id="4-3-3-设备管理"><a href="#4-3-3-设备管理" class="headerlink" title="4.3.3 设备管理"></a>4.3.3 设备管理</h3><p>设备管理允许 Ceph 解决硬件故障。</p><h4 id="设备跟踪"><a href="#设备跟踪" class="headerlink" title="设备跟踪"></a>设备跟踪</h4><p>查看正在使用的存储设备的列表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph device ls</span><br></pre></td></tr></table></figure><p>Ceph 跟踪硬件存储设备（HDD、SSD）以查看哪些设备由哪些守护进程管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph device ls-by-daemon &lt;daemon&gt;  </span><br><span class="line">ceph device ls-by-host &lt;host&gt;</span><br></pre></td></tr></table></figure><p>要检索设备存储的运行状况指标（可以选择特定时间戳），请运行以下形式的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph device get-health-metrics &lt;devid&gt; [sample-timestamp]</span><br></pre></td></tr></table></figure><h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bandaoyu/p/16752154.html#%E7%94%A8%E6%88%B7%E5%92%8C%E8%AE%A4%E8%AF%81">https://www.cnblogs.com/bandaoyu/p/16752154.html#%E7%94%A8%E6%88%B7%E5%92%8C%E8%AE%A4%E8%AF%81</a></p><h3 id="ceph-deploy"><a href="#ceph-deploy" class="headerlink" title="ceph-deploy"></a>ceph-deploy</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bandaoyu/p/16752154.html#ceph-deploy">https://www.cnblogs.com/bandaoyu/p/16752154.html#ceph-deploy</a></p><h2 id="4-2-管理CRUSHMAP"><a href="#4-2-管理CRUSHMAP" class="headerlink" title="4.2 管理CRUSHMAP"></a>4.2 管理CRUSHMAP</h2><h3 id="4-2-1-CRUSHMAP的管理思路"><a href="#4-2-1-CRUSHMAP的管理思路" class="headerlink" title="4.2.1 CRUSHMAP的管理思路"></a>4.2.1 CRUSHMAP的管理思路</h3><blockquote><p>在 ceph-deploy 部署完Ceph后，生成一个默认的 CRUSH map，生产环境中需要定制 CRUSHMAP</p></blockquote><p>对CRUSHMAP的管理思路：</p><ol><li>在任意Monitor上获取集群CRUSHMAP信息</li><li>反编译CRUSHMAP</li><li>自定义修改</li><li>编译CRUSHMAP</li><li>将编译完成的CRUSHMAP注入Ceph集群中，CRUSHMAP会实时生效</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在任一个monitor节点上提取CRUSHMAP</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd getcrushmap -o crushmap.txt <span class="comment">#获取现有CRUSH map , -o 表示编译输出到指定文件</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -d crushmap.txt -o crushmap-decompile <span class="comment">#-d 指定需要反编译的CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim crushmap-decompile <span class="comment"># 编辑CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -c crushmap-decompile -o crushmap-compiled <span class="comment">#重新编译新的CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd setcrushmap -i crushmap-compiled <span class="comment">#将新的CRUSH map应用到Ceph集群中</span></span></span><br></pre></td></tr></table></figure><h3 id="4-2-2-CRUSHMAP定义"><a href="#4-2-2-CRUSHMAP定义" class="headerlink" title="4.2.2 CRUSHMAP定义"></a>4.2.2 CRUSHMAP定义</h3><blockquote><p>CRUSH map：从软件角度表示集群的物理布局</p><p>包含：OSD设备定义、Bucket节点定义、bucket实例定义、root节点定义、查找规则</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># begin crush map</span><br><span class="line">...</span><br><span class="line"># devices // OSD设备</span><br><span class="line">device 0 osd.0 class hdd</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># bucket //bucket节点情况</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># bucket instances //bucket实例</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># rules //可定制的规则</span><br><span class="line">rule replicated_rule</span><br><span class="line"></span><br><span class="line"># end crush map</span><br></pre></td></tr></table></figure><h4 id="设备列表-device"><a href="#设备列表-device" class="headerlink" title="设备列表(device)"></a>设备列表(device)</h4><p>包含所有的OSD的信息，由Ceph自行管理</p><ul><li>在一个Ceph集群中，无论何时新增或移除一个新的OSD，CRUSH map设备列表都会自动更新。</li></ul><p>若自行修改，则需要为OSD标注唯一的设备号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">devices</span></span><br><span class="line">device 0 osd.0</span><br><span class="line">device 1 osd.1</span><br><span class="line">device 2 osd.2</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h4 id="bucket类型-Bucket-types"><a href="#bucket类型-Bucket-types" class="headerlink" title="bucket类型(Bucket types)"></a>bucket类型(Bucket types)</h4><p>定义了CURSH map中会用到的bucket类型，表示OSD在CRUSH分层结构中的位置</p><ul><li>节点bucket(nodes)表示物理位置，叶子bucket(leaves)表示OSD(ceph-osd+底层物理设备)</li></ul><p><img src="/posts/3125950576/image-20231106093326016.png" alt="image-20231106093326016"></p><p>Bucket由物理位置（磁盘、节点、机架(rack)、行(row)、开关、电源电路、房间、数据中心）的分层聚合以及它们被分配的权重（weights）组成。</p><p><img src="/posts/3125950576/image-20231110001821973.png" alt="image-20231110001821973"></p><p>CRUSH map包含很多默认的bucket类型，可以自行添加或删除bucket类型</p><ul><li>添加bucket：输入ID与bucket名称</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">types</span></span><br><span class="line">type 0 osd</span><br><span class="line">type 1 host 	#主机</span><br><span class="line">type 2 chassis 	#机箱</span><br><span class="line">type 3 rack 	#机架</span><br><span class="line">type 4 row 		#行</span><br><span class="line">type 5 pdu		</span><br><span class="line">type 6 pod		</span><br><span class="line">type 7 room 	#房间</span><br><span class="line">type 8 datacenter 	# 数据中心</span><br><span class="line">type 9 region	</span><br><span class="line">type 10 root 	#Ceph集群名</span><br></pre></td></tr></table></figure><h4 id="bucket实例-Bucket-instances"><a href="#bucket实例-Bucket-instances" class="headerlink" title="bucket实例(Bucket instances)"></a>bucket实例(Bucket instances)</h4><blockquote><p>CRUSH map文件的buckets段定义了CRUSH层次结构中的bucket实例。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[bucket-type] [bucket-name] &#123; </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bucket-type必须在types段定义</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bucket name为唯一的名称字符串</span></span><br><span class="line">	id [CRUSHMAP内一个唯一的负整数]</span><br><span class="line">	type [bucket类型]</span><br><span class="line">	weight [相对权重=子节点权重和/与当前bucket总设备容量相关的权重和]</span><br><span class="line">	alg [bucket算法类型：uniform | list | tree | straw]</span><br><span class="line">	hash [默认为0,表示使用CURSH默认算法rjenkins1]</span><br><span class="line">	item [设备名] weight [权重]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如：</p><p><img src="/posts/3125950576/image-20231107213320736.png" alt="image-20231107213320736"></p><p><strong>weight</strong> ：CRUSH算法为每个OSD分配一个权重，OSD权重越大，则物理存储容量越大。权重表示物理设备间的相对差异</p><p><strong>alg</strong> ：</p><ul><li><p>uniform：所有存储设备权重相等。当权重不统一时不能使用。在这种类型的bucket中添加或删除设备时数据都会被重新平衡(reshuffling of data)</p></li><li><p>List：bucket将内容聚合成链表，新设备以头插法的方式插入。数据迁移最少，但移动存储设备会产生很多的数据移动。</p><p><strong>适合很少或从不添加设备的场景，适合小集群，不适合大集群</strong></p></li><li><p>tree：bucket被组织为带权二叉树，每个根节点都知道左右子树的总权重。提供优异的性能和重组效率</p><p>适合大项目，比链表式bucket高效</p></li><li><p>straw：在列表和树型bucket中选择一个设备时，需要计算一定数量的Hash和相对权重。采用分治法，给一些特定设备赋予更高优先级（列表开头的项目）。这会改善副本放置过程的性能，但在bucket被添加、删除或调整权重时产生重组</p><p>straw允许副本公平的放置在所有设备上。</p><p>适合：有设备删除但重组性能也很重要的场景</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 原版straw</span><br><span class="line">max_x = <span class="number">-1</span>;</span><br><span class="line">max_item = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> each item:</span><br><span class="line">	<span class="meta"># x为某节点hash值的后32位，从概率上x是随机的，介于0~65535间</span></span><br><span class="line">    x = random value from <span class="number">0.</span><span class="number">.65535</span></span><br><span class="line">    # 权重因子运算中涉及的scaling factor，不但与本节点的权重因子值有关，还与同级其他节点的权重因子值有关</span><br><span class="line">    x *= scaling factor</span><br><span class="line">    <span class="keyword">if</span> x &gt; max_x:</span><br><span class="line">        max_x = x</span><br><span class="line">        max_item = item</span><br><span class="line"><span class="keyword">return</span> item=</span><br></pre></td></tr></table></figure></li><li><p><a href="../Ceph原理与分析/2.libRADOS.md">straw2</a>：改进的straw算法，减少了集群发生改变后的数据移动量</p><p><strong>在straw2模式下，仅下属子节点的权重值参与运算</strong>，因此一个OSD的权重变化时对整体的影响有限，<strong>权重变化时不会发生大规模数据迁移</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># straw2</span><br><span class="line">max_x = <span class="number">-1</span>;</span><br><span class="line">max_item = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">for</span> each item:</span><br><span class="line">	<span class="meta"># x为某节点hash值的后32位，从概率上x是随机的，介于0~65535间</span></span><br><span class="line">    x = random value from <span class="number">0.</span><span class="number">.65535</span></span><br><span class="line">    # 权重因子运算只与当前节点的权重有关，某一OSD权重值的调整仅影响该OSD节点所在的分支，不会影响其他节点</span><br><span class="line">    x = (<span class="number">2</span>^<span class="number">44</span>*<span class="built_in">log2</span>(x+<span class="number">1</span>)<span class="number">-0x1000000000000</span>)/weight</span><br><span class="line">    <span class="keyword">if</span> x &gt; max_x:</span><br><span class="line">        max_x = x</span><br><span class="line">        max_item = item</span><br><span class="line"><span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></li></ul><h4 id="规则集-rules"><a href="#规则集-rules" class="headerlink" title="规则集(rules)"></a>规则集(rules)</h4><p>定义了如何从池中选择合适的bucket用于数据存放</p><p>要为每个池创建对应的CURSH规则集</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rule &lt;rulename&gt;&#123;//规则名称，Pool基于规则名称与规则关联</span><br><span class="line">	id &lt;ruleset id&gt; #整数值</span><br><span class="line">    # 表示副本策略</span><br><span class="line">    type [replicated | erasure]</span><br><span class="line">    # 多副本策略时，限制副本数量</span><br><span class="line">    min_size &lt;min-size&gt;</span><br><span class="line">    max_size &lt;max-size&gt;</span><br><span class="line">    # 选择一个bucket节点作为寻址起点，从该节点向下查找，default表示root</span><br><span class="line">    step take &lt;bucket-type&gt;</span><br><span class="line">    # 选择故障域模式</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"> - firstn 0表示按照副本数选择OSD</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"> - <span class="built_in">type</span> host 表示故障域为host级，同一PG的目标OSD组成员应位于不同故障域</span></span><br><span class="line">    step [choose | chooseleaf] [firstn | indep] &lt;N&gt; &lt;bucket-type&gt;</span><br><span class="line">    step emit</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231107214400837.png" alt="image-20231107214400837"></p><p><strong>step chooseleaf firstn {num} type {bucket-type}</strong></p><p>选择 {bucket-type} 类型的一组bucket，并从各bucket的子树里选择一个叶子节点。这个数字通常是存储池的副本数</p><ul><li><p>N为池副本数</p><ul><li>num==0，选择N个bucket</li><li>0&lt;num&lt;N,选择num个bucket</li><li>若num&lt;0，则选择 N-num个bucket</li></ul><blockquote><p>num=1，N=3，<code>step choose firstn 1 type row</code> 表示选择一个row类型的bucket</p><p>num=0，N=3，<code>step chooseleaf firstn 0 type row</code> 表示选择3个row类型的bucket，从各row的子树中各选一个叶子节点(osd)</p></blockquote></li></ul><h3 id="4-2-3-向集群导入CRUSHMAP并与池关联"><a href="#4-2-3-向集群导入CRUSHMAP并与池关联" class="headerlink" title="4.2.3 向集群导入CRUSHMAP并与池关联"></a>4.2.3 向集群导入CRUSHMAP并与池关联</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重新编译新的CRUSH map</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -c crushmap-decompile -o crushmap-compiled</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将新的CRUSH map应用到Ceph集群中</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd setcrushmap -i crushmap-compiled</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将新建的CRUSH rule与指定池关联</span></span><br><span class="line">ceph osd pool set PoolName crush_rule &lt;rulename&gt;</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="CRUSH定位"><a href="#CRUSH定位" class="headerlink" title="CRUSH定位"></a>CRUSH定位</h4><p>CRUSH定位就是确定一个OSD在CRUSH map中的位置</p><p><img src="/posts/3125950576/image-20231107174927914.png" alt="image-20231107174927914"></p><h4 id="Ceph中的各种map"><a href="#Ceph中的各种map" class="headerlink" title="Ceph中的各种map"></a>Ceph中的各种map</h4><p>Ceph monitor 负责监控整个集群的健康状态，以及维护集群成员关系状态 (cluster membership state)、对等节点(peer nodes)的状态，和集群的配置信息等。</p><p>Ceph monitor通过维护 cluster map 的主复制来实现这些功能。cluster map 是多个 map 的组合，包括monitor map、OSD map、PG map、CRUSH map 以及MDS map 等。这些map统称为 cluster map。</p><h5 id="monitor-map"><a href="#monitor-map" class="headerlink" title="monitor map"></a>monitor map</h5><ul><li>集群ID</li><li>monitor 节点名称(hostname)、IP地址和端口号等</li><li>monitor map 被创建以来的最新版本号(epoch:每种 map 都维护着其历史版本，每个版本被称为一个epoch，epoch是一个单调递增的序列)，以及最后修改时间等。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mon dump</span><br></pre></td></tr></table></figure><h5 id="OSD-map"><a href="#OSD-map" class="headerlink" title="OSD map"></a>OSD map</h5><ul><li>集群ID</li><li>关于OSD的信息：数目、状态、权重、最近处于clean状态的间隔(last clean interval)及OSD主机等信息</li><li>OSD map创建版本和最后一次修改信息</li><li>与池相关的信息：池名、池ID、类型、副本级别(replication level)和PG</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd dump</span><br></pre></td></tr></table></figure><h5 id="PG-map"><a href="#PG-map" class="headerlink" title="PG map"></a>PG map</h5><ul><li>最新的OSD map版本</li><li>PG的版本、时间戳、容量充满比例（禁止客户端读写）以及容量接近充满（集群发出告警）的比例</li><li>跟踪每个PG ID（poolname.pgID）、对象数、状态时间戳、OSD的up集（所有副本所在OSD的有序列表，第一个为主OSD）、acting集（所有副本所在OSD的列表）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph pg dump</span><br></pre></td></tr></table></figure><h5 id="CRUSH-map"><a href="#CRUSH-map" class="headerlink" title="CRUSH map"></a>CRUSH map</h5><ul><li>集群的存储设备信息、故障域层次结构</li><li>在故障域中定义如何存储数据的规则</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush dump</span><br></pre></td></tr></table></figure><h5 id="MDS-map"><a href="#MDS-map" class="headerlink" title="MDS map"></a>MDS map</h5><ul><li>集群中MDS的数目以及MDS状态</li><li>当前MDS map的版本，创建时间和修改时间</li><li>数据和元数据池的ID</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mds dump</span><br></pre></td></tr></table></figure><h2 id="4-2-将池放置于不同OSD"><a href="#4-2-将池放置于不同OSD" class="headerlink" title="4.2 将池放置于不同OSD"></a>4.2 将池放置于不同OSD</h2><p>实际生产中，需要在多种类型的存储设备上创建存储集群</p><ul><li>基于SSD磁盘可以提供快速存储池</li><li>对于不需要更好的I/O性能的数据，可以在较慢的磁盘驱动器创建存储池</li></ul><p>假设：</p><p>ceph-node1有三个SSD，ceph-node2和ceph-node3分别有三个SATA磁盘</p><p>现要创建一个ssd池和一个sata池，ssd池的主副本都在ceph-node1上，sata池的主副本交叉存放于ceph-node2和ceph-node3上</p><h3 id="4-2-1-获取CURSH-map"><a href="#4-2-1-获取CURSH-map" class="headerlink" title="4.2.1 获取CURSH map"></a>4.2.1 获取CURSH map</h3><p>从任一个monitor节点上提取CRUSH map并反编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd getcrushmap -o crushmap-extract</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -d crushmap-extract -o crushmap-decompiled</span></span><br></pre></td></tr></table></figure><h3 id="4-2-2-编辑CRUSH-map"><a href="#4-2-2-编辑CRUSH-map" class="headerlink" title="4.2.2 编辑CRUSH map"></a>4.2.2 编辑CRUSH map</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim crushmap-decompiled</span></span><br></pre></td></tr></table></figure><p><strong>buckets定义</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">buckets</span></span><br><span class="line">host ceph-node1 &#123;</span><br><span class="line">	id  -2</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rienkins1</span><br><span class="line">	item osd.0 weight 0.010</span><br><span class="line">	item osd.1 weight 0.010</span><br><span class="line">	item osd.2 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">host ceph-node2 &#123;</span><br><span class="line">	id -3</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rjenkins1</span><br><span class="line">	item osd.3 weight 0.010</span><br><span class="line">	item osd.4 weight 0.010</span><br><span class="line">	item osd.5 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">host ceph-node3 &#123;</span><br><span class="line">	id -4</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rjenkins1</span><br><span class="line">	item osd.6 weight 0.010</span><br><span class="line">	item osd.7 weight 0.010</span><br><span class="line">	item osd.8 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">root ssd&#123;</span><br><span class="line">	id -1</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0</span><br><span class="line">	item ceph-node1 weight 0.03</span><br><span class="line">&#125;</span><br><span class="line">root sata&#123;</span><br><span class="line">	id -5</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0</span><br><span class="line">	item ceph-node2 weight 0.03</span><br><span class="line">	item ceph-node3 weight 0.03</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">end buckets</span></span><br></pre></td></tr></table></figure><p><strong>ruleset</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># rules</span></span></span><br><span class="line">rule data &#123;</span><br><span class="line">	ruleset 0</span><br><span class="line">	type replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	maxsize 10</span><br><span class="line">	step take sata #修改，用sata 代替default</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line">rule metadata &#123;</span><br><span class="line">	ruleset 1</span><br><span class="line">	type replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	maxsize 10</span><br><span class="line">	step take sata</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line">rule rbd &#123;</span><br><span class="line">	ruleset 2</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take sata</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>定义规则</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule sata&#123;</span><br><span class="line">	ruleset 3</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take sata #</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit	</span><br><span class="line">&#125;</span><br><span class="line">rule ssd&#123;</span><br><span class="line">	ruleset 4</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take ssd #</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-3-应用CRUSH-map的修改"><a href="#4-2-3-应用CRUSH-map的修改" class="headerlink" title="4.2.3 应用CRUSH map的修改"></a>4.2.3 应用CRUSH map的修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crushtool -c crushmap-decompiled -o crushmap-compiled</span><br><span class="line">ceph osd setcrushmap -i crushmap-compiled</span><br></pre></td></tr></table></figure><p>一旦将新的CRUSH map注入到Ceph集群，集群将会发生数据调整和数据恢复，并且很快进入 <code>HEALTH_OK</code> 状态</p><h3 id="4-2-4-创建池"><a href="#4-2-4-创建池" class="headerlink" title="4.2.4 创建池"></a>4.2.4 创建池</h3><p>一旦集群处于健康状态，创建ssd池和sata池</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create sata 64 64</span><br><span class="line">ceph osd pool create ssd 64 64 </span><br></pre></td></tr></table></figure><p>为池指定规则</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool set sata crush_ruleset 3</span><br><span class="line">ceph osd pool set ssd crush_ruleset 4</span><br><span class="line">ceph osd dump | egrep -i &quot;ssd|sata&quot;</span><br></pre></td></tr></table></figure><h3 id="4-2-5-向指定池写入数据"><a href="#4-2-5-向指定池写入数据" class="headerlink" title="4.2.5 向指定池写入数据"></a>4.2.5 向指定池写入数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建数据文件</span></span><br><span class="line">dd if=/dev/zero of=sata_data bs=1M count=32 conv=fsync</span><br><span class="line">dd if=/dev/zero of=ssd_data bs=1M count=32 conv=fsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将文件放入Ceph集群上指定的池中</span></span><br><span class="line">rados -p ssd put ssd_data_object ssd_data</span><br><span class="line">rados -p ssd put sata_data_objec sata_data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在OSD map中检查池中对象的信息</span></span><br><span class="line">ceph osd map ssd ssd_data_object</span><br><span class="line">ceph osd map sata sata_data_object</span><br></pre></td></tr></table></figure><h2 id="4-3-横向扩展-缩容OSD集群"><a href="#4-3-横向扩展-缩容OSD集群" class="headerlink" title="4.3 横向扩展/缩容OSD集群"></a>4.3 横向扩展/缩容OSD集群</h2><p>存储系统纵向扩展的设计方法：</p><ul><li>向已有设备中添加磁盘，但到达一定程度后，会成为性能、容量以及可管理性方面的瓶颈</li></ul><p>存储系统横向扩展的设计方法：</p><ul><li>向现有的集群添加节点，包括：磁盘、CPU、内存</li></ul><p><img src="/posts/3125950576/image-20231107162139487.png" alt="image-20231107162139487"></p><p>Ceph是一个无缝可扩展的存储系统，允许在线添加monitor和OSD节点到现有集群中，同时不造成服务下线</p><h3 id="4-3-1-向Ceph中添加OSD节点"><a href="#4-3-1-向Ceph中添加OSD节点" class="headerlink" title="4.3.1 向Ceph中添加OSD节点"></a>4.3.1 向Ceph中添加OSD节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前集群osd的详细情况</span></span><br><span class="line">ceph osd tree</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在客户端client上制造ceph集群上的工作负载，模拟在线扩容</span></span><br><span class="line">dd if=/dev/zero of=/mnt/ceph-voll/file1 bs=1M count=10240</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">支持在Ceph集群写入时，对集群osd扩展</span></span><br><span class="line">ceph-deploy disk zap ceph-node4:sdb ceph-node4:sdc ceph-node4:sdd</span><br><span class="line">ceph-deploy osd create ceph-node4:sdb ceph-node4:sdc ceph-node4:sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时可以发现容量在扩充</span></span><br><span class="line">watch ceph status</span><br><span class="line"></span><br><span class="line">ceph osd tree</span><br><span class="line">- osd的up/down状态</span><br><span class="line">- osd的IN/OUT状态，用1,0表示</span><br></pre></td></tr></table></figure><h3 id="4-3-2-从Ceph集群中移除并关闭一个OSD"><a href="#4-3-2-从Ceph集群中移除并关闭一个OSD" class="headerlink" title="4.3.2 从Ceph集群中移除并关闭一个OSD"></a>4.3.2 从Ceph集群中移除并关闭一个OSD</h3><h4 id="移除OSD"><a href="#移除OSD" class="headerlink" title="移除OSD"></a>移除OSD</h4><p>在移除OSD前，需要确保集群有足够的空余空间存放所移除节点上的数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前集群osd的详细情况</span></span><br><span class="line">ceph osd tree</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在客户端client上制造ceph集群上的工作负载，模拟在线缩容</span></span><br><span class="line">dd if=/dev/zero of=/mnt/ceph-voll/file1 bs=1M count=10240</span><br><span class="line"></span><br><span class="line">ceph osd out osd.9</span><br></pre></td></tr></table></figure><p>当把集群中的某个OSD标记为out时，属于它的所有PG中的数据都会被迁移至集群，直至集群再次平衡</p><p>在再平衡过程中，集群会有一段时间处于不健康状态（性能会下降），但对于客户端的数据访问服务都是正常的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph -s #可以看到集群处于恢复模式，同时开放数服务</span><br><span class="line">ceph -w #可以查看集群的恢复操作</span><br></pre></td></tr></table></figure><h4 id="关闭OSD进程"><a href="#关闭OSD进程" class="headerlink" title="关闭OSD进程"></a>关闭OSD进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service ceph stop osd.9</span><br><span class="line">ceph osd tree</span><br></pre></td></tr></table></figure><p>一旦osd进程关闭，则OSD的状态是down和out</p><h4 id="从CRUSH-map中移除OSD"><a href="#从CRUSH-map中移除OSD" class="headerlink" title="从CRUSH map中移除OSD"></a>从CRUSH map中移除OSD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush remove osd.9</span><br></pre></td></tr></table></figure><p>从CRUSH map中移除OSD后，Ceph集群的状态变为健康状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br></pre></td></tr></table></figure><p>这时看到的是osd总数是不变的，但IN和UP状态的OSD是正常的，即OSD数量&gt;IN数量，UP数量</p><h4 id="从OSD-map中移除OSD密钥"><a href="#从OSD-map中移除OSD密钥" class="headerlink" title="从OSD map中移除OSD密钥"></a>从OSD map中移除OSD密钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除osd的验证密钥</span></span><br><span class="line">ceph auth del osd.9</span><br></pre></td></tr></table></figure><p>此时，OSD总数与IN，UP状态的OSD数相等</p><h4 id="从CRUSH-map移除OSD所在节点信息"><a href="#从CRUSH-map移除OSD所在节点信息" class="headerlink" title="从CRUSH map移除OSD所在节点信息"></a>从CRUSH map移除OSD所在节点信息</h4><p>为保持集群清洁，执行一些清理操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush remove ceph-node4</span><br></pre></td></tr></table></figure><h3 id="4-3-3-替换出故障的磁盘设备"><a href="#4-3-3-替换出故障的磁盘设备" class="headerlink" title="4.3.3 替换出故障的磁盘设备"></a>4.3.3 替换出故障的磁盘设备</h3><p>首先检查集群状态<code>ceph -s</code> ，若集群中没有出现故障磁盘，则状态是 <code>HEALTH_OK</code></p><p>一旦OSD下线，则Ceph会将该OSD标记为 down，默认等待时间为300s</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph osd out osd.0 # 手动模拟磁盘故障</span><br><span class="line"></span><br><span class="line">磁盘出现故障后，集群状态会变为非健康状态，会执行恢复与再平衡操作</span><br><span class="line">ceph osd crush rm osd.0 #将故障OSD从CRUSH map中移除</span><br><span class="line">ceph osd del osd.0 # 移除OSD的验证密钥</span><br><span class="line">ceph osd rm osd.0 #从集群中移除OSD</span><br></pre></td></tr></table></figure><p>用新磁盘替换Ceph节点中出现故障的磁盘</p><p>一旦磁盘加入，标识磁盘在操作系统中的设备号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">罗列所有磁盘</span></span><br><span class="line">ceph-deploy disk list ceph-node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般而言，新磁盘无分区，也可以执行分区清理工作</span></span><br><span class="line">ceph-deploy disk zap ceph-node1:sdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基于磁盘创建OSD，Ceph会将其添加为osd.0</span></span><br><span class="line">ceph-deploy --overwrite-conf osd create ceph-node1:sdb</span><br></pre></td></tr></table></figure><h2 id="4-6-身份验证和授权"><a href="#4-6-身份验证和授权" class="headerlink" title="4.6 身份验证和授权"></a>4.6 身份验证和授权</h2><h2 id="4-6-监控集群"><a href="#4-6-监控集群" class="headerlink" title="4.6 监控集群"></a>4.6 监控集群</h2><h3 id="4-6-1-CLI"><a href="#4-6-1-CLI" class="headerlink" title="4.6.1 CLI"></a>4.6.1 CLI</h3><h4 id="监控集群"><a href="#监控集群" class="headerlink" title="监控集群"></a>监控集群</h4><h5 id="集群健康状态"><a href="#集群健康状态" class="headerlink" title="集群健康状态"></a>集群健康状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -health <span class="comment"># 检查集群健康状况</span></span></span><br><span class="line">HEALTH WARN 64 pgs degraded; 1408 pgs stuck unclean; recovery 1/5744 objects degraded (0.017%)</span><br><span class="line">- 集群健康状况：</span><br><span class="line">	HEALTH_OK 健康状态</span><br><span class="line">	HEALTH_WARN 告警状态</span><br><span class="line">- PG数量和PG状态</span><br><span class="line">	clean</span><br><span class="line">	unclean</span><br><span class="line">- 集群对象情况</span><br><span class="line">	表示集群处于 recovery 状态。目前正在处理5744个对象中的一个，整个集群中有0.017%的对象处于degraded状态</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph health detail <span class="comment">#可以得到健康状态的细节</span></span></span><br><span class="line">返回状态不是active和clea的PG，即unclean ，unconsistent，degrated状态的PG都会输出状态细节</span><br></pre></td></tr></table></figure><h5 id="集群事件"><a href="#集群事件" class="headerlink" title="集群事件"></a>集群事件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -w [optionss] <span class="comment">#显示集群状态，包括Info(信息)、WRN(警告)、ERR(错误)</span></span></span><br><span class="line">实时指令，CTRL+C退出</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line">--watch-debug：只查看调试事件</span><br><span class="line">--watch-info：只查看信息事件</span><br><span class="line">--watch-sec：只查看安全事件</span><br><span class="line">--watch-warn：只查看警告事件</span><br><span class="line">--watch-error：只查看错误事件</span><br></pre></td></tr></table></figure><h5 id="集群利用率"><a href="#集群利用率" class="headerlink" title="集群利用率"></a>集群利用率</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph <span class="built_in">df</span> <span class="comment">#输出集群的空间利用率统计信息</span></span></span><br><span class="line">集群总容量、可用容量、已用容量和百分比</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231108095303503.png" alt="image-20231108095303503"></p><h5 id="集群组件状态"><a href="#集群组件状态" class="headerlink" title="集群组件状态"></a>集群组件状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph status</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -s</span></span><br><span class="line"></span><br><span class="line">cluster：表示Ceph唯一的集群ID</span><br><span class="line">health：集群的健康状态</span><br><span class="line">monmap：monitor map的版本、信息、选举信息和mon法定人数</span><br><span class="line">mdsmap：MDS map版本和状态</span><br><span class="line">osdmap：OSD map版本和状态</span><br><span class="line">pgmap：PG map版本，总的PG数，池数和总对象数</span><br><span class="line">		同时展示集群利用率信息(集群总容量、可用容量、已用容量和百分比)</span><br></pre></td></tr></table></figure><h5 id="检查集群密钥"><a href="#检查集群密钥" class="headerlink" title="检查集群密钥"></a>检查集群密钥</h5><p>Ceph工作在一个基于密钥的验证系统上，所有组件之间的交互都经过基于密钥的验证系统</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth list<span class="comment"># 获取所有密钥的列表</span></span></span><br></pre></td></tr></table></figure><h4 id="集群映射信息"><a href="#集群映射信息" class="headerlink" title="集群映射信息"></a>集群映射信息</h4><p>Ceph 客户端和 OSD 需要确认 <strong>集群拓扑</strong> 。由5个map表示 <strong>集群拓扑</strong> ，统称 <strong>集群映射</strong></p><h5 id="监控mon"><a href="#监控mon" class="headerlink" title="监控mon"></a>监控mon</h5><blockquote><p>Ceph 监控器(Mon)守护进程，维护集群映射的主副本。Ceph MON 集群在监控器守护进程出现故障时确保高可用性</p></blockquote><p>monitor只有达到选举的法定人数才能保证集群功能正常</p><h6 id="mon状态"><a href="#mon状态" class="headerlink" title="mon状态"></a>mon状态</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon <span class="built_in">stat</span> <span class="comment">#获取mon集群的状态</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon dump <span class="comment">#获取mon集群的map</span></span></span><br></pre></td></tr></table></figure><h6 id="mon法定人数状态"><a href="#mon法定人数状态" class="headerlink" title="mon法定人数状态"></a>mon法定人数状态</h6><p>Ceph集群中应该有超过 $\frac{1}{2}$ 的可用mon</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph quorum_status --format json-pretty</span></span><br><span class="line"></span><br><span class="line">election_epoch 选举版本号</span><br><span class="line">quorum_leader_name leader主机名 </span><br><span class="line">monmap&#123;	集群的monmap</span><br><span class="line">	epoch #版本号</span><br><span class="line">	fsid #集群ID</span><br><span class="line">	集群创建、修改时间</span><br><span class="line">	mons:[</span><br><span class="line">		&#123;</span><br><span class="line">			rank: #为集群中的mon分配的等级</span><br><span class="line">			name:</span><br><span class="line">			addr:</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon dump <span class="comment">#导出Ceph monitor信息</span></span></span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20240721155625856.png" alt="image-20240721155625856"></p><blockquote><p>集群 fsid、各个监控器的位置、名称、地址和端口，以及映射时间戳</p><ul><li>epoch：监视器映射的时代编号。</li><li>fsid：Ceph集群的唯一标识符。</li><li>last_changed：修改监视器映射的时间。</li><li>created：创建监视器映射的时间。</li><li>min_mon_release：与监视器映射兼容的最小Ceph版本。</li><li>election_strategy：监视器用于选举领导者的策略。Ceph监视器的选举策略有两种：<ul><li>classic：这是默认的选举策略，在此策略下，监视器具有相同的投票权，并根据周期性心跳和消息传递进行通信。如果监视器检测到其他监视器离线，则它们将在一段时间后进入新的领导者选举过程。</li><li>quorum：该策略要求至少三个监视器在线，并从中选择领导者，而不是所有在线监视器都拥有相同的投票权。采用此策略时，如果没有足够的监视器参与选举，则集群将无法正常工作或处于只读状态，直到更多的监视器加入并恢复其大多数选举能力。</li></ul></li><li>0、1、2：集群中每个监视器的排名和IP地址，以及它们的主机名。</li><li>dumped：表示已成功转储指定epoch的监视器映射。</li></ul></blockquote><h5 id="监控mgr"><a href="#监控mgr" class="headerlink" title="监控mgr"></a>监控mgr</h5><p><code>ceph mgr dump</code> ：显示mgr集群信息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;epoch&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_gid&quot;</span><span class="punctuation">:</span> <span class="number">134101</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node02.owpknt&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_addrs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;addrvec&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.192.157:6808&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;nonce&quot;</span><span class="punctuation">:</span> <span class="number">3716212138</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.192.157:6809&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;nonce&quot;</span><span class="punctuation">:</span> <span class="number">3716212138</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.192.157:6809/3716212138&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_change&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-07-21T06:37:22.629953+0000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_mgr_features&quot;</span><span class="punctuation">:</span> <span class="number">4540138320759226367</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;available&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;standbys&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="comment">/*候选模块*/</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gid&quot;</span><span class="punctuation">:</span> <span class="number">134102</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node01.ohhfsw&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mgr_features&quot;</span><span class="punctuation">:</span> <span class="number">4540138320759226367</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;available_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">/*可用模块*/</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;can_run&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;error_string&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;module_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                ...</span><br><span class="line">                <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">             <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="comment">/*已启动的模块*/</span></span><br><span class="line">        <span class="string">&quot;cephadm&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;dashboard&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;iostat&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;nfs&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;restful&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;available_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="comment">/*未被禁用模块*/</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;can_run&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;error_string&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;module_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;option_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;option_info_key&quot;</span><span class="punctuation">:</span> option_info_value、</span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;services&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;dashboard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://192.168.192.157:8443/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;prometheus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.192.157:9283/&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;always_on_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;octopus&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            xxx</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pacific&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            xxx</span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;quincy&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;balancer&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;crash&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;devicehealth&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;orchestrator&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;pg_autoscaler&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;progress&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;rbd_support&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;status&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;telemetry&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;volumes&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;last_failure_osd_epoch&quot;</span><span class="punctuation">:</span> <span class="number">354</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;addrvec&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.192.157:0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;nonce&quot;</span><span class="punctuation">:</span> <span class="number">2310029076</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="监控OSD"><a href="#监控OSD" class="headerlink" title="监控OSD"></a>监控OSD</h5><p>集群越大，OSD越多，磁盘故障可能性很高</p><h6 id="OSD树视图"><a href="#OSD树视图" class="headerlink" title="OSD树视图"></a>OSD树视图</h6><p>OSD的树视图用于查看OSD的in、up、out或down等状态时</p><p>OSD树视图展示了每个节点的所有OSD以及所在CRUSH map中的位置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd tree</span></span><br></pre></td></tr></table></figure><p>展示了Ceph OSD的信息</p><ul><li>权重</li><li>up/down状态</li><li>in/out状态</li></ul><p>输出格式会根据CRUSH map进行规则的格式化</p><h6 id="OSD统计"><a href="#OSD统计" class="headerlink" title="OSD统计"></a>OSD统计</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd dump <span class="comment">#获取Ceph集群和OSD的详细信息</span></span></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">epoch 357	# 版本号</span><br><span class="line">fsid b5b8c73c-3364-11ef-9424-cb387dad71a6 #fsid</span><br><span class="line">created 2024-06-26T02:35:14.490179+0000 # 创建OSD映射的时间</span><br><span class="line">modified 2024-07-21T06:37:26.309666+0000 # 修改OSD映射的时间</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">flags是有关 OSD映射状态的标志位，用于控制Ceph集群中OSD的行为状态、最大程度地提高性能和可靠性</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># sortbitwise：开启了每个对象单独排序，这可以优化存储分配和数据分布。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># recovery_deletes：在恢复过程中删除陈旧的对象，以避免占用空间和影响性能。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># purged_snapdirs：快照目录已从PG日志中删除，以节省空间并提高性能。</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># pglog_hardlimit：PG日志达到硬限制时强制转储日志，以保持一致性并避免性能问题。</span></span></span><br><span class="line">flags sortbitwise,recovery_deletes,purged_snapdirs,pglog_hardlimit </span><br><span class="line">crush_version 20 # crush版本</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数配置</span></span><br><span class="line">full_ratio 0.95 </span><br><span class="line">backfillfull_ratio 0.9</span><br><span class="line">nearfull_ratio 0.85</span><br><span class="line">require_min_compat_client luminous</span><br><span class="line">min_compat_client jewel</span><br><span class="line">require_osd_release quincy</span><br><span class="line">stretch_mode_enabled false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">池信息：池ID、池名、池类型（复制、擦除）、CRUSH规则集和PG规则</span></span><br><span class="line">pool 1 &#x27;.mgr&#x27; replicated size 2 min_size 1 crush_rule 0 object_hash rjenkins pg_num 1 pgp_num 1 autoscale_mode on last_change 350 flags hashpspool stripe_width 0 pg_num_max 32 pg_num_min 1 application mgr</span><br><span class="line">pool 5 &#x27;test&#x27; replicated size 2 min_size 1 crush_rule 0 object_hash rjenkins pg_num 64 pgp_num 64 autoscale_mode on last_change 350 lfor 0/0/279 flags hashpspool stripe_width 0</span><br><span class="line">max_osd 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd信息：ID、状态、权重、OSD健康状态、版本区间</span></span><br><span class="line">osd.0 up   in  weight 1 up_from 356 up_thru 356 down_at 355 last_clean_interval [141,350) [v2:192.168.192.156:6800/2298987942,v1:192.168.192.156:6801/2298987942] [v2:10.168.192.156:6802/2298987942,v1:10.168.192.156:6803/2298987942] exists,up 46e1cb35-7472-4389-8d01-2d98ba4897e0</span><br><span class="line">osd.1 up   in  weight 1 up_from 353 up_thru 356 down_at 352 last_clean_interval [143,350) [v2:192.168.192.157:6800/352260118,v1:192.168.192.157:6801/352260118] [v2:10.168.192.157:6802/352260118,v1:10.168.192.157:6803/352260118] exists,up d6d43523-a098-4cea-bb2d-42df8d102461</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设备信息</span></span><br><span class="line">blocklist 192.168.192.157:6809/378083828 expires 2024-07-22T06:37:22.629710+0000</span><br><span class="line">blocklist 192.168.192.157:6808/378083828 expires 2024-07-22T06:37:22.629710+0000</span><br><span class="line">blocklist 192.168.192.156:0/2939350335 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.156:0/3581074465 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.157:0/328775035 expires 2024-07-22T06:37:22.629710+0000</span><br><span class="line">blocklist 192.168.192.156:6808/865415237 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.157:0/1362332659 expires 2024-07-22T06:37:22.629710+0000</span><br><span class="line">blocklist 192.168.192.156:0/2647831566 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.156:0/1889768730 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.156:6808/3436067180 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.156:6809/3436067180 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.156:0/3199323232 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.156:0/4148433618 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.156:6809/865415237 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.156:0/389666931 expires 2024-07-21T12:24:54.305465+0000</span><br><span class="line">blocklist 192.168.192.157:0/2326070148 expires 2024-07-22T06:37:22.629710+0000</span><br><span class="line">blocklist 192.168.192.156:0/4165816795 expires 2024-07-21T16:49:26.573907+0000</span><br><span class="line">blocklist 192.168.192.157:0/4198367927 expires 2024-07-22T06:37:22.629710+0000</span><br></pre></td></tr></table></figure><p>OSD map版本</p><ul><li>OSD ID</li><li>状态</li><li>权重</li><li>每个OSD的健康状态，版本区间等信息</li></ul><p>池的细节</p><ul><li>池ID</li><li>池名</li><li>池类型（复制、擦除）</li><li>CRUSH 规则集和PG</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd blacklist <span class="built_in">ls</span> <span class="comment">#查看添加到黑名单的客户端</span></span></span><br></pre></td></tr></table></figure><h6 id="CRUSH-map-1"><a href="#CRUSH-map-1" class="headerlink" title="CRUSH map"></a>CRUSH map</h6><p>使用CRUSH map命令行工具比手动查看和修改CRUSH map节省时间</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd tree <span class="comment"># 获取当前集群布局</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush [操作] [被操作组件] [目标组件]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在集群中添加新机架</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack01 rack</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack02 rack</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack03 rack</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动主机到指定机架下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack01</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack02</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack03</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动机架到默认根下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack01 root=default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack02 root=default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack03 root=default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush rule list <span class="comment"># 查看CRUSH map规则集</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush rule dump &lt;crush_rule_name&gt; <span class="comment"># 查看CRUSH map规则集的详细信息</span></span></span><br></pre></td></tr></table></figure><h6 id="OSD-定位指令"><a href="#OSD-定位指令" class="headerlink" title="OSD 定位指令"></a>OSD 定位指令</h6><p>当OSD数量多、CRUSH map层级多时，手动的 OSD 定位会很困难，需要借助CRUSH CLI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd find &lt;OSD_ID&gt;</span><br></pre></td></tr></table></figure><h5 id="监控PG"><a href="#监控PG" class="headerlink" title="监控PG"></a>监控PG</h5><p>OSD 存储PG，PG包含对象</p><p>集群整体的健康状态主要取决于PG。只有PG的状态是 active+clean 状态，集群才会保持为 HELATH_OK 状态</p><h6 id="PG的状态"><a href="#PG的状态" class="headerlink" title="PG的状态"></a>PG的状态</h6><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/36c2d5682d87">分布式存储Ceph之PG状态详解</a></p><blockquote><p>无故障操作</p></blockquote><p><strong>creating</strong> ：通常当存储池正在被创建或增加一个存储池的PG数量时会出现这种状态</p><p><strong>active</strong> ：处于active状态的PG，则主PG及其副本中的数据都处于可被客户端正常IO的状态</p><p><strong>peering（对齐）</strong> ：PG的OSD都处在acting集合中。peer操作：由主OSD发起的，存储PG副本的所有OSD，就PG的所有对象和元数据状态一致。完成后，存储PG的所有OSD都彼此确认当前状态，客户端可以读写</p><p><strong>splitting（分割中）</strong> ：PG正在被分割为多个PG。</p><p>在一个存储池的PG数增加后呈现</p><p><strong>scrubbing（清理中）</strong> ：PG正在做不一致性校验</p><hr><blockquote><p>PG出错</p></blockquote><p><strong>down（失效）</strong> ：包含PG必需数据的一个副本失效了，因此PG失效</p><p><strong>degraded</strong> ：PG中部分对象未达到规定副本数，处于degraded状态的PG仍可被客户端IO</p><ul><li><p>OSD处于down状态，Ceph将分配到该OSD上的所有PG状态变为degraded状态</p><p>在OSD重新up之后，执行peer操作，使得所有处于degraded状态的PG变为clean</p></li><li><p>如果OSD持续处于down状态超过300s后，OSD状态变为out</p><p>Ceph将会从副本中恢复所有处于degraded状态的PG保持复制级</p></li><li><p>Ceph认为对象应该存在于某个PG中，但该对象并不可用，此时将该PG状态置为degraded并从其副本中恢复PG</p></li></ul><p><strong>remapped</strong> ：当PG的acting集合变化时，会触发数据迁移。数据从老的acting集合OSD向新的acting集合OSD转移</p><ul><li>在迁移过程中，仍然使用老acting集合中的OSD为客户端提供读写请求</li><li>迁移完成，才会启用新acting 集合中的OSD为客户端提供读写请求</li></ul><p><strong>inconsistent（不一致）</strong> ：PG的副本出现了不一致。如：对象大小不正确，recovery后某副本出现了对象丢失</p><p><strong>incomplete(不完整)</strong> ：PG日志缺失一个时间段的数据。当包含PG所需信息的某OSD失效或不可用，会出现这种情况</p><p><strong>stable</strong> ：如果PG acting集合中的主副本OSD未向monitor报告统计结果 或 其他OSD报告主副本OSD状态变为down，则monitor将这些PG处于stable状态。</p><p>通常Peering结束前PG处于该状态</p><p><strong>repair（修复中）</strong> ：PG正在被检查，被发现的任何不一致都被尽可能地修复</p><hr><blockquote><p>OSD异常处理</p></blockquote><p><strong>backfilling</strong> ：新的OSD加入集群时，Ceph通过移动其他OSD上的一些PG到新OSD上保持负载均衡。</p><ul><li>在后台平滑地执行backfill，确保集群不会超载</li><li>backfill完成，OSD可以参与到客户端的IO操作</li></ul><p><strong>backfill-wait</strong> ：PG正在等待回填操作</p><p><strong>recovering</strong> ：当一个OSD处于 down 状态，其PG中的内容会落后与放置在其他OSD上的PG副本。一旦该OSD处于up状态，Ceph会针对这些PG启动恢复操作，使得该PG中的数据与其他PG副本保持一致</p><p><strong>relay（重做）</strong> ：OSD崩后PG正在等待客户端重新发起请求</p><p><strong>clean</strong> ：主OSD和顺位OSD已经彼此确认；所有PG都在正确位置上，未发生偏移；所有都按副本级复制完成</p><p><img src="/posts/3125950576/70.jpeg" alt="img"></p><h6 id="监控PG-1"><a href="#监控PG-1" class="headerlink" title="监控PG"></a>监控PG</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg <span class="built_in">stat</span> <span class="comment">#获取PG状态</span></span></span><br><span class="line"></span><br><span class="line">vNNNN: X pgs: Y active+clean; R bytes data, u MB used , F GB/T GB aval</span><br></pre></td></tr></table></figure><ul><li>vNNNN：PG map版本号</li><li>X：总PG数</li><li>Y：当前状态度的PG树</li><li>R：当前集群处处的裸数据容量</li><li>U：当前集群已经存储的包含副本的真是数据容量</li><li>F：剩余容量</li><li>T：总容量</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg dump <span class="comment"># 获取PG列表</span></span></span><br><span class="line">PG_STAT  OBJECTS  MISSING_ON_PRIMARY  DEGRADED  MISPLACED  UNFOUND  BYTES  OMAP_BYTES*  OMAP_KEYS*  LOG  DISK_LOG  STATE         STATE_STAMP                      VERSION  REPORTED  UP       UP_PRIMARY  ACTING   ACTING_PRIMARY  LAST_SCRUB  SCRUB_STAMP                      LAST_DEEP_SCRUB  DEEP_SCRUB_STAMP                 SNAPTRIMQ_LEN</span><br><span class="line">4.19           0                   0         0          0        0      0            0           0    0         0  active+clean  2023-04-30T05:50:02.431578+0000      0&#x27;0    108:12  [7,2,5]           7  [7,2,5]               7         0&#x27;0  2023-04-30T05:50:01.330091+0000              0&#x27;0  2023-04-30T05:50:01.330091+0000              0</span><br><span class="line">2.1f           0                   0         0          0        0      0            0           0    0         0  active+clean  2023-04-30T05:49:47.320452+0000      0&#x27;0    108:17  [0,3,8]           0  [0,3,8]               0         0&#x27;0  2023-04-30T05:49:46.202749+0000              0&#x27;0  2023-04-30T05:49:46.202749+0000              0</span><br><span class="line">3.1e           0                   0         0          0        0      0            0           0    0         0  active+clean  2023-04-30T05:49:49.349973+0000      0&#x27;0    108:15  [2,6,3]           2  [2,6,3]               2         0&#x27;0  2023-04-30T05:49:48.270032+0000              0&#x27;0  2023-04-30T05:49:48.270032+0000              0</span><br><span class="line">4.18           0                   0         0          0        0      0            0           0    0         0  active+clean  2023-04-30T05:50:02.449439+0000      0&#x27;0    108:12  [3,1,6]           3  [3,1,6]               3         0&#x27;0  2023-04-30T05:50:01.330091+0000              0&#x27;0  2023-04-30T05:50:01.330091+0000              0</span><br></pre></td></tr></table></figure><ul><li><p>PG_STAT: PG 的状态，表示 PG 在当前时间点内的活动情况和健康状况。</p><p>第一部分是十六进制的 OSD 编号，第二部分是十六进制的 epoch 号</p></li><li><p>OBJECTS: PG 中对象数量。</p></li><li><p>MISSING_ON_PRIMARY: 在 primary OSD 上缺少的对象数量。</p></li><li><p>DEGRADED: 在副本 OSD 上损坏或不可用的对象数量。</p></li><li><p>MISPLACED: 在非预期 OSD 上的对象数量。</p></li><li><p>UNFOUND: 未找到的对象数量。</p></li><li><p>BYTES: PG 中对象的总字节数。</p></li><li><p>OMAP_BYTES: PG 中对象元数据的总字节数。</p></li><li><p>OMAP_KEYS: PG 中对象元数据键值对的总数。</p></li><li><p>LOG: 最近操作日志的序列号范围。</p></li><li><p>DISK_LOG: 存储在磁盘上的日志序列号范围。</p></li><li><p>STATE: PG 的状态，例如“active+clean”。</p></li><li><p>STATE_STAMP: PG 最后转换到当前状态的时间戳。</p></li><li><p>VERSION: PG 的版本。</p></li><li><p>REPORTED: 汇报 PG 状态的 OSD 的编号。</p></li><li><p>UP: 处于活动状态的 OSD 编号列表。</p></li><li><p>UP_PRIMARY: 作为主 OSD 进行同步的 OSD 编号。</p></li><li><p>ACTING: 负责读写请求的 OSD 编号列表。</p></li><li><p>ACTING_PRIMARY: 正在执行同步操作的 OSD 编号。</p></li><li><p>LAST_SCRUB: 上次 scrub 的时间戳和结果。</p></li><li><p>SCRUB_STAMP: 上次 scrub 的结束时间戳。</p></li><li><p>LAST_DEEP_SCRUB: 上次 deep scrub 的时间戳和结果。</p></li><li><p>SNAPTRIMQ_LEN: PgSnapTrimq 中等待处理的数量。</p></li><li><p>DEEP_SCRUB_STAMP: 上次 deep scrub 的结束时间戳。</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg &lt;PG_ID&gt; query <span class="comment">#查询一个PG的详细信息</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg 2.7d query</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg dump_stuck &lt;PG状态&gt; <span class="comment"># 获取处于stuck 状态的PG列表</span></span></span><br></pre></td></tr></table></figure><h5 id="监控MDS"><a href="#监控MDS" class="headerlink" title="监控MDS"></a>监控MDS</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mds <span class="built_in">stat</span></span></span><br><span class="line">ACTIVE、INACTIVE、UP、DOWN</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph msd dump</span></span><br><span class="line">e1 # 当前文件系统的 epoch 号</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件系统是否启用了多 MDS 支持并且曾经启用过</span></span><br><span class="line">enable_multiple, ever_enabled_multiple: 1,1 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件系统支持的兼容性特性:compat 表示 CephFS 要求支持的最低版本，而 rocompat 和 incompat 分别表示与只读客户端和不兼容客户端相关的特性。</span></span><br><span class="line">compat: compat=&#123;&#125;,rocompat=&#123;&#125;,incompat=&#123;1=base v0.20,2=client writeable ranges,3=default file layouts on dirs,4=dir inode in separate object,5=mds uses versioned encoding,6=dirfrag is stored in omap,8=no anchor table,9=file layout v2,10=snaprealm v2&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定将 legacy 客户端分配给文件系统的 ID，但当前没有 legacy 客户端连接到该文件系统。</span></span><br><span class="line">legacy client fscid: -1</span><br><span class="line"></span><br><span class="line">No filesystems configured</span><br><span class="line">dumped fsmap epoch 1</span><br></pre></td></tr></table></figure><h3 id="4-6-2-REST-API"><a href="#4-6-2-REST-API" class="headerlink" title="4.6.2 REST API"></a>4.6.2 REST API</h3><p>Ceph自带REST API，允许用户通过编程的方式对集群进行管理，使其可以运行为一个WSGI应用或独立的服务器，默认监听5000端口</p><p>提供了一个类似Ceph命令的通过HTTP访问的接口，以HTTP GET和PUT请求的方式提交，结果以 json、XML、txt的格式返回</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.在Ceph集群中，创建一个用户client.restapi，授予它适当的 mon、osd 和mds权限:</span></span><br><span class="line">ceph auth get-or-create client.restapi mds &#x27;allow&#x27; osd &#x27;allow *&#x27; mon&#x27;allow*&#x27; &gt; /etc/ceph/ceph.client.restapi.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 修改ceph.conf文件</span></span><br><span class="line">[client.restapi]</span><br><span class="line">log file=/var/log/ceph/ceph.restapi.log</span><br><span class="line">keyring=/etc/ceph/ceph.client.restapi.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 执行以下命令来启动ceph-rest-api,并将它作为一个在后台独立的 Web 服务器来运行</span></span><br><span class="line">nohup ceph-rest-api &gt; /var/log/ceph-rest-api &amp;&gt; /var/log/cephrest-api-error.log&amp;</span><br></pre></td></tr></table></figure><ul><li>也可以不用 nohup来运行 ceph-rest-api，但会抑制后台运行</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. ceph-rest-api将会在 0.0.0.0:5000上监听，也可以用curl访问ceph-rest-api来查询集群的健康状态:</span></span><br><span class="line">curl localhost:5000/api/v0.1/health</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 类似地，通过rest-api检查osd和mon的状态</span></span><br><span class="line">curl localhost:5000/api/v0.1/osd/stat</span><br><span class="line">curl localhost:5000/api/v0.1/mon/stat</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231111005247522.png" alt="image-20231111005247522"></p><p>ceph-rest-api 支持大多数 Ceph CLI。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ceph-rest-api的可用命令</span></span><br><span class="line">curl localhost:5000/api/v0.1</span><br></pre></td></tr></table></figure><p>以HTML形式返回，用Web浏览器访问访问更易读</p><p>要将它运行在生产环境中，最好部署多个它的实例，每个实例都是一个封装在 Web 服务器中的 WSGI应用，前端再使用一个负载均衡器。</p><h3 id="4-6-3-开源管理控制平台"><a href="#4-6-3-开源管理控制平台" class="headerlink" title="4.6.3 开源管理控制平台"></a>4.6.3 开源管理控制平台</h3><h4 id="Kraken"><a href="#Kraken" class="headerlink" title="Kraken"></a>Kraken</h4><p>Python，用来统计信息和监控Cepgh集群</p><ul><li>集群数据量</li><li>mon状态</li><li>OSD状态</li><li>PG状态</li><li>支持多个mon</li><li>变更OSD操作</li><li>动态CRUSH map配置</li><li>Ceph身份验证</li><li>池操作</li><li>块设备管理</li><li>CPU、内存等系统指标</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 安装karen依赖，如python-pip、screen和Firefox</span></span><br><span class="line">yum install python-pip screen firefox</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装开发库</span></span><br><span class="line">yum install gcc python-deve1 libxm12-devel.x86_64 libxslt-devel.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 为karen新建目录</span></span><br><span class="line">mkdir /karen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 从github复制karen存储不哭</span></span><br><span class="line">git clone /karendash/karendash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 使用Python包管理器安装karen所需的包，如Django、python-cephclient、djangorestframework、markdown、humanize</span></span><br><span class="line">cd /karendash</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 执行api.sh和djanfo.sh，分别调用ceph-rest-api和django python仪表盘</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这些脚本会在独立的screen环境中执行</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">CTRL+D分离当前screen会话并将其转移到后台</span></span><br><span class="line">cp ../krakendash/contrib/*.sh</span><br><span class="line">./api.sh</span><br><span class="line">./django.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 检查screen会话</span></span><br><span class="line">ps -ef | grep -i screen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 浏览器打开 localhost:8000</span></span><br></pre></td></tr></table></figure><h4 id="Ceph-dash工具"><a href="#Ceph-dash工具" class="headerlink" title="Ceph-dash工具"></a>Ceph-dash工具</h4><p>用尽可能简单的方法通过RESTful JSON API及Web GUI来提供监控Ceph集群</p><p>python wsgi的应用程序，通过librados直接与集群通信</p><ul><li>整体集群状态及详细的问题描述</li><li>支持多个mon、支持每个mon的状态</li><li>OSD状态包含处于in、out和不健康的OSD数</li><li>可视化存储容量图</li><li>实时吞吐量，包括读写速度和每秒操作数</li><li>可视化PG状态图</li><li>集群恢复状态</li></ul><p>在拥有wsgi的Web服务器(Apache、nginx)上部署这个应用程序</p><p>Ceph-dash访问Ceph集群是只读的，不需要任何写权限，通过Python的RADOS类来使用cepgh status命令，通过REST API或WebGUI导出输出结果</p><h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ceph必须安装在有Ceph访问权限的节点上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 新建目录，从github上复制存储库</span></span><br><span class="line">mkdir /ceph-dash</span><br><span class="line">git clone /Crapworks/ceph-dash.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装python-pip</span></span><br><span class="line">yum install python-pip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 安装jinja2</span></span><br><span class="line">easy_install Jinja2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 启动Ceph-dash GUI</span></span><br><span class="line">./ceph-dash.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 访问/localhost:5000</span></span><br></pre></td></tr></table></figure><h4 id="Calamari"><a href="#Calamari" class="headerlink" title="Calamari"></a>Calamari</h4><h3 id="4-6-4-日志"><a href="#4-6-4-日志" class="headerlink" title="4.6.4 日志"></a>4.6.4 日志</h3><p>默认情况下降日志存储在 /var/log/ceph目录下</p><p>[企业级]#13故障定位方法$13.1获取集群状态</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/3125950576/" title="5.Ceph操作及管理">https://amostian.github.io/posts/3125950576/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 存储</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a> <a href="/tags/Ceph/" rel="tag"><i class="fa fa-tags"></i> Ceph</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/2699312118/" rel="prev" title="9.动手学深度学习-经典循环神经网络"><i class="fa fa-chevron-left"></i> 9.动手学深度学习-经典循环神经网络</a></div><div class="post-nav-item"><a href="/posts/3545351090/" rel="next" title="10. Transformer 原理">10. Transformer 原理 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Ceph%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-text">4.1 Ceph服务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-sysinit"><span class="nav-text">4.1.1 sysinit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8sysinit%E8%BF%90%E8%A1%8CCeph"><span class="nav-text">使用sysinit运行Ceph</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%90%AF%E5%8A%A8%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">根据类型启动守护进程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%81%9C%E6%AD%A2%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">根据类型停止守护进程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">启动及停止所有守护进程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%81%9C%E6%AD%A2%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B"><span class="nav-text">启动停止指定进程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8A%8ACeph%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E8%BF%90%E8%A1%8C"><span class="nav-text">把Ceph作为服务运行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-systemctl"><span class="nav-text">4.1.2 systemctl</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%90%84%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%93%8D%E4%BD%9C%E6%93%8D%E4%BD%9C"><span class="nav-text">4.2 各服务的操作操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mon"><span class="nav-text">mon</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OSD"><span class="nav-text">OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PG%E7%9B%B8%E5%85%B3"><span class="nav-text">PG相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mds"><span class="nav-text">mds</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rbd"><span class="nav-text">rbd</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="nav-text">4.3 集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E6%B1%A0%E6%93%8D%E4%BD%9C"><span class="nav-text">4.3.1 池操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rados%E9%9B%86%E7%BE%A4%E6%B1%A0%E6%9F%A5%E7%9C%8B"><span class="nav-text">rados集群池查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bceph%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84pool%E6%95%B0%E9%87%8F"><span class="nav-text">查看ceph集群中的pool数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A0%E5%89%AF%E6%9C%AC%E6%95%B0"><span class="nav-text">池副本数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%B1%A0"><span class="nav-text">删除池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E9%9B%86%E7%BE%A4%E4%B8%ADpool%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="nav-text">显示集群中pool的详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A0%E5%B1%9E%E6%80%A7%E6%9F%A5%E7%9C%8B%E4%B8%8E%E4%BF%AE%E6%94%B9"><span class="nav-text">池属性查看与修改</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-rados%E6%93%8D%E4%BD%9C"><span class="nav-text">4.3.2 rados操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rados%E5%AD%98%E5%82%A8%E6%B1%A0%E5%BF%AB%E7%85%A7"><span class="nav-text">rados存储池快照</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rados-%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E5%88%B0%E5%AD%98%E5%82%A8%E6%B1%A0"><span class="nav-text">rados 上传一个文件到存储池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A0%E4%B8%AD%E5%AF%B9%E8%B1%A1"><span class="nav-text">池中对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B1%A0%E5%BF%AB%E7%85%A7"><span class="nav-text">池快照</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86"><span class="nav-text">4.3.3 设备管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E8%B7%9F%E8%B8%AA"><span class="nav-text">设备跟踪</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="nav-text">用户认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-deploy"><span class="nav-text">ceph-deploy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E7%AE%A1%E7%90%86CRUSHMAP"><span class="nav-text">4.2 管理CRUSHMAP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-CRUSHMAP%E7%9A%84%E7%AE%A1%E7%90%86%E6%80%9D%E8%B7%AF"><span class="nav-text">4.2.1 CRUSHMAP的管理思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-CRUSHMAP%E5%AE%9A%E4%B9%89"><span class="nav-text">4.2.2 CRUSHMAP定义</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E5%88%97%E8%A1%A8-device"><span class="nav-text">设备列表(device)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bucket%E7%B1%BB%E5%9E%8B-Bucket-types"><span class="nav-text">bucket类型(Bucket types)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bucket%E5%AE%9E%E4%BE%8B-Bucket-instances"><span class="nav-text">bucket实例(Bucket instances)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E9%9B%86-rules"><span class="nav-text">规则集(rules)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%90%91%E9%9B%86%E7%BE%A4%E5%AF%BC%E5%85%A5CRUSHMAP%E5%B9%B6%E4%B8%8E%E6%B1%A0%E5%85%B3%E8%81%94"><span class="nav-text">4.2.3 向集群导入CRUSHMAP并与池关联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CRUSH%E5%AE%9A%E4%BD%8D"><span class="nav-text">CRUSH定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8Dmap"><span class="nav-text">Ceph中的各种map</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#monitor-map"><span class="nav-text">monitor map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OSD-map"><span class="nav-text">OSD map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PG-map"><span class="nav-text">PG map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CRUSH-map"><span class="nav-text">CRUSH map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MDS-map"><span class="nav-text">MDS map</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%B0%86%E6%B1%A0%E6%94%BE%E7%BD%AE%E4%BA%8E%E4%B8%8D%E5%90%8COSD"><span class="nav-text">4.2 将池放置于不同OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-%E8%8E%B7%E5%8F%96CURSH-map"><span class="nav-text">4.2.1 获取CURSH map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E7%BC%96%E8%BE%91CRUSH-map"><span class="nav-text">4.2.2 编辑CRUSH map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%BA%94%E7%94%A8CRUSH-map%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-text">4.2.3 应用CRUSH map的修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-4-%E5%88%9B%E5%BB%BA%E6%B1%A0"><span class="nav-text">4.2.4 创建池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-5-%E5%90%91%E6%8C%87%E5%AE%9A%E6%B1%A0%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-text">4.2.5 向指定池写入数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E6%A8%AA%E5%90%91%E6%89%A9%E5%B1%95-%E7%BC%A9%E5%AE%B9OSD%E9%9B%86%E7%BE%A4"><span class="nav-text">4.3 横向扩展&#x2F;缩容OSD集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E5%90%91Ceph%E4%B8%AD%E6%B7%BB%E5%8A%A0OSD%E8%8A%82%E7%82%B9"><span class="nav-text">4.3.1 向Ceph中添加OSD节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E4%BB%8ECeph%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%A7%BB%E9%99%A4%E5%B9%B6%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AAOSD"><span class="nav-text">4.3.2 从Ceph集群中移除并关闭一个OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4OSD"><span class="nav-text">移除OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%ADOSD%E8%BF%9B%E7%A8%8B"><span class="nav-text">关闭OSD进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8ECRUSH-map%E4%B8%AD%E7%A7%BB%E9%99%A4OSD"><span class="nav-text">从CRUSH map中移除OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8EOSD-map%E4%B8%AD%E7%A7%BB%E9%99%A4OSD%E5%AF%86%E9%92%A5"><span class="nav-text">从OSD map中移除OSD密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8ECRUSH-map%E7%A7%BB%E9%99%A4OSD%E6%89%80%E5%9C%A8%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="nav-text">从CRUSH map移除OSD所在节点信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E6%9B%BF%E6%8D%A2%E5%87%BA%E6%95%85%E9%9A%9C%E7%9A%84%E7%A3%81%E7%9B%98%E8%AE%BE%E5%A4%87"><span class="nav-text">4.3.3 替换出故障的磁盘设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="nav-text">4.6 身份验证和授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4"><span class="nav-text">4.6 监控集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-1-CLI"><span class="nav-text">4.6.1 CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4"><span class="nav-text">监控集群</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-text">集群健康状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E4%BA%8B%E4%BB%B6"><span class="nav-text">集群事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%88%A9%E7%94%A8%E7%8E%87"><span class="nav-text">集群利用率</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%84%E4%BB%B6%E7%8A%B6%E6%80%81"><span class="nav-text">集群组件状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E5%AF%86%E9%92%A5"><span class="nav-text">检查集群密钥</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%98%A0%E5%B0%84%E4%BF%A1%E6%81%AF"><span class="nav-text">集群映射信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7mon"><span class="nav-text">监控mon</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#mon%E7%8A%B6%E6%80%81"><span class="nav-text">mon状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mon%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E7%8A%B6%E6%80%81"><span class="nav-text">mon法定人数状态</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7mgr"><span class="nav-text">监控mgr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7OSD"><span class="nav-text">监控OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#OSD%E6%A0%91%E8%A7%86%E5%9B%BE"><span class="nav-text">OSD树视图</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#OSD%E7%BB%9F%E8%AE%A1"><span class="nav-text">OSD统计</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#CRUSH-map-1"><span class="nav-text">CRUSH map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#OSD-%E5%AE%9A%E4%BD%8D%E6%8C%87%E4%BB%A4"><span class="nav-text">OSD 定位指令</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7PG"><span class="nav-text">监控PG</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#PG%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-text">PG的状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7PG-1"><span class="nav-text">监控PG</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7MDS"><span class="nav-text">监控MDS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-2-REST-API"><span class="nav-text">4.6.2 REST API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-3-%E5%BC%80%E6%BA%90%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%B9%B3%E5%8F%B0"><span class="nav-text">4.6.3 开源管理控制平台</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kraken"><span class="nav-text">Kraken</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph-dash%E5%B7%A5%E5%85%B7"><span class="nav-text">Ceph-dash工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Calamari"><span class="nav-text">Calamari</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-4-%E6%97%A5%E5%BF%97"><span class="nav-text">4.6.4 日志</span></a></li></ol></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">218</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">65</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">82</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">1186.8k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">48:09</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"live2d-widget-model-hijiki"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1})</script></body></html>