<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="[TOC]"><meta property="og:type" content="article"><meta property="og:title" content="5.Ceph操作及管理"><meta property="og:url" content="https://amostian.github.io/posts/3125950576/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="[TOC]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231106093326016.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231110001821973.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107213320736.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107214400837.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107174927914.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231107162139487.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231108095303503.png"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/70.jpeg"><meta property="og:image" content="https://amostian.github.io/posts/3125950576/image-20231111005247522.png"><meta property="article:published_time" content="2024-04-11T02:33:39.139Z"><meta property="article:modified_time" content="2024-04-11T02:30:40.667Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="分布式"><meta property="article:tag" content="分布式存储"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/3125950576/image-20231106093326016.png"><link rel="canonical" href="https://amostian.github.io/posts/3125950576/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>5.Ceph操作及管理 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">60</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">375</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/3125950576/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">5.Ceph操作及管理</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2024-04-11 10:33:39 / 修改时间 10:30:40" itemprop="dateCreated datePublished" datetime="2024-04-11T10:33:39+08:00">2024-04-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">6.7k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>[TOC]</p><span id="more"></span><h2 id="4-1-Ceph服务管理"><a href="#4-1-Ceph服务管理" class="headerlink" title="4.1 Ceph服务管理"></a>4.1 Ceph服务管理</h2><h3 id="4-1-1-使用sysinit运行Ceph"><a href="#4-1-1-使用sysinit运行Ceph" class="headerlink" title="4.1.1 使用sysinit运行Ceph"></a>4.1.1 使用sysinit运行Ceph</h3><p>在 RedHat 以及一些旧版的Debian/Ubuntu发行版中，sysinit是一个传统的但被推荐用于管理Ceph守护进程的方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph [options] [command] [dameons]</span><br></pre></td></tr></table></figure><p>[options]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--verbose(-v)	: 用于记录详细日志</span><br><span class="line">--allhosts(-a)	: 在Ceph.conf提及的所有节点上执行命令，否则只在本节点上运行</span><br><span class="line">--conf(-c)		: 使用可选的配置文件</span><br></pre></td></tr></table></figure><p>[command]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">status	: 显示守护进程状态</span><br><span class="line">start	: 启动守护进程</span><br><span class="line">stop	: 停止守护进程</span><br><span class="line">restart	: 重启守护进程</span><br><span class="line">forcestop	: 强制进程关闭 类似与kill -9</span><br></pre></td></tr></table></figure><p>[dameons]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mon</span><br><span class="line">mgr</span><br><span class="line">osd</span><br><span class="line">mds</span><br><span class="line">ceph-radosgw</span><br></pre></td></tr></table></figure><h4 id="根据类型启动守护进程"><a href="#根据类型启动守护进程" class="headerlink" title="根据类型启动守护进程"></a>根据类型启动守护进程</h4><p>若要在本机启动monitor进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph start mon</span><br></pre></td></tr></table></figure><p>若在本地及远程主机上启动所有的monitor进程，添加 <code>-a</code> 选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start mon</span><br></pre></td></tr></table></figure><p>其他类型的进程同理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start osd</span><br><span class="line">/etc/init.d/ceph -a start mgr</span><br><span class="line">/etc/init.d/ceph -a start mds</span><br><span class="line">/etc/init.d/ceph -a start radosgw</span><br></pre></td></tr></table></figure><h4 id="根据类型停止守护进程"><a href="#根据类型停止守护进程" class="headerlink" title="根据类型停止守护进程"></a>根据类型停止守护进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a stop mon</span><br><span class="line">/etc/init.d/ceph -a stop osd</span><br><span class="line">/etc/init.d/ceph -a stop mgr</span><br><span class="line">/etc/init.d/ceph -a stop mds</span><br><span class="line">/etc/init.d/ceph -a stop radosgw</span><br></pre></td></tr></table></figure><h4 id="启动及停止所有守护进程"><a href="#启动及停止所有守护进程" class="headerlink" title="启动及停止所有守护进程"></a>启动及停止所有守护进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start</span><br><span class="line">/etc/init.d/ceph -a stop</span><br></pre></td></tr></table></figure><h4 id="启动停止指定进程"><a href="#启动停止指定进程" class="headerlink" title="启动停止指定进程"></a>启动停止指定进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/ceph -a start osd.0</span><br><span class="line"></span><br><span class="line">/etc/init.d/ceph -a status osd.0</span><br><span class="line"></span><br><span class="line">/etc/init.d/ceph -a stop osd.0</span><br></pre></td></tr></table></figure><h3 id="4-1-2-把Ceph作为服务运行"><a href="#4-1-2-把Ceph作为服务运行" class="headerlink" title="4.1.2 把Ceph作为服务运行"></a>4.1.2 把Ceph作为服务运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ceph [options] [command] [dameons]</span><br></pre></td></tr></table></figure><p>[options]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--verbose(-v)	: 用于记录详细日志</span><br><span class="line">--allhosts(-a)	: 在Ceph.conf提及的所有节点上执行命令，否则只在本年级上运行</span><br><span class="line">--conf(-c)		: 使用可选的配置文件</span><br></pre></td></tr></table></figure><p>[command]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">status	: 显示守护进程状态</span><br><span class="line">start	: 启动守护进程</span><br><span class="line">stop	: 停止守护进程</span><br><span class="line">restart	: 重启守护进程</span><br><span class="line">forcestop	: 强制进程关闭 类似与kill -9</span><br></pre></td></tr></table></figure><p>[dameons]</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mon</span><br><span class="line">mgr</span><br><span class="line">osd</span><br><span class="line">mds</span><br><span class="line">ceph-radosgw</span><br></pre></td></tr></table></figure><h2 id="4-2-管理CRUSH-map"><a href="#4-2-管理CRUSH-map" class="headerlink" title="4.2 管理CRUSH map"></a>4.2 管理CRUSH map</h2><h3 id="4-2-1-CRUSH-map编译-反编译"><a href="#4-2-1-CRUSH-map编译-反编译" class="headerlink" title="4.2.1 CRUSH map编译/反编译"></a>4.2.1 CRUSH map编译/反编译</h3><p>在 ceph-deploy 部署完Ceph后，会生成一个默认的 CRUSH map，生产环境中需要定制 CRUSH map</p><p>若要获取CRUSH map的信息，需要进行反编译，修改后，编译注入会Ceph集群中，在系统运行时CRUSH map会马上生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在任一个monitor节点上提取CRUSH map</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd getcrushmap -o crushmap.txt <span class="comment">#获取现有CRUSH map , -o 表示编译输出到指定文件</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -d crushmap.txt -o crushmap-decompile <span class="comment">#-d 指定需要反编译的CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim crushmap-decompile <span class="comment"># 编辑CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -c crushmap-decompile -o crushmap-compiled <span class="comment">#重新编译新的CRUSH map</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd setcrushmap -i crushmap-compiled <span class="comment">#将新的CRUSH map应用到Ceph集群中</span></span></span><br></pre></td></tr></table></figure><h3 id="4-2-2-CRUSH-map内部信息"><a href="#4-2-2-CRUSH-map内部信息" class="headerlink" title="4.2.2 CRUSH map内部信息"></a>4.2.2 CRUSH map内部信息</h3><blockquote><p>CRUSH map：从软件角度表示集群的物理布局</p><p>包含一系列可用的 bucket（共同标识设备的具体物理位置）、Ceph池复制数据的规则</p></blockquote><h4 id="设备列表-device"><a href="#设备列表-device" class="headerlink" title="设备列表(device)"></a>设备列表(device)</h4><p>包含所有的OSD列表信息，由Ceph自行管理</p><ul><li>在一个Ceph集群中，无论何时新增或移除一个新的OSD，CRUSH map设备列表都会自动更新。</li></ul><p>若自行修改，则需要为OSD标注唯一的设备号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">devices</span></span><br><span class="line">device 0 osd.0</span><br><span class="line">device 1 osd.1</span><br><span class="line">device 2 osd.2</span><br><span class="line">......</span><br></pre></td></tr></table></figure><h4 id="bucket类型-Bucket-types"><a href="#bucket类型-Bucket-types" class="headerlink" title="bucket类型(Bucket types)"></a>bucket类型(Bucket types)</h4><p>定义了CURSH map中会用到的bucket类型，表示OSD在CRUSH分层结构中的位置</p><ul><li>节点bucket(nodes)表示物理位置，叶子bucket(leaves)表示ceph-osd守护进程和底层物理设备</li></ul><p><img src="/posts/3125950576/image-20231106093326016.png" alt="image-20231106093326016"></p><p>Bucket由物理位置（磁盘、节点、机架(rack)、行(row)、开关、电源电路、房间、数据中心）的分层聚合以及它们被分配的权重（weights）组成。</p><p><img src="/posts/3125950576/image-20231110001821973.png" alt="image-20231110001821973"></p><p>CRUSH map包含很多默认的bucket类型，可以自行添加或删除bucket类型</p><ul><li>添加bucket：输入ID与bucket名称</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">types</span></span><br><span class="line">type 0 osd</span><br><span class="line">type 1 host #主机</span><br><span class="line">type 2 chassis #机箱</span><br><span class="line">type 3 rack #机架</span><br><span class="line">type 4 row #行</span><br><span class="line">type 5 room #房间</span><br><span class="line">type 6 datacenter # 数据中心</span><br><span class="line">type 7 root #Ceph集群名</span><br></pre></td></tr></table></figure><h4 id="bucket实例-Bucket-instances"><a href="#bucket实例-Bucket-instances" class="headerlink" title="bucket实例(Bucket instances)"></a>bucket实例(Bucket instances)</h4><blockquote><p>CRUSH map文件的buckets段定义了CRUSH层次结构中的bucket实例。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[bucket-type] [bucket-name] &#123; </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bucket-type必须在types段定义</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bucket name为唯一的名称字符串</span></span><br><span class="line">	id [一个唯一的负整数]</span><br><span class="line">	weight [相对权重=与当前bucket总设备容量相关的权重和]</span><br><span class="line">	alg [bucket算法类型：uniform | list | tree | straw]</span><br><span class="line">	hash [默认为0,表示使用CURSH默认算法rjenkins1]</span><br><span class="line">	item [设备名] weight [权重]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如：</p><p><img src="/posts/3125950576/image-20231107213320736.png" alt="image-20231107213320736"></p><p><strong>weight</strong> ：所有的磁盘无论其容量大小都要被加入到集群，Ceph需要在集群的所有磁盘上均匀读写数据。CRUSH为每个OSD分配一个权重，OSD权重越大，则物理存储容量越大。权重表示物理设备间的相对差异</p><p><strong>alg</strong> ：</p><ul><li><p>uniform：所有存储设备权重都统一。当权重不统一时不能使用。在这种类型的bucket中添加或删除设备时数据都会被重新平衡(reshuffling of data)</p></li><li><p>List：链表类型的bucket将内容聚合成链表，新设备以头插法的方式插入。数据迁移最少，但移动存储设备会产生很多的数据移动。</p><p><strong>适合很少或从不添加设备的场景，适合小集群，不适合大集群</strong></p></li><li><p>tree：bucket被组织为带权二叉树，每个根节点都知道左右子树的总权重。提供优异的性能和重组效率</p><p>适合大项目，比链表式bucket高效</p></li><li><p>straw：在列表和树型bucket中选择一个设备时，需要计算一定数量的Hash和相对权重。采用分治法，给一些特定设备赋予更高优先级（列表开头的项目）。这会改善副本放置过程的性能，但在bucket被添加、删除或调整权重时产生重组</p><p>straw允许副本公平的放置在所有设备上。</p><p>适合：有设备删除但重组性能也很重要的场景</p></li><li><p>straw2：改进的straw算法。在设备A和B的权重都没改变时，避免数据移动。当新增设备C或删除设备C后，只会移动C上的数据到其他地方，而不会在bucket内其他设备间移动</p><p>减少了集群发生改变后的数据移动量</p></li></ul><h4 id="规则集-rules"><a href="#规则集-rules" class="headerlink" title="规则集(rules)"></a>规则集(rules)</h4><p>定义了如何从池中选择合适的bucket用于数据存放</p><p>要为每个池创建对应的CURSH规则集</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rule &lt;rulename&gt;&#123;</span><br><span class="line">	ruleset &lt;ruleset id&gt; #整数值</span><br><span class="line">		type [replicated | erasure]</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">启用规则的池副本数下限，低则不会使用</span></span><br><span class="line">		min_size &lt;min-size&gt;</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">启用规则的池副本数上限，高则不会使用</span></span><br><span class="line">		max_size &lt;max-size&gt;</span><br><span class="line">		step take &lt;bucket-type&gt; #map的遍历起点，一般为root类型的bucket</span><br><span class="line">		step [choose | chooseleaf] [firstn | indep] &lt;N&gt; &lt;bucket-type&gt;</span><br><span class="line">		step emit</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231107214400837.png" alt="image-20231107214400837"></p><p><strong>step choose firstn {num} type {bucket-type}</strong></p><p>在指定类型的bucket类型(一般为osd)中选取指定数量的桶，这个数字通常是存储池的副本数</p><p><strong>step chooseleaf firstn {num} type {bucket-type}</strong></p><p>选择 {bucket-type} 类型的一组bucket，并从各bucket的子树里选择一个叶子节点。这个数字通常是存储池的副本数</p><ul><li><p>N为池副本数</p><ul><li><p>num==0，选择N个bucket</p></li><li><p>0&lt;num&lt;N,选择num个bucket</p></li><li><p>若num&lt;0，则选择 N-num个bucket</p></li></ul></li></ul><p>num=1，N=3，<code>step choose firstn 1 type row</code> 表示选择一个row类型的bucket</p><p>num=0，N=3，<code>step chooseleaf firstn 0 type row</code> 表示选择3个row类型的bucket，从各row的子树中各选一个叶子节点(osd)</p><h3 id="4-2-3-CRUSH定位"><a href="#4-2-3-CRUSH定位" class="headerlink" title="4.2.3 CRUSH定位"></a>4.2.3 CRUSH定位</h3><p>CRUSH定位就是确定一个OSD在CRUSH map中的位置</p><p><img src="/posts/3125950576/image-20231107174927914.png" alt="image-20231107174927914"></p><h3 id="4-2-4-Ceph中的各种map"><a href="#4-2-4-Ceph中的各种map" class="headerlink" title="4.2.4 Ceph中的各种map"></a>4.2.4 Ceph中的各种map</h3><p>Ceph monitor 负责监控整个集群的健康状态，以及维护集群成员关系状态 (cluster membership state)、对等节点(peer nodes)的状态，和集群的配置信息等。</p><p>Ceph monitor通过维护 cluster map 的主复制来实现这些功能。cluster map 是多个 map 的组合，包括monitor map、OSD map、PG map、CRUSH map 以及MDS map 等。这些map统称为 cluster map。</p><h4 id="monitor-map"><a href="#monitor-map" class="headerlink" title="monitor map"></a>monitor map</h4><ul><li>集群ID</li><li>monitor 节点名称(hostname)、IP地址和端口号等</li><li>monitor map 被创建以来的最新版本号(epoch:每种 map 都维护着其历史版本，每个版本被称为一个epoch，epoch是一个单调递增的序列)，以及最后修改时间等。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mon dump</span><br></pre></td></tr></table></figure><h4 id="OSD-map"><a href="#OSD-map" class="headerlink" title="OSD map"></a>OSD map</h4><ul><li>集群ID</li><li>关于OSD的信息：数目、状态、权重、最近处于clean状态的间隔(last clean interval)及OSD主机等信息</li><li>OSD map创建版本和最后一次修改信息</li><li>与池相关的信息：池名、池ID、类型、副本级别(replication level)和PG</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd dump</span><br></pre></td></tr></table></figure><h4 id="PG-map"><a href="#PG-map" class="headerlink" title="PG map"></a>PG map</h4><ul><li>最新的OSD map版本</li><li>PG的版本、时间戳、容量充满比例（禁止客户端读写）以及容量接近充满（集群发出告警）的比例</li><li>跟踪每个PG ID（poolname.pgID）、对象数、状态时间戳、OSD的up集（所有副本所在OSD的有序列表，第一个为主OSD）、acting集（所有副本所在OSD的列表）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph pg dump</span><br></pre></td></tr></table></figure><h4 id="CRUSH-map"><a href="#CRUSH-map" class="headerlink" title="CRUSH map"></a>CRUSH map</h4><ul><li>集群的存储设备信息、故障域层次结构</li><li>在故障域中定义如何存储数据的规则</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush dump</span><br></pre></td></tr></table></figure><h4 id="MDS-map"><a href="#MDS-map" class="headerlink" title="MDS map"></a>MDS map</h4><ul><li>集群中MDS的数目以及MDS状态</li><li>当前MDS map的版本，创建时间和修改时间</li><li>数据和元数据池的ID</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mds dump</span><br></pre></td></tr></table></figure><h2 id="4-3-横向扩展-缩容OSD集群"><a href="#4-3-横向扩展-缩容OSD集群" class="headerlink" title="4.3 横向扩展/缩容OSD集群"></a>4.3 横向扩展/缩容OSD集群</h2><p>存储系统纵向扩展的设计方法：</p><ul><li>向已有设备中添加磁盘，但到达一定程度后，会成为性能、容量以及可管理性方面的瓶颈</li></ul><p>存储系统横向扩展的设计方法：</p><ul><li>向现有的集群添加节点，包括：磁盘、CPU、内存</li></ul><p><img src="/posts/3125950576/image-20231107162139487.png" alt="image-20231107162139487"></p><p>Ceph是一个无缝可扩展的存储系统，允许在线添加monitor和OSD节点到现有集群中，同时不造成服务下线</p><h3 id="4-3-1-向Ceph中添加OSD节点"><a href="#4-3-1-向Ceph中添加OSD节点" class="headerlink" title="4.3.1 向Ceph中添加OSD节点"></a>4.3.1 向Ceph中添加OSD节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前集群osd的详细情况</span></span><br><span class="line">ceph osd tree</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在客户端client上制造ceph集群上的工作负载，模拟在线扩容</span></span><br><span class="line">dd if=/dev/zero of=/mnt/ceph-voll/file1 bs=1M count=10240</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">支持在Ceph集群写入时，对集群osd扩展</span></span><br><span class="line">ceph-deploy disk zap ceph-node4:sdb ceph-node4:sdc ceph-node4:sdd</span><br><span class="line">ceph-deploy osd create ceph-node4:sdb ceph-node4:sdc ceph-node4:sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时可以发现容量在扩充</span></span><br><span class="line">watch ceph status</span><br><span class="line"></span><br><span class="line">ceph osd tree</span><br><span class="line">- osd的up/down状态</span><br><span class="line">- osd的IN/OUT状态，用1,0表示</span><br></pre></td></tr></table></figure><h3 id="4-3-2-从Ceph集群中移除并关闭一个OSD"><a href="#4-3-2-从Ceph集群中移除并关闭一个OSD" class="headerlink" title="4.3.2 从Ceph集群中移除并关闭一个OSD"></a>4.3.2 从Ceph集群中移除并关闭一个OSD</h3><h4 id="移除OSD"><a href="#移除OSD" class="headerlink" title="移除OSD"></a>移除OSD</h4><p>在移除OSD前，需要确保集群有足够的空余空间存放所移除节点上的数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前集群osd的详细情况</span></span><br><span class="line">ceph osd tree</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在客户端client上制造ceph集群上的工作负载，模拟在线缩容</span></span><br><span class="line">dd if=/dev/zero of=/mnt/ceph-voll/file1 bs=1M count=10240</span><br><span class="line"></span><br><span class="line">ceph osd out osd.9</span><br></pre></td></tr></table></figure><p>当把集群中的某个OSD标记为out时，属于它的所有PG中的数据都会被迁移至集群，直至集群再次平衡</p><p>在再平衡过程中，集群会有一段时间处于不健康状态（性能会下降），但对于客户端的数据访问服务都是正常的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph -s #可以看到集群处于恢复模式，同时开放数服务</span><br><span class="line">ceph -w #可以查看集群的恢复操作</span><br></pre></td></tr></table></figure><h4 id="关闭OSD进程"><a href="#关闭OSD进程" class="headerlink" title="关闭OSD进程"></a>关闭OSD进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service ceph stop osd.9</span><br><span class="line">ceph osd tree</span><br></pre></td></tr></table></figure><p>一旦osd进程关闭，则OSD的状态是down和out</p><h4 id="从CRUSH-map中移除OSD"><a href="#从CRUSH-map中移除OSD" class="headerlink" title="从CRUSH map中移除OSD"></a>从CRUSH map中移除OSD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush remove osd.9</span><br></pre></td></tr></table></figure><p>从CRUSH map中移除OSD后，Ceph集群的状态变为健康状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br></pre></td></tr></table></figure><p>这时看到的是osd总数是不变的，但IN和UP状态的OSD是正常的，即OSD数量&gt;IN数量，UP数量</p><h4 id="从OSD-map中移除OSD密钥"><a href="#从OSD-map中移除OSD密钥" class="headerlink" title="从OSD map中移除OSD密钥"></a>从OSD map中移除OSD密钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除osd的验证密钥</span></span><br><span class="line">ceph auth del osd.9</span><br></pre></td></tr></table></figure><p>此时，OSD总数与IN，UP状态的OSD数相等</p><h4 id="从CRUSH-map移除OSD所在节点信息"><a href="#从CRUSH-map移除OSD所在节点信息" class="headerlink" title="从CRUSH map移除OSD所在节点信息"></a>从CRUSH map移除OSD所在节点信息</h4><p>为保持集群清洁，执行一些清理操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd crush remove ceph-node4</span><br></pre></td></tr></table></figure><h3 id="4-3-3-替换出故障的磁盘设备"><a href="#4-3-3-替换出故障的磁盘设备" class="headerlink" title="4.3.3 替换出故障的磁盘设备"></a>4.3.3 替换出故障的磁盘设备</h3><p>首先检查集群状态<code>ceph -s</code> ，若集群中没有出现故障磁盘，则状态是 <code>HEALTH_OK</code></p><p>一旦OSD下线，则Ceph会将该OSD标记为 down，默认等待时间为300s</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph osd out osd.0 # 手动模拟磁盘故障</span><br><span class="line"></span><br><span class="line">磁盘出现故障后，集群状态会变为非健康状态，会执行恢复与再平衡操作</span><br><span class="line">ceph osd crush rm osd.0 #将故障OSD从CRUSH map中移除</span><br><span class="line">ceph osd del osd.0 # 移除OSD的验证密钥</span><br><span class="line">ceph osd rm osd.0 #从集群中移除OSD</span><br></pre></td></tr></table></figure><p>用新磁盘替换Ceph节点中出现故障的磁盘</p><p>一旦磁盘加入，标识磁盘在操作系统中的设备号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">罗列所有磁盘</span></span><br><span class="line">ceph-deploy disk list ceph-node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般而言，新磁盘无分区，也可以执行分区清理工作</span></span><br><span class="line">ceph-deploy disk zap ceph-node1:sdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基于磁盘创建OSD，Ceph会将其添加为osd.0</span></span><br><span class="line">ceph-deploy --overwrite-conf osd create ceph-node1:sdb</span><br></pre></td></tr></table></figure><h2 id="4-4-将池放置于不同OSD"><a href="#4-4-将池放置于不同OSD" class="headerlink" title="4.4 将池放置于不同OSD"></a>4.4 将池放置于不同OSD</h2><p>实际生产中，需要在多种类型的存储设备上创建存储集群</p><ul><li>基于SSD磁盘可以提供快速存储池</li><li>对于不需要更好的I/O性能的数据，可以在较慢的磁盘驱动器创建存储池</li></ul><p>假设：</p><p>ceph-node1有三个SSD，ceph-node2和ceph-node3分别有三个SATA磁盘</p><p>现要创建一个ssd池和一个sata池，ssd池的主副本都在ceph-node1上，sata池的主副本交叉存放于ceph-node2和ceph-node3上</p><h3 id="4-4-1-获取CURSH-map"><a href="#4-4-1-获取CURSH-map" class="headerlink" title="4.4.1 获取CURSH map"></a>4.4.1 获取CURSH map</h3><p>从任一个monitor节点上提取CRUSH map并反编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd getcrushmap -o crushmap-extract</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crushtool -d crushmap-extract -o crushmap-decompiled</span></span><br></pre></td></tr></table></figure><h3 id="4-4-2-编辑CRUSH-map"><a href="#4-4-2-编辑CRUSH-map" class="headerlink" title="4.4.2 编辑CRUSH map"></a>4.4.2 编辑CRUSH map</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">vim crushmap-decompiled</span></span><br></pre></td></tr></table></figure><p><strong>buckets定义</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">buckets</span></span><br><span class="line">host ceph-node1 &#123;</span><br><span class="line">	id  -2</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rienkins1</span><br><span class="line">	item osd.0 weight 0.010</span><br><span class="line">	item osd.1 weight 0.010</span><br><span class="line">	item osd.2 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">host ceph-node2 &#123;</span><br><span class="line">	id -3</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rjenkins1</span><br><span class="line">	item osd.3 weight 0.010</span><br><span class="line">	item osd.4 weight 0.010</span><br><span class="line">	item osd.5 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">host ceph-node3 &#123;</span><br><span class="line">	id -4</span><br><span class="line">	weight 0.030</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0#rjenkins1</span><br><span class="line">	item osd.6 weight 0.010</span><br><span class="line">	item osd.7 weight 0.010</span><br><span class="line">	item osd.8 weight 0.010</span><br><span class="line">&#125;</span><br><span class="line">root ssd&#123;</span><br><span class="line">	id -1</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0</span><br><span class="line">	item ceph-node1 weight 0.03</span><br><span class="line">&#125;</span><br><span class="line">root sata&#123;</span><br><span class="line">	id -5</span><br><span class="line">	alg straw</span><br><span class="line">	hash 0</span><br><span class="line">	item ceph-node2 weight 0.03</span><br><span class="line">	item ceph-node3 weight 0.03</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">end buckets</span></span><br></pre></td></tr></table></figure><p><strong>ruleset</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># rules</span></span></span><br><span class="line">rule data &#123;</span><br><span class="line">	ruleset 0</span><br><span class="line">	type replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	maxsize 10</span><br><span class="line">	step take sata #修改，用sata 代替default</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line">rule metadata &#123;</span><br><span class="line">	ruleset 1</span><br><span class="line">	type replicated</span><br><span class="line">	min_size 1</span><br><span class="line">	maxsize 10</span><br><span class="line">	step take sata</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br><span class="line">rule rbd &#123;</span><br><span class="line">	ruleset 2</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take sata</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>为ssd池和sata池新增规则</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule sata&#123;</span><br><span class="line">	ruleset 3</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take sata #</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit	</span><br><span class="line">&#125;</span><br><span class="line">rule ssd&#123;</span><br><span class="line">	ruleset 4</span><br><span class="line">	type replicated</span><br><span class="line">	minsize 1</span><br><span class="line">	max_size 10</span><br><span class="line">	step take ssd #</span><br><span class="line">	step chooseleaf firstn 0 type host</span><br><span class="line">	step emit	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-3-应用CRUSH-map的修改"><a href="#4-4-3-应用CRUSH-map的修改" class="headerlink" title="4.4.3 应用CRUSH map的修改"></a>4.4.3 应用CRUSH map的修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crushtool -c crushmap-decompiled -o crushmap-compiled</span><br><span class="line">ceph osd setcrushmap -i crushmap-compiled</span><br></pre></td></tr></table></figure><p>一旦将新的CRUSH map注入到Ceph集群，集群将会发生数据调整和数据恢复，并且很快进入 <code>HEALTH_OK</code> 状态</p><h3 id="4-4-4-创建池"><a href="#4-4-4-创建池" class="headerlink" title="4.4.4 创建池"></a>4.4.4 创建池</h3><p>一旦集群处于健康状态，创建ssd池和sata池</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create sata 64 64</span><br><span class="line">ceph osd pool create ssd 64 64 </span><br></pre></td></tr></table></figure><p>为池指定规则</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool set sata crush_ruleset 3</span><br><span class="line">ceph osd pool set ssd crush_ruleset 4</span><br><span class="line">ceph osd dump | egrep -i &quot;ssd|sata&quot;</span><br></pre></td></tr></table></figure><h3 id="4-4-5-向指定池写入数据"><a href="#4-4-5-向指定池写入数据" class="headerlink" title="4.4.5 向指定池写入数据"></a>4.4.5 向指定池写入数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建数据文件</span></span><br><span class="line">dd if=/dev/zero of=sata_data bs=1M count=32 conv=fsync</span><br><span class="line">dd if=/dev/zero of=ssd_data bs=1M count=32 conv=fsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将文件放入Ceph集群上指定的池中</span></span><br><span class="line">rados -p ssd put ssd_data_object ssd_data</span><br><span class="line">rados -p ssd put sata_data_objec sata_data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在OSD map中检查池中对象的信息</span></span><br><span class="line">ceph osd map ssd ssd_data_object</span><br><span class="line">ceph osd map sata sata_data_object</span><br></pre></td></tr></table></figure><h2 id="4-6-身份验证和授权"><a href="#4-6-身份验证和授权" class="headerlink" title="4.6 身份验证和授权"></a>4.6 身份验证和授权</h2><h2 id="4-6-监控集群"><a href="#4-6-监控集群" class="headerlink" title="4.6 监控集群"></a>4.6 监控集群</h2><h3 id="4-6-1-CLI"><a href="#4-6-1-CLI" class="headerlink" title="4.6.1 CLI"></a>4.6.1 CLI</h3><h4 id="监控集群"><a href="#监控集群" class="headerlink" title="监控集群"></a>监控集群</h4><h5 id="集群健康状态"><a href="#集群健康状态" class="headerlink" title="集群健康状态"></a>集群健康状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -health <span class="comment"># 检查集群健康状况</span></span></span><br><span class="line">HEALTH WARN 64 pgs degraded; 1408 pgs stuck unclean; recovery 1/5744 objects degraded (0.017%)</span><br><span class="line">- 集群健康状况：</span><br><span class="line">	HEALTH_OK 健康状态</span><br><span class="line">	HEALTH_WARN 告警状态</span><br><span class="line">- PG数量和PG状态</span><br><span class="line">	clean</span><br><span class="line">	unclean</span><br><span class="line">- 集群对象情况</span><br><span class="line">	表示集群处于 recovery 状态。目前正在处理5744个对象中的一个，整个集群中有0.017%的对象处于degraded状态</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph health detail <span class="comment">#可以得到健康状态的细节</span></span></span><br><span class="line">返回状态不是active和clea的PG，即unclean ，unconsistent，degrated状态的PG都会输出状态细节</span><br></pre></td></tr></table></figure><h5 id="集群事件"><a href="#集群事件" class="headerlink" title="集群事件"></a>集群事件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -w [optionss] <span class="comment">#显示集群状态，包括Info(信息)、WRN(警告)、ERR(错误)</span></span></span><br><span class="line">实时指令，CTRL+C退出</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line">--watch-debug：只查看调试事件</span><br><span class="line">--watch-info：只查看信息事件</span><br><span class="line">--watch-sec：只查看安全事件</span><br><span class="line">--watch-warn：只查看警告事件</span><br><span class="line">--watch-error：只查看错误事件</span><br></pre></td></tr></table></figure><h5 id="集群利用率"><a href="#集群利用率" class="headerlink" title="集群利用率"></a>集群利用率</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph <span class="built_in">df</span> <span class="comment">#输出集群的空间利用率统计信息</span></span></span><br><span class="line">集群总容量、可用容量、已用容量和百分比</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231108095303503.png" alt="image-20231108095303503"></p><h5 id="集群组件状态"><a href="#集群组件状态" class="headerlink" title="集群组件状态"></a>集群组件状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph status</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph -s</span></span><br><span class="line"></span><br><span class="line">cluster：表示Ceph唯一的集群ID</span><br><span class="line">health：集群的健康状态</span><br><span class="line">monmap：monitor map的版本、信息、选举信息和mon法定人数</span><br><span class="line">mdsmap：MDS map版本和状态</span><br><span class="line">osdmap：OSD map版本和状态</span><br><span class="line">pgmap：PG map版本，总的PG数，池数和总对象数</span><br><span class="line">		同时展示集群利用率信息(集群总容量、可用容量、已用容量和百分比)</span><br></pre></td></tr></table></figure><h5 id="检查集群密钥"><a href="#检查集群密钥" class="headerlink" title="检查集群密钥"></a>检查集群密钥</h5><p>Ceph工作在一个基于密钥的验证系统上，所有组件之间的交互都经过基于密钥的验证系统</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph auth list<span class="comment"># 获取所有密钥的列表</span></span></span><br></pre></td></tr></table></figure><h4 id="监控mon"><a href="#监控mon" class="headerlink" title="监控mon"></a>监控mon</h4><p>monitor只有达到选举的法定人数才能保证集群功能正常</p><h5 id="mon状态"><a href="#mon状态" class="headerlink" title="mon状态"></a>mon状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon <span class="built_in">stat</span> <span class="comment">#获取mon集群的状态</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon dump <span class="comment">#获取mon集群的map</span></span></span><br></pre></td></tr></table></figure><h5 id="mon法定人数状态"><a href="#mon法定人数状态" class="headerlink" title="mon法定人数状态"></a>mon法定人数状态</h5><p>Ceph集群中应该有超过 $\frac{1}{2}$ 的可用mon</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph quorum_status --format json-pretty</span></span><br><span class="line"></span><br><span class="line">election_epoch 选举版本号</span><br><span class="line">quorum_leader_name leader主机名 </span><br><span class="line">monmap&#123;	集群的monmap</span><br><span class="line">	epoch #版本号</span><br><span class="line">	fsid #集群ID</span><br><span class="line">	集群创建、修改时间</span><br><span class="line">	mons:[</span><br><span class="line">		&#123;</span><br><span class="line">			rank: #为集群中的mon分配的等级</span><br><span class="line">			name:</span><br><span class="line">			addr:</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mon dump <span class="comment">#导出Ceph monitor信息</span></span></span><br></pre></td></tr></table></figure><h4 id="监控OSD"><a href="#监控OSD" class="headerlink" title="监控OSD"></a>监控OSD</h4><p>集群越大，OSD越多，磁盘故障可能性很高</p><h5 id="OSD树视图"><a href="#OSD树视图" class="headerlink" title="OSD树视图"></a>OSD树视图</h5><p>OSD的树视图用于查看OSD的in、up、out或down等状态时</p><p>OSD树视图展示了每个节点的所有OSD以及所在CRUSH map中的位置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd tree</span></span><br></pre></td></tr></table></figure><p>展示了Ceph OSD的信息</p><ul><li>权重</li><li>up/down状态</li><li>in/out状态</li></ul><p>输出格式会根据CRUSH map进行规则的格式化</p><h5 id="OSD统计"><a href="#OSD统计" class="headerlink" title="OSD统计"></a>OSD统计</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd dump <span class="comment">#获取Ceph集群和OSD的详细信息</span></span></span><br></pre></td></tr></table></figure><p>输出：</p><p>OSD map版本</p><ul><li>OSD ID</li><li>状态</li><li>权重</li><li>每个OSD的健康状态，版本区间等信息</li></ul><p>池的细节</p><ul><li>池ID</li><li>池名</li><li>池类型（复制、擦除）</li><li>CRUSH 规则集和PG</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd blacklist <span class="built_in">ls</span> <span class="comment">#查看添加到黑名单的客户端</span></span></span><br></pre></td></tr></table></figure><h5 id="CRUSH-map-1"><a href="#CRUSH-map-1" class="headerlink" title="CRUSH map"></a>CRUSH map</h5><p>使用CRUSH map命令行工具比手动查看和修改CRUSH map节省时间</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd tree <span class="comment"># 获取当前集群布局</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush [操作] [被操作组件] [目标组件]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在集群中添加新机架</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack01 rack</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack02 rack</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush add-bucket rack03 rack</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动主机到指定机架下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack01</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack02</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move ceph-node1 rack=rack03</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移动机架到默认根下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack01 root=default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack02 root=default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush move rack03 root=default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush rule list <span class="comment"># 查看CRUSH map规则集</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph osd crush rule dump &lt;crush_rule_name&gt; <span class="comment"># 查看CRUSH map规则集的详细信息</span></span></span><br></pre></td></tr></table></figure><h5 id="OSD-定位指令"><a href="#OSD-定位指令" class="headerlink" title="OSD 定位指令"></a>OSD 定位指令</h5><p>当OSD数量多、CRUSH map层级多时，手动的 OSD 定位会很困难，需要借助CRUSH CLI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd find &lt;OSD_ID&gt;</span><br></pre></td></tr></table></figure><h4 id="监控PG"><a href="#监控PG" class="headerlink" title="监控PG"></a>监控PG</h4><p>OSD 存储PG，PG包含对象</p><p>集群整体的健康状态主要取决于PG。只有PG的状态是 active+clean 状态，集群才会保持为 HELATH_OK 状态</p><h5 id="PG的状态"><a href="#PG的状态" class="headerlink" title="PG的状态"></a>PG的状态</h5><blockquote><p>无故障操作</p></blockquote><p><strong>creating</strong> ：通常当存储池正在被创建或增加一个存储池的PG数量时会出现这种状态</p><p><strong>active</strong> ：处于active状态的PG，则主PG及其副本中的数据都处于可被客户端正常IO的状态</p><p><strong>peering（对齐）</strong> ：PG的OSD都处在acting集合中。peer操作：由主OSD发起的，存储PG副本的所有OSD，就PG的所有对象和元数据状态一致。完成后，存储PG的所有OSD都彼此确认当前状态，客户端可以读写</p><p><strong>splitting（分割中）</strong> ：PG正在被分割为多个PG。</p><p>在一个存储池的PG数增加后呈现</p><p><strong>scrubbing（清理中）</strong> ：PG正在做不一致性校验</p><hr><blockquote><p>PG出错</p></blockquote><p><strong>down（失效）</strong> ：包含PG必需数据的一个副本失效了，因此PG失效</p><p><strong>degraded</strong> ：PG中部分对象未达到规定副本数，处于degraded状态的PG仍可被客户端IO</p><ul><li><p>OSD处于down状态，Ceph将分配到该OSD上的所有PG状态变为degraded状态</p><p>在OSD重新up之后，执行peer操作，使得所有处于degraded状态的PG变为clean</p></li><li><p>如果OSD持续处于down状态超过300s后，OSD状态变为out</p><p>Ceph将会从副本中恢复所有处于degraded状态的PG保持复制级</p></li><li><p>Ceph认为对象应该存在于某个PG中，但该对象并不可用，此时将该PG状态置为degraded并从其副本中恢复PG</p></li></ul><p><strong>remapped</strong> ：当PG的acting集合变化时，会触发数据迁移。数据从老的acting集合OSD向新的acting集合OSD转移</p><ul><li>在迁移过程中，仍然使用老acting集合中的OSD为客户端提供读写请求</li><li>迁移完成，才会启用新acting 集合中的OSD为客户端提供读写请求</li></ul><p><strong>inconsistent（不一致）</strong> ：PG的副本出现了不一致。如：对象大小不正确，recovery后某副本出现了对象丢失</p><p><strong>incomplete(不完整)</strong> ：PG日志缺失一个时间段的数据。当包含PG所需信息的某OSD失效或不可用，会出现这种情况</p><p><strong>stable</strong> ：如果PG acting集合中的主副本OSD未向monitor报告统计结果 或 其他OSD报告主副本OSD状态变为down，则monitor将这些PG处于stable状态。</p><p>通常Peering结束前PG处于该状态</p><p><strong>repair（修复中）</strong> ：PG正在被检查，被发现的任何不一致都被尽可能地修复</p><hr><blockquote><p>OSD异常处理</p></blockquote><p><strong>backfilling</strong> ：新的OSD加入集群时，Ceph通过移动其他OSD上的一些PG到新OSD上保持负载均衡。</p><ul><li>在后台平滑地执行backfill，确保集群不会超载</li><li>backfill完成，OSD可以参与到客户端的IO操作</li></ul><p><strong>backfill-wait</strong> ：PG正在等待回填操作</p><p><strong>recovering</strong> ：当一个OSD处于 down 状态，其PG中的内容会落后与放置在其他OSD上的PG副本。一旦该OSD处于up状态，Ceph会针对这些PG启动恢复操作，使得该PG中的数据与其他PG副本保持一致</p><p><strong>relay（重做）</strong> ：OSD崩后PG正在等待客户端重新发起请求</p><p><strong>clean</strong> ：主OSD和顺位OSD已经彼此确认；所有PG都在正确位置上，未发生偏移；所有都按副本级复制完成</p><p><img src="/posts/3125950576/70.jpeg" alt="img"></p><h5 id="监控PG-1"><a href="#监控PG-1" class="headerlink" title="监控PG"></a>监控PG</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg <span class="built_in">stat</span> <span class="comment">#获取PG状态</span></span></span><br><span class="line"></span><br><span class="line">vNNNN: X pgs: Y active+clean; R bytes data, u MB used , F GB/T GB aval</span><br></pre></td></tr></table></figure><ul><li>vNNNN：PG map版本号</li><li>X：总PG数</li><li>Y：当前状态度的PG树</li><li>R：当前集群处处的裸数据容量</li><li>U：当前集群已经存储的包含副本的真是数据容量</li><li>F：剩余容量</li><li>T：总容量</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg dump <span class="comment"># 获取PG列表</span></span></span><br><span class="line">PG map 版本</span><br><span class="line">PG ID</span><br><span class="line">PG 状态</span><br><span class="line">acting集合</span><br><span class="line">负责该PG的acting集合的主OSD</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg &lt;PG_ID&gt; query <span class="comment">#查询一个PG的详细信息</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg 2.7d query</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph pg dump_stuck &lt;PG状态&gt; <span class="comment"># 获取处于stuck 状态的PG列表</span></span></span><br></pre></td></tr></table></figure><h4 id="监控MDS"><a href="#监控MDS" class="headerlink" title="监控MDS"></a>监控MDS</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph mds <span class="built_in">stat</span></span></span><br><span class="line">ACTIVE、INACTIVE、UP、DOWN</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph msd dump</span></span><br></pre></td></tr></table></figure><h3 id="4-6-2-REST-API"><a href="#4-6-2-REST-API" class="headerlink" title="4.6.2 REST API"></a>4.6.2 REST API</h3><p>Ceph自带REST API，允许用户通过编程的方式对集群进行管理，使其可以运行为一个WSGI应用或独立的服务器，默认监听5000端口</p><p>提供了一个类似Ceph命令的通过HTTP访问的接口，以HTTP GET和PUT请求的方式提交，结果以 json、XML、txt的格式返回</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.在Ceph集群中，创建一个用户client.restapi，授予它适当的 mon、osd 和mds权限:</span></span><br><span class="line">ceph auth get-or-create client.restapi mds &#x27;allow&#x27; osd &#x27;allow *&#x27; mon&#x27;allow*&#x27; &gt; /etc/ceph/ceph.client.restapi.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 修改ceph.conf文件</span></span><br><span class="line">[client.restapi]</span><br><span class="line">log file=/var/log/ceph/ceph.restapi.log</span><br><span class="line">keyring=/etc/ceph/ceph.client.restapi.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 执行以下命令来启动ceph-rest-api,并将它作为一个在后台独立的 Web 服务器来运行</span></span><br><span class="line">nohup ceph-rest-api &gt; /var/log/ceph-rest-api &amp;&gt; /var/log/cephrest-api-error.log&amp;</span><br></pre></td></tr></table></figure><ul><li>也可以不用 nohup来运行 ceph-rest-api，但会抑制后台运行</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. ceph-rest-api将会在 0.0.0.0:5000上监听，也可以用curl访问ceph-rest-api来查询集群的健康状态:</span></span><br><span class="line">curl localhost:5000/api/v0.1/health</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 类似地，通过rest-api检查osd和mon的状态</span></span><br><span class="line">curl localhost:5000/api/v0.1/osd/stat</span><br><span class="line">curl localhost:5000/api/v0.1/mon/stat</span><br></pre></td></tr></table></figure><p><img src="/posts/3125950576/image-20231111005247522.png" alt="image-20231111005247522"></p><p>ceph-rest-api 支持大多数 Ceph CLI。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ceph-rest-api的可用命令</span></span><br><span class="line">curl localhost:5000/api/v0.1</span><br></pre></td></tr></table></figure><p>以HTML形式返回，用Web浏览器访问访问更易读</p><p>要将它运行在生产环境中，最好部署多个它的实例，每个实例都是一个封装在 Web 服务器中的 WSGI应用，前端再使用一个负载均衡器。</p><h3 id="4-6-3-开源管理控制平台"><a href="#4-6-3-开源管理控制平台" class="headerlink" title="4.6.3 开源管理控制平台"></a>4.6.3 开源管理控制平台</h3><h4 id="Kraken"><a href="#Kraken" class="headerlink" title="Kraken"></a>Kraken</h4><p>Python，用来统计信息和监控Cepgh集群</p><ul><li>集群数据量</li><li>mon状态</li><li>OSD状态</li><li>PG状态</li><li>支持多个mon</li><li>变更OSD操作</li><li>动态CRUSH map配置</li><li>Ceph身份验证</li><li>池操作</li><li>块设备管理</li><li>CPU、内存等系统指标</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 安装karen依赖，如python-pip、screen和Firefox</span></span><br><span class="line">yum install python-pip screen firefox</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装开发库</span></span><br><span class="line">yum install gcc python-deve1 libxm12-devel.x86_64 libxslt-devel.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 为karen新建目录</span></span><br><span class="line">mkdir /karen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 从github复制karen存储不哭</span></span><br><span class="line">git clone /karendash/karendash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 使用Python包管理器安装karen所需的包，如Django、python-cephclient、djangorestframework、markdown、humanize</span></span><br><span class="line">cd /karendash</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 执行api.sh和djanfo.sh，分别调用ceph-rest-api和django python仪表盘</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这些脚本会在独立的screen环境中执行</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">CTRL+D分离当前screen会话并将其转移到后台</span></span><br><span class="line">cp ../krakendash/contrib/*.sh</span><br><span class="line">./api.sh</span><br><span class="line">./django.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 检查screen会话</span></span><br><span class="line">ps -ef | grep -i screen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 浏览器打开 localhost:8000</span></span><br></pre></td></tr></table></figure><h4 id="Ceph-dash工具"><a href="#Ceph-dash工具" class="headerlink" title="Ceph-dash工具"></a>Ceph-dash工具</h4><p>用尽可能简单的方法通过RESTful JSON API及Web GUI来提供监控Ceph集群</p><p>python wsgi的应用程序，通过librados直接与集群通信</p><ul><li>整体集群状态及详细的问题描述</li><li>支持多个mon、支持每个mon的状态</li><li>OSD状态包含处于in、out和不健康的OSD数</li><li>可视化存储容量图</li><li>实时吞吐量，包括读写速度和每秒操作数</li><li>可视化PG状态图</li><li>集群恢复状态</li></ul><p>在拥有wsgi的Web服务器(Apache、nginx)上部署这个应用程序</p><p>Ceph-dash访问Ceph集群是只读的，不需要任何写权限，通过Python的RADOS类来使用cepgh status命令，通过REST API或WebGUI导出输出结果</p><h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ceph必须安装在有Ceph访问权限的节点上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 新建目录，从github上复制存储库</span></span><br><span class="line">mkdir /ceph-dash</span><br><span class="line">git clone /Crapworks/ceph-dash.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装python-pip</span></span><br><span class="line">yum install python-pip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 安装jinja2</span></span><br><span class="line">easy_install Jinja2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 启动Ceph-dash GUI</span></span><br><span class="line">./ceph-dash.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 访问/localhost:5000</span></span><br></pre></td></tr></table></figure><h4 id="Calamari"><a href="#Calamari" class="headerlink" title="Calamari"></a>Calamari</h4><h3 id="4-6-4-日志"><a href="#4-6-4-日志" class="headerlink" title="4.6.4 日志"></a>4.6.4 日志</h3><p>默认情况下降日志存储在 /var/log/ceph目录下</p><p>[企业级]#13故障定位方法$13.1获取集群状态</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/3125950576/" title="5.Ceph操作及管理">https://amostian.github.io/posts/3125950576/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tags"></i> 分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/2699312118/" rel="prev" title="9.动手学深度学习-经典循环神经网络"><i class="fa fa-chevron-left"></i> 9.动手学深度学习-经典循环神经网络</a></div><div class="post-nav-item"><a href="/posts/919959330/" rel="next" title="3.Ceph数据处理">3.Ceph数据处理 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Ceph%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-text">4.1 Ceph服务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E4%BD%BF%E7%94%A8sysinit%E8%BF%90%E8%A1%8CCeph"><span class="nav-text">4.1.1 使用sysinit运行Ceph</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%90%AF%E5%8A%A8%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">根据类型启动守护进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%81%9C%E6%AD%A2%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">根据类型停止守护进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%81%9C%E6%AD%A2%E6%89%80%E6%9C%89%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">启动及停止所有守护进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%81%9C%E6%AD%A2%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B"><span class="nav-text">启动停止指定进程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-%E6%8A%8ACeph%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E8%BF%90%E8%A1%8C"><span class="nav-text">4.1.2 把Ceph作为服务运行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E7%AE%A1%E7%90%86CRUSH-map"><span class="nav-text">4.2 管理CRUSH map</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-CRUSH-map%E7%BC%96%E8%AF%91-%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="nav-text">4.2.1 CRUSH map编译&#x2F;反编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-CRUSH-map%E5%86%85%E9%83%A8%E4%BF%A1%E6%81%AF"><span class="nav-text">4.2.2 CRUSH map内部信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E5%88%97%E8%A1%A8-device"><span class="nav-text">设备列表(device)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bucket%E7%B1%BB%E5%9E%8B-Bucket-types"><span class="nav-text">bucket类型(Bucket types)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bucket%E5%AE%9E%E4%BE%8B-Bucket-instances"><span class="nav-text">bucket实例(Bucket instances)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E5%88%99%E9%9B%86-rules"><span class="nav-text">规则集(rules)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-CRUSH%E5%AE%9A%E4%BD%8D"><span class="nav-text">4.2.3 CRUSH定位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-4-Ceph%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8Dmap"><span class="nav-text">4.2.4 Ceph中的各种map</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor-map"><span class="nav-text">monitor map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OSD-map"><span class="nav-text">OSD map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PG-map"><span class="nav-text">PG map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CRUSH-map"><span class="nav-text">CRUSH map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MDS-map"><span class="nav-text">MDS map</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E6%A8%AA%E5%90%91%E6%89%A9%E5%B1%95-%E7%BC%A9%E5%AE%B9OSD%E9%9B%86%E7%BE%A4"><span class="nav-text">4.3 横向扩展&#x2F;缩容OSD集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E5%90%91Ceph%E4%B8%AD%E6%B7%BB%E5%8A%A0OSD%E8%8A%82%E7%82%B9"><span class="nav-text">4.3.1 向Ceph中添加OSD节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E4%BB%8ECeph%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%A7%BB%E9%99%A4%E5%B9%B6%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AAOSD"><span class="nav-text">4.3.2 从Ceph集群中移除并关闭一个OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4OSD"><span class="nav-text">移除OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%ADOSD%E8%BF%9B%E7%A8%8B"><span class="nav-text">关闭OSD进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8ECRUSH-map%E4%B8%AD%E7%A7%BB%E9%99%A4OSD"><span class="nav-text">从CRUSH map中移除OSD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8EOSD-map%E4%B8%AD%E7%A7%BB%E9%99%A4OSD%E5%AF%86%E9%92%A5"><span class="nav-text">从OSD map中移除OSD密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8ECRUSH-map%E7%A7%BB%E9%99%A4OSD%E6%89%80%E5%9C%A8%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="nav-text">从CRUSH map移除OSD所在节点信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E6%9B%BF%E6%8D%A2%E5%87%BA%E6%95%85%E9%9A%9C%E7%9A%84%E7%A3%81%E7%9B%98%E8%AE%BE%E5%A4%87"><span class="nav-text">4.3.3 替换出故障的磁盘设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E5%B0%86%E6%B1%A0%E6%94%BE%E7%BD%AE%E4%BA%8E%E4%B8%8D%E5%90%8COSD"><span class="nav-text">4.4 将池放置于不同OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E8%8E%B7%E5%8F%96CURSH-map"><span class="nav-text">4.4.1 获取CURSH map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E7%BC%96%E8%BE%91CRUSH-map"><span class="nav-text">4.4.2 编辑CRUSH map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-%E5%BA%94%E7%94%A8CRUSH-map%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-text">4.4.3 应用CRUSH map的修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-4-%E5%88%9B%E5%BB%BA%E6%B1%A0"><span class="nav-text">4.4.4 创建池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-5-%E5%90%91%E6%8C%87%E5%AE%9A%E6%B1%A0%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-text">4.4.5 向指定池写入数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="nav-text">4.6 身份验证和授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4"><span class="nav-text">4.6 监控集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-1-CLI"><span class="nav-text">4.6.1 CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4"><span class="nav-text">监控集群</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-text">集群健康状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E4%BA%8B%E4%BB%B6"><span class="nav-text">集群事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%88%A9%E7%94%A8%E7%8E%87"><span class="nav-text">集群利用率</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%84%E4%BB%B6%E7%8A%B6%E6%80%81"><span class="nav-text">集群组件状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E5%AF%86%E9%92%A5"><span class="nav-text">检查集群密钥</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7mon"><span class="nav-text">监控mon</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mon%E7%8A%B6%E6%80%81"><span class="nav-text">mon状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mon%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E7%8A%B6%E6%80%81"><span class="nav-text">mon法定人数状态</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7OSD"><span class="nav-text">监控OSD</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#OSD%E6%A0%91%E8%A7%86%E5%9B%BE"><span class="nav-text">OSD树视图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OSD%E7%BB%9F%E8%AE%A1"><span class="nav-text">OSD统计</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CRUSH-map-1"><span class="nav-text">CRUSH map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OSD-%E5%AE%9A%E4%BD%8D%E6%8C%87%E4%BB%A4"><span class="nav-text">OSD 定位指令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7PG"><span class="nav-text">监控PG</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PG%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-text">PG的状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7PG-1"><span class="nav-text">监控PG</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7MDS"><span class="nav-text">监控MDS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-2-REST-API"><span class="nav-text">4.6.2 REST API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-3-%E5%BC%80%E6%BA%90%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%B9%B3%E5%8F%B0"><span class="nav-text">4.6.3 开源管理控制平台</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kraken"><span class="nav-text">Kraken</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph-dash%E5%B7%A5%E5%85%B7"><span class="nav-text">Ceph-dash工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-text">部署</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Calamari"><span class="nav-text">Calamari</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-4-%E6%97%A5%E5%BF%97"><span class="nav-text">4.6.4 日志</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">375</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">60</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">78</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">959.3k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">40:22</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"live2d-widget-model-hijiki"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1})</script></body></html>