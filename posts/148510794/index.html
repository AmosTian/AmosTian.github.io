<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="提取Ceph O版的所有参数分析"><meta property="og:type" content="article"><meta property="og:title" content="9.Ceph参数配置"><meta property="og:url" content="https://amostian.github.io/posts/148510794/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="提取Ceph O版的所有参数分析"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/148510794/task4_2.png"><meta property="og:image" content="https://amostian.github.io/posts/148510794/task4_3.png"><meta property="og:image" content="https://amostian.github.io/posts/148510794/task4_6.png"><meta property="og:image" content="https://amostian.github.io/posts/148510794/task4_7.png"><meta property="og:image" content="https://amostian.github.io/posts/148510794/task4_8.png"><meta property="article:published_time" content="2023-12-30T15:20:04.000Z"><meta property="article:modified_time" content="2024-10-04T03:59:48.331Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="存储"><meta property="article:tag" content="分布式存储"><meta property="article:tag" content="Ceph"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/148510794/task4_2.png"><link rel="canonical" href="https://amostian.github.io/posts/148510794/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>9.Ceph参数配置 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">66</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">83</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">216</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/148510794/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">9.Ceph参数配置</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2023-12-30 23:20:04" itemprop="dateCreated datePublished" datetime="2023-12-30T23:20:04+08:00">2023-12-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2024-10-04 11:59:48" itemprop="dateModified" datetime="2024-10-04T11:59:48+08:00">2024-10-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/Ceph/" itemprop="url" rel="index"><span itemprop="name">Ceph</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">5.6k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>18 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>提取Ceph O版的所有参数分析</p></blockquote><span id="more"></span><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_67736058/article/details/137922219">https://blog.csdn.net/qq_67736058/article/details/137922219</a></p><p>结合 <code>src/common/legacy_config_opts.h</code> 再查看</p><p>Ceph 参数配置分为运行时生效与启动时生效的参数，<br>对于运行时生效的参数，在 ceph 创建后一直保存在进程中，只有相关事件才会触发对这些参数的访问，因此只要修改进程所链接的文件，就可认为这些参数的修改已实时生效<br>对于启动时生效的函数，只有在 ceph 进程创建时才会起作用，如：只有在创建 osd 进程时，才会通过 <code>osd_op_num_shards *osd_op_num_threads_per_shard</code> 计算线程数并向操作系统申请。在 OSD 进程创建之后，即使调整这些参数也不会生效，所以这才是一些参数重启才会生效的真正原因。</p><h2 id="参数查看"><a href="#参数查看" class="headerlink" title="参数查看"></a>参数查看</h2><h3 id="提取所有参数"><a href="#提取所有参数" class="headerlink" title="提取所有参数"></a>提取所有参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">touch O_conf.txt # 创建保存参数的文件</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取所有的参数名</span></span><br><span class="line">ceph config ls &gt; ceph_config.txt</span><br><span class="line"></span><br><span class="line">ceph config help </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取各进程中参数的默认值，导出为<span class="string">&#x27;NAME=VALUE&#x27;</span>格式</span></span><br><span class="line">ceph config show-with-defaults mon.node1 | awk &#x27;&#123;print $1,&quot;=&quot;, $2&#125;&#x27; &gt; knobs_with_default.txt </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分别在 mon,mgr,osd节点上，通过运行中的进程默认knobs值</span></span><br><span class="line">ceph daemon mon.node1 config show &gt; mon_default_knobs_value.txt</span><br><span class="line">ceph daemon mgr.node2 config show &gt; mgr_default_knobs_value.txt</span><br><span class="line">ceph daemon osd.0 config show &gt; osd_default_knobs_value.txt</span><br><span class="line">三个角色的节点导出配置相同，导出为json格式</span><br></pre></td></tr></table></figure><h4 id="查看指定参数的值"><a href="#查看指定参数的值" class="headerlink" title="查看指定参数的值"></a>查看指定参数的值</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取参数默认值</span></span><br><span class="line">ceph config get mgr.node2 &lt;&gt;</span><br><span class="line">ceph config show mon.node1 osd_max_write_size #显示指定参数值</span><br></pre></td></tr></table></figure><h3 id="源码查看参数"><a href="#源码查看参数" class="headerlink" title="源码查看参数"></a>源码查看参数</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huangwenhuan/article/details/130411626">https://blog.csdn.net/huangwenhuan/article/details/130411626</a></p><p>Ceph中所有可配置的参数都定义在 <code>src/common/legacy_config_opts.h</code> 中，</p><p>参数在Ceph中以结构体形式保存，定义在 <code>src/common/options.h</code> 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Option</span> &#123;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">type_t</span> &#123;</span><br><span class="line">        TYPE_UINT,</span><br><span class="line">        TYPE_INT,</span><br><span class="line">        TYPE_STR,</span><br><span class="line">        TYPE_FLOAT,</span><br><span class="line">        TYPE_BOOL,</span><br><span class="line">        TYPE_ADDR,</span><br><span class="line">        TYPE_UUID,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Basic: for users, configures some externally visible functional aspect</span></span><br><span class="line"><span class="comment">	 * Advanced: for users, configures some internal behaviour</span></span><br><span class="line"><span class="comment">	 * Development: not for users.  May be dangerous, may not be documented.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">enum</span> <span class="title class_">level_t</span> &#123;</span><br><span class="line">    	LEVEL_BASIC,</span><br><span class="line">    	LEVEL_ADVANCED,</span><br><span class="line">    	LEVEL_DEV,</span><br><span class="line">  	&#125;;</span><br><span class="line">    <span class="keyword">using</span> <span class="type">value_t</span> = boost::variant&lt;</span><br><span class="line">    	boost::blank,</span><br><span class="line">    	std::string,</span><br><span class="line">    	<span class="type">uint64_t</span>,</span><br><span class="line">    	<span class="type">int64_t</span>,</span><br><span class="line">    	<span class="type">double</span>,</span><br><span class="line">   		<span class="type">bool</span>,</span><br><span class="line">    	<span class="type">entity_addr_t</span>,</span><br><span class="line">    	uuid_d&gt;;</span><br><span class="line">	<span class="type">const</span> std::string name;	<span class="comment">//参数名</span></span><br><span class="line">    <span class="type">const</span> <span class="type">type_t</span> type;		<span class="comment">//参数类型</span></span><br><span class="line">    <span class="type">const</span> <span class="type">level_t</span> level;	<span class="comment">//参数级别</span></span><br><span class="line">	std::string desc;		<span class="comment">// 该参数的含义</span></span><br><span class="line">    std::string long_desc;</span><br><span class="line">    <span class="type">value_t</span> value;			<span class="comment">//参数取值</span></span><br><span class="line">    <span class="type">value_t</span> daemon_value;	<span class="comment">//若此值非none，则以此值创建进程</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如 mon, osd, rgw, rbd, ceph-fuse 等组件。这是供可视化层使用的建议性元数据（比如dashboard或文档）</span></span><br><span class="line">    <span class="comment">// 以便它们了解应该在哪里展示哪些参数。</span></span><br><span class="line">    <span class="comment">// 另外：“common” 用于标识在任何 Ceph 代码中存在的设置。</span></span><br><span class="line">    <span class="comment">// 对于仅在某些地方共享的设置，不要使用 “common”，需要标注为相应的组件。</span></span><br><span class="line">    std::list&lt;<span class="type">const</span> <span class="type">char</span>*&gt; services;</span><br><span class="line">    <span class="comment">// 主题示例：</span></span><br><span class="line">    <span class="comment">// &quot;service&quot;：用于涵盖一些基本内容，如日志/asok 路径。</span></span><br><span class="line">    <span class="comment">// &quot;network&quot;</span></span><br><span class="line">    <span class="comment">// &quot;performance&quot;：根据环境/工作负载可能需要调整以获得最佳性能的设置。</span></span><br><span class="line">    std::list&lt;<span class="type">const</span> <span class="type">char</span>*&gt; tags;</span><br><span class="line">    std::list&lt;<span class="type">const</span> <span class="type">char</span>*&gt; see_also;</span><br><span class="line">    <span class="type">value_t</span> min, max;</span><br><span class="line">    std::list&lt;std::string&gt; enum_allowed;</span><br><span class="line">    <span class="type">bool</span> safe;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*其余的检查逻辑*/</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>在 <code>src/common/options.cc</code> 中，有参数的具体帮助信息</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> std::vector&lt;Option&gt; <span class="title">build_options</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  std::vector&lt;Option&gt; result = <span class="built_in">get_global_options</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> ingest = [&amp;result](std::vector&lt;Option&gt;&amp;&amp; options, <span class="type">const</span> <span class="type">char</span>* svc) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;o_in : options) &#123;</span><br><span class="line">      Option <span class="built_in">o</span>(o_in);</span><br><span class="line">      o.<span class="built_in">add_service</span>(svc);</span><br><span class="line">      result.<span class="built_in">push_back</span>(o);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ingest</span>(<span class="built_in">get_rgw_options</span>(), <span class="string">&quot;rgw&quot;</span>);</span><br><span class="line">  <span class="built_in">ingest</span>(<span class="built_in">get_rbd_options</span>(), <span class="string">&quot;rbd&quot;</span>);</span><br><span class="line">  <span class="built_in">ingest</span>(<span class="built_in">get_rbd_mirror_options</span>(), <span class="string">&quot;rbd-mirror&quot;</span>);</span><br><span class="line">  <span class="built_in">ingest</span>(<span class="built_in">get_mds_options</span>(), <span class="string">&quot;mds&quot;</span>);</span><br><span class="line">  <span class="built_in">ingest</span>(<span class="built_in">get_mds_client_options</span>(), <span class="string">&quot;mds_client&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>get_global_options()</code> 基本所有的模块都可以使用这些参数。</li><li><code>get_rgw_options()</code> 函数中的参数是给rgw模块使用。</li><li><code>get_rbd_options()</code> 函数和 <code>get_rbd_mirror_options()</code> 函数中的参数是给rbd相关模块使用。</li><li><code>get_mds_options()</code> 函数中的参数是给mds模块使用。<code>get_mds_client_options()</code>函数中的参数是给mds client模块使用。</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> std::vector&lt;Option&gt; ceph_options = <span class="built_in">build_options</span>();</span><br></pre></td></tr></table></figure><p>ceph_options这个向量包含了所有的参数，在任何地方，可以通过 <code>md_config_t</code> 这个结构体查看当前Ceph的参数配置</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">src/common/config.h</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">md_config_t</span> &#123;</span><br><span class="line">    <span class="comment">// 保存ceph_options中的所有Option参数</span></span><br><span class="line">    std::map&lt;std::string, <span class="type">const</span> Option &amp;&gt; schema;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此类表示当前的 Ceph 配置。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对于 Ceph 守护进程，这是守护进程的配置。日志级别、缓存设置、btrfs 设置等都可以在这里找到。</span></span><br><span class="line"><span class="comment"> * 对于 libcephfs 和 librados 用户，这是与他们的上下文关联的配置。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 关于此类如何从配置文件加载的信息，请参阅 common/ConfUtils。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 访问方式：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 有三种读取 ceph 上下文的方法——旧方法和两种新方法。旧方法中，代码会直接读取配置的公共变量，而不加锁。新方法 #1 中，代码注册一个配置观察者，</span></span><br><span class="line"><span class="comment"> * 当值发生变化时会收到回调。这些回调是在 md_config_t 锁保护下发生的。或者可以使用 get_val(const char *name) 方法安全地获取值的副本。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 为了避免因线程安全性问题导致的严重问题，当 md_config_t::internal_safe_to_start_threads 变为 true 后，我们禁止更改 std::string 类型的配置值。</span></span><br><span class="line"><span class="comment"> * 仍然可以更改整数或浮点数值，以及使用 SAFE_OPTION 宏声明的选项。请注意，后者的选项不能直接读取（如 conf-&gt;foo），应该使用观察者或 get_val()</span></span><br><span class="line"><span class="comment"> * 方法（如 conf-&gt;get_val(&quot;foo&quot;)）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> 我们实际上也不应该允许在另一个线程正在读取这些值时更改整数或浮点数值。</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h2 id="参数修改"><a href="#参数修改" class="headerlink" title="参数修改"></a>参数修改</h2><p>通过 <code>ceph daemon</code> 查看运行中进程的参数配置值或修改这些参数。永久配置方式，就是在配置文件 <code>ceph.conf</code> 中添加该参数配置，重启进程后，参数才生效。临时方式，就是通过 <code>ceph daemon</code> 设置内存中的参数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在N版以上，可以config <span class="built_in">set</span>持久化配置，重启后生效</span></span><br><span class="line">ceph config set &lt;role&gt; &lt;key&gt; &lt;value&gt; 的方式在当前版本不适用</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于L版</span></span><br><span class="line">首先没有&lt;role&gt;</span><br><span class="line">其次，ceph config set &lt;key&gt; &lt;value&gt;，尝试osd_num_shards，重启之后并没有生效</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_59586152/article/details/127925028">https://blog.csdn.net/m0_59586152/article/details/127925028</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">xxx为 admin_socket = <span class="variable">$rundir</span>/<span class="variable">$cluster</span>-<span class="variable">$id</span>.asok (/run/ceph/ceph-osd.0.asok)</span></span><br><span class="line">ceph daemon xxx config show | grep []</span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-osd.0.asok config show |grep []</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">二者是等价的，都是修改内存中临时参数配置值</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">任何节点临时修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># ceph tell命令会通过 monitor 起作用</span></span></span><br><span class="line">ceph tell &lt;role&gt;.* injectargs --&lt;name&gt;=&lt;value&gt;</span><br><span class="line">ceph tell /run/ceph/ceph-osd.0.asok injectargs --debug-osd 0/5</span><br><span class="line"></span><br><span class="line">ceph tell mon.mon01 injectargs &#x27;--osd_max_write_size=95&#x27;</span><br><span class="line">ceph tell osd.* injectargs &#x27;--osd_recovery_max_active=1 --osd_recovery_max_single_start=l --osd_recovery_op_priority=50&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要到该进程节点上修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 如果你不能绑定 monitor，仍可以登录你要改的那台主机然后用 ceph daemon 来更改</span></span></span><br><span class="line">ceph --admin-daemon /var/run/ceph/ceph-mon.node1.asok config set &lt;name&gt; &lt;value&gt;</span><br><span class="line">ceph daemon /run/ceph/ceph-osd.0.asok config set debug_osd 0/5</span><br><span class="line">ceph daemon &lt;role&gt;.* config set debug_osd 0/5</span><br></pre></td></tr></table></figure><p>若持久化，需要写入配置文件；同步配置文件；重启mon服务</p><ol><li><p>写入 <code>ceph.conf</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">fsid = 4b0fbef4-9617-41d1-94f4-05efb32d5d32</span><br><span class="line">mon_initial_members = node-1</span><br><span class="line">mon_host = 10.0.0.92</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line">auth_allow_insecure_global_id_reclaim = false</span><br><span class="line">public_network = 10.0.0.0/24</span><br><span class="line">cluster_network = 10.0.0.0/24</span><br><span class="line">mon_allow_pool_delete = true</span><br></pre></td></tr></table></figure></li><li><p>同步配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf config push node1 xxx</span><br></pre></td></tr></table></figure></li><li><p>重启mon服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for I in &#123;1..xxx&#125;: do ssh node$&#123;I&#125; systemctl restart ceph-mon.target;done</span><br></pre></td></tr></table></figure></li></ol><h2 id="内核参数修改——避免成为瓶颈"><a href="#内核参数修改——避免成为瓶颈" class="headerlink" title="内核参数修改——避免成为瓶颈"></a>内核参数修改——避免成为瓶颈</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kernel pid max,</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">OSD &gt; 20 在恢复和再平衡过程中会生成很多进程和线程用于快速的数据恢复和再平衡</span></span><br><span class="line">echo 4194303 &gt; /proc/sys/kernel/pid_max</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭内存swap</span></span><br><span class="line">echo &quot;vm.swappiness = 0&quot;/&gt;etc/sysctl.conf ; sysctl –p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">I/O Scheduler，SSD要用noop，SATA/SAS使用deadline</span></span><br><span class="line">echo &quot;deadline&quot; &gt;/sys/block/sd[x]/queue/scheduler </span><br><span class="line">echo &quot;noop&quot; &gt;/sys/block/sd[x]/queue/scheduler</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最大打开文件数</span></span><br><span class="line">xxx</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过数据预读并且记载到随机访问内存方式提高磁盘读操作</span></span><br><span class="line">echo &quot;8192&quot; &gt; /sys/block/sda/queue/read_ahead_kb</span><br></pre></td></tr></table></figure><p><strong>PG 数计算公式</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Total PGs = (Total_number_of_OSD * 100) / max_replication_count</span><br><span class="line"></span><br><span class="line">5*100/3=166 -&gt; 128</span><br></pre></td></tr></table></figure><h2 id="Ceph配置经验"><a href="#Ceph配置经验" class="headerlink" title="Ceph配置经验"></a>Ceph配置经验</h2><p><a target="_blank" rel="noopener" href="https://www.yangguanjun.com/2017/05/15/Ceph-configuration/">https://www.yangguanjun.com/2017/05/15/Ceph-configuration/</a></p><h3 id="引导参数"><a href="#引导参数" class="headerlink" title="引导参数"></a>引导参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通常是通过ceph-deploy生成的，都是ceph monitor相关的参数，不用修改；</span></span><br><span class="line">fsid = 6d529c3d-5745-4fa5-be5f-3962a8e8687c</span><br><span class="line">mon_initial_members = mon1, mon2, mon3</span><br><span class="line">mon_host = 10.10.40.67,10.10.40.68,10.10.40.69</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网络配置参数</span></span><br><span class="line">public_network = 10.10.40.0/24    默认值 &quot;&quot;</span><br><span class="line">cluster_network = 10.10.41.0/24  默认值 &quot;&quot;</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/master/rados/configuration/network-config-ref/">http://docs.ceph.com/docs/master/rados/configuration/network-config-ref/</a></p><p><strong>public network：monitor与osd，client与monitor，client与osd通信的网络，最好配置为带宽较高的万兆网络；</strong></p><p><strong>cluster network：OSD之间通信的网络，一般配置为带宽较高的万兆网络；</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">认证配置参数</span></span><br><span class="line">auth_service_required = none    默认值 &quot;cephx&quot;</span><br><span class="line">auth_client_required = none     默认值 &quot;cephx, none&quot;</span><br><span class="line">auth_cluster_required = none   默认值 &quot;cephx&quot;</span><br></pre></td></tr></table></figure><p>默认值为开启ceph认证；</p><p><strong>在内部使用的ceph集群中一般配置为none，即不使用认证，这样能适当加快ceph集群访问速度；</strong></p><h3 id="global参数"><a href="#global参数" class="headerlink" title="global参数"></a>global参数</h3><h4 id="objecter"><a href="#objecter" class="headerlink" title="objecter"></a>objecter</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objecter_inflight_ops = 10240               默认值 1024</span><br><span class="line">objecter_inflight_op_bytes = 1048576000     默认值 100M</span><br></pre></td></tr></table></figure><p>osd client端objecter的throttle配置，它的配置会影响librbd，RGW端的性能；</p><p><strong>配置建议：</strong> 调大这两个值</p><h4 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h4><p>每一个Ceph子系统有自己的输出日志等级，并记录在内存中。</p><p>可以给日志设置一个log文件等级和内存等级，第一个设置是日志等级，第二个配置是内存等级 <code>debug&lt;subsystem&gt; = &lt;log-level&gt;/&lt;memory-level&gt;</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">debug_lockdep = 0/0</span><br><span class="line">debug_context = 0/0</span><br><span class="line">debug_crush = 0/0</span><br><span class="line">debug_buffer = 0/0</span><br><span class="line">debug_timer = 0/0</span><br><span class="line">debug_filer = 0/0</span><br><span class="line">debug_objecter = 0/0</span><br><span class="line">debug_rados = 0/0</span><br><span class="line">debug_rbd = 0/0</span><br><span class="line">debug_journaler = 0/0</span><br><span class="line">debug_objectcatcher = 0/0</span><br><span class="line">debug_client = 0/0</span><br><span class="line">debug_osd = 0/0</span><br><span class="line">debug_optracker = 0/0</span><br><span class="line">debug_objclass = 0/0</span><br><span class="line">debug_filestore = 0/0</span><br><span class="line">debug_journal = 0/0</span><br><span class="line">debug_ms = 0/0</span><br><span class="line">debug_mon = 0/0</span><br><span class="line">debug_monc = 0/0</span><br><span class="line">debug_tp = 0/0</span><br><span class="line">debug_auth = 0/0</span><br><span class="line">debug_finisher = 0/0</span><br><span class="line">debug_heartbeatmap = 0/0</span><br><span class="line">debug_perfcounter = 0/0</span><br><span class="line">debug_asok = 0/0</span><br><span class="line">debug_throttle = 0/0</span><br><span class="line">debug_paxos = 0/0</span><br><span class="line">debug_rgw = 0/0</span><br></pre></td></tr></table></figure><p>关闭了所有的debug信息，能一定程度加快ceph集群速度，但也会丢失一些关键log，出问题的时候不好分析；</p><h3 id="osd相关参数"><a href="#osd相关参数" class="headerlink" title="osd相关参数"></a>osd相关参数</h3><h4 id="osd-pool"><a href="#osd-pool" class="headerlink" title="osd pool"></a>osd pool</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pool size配置参数</span></span><br><span class="line">一般配置为3和1，3副本能足够保证数据的可靠性；</span><br><span class="line">osd_pool_default_size = 3       默认值 3</span><br><span class="line">osd_pool_default_min_size = 1  默认值 0 // 0 means no specific default; ceph will use size-size/2</span><br></pre></td></tr></table></figure><h4 id="osd-down"><a href="#osd-down" class="headerlink" title="osd down"></a>osd down</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph标记一个osd为down and out的最大时间间隔</span></span><br><span class="line">mon_osd_down_out_interval = 864000  默认值 300 // seconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon标记一个osd为down的最小reporters个数（报告该osd为down的其他osd为一个reporter）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在一个大集群中，建议使用一个比缺省值大的值，3是一个不错的值</span></span><br><span class="line">mon_osd_min_down_reporters = 2      默认值 2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon标记一个osd为down的最长等待时间</span></span><br><span class="line">mon_osd_report_timeout = 900        默认值 900</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd发送heartbeat给其他osd的间隔时间（同一PG之间的osd才会有heartbeat）</span></span><br><span class="line">osd_heartbeat_interval = 15         默认值 6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd报告其他osd为down的最大时间间隔，grace调大，也有副作用，如果某个osd异常退出，等待其他osd上报的时间必须为grace，在这段时间段内，这个osd负责的pg的io会hang住，所以尽量不要将grace调的太大。</span></span><br><span class="line">osd_heartbeat_grace = 60            默认值 20</span><br></pre></td></tr></table></figure><p>基于实际情况合理配置上述参数，能减少或及时发现osd变为down（降低IO hang住的时间和概率），延长osd变为down and out的时间（防止网络抖动造成的数据recovery）；</p><h4 id="osd-op"><a href="#osd-op" class="headerlink" title="osd op"></a>osd op</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">osd_enable_op_tracker = false       默认值 true</span><br><span class="line">osd_num_op_tracker_shard = 32       默认值 32</span><br><span class="line">osd_op_threads = 10                 默认值 2</span><br><span class="line">osd_disk_threads = 1                默认值 1</span><br><span class="line">osd_op_num_shards = 32                 默认值 5</span><br><span class="line">osd_op_num_threads_per_shard = 2    默认值 2</span><br></pre></td></tr></table></figure><p><code>osd_enable_op_tracker</code>：追踪osd op状态的配置参数，默认为true；不建议关闭，关闭后osd的 slow_request，ops_in_flight，historic_ops 无法正常统计；</p><p>打开op tracker后，若集群iops很高，<code>osd_num_op_tracker_shard</code>可以适当调大，因为每个shard都有个独立的mutex锁；</p><p><code>osd_op_threads</code>：对应的work queue有<code>peering_wq</code>（osd peering请求），<code>recovery_gen_wq</code>（PG recovery请求）；<br><code>osd_disk_threads</code>：对应的work queue为 <code>remove_wq</code>（PG remove请求）；<br><code>osd_op_num_shards</code>和<code>osd_op_num_threads_per_shard</code>：对应的thread pool为<code>osd_op_tp</code>，work queue为<code>op_shardedwq</code>；</p><p>处理的请求包括：</p><ol><li><code>OpRequestRef</code></li><li><code>PGSnapTrim</code></li><li><code>PGScrub</code></li></ol><p>调大<code>osd_op_num_shards</code>可以增大osd ops的处理线程数，增大并发性，提升OSD性能；</p><h4 id="osd-client-message"><a href="#osd-client-message" class="headerlink" title="osd client message"></a>osd client message</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> client data allowed in-memory (<span class="keyword">in</span> bytes)</span></span><br><span class="line">osd_client_message_size_cap = 1048576000    默认值 500*1024L*1024L     </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">num client messages allowed in-memory</span></span><br><span class="line">osd_client_message_cap = 10000              默认值 100     </span><br></pre></td></tr></table></figure><p>这个是osd端收到client messages的capacity配置，配置大的话能提升osd的处理能力，但会占用较多的系统内存；</p><p><strong>配置建议：</strong><br>服务器内存足够大的时候，适当增大这两个值</p><h4 id="osd-scrub"><a href="#osd-scrub" class="headerlink" title="osd scrub"></a>osd scrub</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">osd_scrub_begin_hour = 2                默认值 0</span><br><span class="line">osd_scrub_end_hour = 6                   默认值 24</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The time <span class="keyword">in</span> seconds that scrubbing sleeps between two consecutive scrubs</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sleep</span> between [deep]scrub ops</span></span><br><span class="line">osd_scrub_sleep = 2                       默认值 0 </span><br><span class="line"></span><br><span class="line">osd_scrub_load_threshold = 5            默认值 0.5</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">chunky scrub配置的最小/最大objects数，以下是默认值</span></span><br><span class="line">osd_scrub_chunk_min = 5</span><br><span class="line">osd_scrub_chunk_max = 25</span><br></pre></td></tr></table></figure><p>Ceph osd scrub是保证ceph数据一致性的机制，scrub以PG为单位，但每次scrub会获取PG lock，所以它可能会影响PG正常的IO；</p><p>Ceph后来引入了chunky的scrub模式，每次scrub只会选取PG的一部分objects，完成后释放PG lock，并把下一次的PG scrub加入队列；这样能很好的减少PG scrub时候占用PG lock的时间，避免过多影响PG正常的IO；</p><p>同理，引入的<code>osd_scrub_sleep</code>参数会让线程在每次scrub前释放PG lock，然后睡眠一段时间，也能很好的减少scrub对PG正常IO的影响；</p><p><strong>配置建议：</strong></p><ul><li><code>osd_scrub_begin_hour</code>和<code>osd_scrub_end_hour</code>：OSD Scrub的开始结束时间，根据具体业务指定；</li><li><code>osd_scrub_sleep</code>：osd在每次执行scrub时的睡眠时间；有个bug跟这个配置有关，建议关闭；</li><li><code>osd_scrub_load_threshold</code>：osd开启scrub的系统load阈值，根据系统的load average值配置该参数；</li><li><code>osd_scrub_chunk_min</code>和<code>osd_scrub_chunk_max</code>：根据PG中object的个数配置；针对RGW全是小文件的情况，这两个值需要调大；</li></ul><p><strong>参考：</strong><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ea2296e1555c">http://www.jianshu.com/p/ea2296e1555c</a><br><a target="_blank" rel="noopener" href="http://tracker.ceph.com/issues/19497">http://tracker.ceph.com/issues/19497</a></p><h4 id="osd-thread-timeout"><a href="#osd-thread-timeout" class="headerlink" title="osd thread timeout"></a>osd thread timeout</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">osd_op_thread_timeout = 580               默认值 15</span><br><span class="line">osd_op_thread_suicide_timeout = 600         默认值 150</span><br><span class="line"></span><br><span class="line">osd_recovery_thread_timeout = 580           默认值 30</span><br><span class="line">osd_recovery_thread_suicide_timeout = 600   默认值 300</span><br></pre></td></tr></table></figure><p><code>osd_op_thread_timeout</code>和<code>osd_op_thread_suicide_timeout</code>关联的work queue为：</p><ul><li><code>op_shardedwq</code> - 关联的请求为：<code>OpRequestRef</code>，<code>PGSnapTrim</code>，<code>PGScrub</code></li><li><code>peering_wq</code> - 关联的请求为：osd peering</li></ul><p><code>osd_recovery_thread_timeout</code>和<code>osd_recovery_thread_suicide_timeout</code>关联的work queue为：</p><ul><li><code>recovery_wq</code> - 关联的请求为：PG recovery</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Pool of threads that share work submitted to multiple work queues.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> : <span class="keyword">public</span> <span class="type">md_config_obs_t</span> &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/// Basic interface to a work queue used by the worker threads.</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">WorkQueue_</span> &#123;</span><br><span class="line">        string name;</span><br><span class="line">        <span class="type">time_t</span> timeout_interval, suicide_interval;</span><br><span class="line">        <span class="built_in">WorkQueue_</span>(string n, <span class="type">time_t</span> ti, <span class="type">time_t</span> sti)</span><br><span class="line">            : <span class="built_in">name</span>(n), <span class="built_in">timeout_interval</span>(ti), <span class="built_in">suicide_interval</span>(sti)</span><br><span class="line">        &#123; &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这里的 <code>timeout_interval</code> 和 <code>suicide_interval</code> 分别对应上面所述的配置 <code>timeout</code> 和 <code>suicide_timeout</code> ；<br>当thread处理work queue中的一个请求时，会受到这两个timeout时间的限制：</p><ul><li><code>timeout_interval</code> - 到时间后设置 <code>m_unhealthy_workers+1</code></li><li><code>suicide_interval</code> - 到时间后调用assert，OSD进程crush</li></ul><p>对应的处理函数为：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> HeartbeatMap::_check(<span class="type">const</span> heartbeat_handle_d *h, <span class="type">const</span> <span class="type">char</span> *who, <span class="type">time_t</span> now)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> healthy = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">time_t</span> was;</span><br><span class="line">    was = h-&gt;timeout.<span class="built_in">read</span>();</span><br><span class="line">    <span class="keyword">if</span> (was &amp;&amp; was &lt; now) &#123;</span><br><span class="line">        <span class="built_in">ldout</span>(m_cct, <span class="number">1</span>) &lt;&lt; who &lt;&lt; <span class="string">&quot; &#x27;&quot;</span> &lt;&lt; h-&gt;name &lt;&lt; <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">                        &lt;&lt; <span class="string">&quot; had timed out after &quot;</span> &lt;&lt; h-&gt;grace &lt;&lt; dendl;</span><br><span class="line">        healthy = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    was = h-&gt;suicide_timeout.<span class="built_in">read</span>();</span><br><span class="line">    <span class="keyword">if</span> (was &amp;&amp; was &lt; now) &#123;</span><br><span class="line">        <span class="built_in">ldout</span>(m_cct, <span class="number">1</span>) &lt;&lt; who &lt;&lt; <span class="string">&quot; &#x27;&quot;</span> &lt;&lt; h-&gt;name &lt;&lt; <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">                        &lt;&lt; <span class="string">&quot; had suicide timed out after &quot;</span> &lt;&lt; h-&gt;suicide_grace &lt;&lt; dendl;</span><br><span class="line">        <span class="built_in">assert</span>(<span class="number">0</span> == <span class="string">&quot;hit suicide timeout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> healthy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当前仅有RGW添加了worker的perfcounter，所以也只有RGW可以通过perf dump查看total/unhealthy的worker信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ yangguanjun]# ceph daemon /var/run/ceph/ceph-client.rgw.rgwdaemon.asok perf dump | grep worker</span><br><span class="line">        &quot;total_workers&quot;: 32,</span><br><span class="line">        &quot;unhealthy_workers&quot;: 0</span><br></pre></td></tr></table></figure><p><strong>配置建议：</strong></p><ul><li><code>*_thread_timeout</code>：这个值配置越小越能及时发现处理慢的请求，所以不建议配置很大；特别是针对速度快的设备，建议调小该值；</li><li><code>*_thread_suicide_timeout</code>：这个值配置小了会导致超时后的OSD crush，所以建议调大；特别是在对应的throttle调大后，更应该调大该值；</li></ul><h3 id="bluestore"><a href="#bluestore" class="headerlink" title="bluestore"></a>bluestore</h3><h4 id="osd-op-num-shards"><a href="#osd-op-num-shards" class="headerlink" title="osd_op_num_shards"></a>osd_op_num_shards</h4><p><img src="/posts/148510794/task4_2.png" alt="img"></p><p><img src="/posts/148510794/task4_3.png" alt="img"></p><p><strong>get_num_op_shards()</strong> 获取OSD::op_shardedwq中存储操作的队列个数</p><ul><li>当<strong>osd_op_num_shards</strong>为true时，返回<strong>osd_op_num_shards</strong>的值</li><li>否则就看返回<strong>osd_op_num_shards_hdd</strong>或<strong>osd_op_num_shards_ssd</strong>的值<ul><li><strong>store_is_rotational</strong>是bool类型，表示设备属性（默认是true也即是hdd）</li></ul></li></ul><p><strong>get_num_op_threads()</strong>，获取OSD::op_shardedwq中每个队列的操作分发线程数</p><p><code>总线程数=队列数*每个队列线程数</code></p><p><code>总线程数=osd_op_num_shards_ssd*osd_op_num_threads_per_shard_ssd=2*2=4</code></p><p>在客户端运行fio的4k-randwrite操作，同时在服务端多次运行 <code>top -H -p $pid -n 1 | grep tp_osd_tp</code> ，计算有多少个线程，看得出一直都是4个线程</p><p><img src="/posts/148510794/task4_6.png" alt="img"></p><p><img src="/posts/148510794/task4_7.png" alt="img"></p><p><img src="/posts/148510794/task4_8.png" alt="img"></p><h3 id="filestore"><a href="#filestore" class="headerlink" title="filestore"></a>filestore</h3><h4 id="filestore-merge-split"><a href="#filestore-merge-split" class="headerlink" title="filestore merge/split"></a>filestore merge/split</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filestore_merge_threshold = -1       默认值 10</span><br><span class="line">filestore_split_multiple = 16000      默认值 2</span><br></pre></td></tr></table></figure><p>这两个参数是管理filestore的目录分裂/合并的，filestore的每个目录允许的最大文件数为：<br><code>filestore_split_multiple * abs(filestore_merge_threshold) * 16</code></p><p>在RGW的小文件应用场景，会很容易达到默认配置的文件数（320），若在写的过程中触发了filestore的分裂，则会非常影响filestore的性能；</p><p>每次filestore的目录分裂，会依据如下规则分裂为多层目录，最底层16个子目录：</p><p>原始目录下的object会根据规则放到不同的子目录里，object的名称格式为: <code>*__head_xxxxX4C0_*</code>，分裂时候X是几，就放进子目录DIR_X里。比如object：<code>*__head_xxxxA4C0_*</code>, 就放进子目录 <code>DIR_0/DIR_C/DIR_4/DIR_A</code> 里；</p><p><strong>解决办法：</strong></p><ol><li>增大merge/split配置参数的值，使单个目录容纳更多的文件；</li><li><code>filestore_merge_threshold</code>配置为负数；这样会提前触发目录的预分裂，避免目录在某一时间段的集中分裂，详细机制没有调研；</li><li>创建pool时指定<code>expected-num-objects</code>；这样会依据目录分裂规则，在创建pool的时候就创建分裂的子目录，避免了目录分裂对filestore性能的影响；</li></ol><h4 id="filestore-fd-cache"><a href="#filestore-fd-cache" class="headerlink" title="filestore fd cache"></a>filestore fd cache</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filestore_fd_cache_shards =  32     默认值 16     // FD number of shardsfilestore_fd_cache_size = 32768     默认值 128  // FD lru size</span><br></pre></td></tr></table></figure><p>filestore的fd cache是加速访问filestore里的file的，在非一次性写入的应用场景，增大配置可以很明显的提升filestore的性能；</p><h4 id="filestore-sync"><a href="#filestore-sync" class="headerlink" title="filestore sync"></a>filestore sync</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># SSD的时候建议关闭, 默认值 true   </span><br><span class="line">filestore_wbthrottle_enable = false         </span><br><span class="line"># 最小同步间隔秒数，sync fs的数据到disk，FileStore::sync_entry()</span><br><span class="line"># 默认值 0.01 s   </span><br><span class="line">filestore_min_sync_interval = 5</span><br><span class="line"># 最大同步间隔秒数，sync fs的数据到disk，FileStore::sync_entry()</span><br><span class="line"># 默认值 5 s </span><br><span class="line">filestore_max_sync_interval = 10     </span><br><span class="line"># FileStore::sync_entry() 里 new SyncEntryTimeout(m_filestore_commit_timeout)</span><br><span class="line"># 默认值 600 s       </span><br><span class="line">filestore_commit_timeout = 3000         </span><br></pre></td></tr></table></figure><p><code>filestore_wbthrottle_enable</code>的配置是关于filestore writeback throttle的，即我们说的filestore处理workqueue <code>op_wq</code>的数据量阈值；默认值是true，开启后XFS相关的配置参数有：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_bytes_start_flusher, OPT_U64, <span class="number">41943040</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_bytes_hard_limit, OPT_U64, <span class="number">419430400</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_ios_start_flusher, OPT_U64, <span class="number">500</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_ios_hard_limit, OPT_U64, <span class="number">5000</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_inodes_start_flusher, OPT_U64, <span class="number">500</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(filestore_wbthrottle_xfs_inodes_hard_limit, OPT_U64, <span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>若使用普通HDD，可以保持其为true；针对SSD，建议将其关闭，不开启writeback throttle；</p><p><code>filestore_min_sync_interval</code>和<code>filestore_max_sync_interval</code>是配置filestore flush outstanding IO到disk的时间间隔的；增大配置可以让系统做尽可能多的IO merge，减少filestore写磁盘的压力，但也会增大page cache占用内存的开销，增大数据丢失的可能性；</p><p><code>filestore_commit_timeout</code>是配置filestore sync entry到disk的超时时间，在filestore压力很大时，调大这个值能尽量避免IO超时导致OSD crush；</p><h4 id="filestore-throttle"><a href="#filestore-throttle" class="headerlink" title="filestore throttle"></a>filestore throttle</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># Expected filestore throughput in B/s</span><br><span class="line">## 默认值 200MB </span><br><span class="line">filestore_expected_throughput_bytes =  536870912          </span><br><span class="line"># Expected filestore throughput in ops/s</span><br><span class="line">## 默认值 200</span><br><span class="line">filestore_expected_throughput_ops = 2500  </span><br><span class="line">#  默认值 100MB</span><br><span class="line">filestore_queue_max_bytes= 1048576000         </span><br><span class="line"># 默认值 50</span><br><span class="line">filestore_queue_max_ops = 5000                          </span><br><span class="line"> </span><br><span class="line"># Use above to inject delays intended to keep the op queue between low and high</span><br><span class="line">## 默认值 0.3</span><br><span class="line">filestore_queue_low_threshhold = 0.6</span><br><span class="line">## 默认值 0.9</span><br><span class="line">filestore_queue_high_threshhold = 0.9                   </span><br><span class="line"></span><br><span class="line"># Filestore high delay multiple.  Defaults to 0 (disabled)</span><br><span class="line">## 默认值 0  </span><br><span class="line">filestore_queue_high_delay_multiple = 2</span><br><span class="line"># Filestore max delay multiple.  Defaults to 0 (disabled) </span><br><span class="line">## 默认值 0</span><br><span class="line">filestore_queue_max_delay_multiple = 10</span><br></pre></td></tr></table></figure><p>在jewel版本里，引入了dynamic throttle，来平滑普通throttle带来的长尾效应问题；</p><p>一般在使用普通磁盘时，之前的throttle机制即可很好的工作，所以这里默认<code>filestore_queue_high_delay_multiple</code>和<code>filestore_queue_max_delay_multiple</code>都为0；</p><p>针对高速磁盘，需要在部署之前，通过小工具<code>ceph_smalliobenchfs</code>来测试下，获取合适的配置参数；</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">BackoffThrottle的介绍如下：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* BackoffThrottle</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Creates a throttle which gradually induces delays when get() is called</span></span><br><span class="line"><span class="comment">* based on params low_threshhold, high_threshhold, expected_throughput,</span></span><br><span class="line"><span class="comment">* high_multiple, and max_multiple.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [0, low_threshhold), we want no delay.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [low_threshhold, high_threshhold), delays should be injected based</span></span><br><span class="line"><span class="comment">* on a line from 0 at low_threshhold to</span></span><br><span class="line"><span class="comment">* high_multiple * (1/expected_throughput) at high_threshhold.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* In [high_threshhold, 1), we want delays injected based on a line from</span></span><br><span class="line"><span class="comment">* (high_multiple * (1/expected_throughput)) at high_threshhold to</span></span><br><span class="line"><span class="comment">* (high_multiple * (1/expected_throughput)) +</span></span><br><span class="line"><span class="comment">* (max_multiple * (1/expected_throughput)) at 1.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Let the current throttle ratio (current/max) be r, low_threshhold be l,</span></span><br><span class="line"><span class="comment">* high_threshhold be h, high_delay (high_multiple / expected_throughput) be e,</span></span><br><span class="line"><span class="comment">* and max_delay (max_muliple / expected_throughput) be m.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* delay = 0, r \in [0, l)</span></span><br><span class="line"><span class="comment">* delay = (r - l) * (e / (h - l)), r \in [l, h)</span></span><br><span class="line"><span class="comment">* delay = h + (r - h)((m - e)/(1 - h))</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p><strong>参考：</strong><br><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/jewel/dev/osd_internals/osd_throttles/">http://docs.ceph.com/docs/jewel/dev/osd_internals/osd_throttles/</a><br><a target="_blank" rel="noopener" href="http://blog.wjin.org/posts/ceph-dynamic-throttle.html">http://blog.wjin.org/posts/ceph-dynamic-throttle.html</a><br><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/blob/master/src/doc/dynamic-throttle.txt">https://github.com/ceph/ceph/blob/master/src/doc/dynamic-throttle.txt</a><br><a target="_blank" rel="noopener" href="https://www.yangguanjun.com/2017/05/15/Ceph-configuration/Ceph-BackoffThrottle.md">Ceph BackoffThrottle分析</a></p><h4 id="filestore-finisher-threads"><a href="#filestore-finisher-threads" class="headerlink" title="filestore finisher threads"></a>filestore finisher threads</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filestore_ondisk_finisher_threads = 2   默认值 1</span><br><span class="line">filestore_apply_finisher_threads = 2   默认值 1</span><br></pre></td></tr></table></figure><p>这两个参数定义filestore commit/apply的finisher处理线程数，默认都为1，任何IO commit/apply完成后，都需要经过对应的ondisk/apply finisher thread处理；</p><p>在使用普通HDD时，磁盘性能是瓶颈，单个finisher thread就能处理好；<br>但在使用高速磁盘的时候，IO完成比较快，单个finisher thread不能处理这么多的IO commit/apply reply，它会成为瓶颈；所以在jewel版本里引入了finisher thread pool的配置，这里一般配置为2即可；</p><h4 id="journal"><a href="#journal" class="headerlink" title="journal"></a>journal</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">journal_max_write_bytes=<span class="number">1048576000</span>          默认值 <span class="number">10</span>M    </span><br><span class="line">journal_max_write_entries=<span class="number">5000</span>                默认值 <span class="number">100</span></span><br><span class="line"></span><br><span class="line"># Multiple over expected at high_threshhold. Defaults to <span class="number">0</span> (disabled).</span><br><span class="line">## 默认值 <span class="number">0</span></span><br><span class="line">journal_throttle_high_multiple = <span class="number">2</span></span><br><span class="line"># Multiple over expected at max.  Defaults to <span class="number">0</span> (disabled).</span><br><span class="line">## 默认值 <span class="number">0</span> </span><br><span class="line">journal_throttle_max_multiple = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"># Target range <span class="keyword">for</span> journal fullness</span><br><span class="line"><span class="built_in">OPTION</span>(journal_throttle_low_threshhold, OPT_DOUBLE, <span class="number">0.6</span>)</span><br><span class="line"><span class="built_in">OPTION</span>(journal_throttle_high_threshhold, OPT_DOUBLE, <span class="number">0.9</span>)</span><br></pre></td></tr></table></figure><p><code>journal_max_write_bytes</code>和<code>journal_max_write_entries</code>是journal一次write的数据量和entries限制；<br>针对SSD分区做journal的情况，这两个值要增大，这样能增大journal的吞吐量；</p><p><code>journal_throttle_high_multiple</code>和<code>journal_throttle_max_multiple</code>是<code>JournalThrottle</code>的配置参数，<code>JournalThrottle</code>是<code>BackoffThrottle</code>的封装类，所以<code>JournalThrottle</code>与我们在filestore throttle介绍的dynamic throttle工作原理一样；</p><h3 id="rbd-cache"><a href="#rbd-cache" class="headerlink" title="rbd cache"></a>rbd cache</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"># cache size in bytes </span><br><span class="line">## 默认值 32M</span><br><span class="line">rbd_cache_size = 134217728</span><br><span class="line"># dirty limit in bytes - set to 0 for write-through caching</span><br><span class="line">## 默认值 24M</span><br><span class="line">rbd_cache_max_dirty = 100663296</span><br><span class="line"># target dirty limit in bytes</span><br><span class="line">## 默认值 16M</span><br><span class="line">rbd_cache_target_dirty = 67108864</span><br><span class="line"># whether to make writeback caching writethrough until flush is called, to be sure the user of librbd will send flushs so that writeback is safe</span><br><span class="line">## 默认值 true</span><br><span class="line">rbd_cache_writethrough_until_flush = true</span><br><span class="line"># seconds in cache before writeback starts</span><br><span class="line">## 默认值 1.0</span><br><span class="line">rbd_cache_max_dirty_age = 5              </span><br></pre></td></tr></table></figure><p><code>rbd_cache_size</code>：client端每个rbd image的cache size，不需要太大，可以调整为64M，不然会比较占client端内存；<br>参照默认值，根据<code>rbd_cache_size</code>的大小调整<code>rbd_cache_max_dirty</code>和<code>rbd_cache_target_dirty</code>；</p><ul><li><code>rbd_cache_max_dirty</code>：在writeback模式下cache的最大bytes数，默认是24MB；当该值为0时，表示使用writethrough模式；</li><li><code>rbd_cache_target_dirty</code>：在writeback模式下cache向ceph集群写入的bytes阀值，默认16MB；注意该值一定要小于<code>rbd_cache_max_dirty</code>值</li></ul><p><code>rbd_cache_writethrough_until_flush</code>：在内核触发flush cache到ceph集群前rbd cache一直是writethrough模式，直到flush后rbd cache变成writeback模式；<br><code>rbd_cache_max_dirty_age</code>：标记OSDC端ObjectCacher中entry在cache中的最长时间；</p><p><a target="_blank" rel="noopener" href="https://my.oschina.net/linuxhunter/blog/541997">https://my.oschina.net/linuxhunter/blog/541997</a></p><h3 id="ceph-rgw"><a href="#ceph-rgw" class="headerlink" title="ceph rgw"></a>ceph rgw</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 默认值 &quot;fastcgi, civetweb port=7480&quot;</span><br><span class="line">rgw_frontends = &quot;civetweb port=10080 num_threads=2000&quot; </span><br><span class="line"># 默认值 100</span><br><span class="line">rgw_thread_pool_size = 512   </span><br><span class="line"># 默认值 0</span><br><span class="line">rgw_override_bucket_index_max_shards = 20               </span><br><span class="line"></span><br><span class="line"># 默认值 512 * 1024</span><br><span class="line">rgw_max_chunk_size = 1048576</span><br><span class="line"># num of entries in rgw cache</span><br><span class="line">## 默认值 10000</span><br><span class="line">rgw_cache_lru_size = 1000000</span><br><span class="line"># number of objects allowed</span><br><span class="line">## 默认值 -1 </span><br><span class="line">rgw_bucket_default_quota_max_objects = 10000000</span><br><span class="line">  </span><br><span class="line">rgw_dns_name = object-storage.ffan.com</span><br></pre></td></tr></table></figure><p><code>rgw_frontends</code>：rgw的前端配置，一般配置为使用轻量级的civetweb；prot为访问rgw的端口，根据实际情况配置；num_threads为civetweb的线程数；<br><code>rgw_thread_pool_size</code>：rgw前端web的线程数，与rgw_frontends中的num_threads含义一致，但num_threads 优于<code>rgw_thread_pool_size</code>的配置，两个只需要配置一个即可；<br><code>rgw_override_bucket_index_max_shards</code>：rgw bucket index object的最大shards数，增大这个值能减少bucket index object的访问时间，但也会加大bucket的ls时间；<br><code>rgw_max_chunk_size</code>：rgw最大chunk size，针对大文件的对象存储场景可以把这个值调大；<br><code>rgw_cache_lru_size</code>：rgw的lru cache size，对于读较多的应用场景，调大这个值能加快rgw的响应速度；<br><code>rgw_bucket_default_quota_max_objects</code>：配合该参数限制一个bucket的最大objects个数；</p><p><strong>参考：</strong><br><a target="_blank" rel="noopener" href="http://docs.ceph.com/docs/jewel/install/install-ceph-gateway/">http://docs.ceph.com/docs/jewel/install/install-ceph-gateway/</a><br><a target="_blank" rel="noopener" href="http://ceph-users.ceph.narkive.com/mdB90g7R/rgw-increase-the-first-chunk-size">http://ceph-users.ceph.narkive.com/mdB90g7R/rgw-increase-the-first-chunk-size</a><br><a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/2122231">https://access.redhat.com/solutions/2122231</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/148510794/" title="9.Ceph参数配置">https://amostian.github.io/posts/148510794/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 存储</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a> <a href="/tags/Ceph/" rel="tag"><i class="fa fa-tags"></i> Ceph</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/4103897705/" rel="prev" title="Python数据分析"><i class="fa fa-chevron-left"></i> Python数据分析</a></div><div class="post-nav-item"><a href="/posts/2201532693/" rel="next" title="2-MDP与有模型学习">2-MDP与有模型学习 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E6%9F%A5%E7%9C%8B"><span class="nav-text">参数查看</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E5%8F%96%E6%89%80%E6%9C%89%E5%8F%82%E6%95%B0"><span class="nav-text">提取所有参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E5%8F%82%E6%95%B0%E7%9A%84%E5%80%BC"><span class="nav-text">查看指定参数的值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E6%9F%A5%E7%9C%8B%E5%8F%82%E6%95%B0"><span class="nav-text">源码查看参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9"><span class="nav-text">参数修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E4%BF%AE%E6%94%B9%E2%80%94%E2%80%94%E9%81%BF%E5%85%8D%E6%88%90%E4%B8%BA%E7%93%B6%E9%A2%88"><span class="nav-text">内核参数修改——避免成为瓶颈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ceph%E9%85%8D%E7%BD%AE%E7%BB%8F%E9%AA%8C"><span class="nav-text">Ceph配置经验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%AF%BC%E5%8F%82%E6%95%B0"><span class="nav-text">引导参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#global%E5%8F%82%E6%95%B0"><span class="nav-text">global参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#objecter"><span class="nav-text">objecter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#debug"><span class="nav-text">debug</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#osd%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="nav-text">osd相关参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-pool"><span class="nav-text">osd pool</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-down"><span class="nav-text">osd down</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-op"><span class="nav-text">osd op</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-client-message"><span class="nav-text">osd client message</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-scrub"><span class="nav-text">osd scrub</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-thread-timeout"><span class="nav-text">osd thread timeout</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bluestore"><span class="nav-text">bluestore</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#osd-op-num-shards"><span class="nav-text">osd_op_num_shards</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#filestore"><span class="nav-text">filestore</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#filestore-merge-split"><span class="nav-text">filestore merge&#x2F;split</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filestore-fd-cache"><span class="nav-text">filestore fd cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filestore-sync"><span class="nav-text">filestore sync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filestore-throttle"><span class="nav-text">filestore throttle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filestore-finisher-threads"><span class="nav-text">filestore finisher threads</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#journal"><span class="nav-text">journal</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rbd-cache"><span class="nav-text">rbd cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-rgw"><span class="nav-text">ceph rgw</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">216</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">83</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">1150.8k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">46:51</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"live2d-widget-model-hijiki"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1})</script></body></html>