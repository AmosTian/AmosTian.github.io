<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="前置知识： [Mysql]"><meta property="og:type" content="article"><meta property="og:title" content="数据库集群"><meta property="og:url" content="https://amostian.github.io/posts/585434688/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="前置知识： [Mysql]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514111248038.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514151427711.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514153548893.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514153830060.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514153952154.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514154438688.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514155751760.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/908fa0ec08fa513d164b929b50889cfdb0fbd9fa.jpeg"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514185145352.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514230410356.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514230746384.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514190811759.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514190559653.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514191250201.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515181528512.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515203036827.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210514233050087.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515100356299.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515100404913.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515110843720.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515111443985.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515111933225.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515112257821.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515113126169.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515181100831.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515181140761.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515183337477.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515212002431.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515214802239.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515215119270.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515215231952.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515215323211.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515215406016.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210515221307866.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516102500140.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516102518531.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516102629805.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516102657130.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516162732043.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516165359586.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516165643429.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516214829252.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516215025537.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516215158759.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516222703096.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516223622529.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210516223734628.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517085633599.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517090516179.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517090620374.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517103523017.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517095921185.png"><meta property="og:image" content="https://amostian.github.io/posts/585434688/image-20210517100036048.png"><meta property="article:published_time" content="2022-04-03T03:26:07.000Z"><meta property="article:modified_time" content="2023-03-23T17:36:53.742Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="开发"><meta property="article:tag" content="Java项目"><meta property="article:tag" content="毕设项目"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/585434688/image-20210514111248038.png"><link rel="canonical" href="https://amostian.github.io/posts/585434688/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>数据库集群 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">58</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">74</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">353</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/585434688/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">数据库集群</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2022-04-03 11:26:07" itemprop="dateCreated datePublished" datetime="2022-04-03T11:26:07+08:00">2022-04-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2023-03-24 01:36:53" itemprop="dateModified" datetime="2023-03-24T01:36:53+08:00">2023-03-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/Java%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">Java项目</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/Java%E9%A1%B9%E7%9B%AE/%E6%AF%95%E8%AE%BE%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">毕设项目</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">8.3k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>30 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>前置知识：</p><p>[Mysql]</p></blockquote><span id="more"></span><h1 id="系统架构存在的问题"><a href="#系统架构存在的问题" class="headerlink" title="系统架构存在的问题"></a>系统架构存在的问题</h1><p><img src="/posts/585434688/image-20210514111248038.png" alt="image-20210514111248038"></p><p>DB Server 目前只是用了单节点服务，如果面对大并发，海量数据存储，单节点的系统架构存在很严重问题，需要实现 <code>Mysql集群</code> ，来应对大并发、海量数据存储问题</p><h1 id="Mysql-数据库的集群方案"><a href="#Mysql-数据库的集群方案" class="headerlink" title="Mysql 数据库的集群方案"></a>Mysql 数据库的集群方案</h1><h2 id="读写分离架构"><a href="#读写分离架构" class="headerlink" title="读写分离架构"></a>读写分离架构</h2><p>一般应用对数据库而言都是 “读多写少” ，也就是数据库读取数据的压力比较大。</p><blockquote><p>采用数据库集群方案：</p><p>其中一个是 <code>主库</code> ，负责写入数据，我们称为 ：<code>写库</code></p><p>其他都是 <code>从库</code>，负责读取数据，称为：<code>读库</code></p></blockquote><ul><li>读库和写库的数据一致</li><li>写数据必须写到写库</li><li>读数据必须到读库</li></ul><p><img src="/posts/585434688/image-20210514151427711.png" alt></p><blockquote><p>问题：</p></blockquote><ol><li><p>应用程序需要连接到多个节点，对应用程序而言开发变得复杂</p><ul><li><p>通过中间件 <code>Mycat解决</code></p></li><li><p>如果程序内部实现，可使用 <code>Spring AOP</code></p></li></ul></li><li><p>主从之间的同步，是异步完成，<code>弱一致性</code></p><ul><li>可能会导致，数据写入主库，应用读取从库获取不到数据，或者丢失数据，对于数据安全性要求高的应用不合适，如支付场景</li><li>该问题通过 <code>PXC</code> 集群解决</li></ul></li></ol><h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>应用程序，连接多个数据库节点，会使应用程序的复杂度提升，可以通过中间件方式解决</p><p><img src="/posts/585434688/image-20210514153548893.png" alt></p><ul><li>应用程序只需要连接到中间件即可，无需连接多个数据库节点</li><li>应用程序无需区分读写操作，对中间件直接进行读写操作即可</li><li>在中间件中进行区分读写操作，读操作发送到从节点，写操作发送到主节点</li></ul><blockquote><p>中间件的性能称为了系统的瓶颈</p></blockquote><p><img src="/posts/585434688/image-20210514153830060.png" alt></p><ul><li>中间件的可靠性得到了保证，但是，应用系统仍然需要连接到两个中间件，为应用系统带来的复杂度</li></ul><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p><img src="/posts/585434688/image-20210514153952154.png" alt></p><p>主从复制 架构的 <code>高可用</code> 框架搭建完成</p><h2 id="PXC集群架构"><a href="#PXC集群架构" class="headerlink" title="PXC集群架构"></a>PXC集群架构</h2><p>在前面的结构中，都是基于 <strong>Mysql主从架构</strong> ，<strong>弱一致性问题</strong> 没有解决，如果在需要强一致性的需求中，显然这种架构是不能应对的，如：交易数据</p><p>PXC提供了 <strong>读写强一致性</strong> 的功能，可以保证数据在任何一个节点写入的同时可以同步到其他节点，也就意味着可以从其他任何节点进行读取操作，无延迟</p><p><img src="/posts/585434688/image-20210514154438688.png" alt></p><h2 id="混合架构"><a href="#混合架构" class="headerlink" title="混合架构"></a>混合架构</h2><p>在 <code>PXC架构</code> 中，虽然可以实现事务的强一致性，但是它是通过牺牲了性能换来的一致性，如果在某些业务场景下，如果没有强一致性的需求，那么使用PXC就不合适了。所以，在我们的系统架构中，需要将两种方式综合起来，才是一个较为完善的结构</p><p><img src="/posts/585434688/image-20210514155751760.png" alt="image-20210514155751760"></p><h1 id="搭建主从复制架构"><a href="#搭建主从复制架构" class="headerlink" title="搭建主从复制架构"></a>搭建主从复制架构</h1><p><img src="/posts/585434688/908fa0ec08fa513d164b929b50889cfdb0fbd9fa.jpeg" alt="908fa0ec08fa513d164b929b50889cfdb0fbd9fa"></p><p>使用的Mysql版本为衍生版 <code>Percona</code> ，版本为5.7.23，通过docker 搭建服务</p><h2 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h2><ul><li><strong>master</strong> 将数据增量记录到 <code>二进制日志(binary log)</code> ，即配置文件 <code>log-bin</code> 指定的文件（这些记录叫做 <code>二进制日志事件 binary log events</code>）</li><li><strong>slave</strong> 将 <strong>master</strong> 的 <code>binary log events</code> 拷贝到他的 <code>中继日志(relay log)</code></li><li><strong>slave</strong> 重做 <code>中继日志</code> 中的事件，将改变反映他自己的数据 （<code>数据重演</code>）</li></ul><blockquote><p>注意</p></blockquote><ul><li>主 DB Server 和 从DB Server 数据库版本一致</li><li>主 DB Server 和 从DB Server 数据库数据一致</li><li>主DB server开启二进制日志</li><li>主DB server和从DB server的server_id都必须唯一</li></ul><h2 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建主库 配置文件和数据文件 路径</span></span><br><span class="line">mkdir -p /data/mysql/master01</span><br><span class="line">cd /data/mysql/master01</span><br><span class="line">mkdir conf data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改当前文件夹读写权限</span></span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/master01/conf</span><br><span class="line">vim my.cnf</span><br></pre></td></tr></table></figure><h3 id="主库配置文件"><a href="#主库配置文件" class="headerlink" title="主库配置文件"></a>主库配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启主从复制，主库的配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定主库serverid</span></span><br><span class="line">server-id=1</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">binlog_format=MIXED</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定同步的库，如果不指定则同步全部数据库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#binlog-do-db=my_test</span></span></span><br></pre></td></tr></table></figure><h3 id="创建主库"><a href="#创建主库" class="headerlink" title="创建主库"></a>创建主库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker create --name percona-master01 -v /data/mysql/master01/data:/var/lib/mysql -v /data/mysql/master01/conf:/etc/my.cnf.d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">docker start percona-master01 &amp;&amp; docker logs -f percona-master01</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210514185145352.png" alt="image-20210514185145352"></p><h3 id="在主库中创建同步用户"><a href="#在主库中创建同步用户" class="headerlink" title="在主库中创建同步用户"></a>在主库中创建同步用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 授权用户slave01使用123456密码登录mysql</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;slave01&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;slave01&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;slave01&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 刷新配置</span></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看master状态</span></span><br><span class="line"><span class="keyword">show</span> master status;</span><br><span class="line"><span class="comment">-- 查看二进制日志相关的配置项</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog%&#x27;</span>;</span><br><span class="line"><span class="comment">-- 查看server相关的配置项</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;server%&#x27;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>出现问题：[Err] 1055 - Expression #1 of ORDER BY clause is not in GROUP BY clause and错误</p></blockquote><p>解决方案，在my.cnf配置文件中设置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br></pre></td></tr></table></figure><h3 id="查看主库状态"><a href="#查看主库状态" class="headerlink" title="查看主库状态"></a>查看主库状态</h3><p><img src="/posts/585434688/image-20210514230410356.png" alt="image-20210514230410356"><img src="/posts/585434688/image-20210514230746384.png" alt="image-20210514230746384"></p><p><img src="/posts/585434688/image-20210514190811759.png" alt></p><p><img src="/posts/585434688/image-20210514190559653.png" alt></p><h2 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir /data/mysql/slave01</span><br><span class="line">cd /data/mysql/slave01</span><br><span class="line">mkdir conf data</span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/slave01/conf</span><br><span class="line">vim my.cnf</span><br></pre></td></tr></table></figure><h3 id="从库配置文件"><a href="#从库配置文件" class="headerlink" title="从库配置文件"></a>从库配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server-id=2 #服务id，不可重复</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br></pre></td></tr></table></figure><h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name percona-slave01 -v /data/mysql/slave01/data:/var/lib/mysql -v /data/mysql/slave01/conf:/etc/my.cnf.d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line">docker start percona-slave01 &amp;&amp; docker logs -f percona-slave01</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210514191250201.png" alt></p><h3 id="设置master相关信息"><a href="#设置master相关信息" class="headerlink" title="设置master相关信息"></a>设置master相关信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#设置master相关信息</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line"> master_host=&#x27;8.140.130.91&#x27;,</span><br><span class="line"> master_user=&#x27;slave01&#x27;,</span><br><span class="line"> master_password=&#x27;slave01&#x27;,</span><br><span class="line"> master_port=3306,</span><br><span class="line"> master_log_file=&#x27;mysql-bin.000003&#x27;,</span><br><span class="line"> master_log_pos=745;</span><br><span class="line"> </span><br><span class="line"># 启动同步</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status;</span><br></pre></td></tr></table></figure><p>返回</p><p><img src="/posts/585434688/image-20210515181528512.png" alt="image-20210515181528512"></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="1-服务器重启后，主从可能会断开同步，slave-sql-running为false"><a href="#1-服务器重启后，主从可能会断开同步，slave-sql-running为false" class="headerlink" title="1. 服务器重启后，主从可能会断开同步，slave_sql_running为false"></a>1. 服务器重启后，主从可能会断开同步，slave_sql_running为false</h3><p>重置 <code>slave</code> 配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE IO_THREAD FOR CHANNEL &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">CHANGE MASTER TO</span><br><span class="line"> master_host=&#x27;8.140.130.91&#x27;,</span><br><span class="line"> master_user=&#x27;slave01&#x27;,</span><br><span class="line"> master_password=&#x27;slave01&#x27;,</span><br><span class="line"> master_port=3306,</span><br><span class="line"> master_log_file=&#x27;mysql-bin.000005&#x27;,</span><br><span class="line"> master_log_pos=1217;</span><br><span class="line"> </span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515203036827.png" alt="image-20210515203036827"></p><h3 id="2-World-writable-config-file-‘-etc-my-cnf’-is-ignored"><a href="#2-World-writable-config-file-‘-etc-my-cnf’-is-ignored" class="headerlink" title="2. World-writable config file ‘/etc/my.cnf’ is ignored"></a>2. World-writable config file ‘/etc/my.cnf’ is ignored</h3><p>问题：</p><p>权限全局可写，任何一个用户都可以写。mysql担心这种文件被其他用户恶意修改，所以忽略掉这个配置文件</p><p>只需要将 conf 目录权限设为 777 ，其下目录设为 644</p><h2 id="主从复制三种模式"><a href="#主从复制三种模式" class="headerlink" title="主从复制三种模式"></a>主从复制三种模式</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>在查看二进制日志相关参数内容中，会发现默认的模式为 <code>ROW</code> ,在Mysql中提供了 3 中模式，对应的 <strong>binlog 的格式有三种</strong>：STATEMENT,ROW,MIXED</p><blockquote><p>STATEMENT模式（SBR）——基于sql语句复制(statement-based replication)</p></blockquote><p>每一条涉及数据修改的sql语句会记录到 <code>binlog</code> 中</p><ul><li>优点：并不需要记录每一条sql语句和每一行的数据变化，减少了 binlog 日志量</li><li>缺点：在某些情况下会导致 <code>master-slave 数据不一致</code> （如sleep()函数，last_insert_id，user_defined function(udf) 等会出现问题）</li></ul><blockquote><p>ROW模式（RBR）——基于行的复制(row-based replication)</p></blockquote><ul><li>优点：不记录每条sql语句的上下文信息，仅需记录哪条数据被修改了，修改成什么样了。 不会出现某些特定情况下的存储过程、或function、或trigger的调用和触发无法被正确复制的问题</li><li>缺点：会产生大量的日志，尤其是alter table的时候会让日志暴涨</li></ul><blockquote><p>MIXED模式（MBR）——混合模式复制(mixedbased replication）</p></blockquote><p>以上两种模式的混合使用，</p><ul><li>一般的复制使用STATEMENT模式保存binlog，</li><li>对于STATEMENT模式无法复制的操作使用ROW模式保存binlog</li></ul><p>MySQL会根据执行的SQL语句选择日志保存方式</p><h3 id="使用MIXED主从复制模式"><a href="#使用MIXED主从复制模式" class="headerlink" title="使用MIXED主从复制模式"></a>使用MIXED主从复制模式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改主库的配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定主库serverid</span></span><br><span class="line">server-id=1</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">binlog_format=MIXED</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定同步的库，如果不指定则同步全部数据库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#binlog-do-db=my_test</span></span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">docker restart percona-master01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看二进制日志相关配置项</span></span><br><span class="line">show global variables like &#x27;binlog%&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210514233050087.png" alt></p><h1 id="MyCat中间件"><a href="#MyCat中间件" class="headerlink" title="MyCat中间件"></a>MyCat中间件</h1><p><img src="/posts/585434688/image-20210515100356299.png" alt="image-20210515100356299"></p><p><img src="/posts/585434688/image-20210515100404913.png" alt="image-20210515100404913"></p><p>基于阿里 Cobar 产品研发</p><p>应用程序与Mycat之间为Mysql协议</p><blockquote><p>数据分片与读写分离</p></blockquote><ul><li>读写分离：读写操作不在同一节点上</li><li>数据分片：扩容</li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>下载链接：<a target="_blank" rel="noopener" href="http://dl.mycat.org.cn/">http://dl.mycat.org.cn/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /haoke/mycat</span><br><span class="line">tar -xvf Mycat-server-1.6.7.6-release-20210303094759-linux.tar.gz</span><br><span class="line">mv mycat mycat01</span><br></pre></td></tr></table></figure><h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><div class="table-container"><table><thead><tr><th>主机</th><th>端口</th><th>容器名称</th><th>角色</th></tr></thead><tbody><tr><td>8.140.130.91</td><td>3306</td><td>percona-master01</td><td>master</td></tr><tr><td>8.140.130.91</td><td>3307</td><td>percona-slave01</td><td>slave</td></tr></tbody></table></div><h3 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:server <span class="keyword">SYSTEM</span> <span class="string">&quot;server.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:server</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nonePasswordLogin&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useHandshakeV10&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useSqlStat&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useGlobleTableCheck&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;subqueryRelationshipCheck&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;processorBufferPoolType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;handleDistributedTransactions&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useOffHeapForMerge&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;memoryPageSize&quot;</span>&gt;</span>64k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;spillsFileBufferSize&quot;</span>&gt;</span>1k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useStreamOutput&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;systemReserveMemorySize&quot;</span>&gt;</span>384m<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useZKSwitch&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里是设置 Mycat 用户mycat 和虚拟逻辑库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;mycat&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>mycat<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>haoke<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:server</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据表--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;haoke&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_ad&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置分片关系--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置连接信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W1R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3307&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>balance 属性：</p></blockquote><ul><li><p>=”0”：</p><p>不开启读写分离机制，所有读操作都发送到当前可用的 writehost上</p></li><li><p>=”1”：</p><p>全部的主从节点都参与到 <code>select</code> 语句的负载均衡，一个主节点会作为另一个主节点的从节点</p></li><li><p>=”2”：</p><p>所有读操作都随机的在主节点、从节点上分发</p></li><li><p>=”3”：</p><p>所有读请求随机分发到主节点对应的从节点上执行，主节点不负担读压力</p><p>只在 Mycat1.4 以后支持</p></li></ul><h3 id="rule-xml"><a href="#rule-xml" class="headerlink" title="rule.xml"></a>rule.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="启动mycat"><a href="#启动mycat" class="headerlink" title="启动mycat"></a>启动mycat</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /haoke/mycat/mycat01</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试配置是否正确</span></span><br><span class="line">./bin/mycat console</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515110843720.png" alt="image-20210515110843720"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./bin/startup_nowrap.sh</span><br><span class="line"></span><br><span class="line">[root@iZ2zeg4pktzjhp9h7wt6doZ mycat01]# jps</span><br><span class="line">5987 Jps</span><br><span class="line">2043 MycatStartup</span><br><span class="line">[root@iZ2zeg4pktzjhp9h7wt6doZ mycat01]# kill 2043</span><br><span class="line">[root@iZ2zeg4pktzjhp9h7wt6doZ mycat01]# jps</span><br><span class="line">6004 Jps</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515111443985.png" alt="image-20210515111443985"></p><blockquote><p>问题：./startup.sh: /bin/sh^M: bad interpreter: No such file or directory</p></blockquote><p>用vi打开文件 执行 :set ff 发现文件格式是dos格式<br>执行 :set ff=unix 将文件变成unix格式<br>然后再执行就可以了</p><p><img src="/posts/585434688/image-20210515111933225.png" alt></p><blockquote><p>问题：连接时出现 database=0错误</p></blockquote><p>mycat指定的database没有被创建</p><p>解决：先创建mycat配置文件中的库，再连接mycat</p><h3 id="测试读写分离"><a href="#测试读写分离" class="headerlink" title="测试读写分离"></a>测试读写分离</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tb_ad` (</span><br><span class="line">    `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `type` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;广告类型&#x27;</span>,</span><br><span class="line">    `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">    `url` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片URL地址&#x27;</span>,</span><br><span class="line">    `created` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `updated` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;广告表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--测试插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `tb_ad` (`id`, `type`, `title`, `url`, `created`, `updated`)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;UniCity万科天空之城&#x27;</span>, <span class="string">&#x27;http://itcast-haoke.oss-cnqingdao.aliyuncs.com/images/2018/11/26/15432029097062227.jpg&#x27;</span>, <span class="string">&#x27;2018-11-26 11:28:49&#x27;</span>,<span class="string">&#x27;2018-11-26 11:28:51&#x27;</span>);</span><br><span class="line">                                                                           </span><br><span class="line"><span class="comment">--测试结果：主库有写入数据，从库会同步数据</span></span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515112257821.png" alt="image-20210515112257821"></p><p><img src="/posts/585434688/image-20210515113126169.png" alt="image-20210515113126169"></p><h2 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h2><p>Mysql集群1：</p><div class="table-container"><table><thead><tr><th>主机</th><th>端口</th><th>容器名称</th><th>角色</th></tr></thead><tbody><tr><td>8.140.130.91</td><td>3306</td><td>percona-master01</td><td>master</td></tr><tr><td>8.140.130.91</td><td>3307</td><td>percona-slave01</td><td>slave</td></tr></tbody></table></div><p>Mysql集群2：</p><div class="table-container"><table><thead><tr><th>主机</th><th>端口</th><th>容器名称</th><th>角色</th></tr></thead><tbody><tr><td>8.140.130.91</td><td>3316</td><td>percona-master02</td><td>master</td></tr><tr><td>8.140.130.91</td><td>3317</td><td>percona-slave02</td><td>slave</td></tr></tbody></table></div><h3 id="配置master02"><a href="#配置master02" class="headerlink" title="配置master02"></a>配置master02</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建主库 配置文件和数据文件 路径</span></span><br><span class="line">mkdir -p /data/mysql/master02</span><br><span class="line">cd /data/mysql/master02</span><br><span class="line">mkdir conf data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改当前文件夹读写权限</span></span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/master02/conf</span><br><span class="line">vim my.cnf</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启主从复制，主库的配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定主库serverid</span></span><br><span class="line">server-id=1# 同一集群 id不同</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">binlog_format=MIXED</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定同步的库，如果不指定则同步全部数据库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#binlog-do-db=my_test</span></span></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name percona-master02 -v /data/mysql/master02/data:/var/lib/mysql  -v /data/mysql/master02/conf:/etc/my.cnf.d -p 3316:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">docker start percona-master02 &amp;&amp; docker logs -f percona-master02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建同步账户以及授权</span></span><br><span class="line">create user &#x27;slave02&#x27;@&#x27;%&#x27; identified by &#x27;slave02&#x27;;</span><br><span class="line">grant replication slave on *.* to &#x27;slave02&#x27;@&#x27;%&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看master状态</span></span><br><span class="line">show master status;</span><br><span class="line"></span><br><span class="line">-- 查看master状态</span><br><span class="line">show master status;</span><br><span class="line">-- 查看二进制日志相关的配置项</span><br><span class="line">show global variables like &#x27;binlog%&#x27;;</span><br><span class="line">-- 查看server相关的配置项</span><br><span class="line">show global variables like &#x27;server%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="配置slave02"><a href="#配置slave02" class="headerlink" title="配置slave02"></a>配置slave02</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">搭建从库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir /data/mysql/slave02</span><br><span class="line">cd /data/mysql/slave02</span><br><span class="line">mkdir conf data</span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/slave02/conf</span><br><span class="line">vim my.cnf</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入如下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2 #服务id，不可重复</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name percona-slave02 -v /data/mysql/slave02/data:/var/lib/mysql -v /data/mysql/slave02/conf:/etc/my.cnf.d -p 3317:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">docker start percona-slave02 &amp;&amp; docker logs -f percona-slave02</span><br></pre></td></tr></table></figure><h3 id="设置主节点信息"><a href="#设置主节点信息" class="headerlink" title="设置主节点信息"></a>设置主节点信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-- 设置master相关信息</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line"> master_host=&#x27;8.140.130.91&#x27;,</span><br><span class="line"> master_user=&#x27;slave02&#x27;,</span><br><span class="line"> master_password=&#x27;slave02&#x27;,</span><br><span class="line"> master_port=3316,</span><br><span class="line"> master_log_file=&#x27;mysql-bin.000006&#x27;,</span><br><span class="line"> master_log_pos=924;</span><br><span class="line"></span><br><span class="line">-- 启动同步</span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line">-- 查看master状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515181100831.png" alt="image-20210515181100831"></p><h3 id="创建数据库和表"><a href="#创建数据库和表" class="headerlink" title="创建数据库和表"></a>创建数据库和表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_ad (</span><br><span class="line">	`id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	`type` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;广告类型&#x27;</span>,</span><br><span class="line">	`title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;描述&#x27;</span>,</span><br><span class="line">	`url` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图片URL地址&#x27;</span>,</span><br><span class="line">	`created` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`updated` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;广告表&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515181140761.png" alt></p><p><img src="/posts/585434688/image-20210515183337477.png" alt="image-20210515183337477"></p><p><img src="/posts/585434688/image-20210515212002431.png" alt></p><h3 id="配置MyCat"><a href="#配置MyCat" class="headerlink" title="配置MyCat"></a>配置MyCat</h3><h4 id="schema-xml-1"><a href="#schema-xml-1" class="headerlink" title="schema.xml"></a>schema.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据表--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;haoke&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_ad&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置分片关系--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置连接信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W1R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3307&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3316&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W2R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3317&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="rule-xml-1"><a href="#rule-xml-1" class="headerlink" title="rule.xml"></a>rule.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="启动Mycat"><a href="#启动Mycat" class="headerlink" title="启动Mycat"></a>启动Mycat</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试mycat</span></span><br><span class="line">./mycat console</span><br><span class="line"></span><br><span class="line">./startup_nowrap.sh &amp;&amp; tail -f ../logs/mycat.log</span><br></pre></td></tr></table></figure><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `TB_AD` (</span><br><span class="line">`id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`type` int(10) DEFAULT NULL COMMENT &#x27;广告类型&#x27;,</span><br><span class="line">`title` varchar(100) DEFAULT NULL COMMENT &#x27;描述&#x27;,</span><br><span class="line">`url` varchar(200) DEFAULT NULL COMMENT &#x27;图片URL地址&#x27;,</span><br><span class="line">`created` datetime DEFAULT NULL,</span><br><span class="line">`updated` datetime DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=&#x27;广告表&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515214802239.png" alt="image-20210515214802239"></p><p>逐条插入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TB_AD (`id`, `type`, `title`, `url`, `created`, `updated`) </span><br><span class="line">VALUES (&#x27;1&#x27;,&#x27;1&#x27;, &#x27;UniCity万科天空之城&#x27;, &#x27;https://haoke-1257323542.cos.ap-beijing.myqcloud.com/ad-swipes/5.jpg&#x27;, &#x27;2021-05-15 11:28:49&#x27;,&#x27;2021-05-15 11:28:49&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515215119270.png" alt="image-20210515215119270"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TB_AD (`id`, `type`, `title`, `url`, `created`, `updated`) </span><br><span class="line">VALUES (&#x27;2&#x27;,&#x27;1&#x27;, &#x27;世界崇明&#x27;, &#x27;https://haoke-1257323542.cos.ap-beijing.myqcloud.com/ad-swipes/2.jpg&#x27;, &#x27;2021-05-15 11:28:49&#x27;,&#x27;2021-05-15 11:28:49&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515215231952.png" alt="image-20210515215231952"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TB_AD (`id`, `type`, `title`, `url`, `created`, `updated`) </span><br><span class="line">VALUES (&#x27;3&#x27;,&#x27;1&#x27;, &#x27;[奉贤 南桥] 光语著&#x27;, &#x27;https://haoke-1257323542.cos.ap-beijing.myqcloud.com/ad-swipes/3.jpg&#x27;, &#x27;2021-05-15 11:28:49&#x27;,&#x27;2021-05-15 11:28:49&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515215323211.png" alt="image-20210515215323211"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TB_AD (`id`, `type`, `title`, `url`, `created`, `updated`) </span><br><span class="line">VALUES (&#x27;4&#x27;,&#x27;1&#x27;, &#x27;[上海周边 嘉兴] 融创海逸长洲&#x27;, &#x27;https://haoke-1257323542.cos.ap-beijing.myqcloud.com/ad-swipes/4.jpg&#x27;, &#x27;2021-05-15 11:28:49&#x27;,&#x27;2021-05-15 11:28:49&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515215406016.png" alt="image-20210515215406016"></p><h2 id="Mycat集群"><a href="#Mycat集群" class="headerlink" title="Mycat集群"></a>Mycat集群</h2><p>为解决单节点性能问题，部署多个mycat节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd /haoke/mycat</span><br><span class="line"></span><br><span class="line">cp mycat01 mycat02 -R</span><br><span class="line"></span><br><span class="line">cd mycat02</span><br><span class="line"></span><br><span class="line">vim wrapper.xml</span><br><span class="line">wrapper.java.additional.6=-Dcom.sun.management.jmxremote.port=1985</span><br><span class="line"></span><br><span class="line">vim server.xml</span><br><span class="line">&lt;property name=&quot;serverPort&quot;&gt;8067&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;managerPort&quot;&gt;9067&lt;/property&gt;</span><br><span class="line">        </span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">启动服务</span></span><br><span class="line">./startup_nowrap.sh</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210515221307866.png" alt="image-20210515221307866"></p><h1 id="负载均衡-1"><a href="#负载均衡-1" class="headerlink" title="负载均衡"></a>负载均衡</h1><p>为解决应用程序需要连接到多个mycat，添加 <code>负载均衡组件</code> HAProxy</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>haproxy C语言编写，高可用性、负载均衡以及基于TCP和HTTP的应用程序代理</p><p>Haproxy 运行在硬件上，支持万级并发。</p><p>HAProxy 实现了 <code>事件驱动</code> <code>单一进程模型</code> ，此模型支持非常大的并发连接。</p><ul><li>多线程或多线程模型受内存限制、系统调度器限制以及无所不在的锁限制，很少能处理千级并发</li><li>事件驱动模型 有更好的资源和时间管理的用户空间实现所有的任务</li></ul><p><a target="_blank" rel="noopener" href="https://www.haproxy.org/">HAProxy - The Reliable, High Performance TCP/HTTP Load Balancer</a></p><h2 id="部署安装HAProxy"><a href="#部署安装HAProxy" class="headerlink" title="部署安装HAProxy"></a>部署安装HAProxy</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取镜像</span></span><br><span class="line">docker pull haproxy:1.9.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录，用于存放配置文件</span></span><br><span class="line">mkdir /haoke/haproxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name haproxy --net host -v /haoke/haproxy:/usr/local/etc/haproxy haproxy:1.9.3</span><br></pre></td></tr></table></figure><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建文件</span></span><br><span class="line">vim /haoke/haproxy/haproxy.cfg</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">global</span><br><span class="line">    log 127.0.0.1 local2</span><br><span class="line">    maxconn 4000</span><br><span class="line">    daemon</span><br><span class="line">    </span><br><span class="line">defaults</span><br><span class="line">	mode	http</span><br><span class="line">	log 	global</span><br><span class="line">	option	 httplog</span><br><span class="line">	option 	dontlognull</span><br><span class="line">	option 	http-server-close</span><br><span class="line">	option 	forwardfor except 127.0.0.0/8</span><br><span class="line">	option 	redispatch</span><br><span class="line">	retries 	3</span><br><span class="line">	timeout 	http-request 10s</span><br><span class="line">	timeout 	queue 1m</span><br><span class="line">	timeout 	connect 10s</span><br><span class="line">	timeout 	client 1m</span><br><span class="line">	timeout 	server 1m</span><br><span class="line">	timeout 	http-keep-alive 10s</span><br><span class="line">	timeout 	check 10s</span><br><span class="line">	maxconn 	3000</span><br><span class="line">	</span><br><span class="line">listen admin_stats</span><br><span class="line">	bind 	0.0.0.0:4001</span><br><span class="line">	mode 	http</span><br><span class="line">	stats	 uri /dbs</span><br><span class="line">	stats	 realm Global\ statistics</span><br><span class="line">	stats	 auth admin:admin</span><br><span class="line">	</span><br><span class="line">listen proxy-mysql</span><br><span class="line">	bind 0.0.0.0:4002</span><br><span class="line">	mode tcp</span><br><span class="line">	balance roundrobin</span><br><span class="line">	option tcplog</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">代理mycat服务</span></span><br><span class="line">		server mycat_1 8.140.130.91:8066 check port 8066 maxconn 2000</span><br><span class="line">		server mycat_2 8.140.130.91:8067 check port 8067 maxconn 2000</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line">docker start haproxy &amp;&amp; docker logs -f haproxy</span><br></pre></td></tr></table></figure><h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><hr><p>web 界面测试：<a target="_blank" rel="noopener" href="http://8.140.130.91:4001/dbs">http://8.140.130.91:4001/dbs</a></p><p><img src="/posts/585434688/image-20210516102500140.png" alt></p><p><img src="/posts/585434688/image-20210516102518531.png" alt="image-20210516102518531"></p><hr><p>mysql客户端测试：</p><p><img src="/posts/585434688/image-20210516102629805.png" alt></p><p><img src="/posts/585434688/image-20210516102657130.png" alt="image-20210516102657130"></p><h1 id="PXC集群"><a href="#PXC集群" class="headerlink" title="PXC集群"></a>PXC集群</h1><p>Percona XtraDB Cluster (PXC) 是针对Mysql用户的高可用性和扩展性解决方案，基于Percona Server，是一个针对事务性应用程序的同步多主机复制插件。</p><p>Percona Server是Mysql的改进版本，使用 XtraDB存储引擎，在功能和性能上较Mysql有着显著提升：提升了高负载情况下的InnoDB的性能，为DBA提供了一些非常有用的性能诊断工具，另外有更多的参数和命令来控制服务器行为</p><p>Percona XtraDB Cluster提供了：</p><ul><li>同步复制：事务可以在所有节点上提交</li><li>多主机复制：可以写到任意节点上</li><li>从(slave)服务器上的并行应用事件，真正的“主从复制”</li><li>自动节点配置</li><li>数据一致性：不再有未同步的从服务器</li></ul><p><a target="_blank" rel="noopener" href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster">https://www.percona.com/software/mysql-database/percona-xtradb-cluster</a></p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul><li>尽可能控制PXC集群的规模，节点越多，数据同步速度越慢</li><li>所有PXC节点的硬件配置要一致，配置低的节点将拖慢数据同步速度</li><li>PXC集群只支持InnoDB引擎，不支持其他的存储引擎</li></ul><h2 id="PXC集群方案与Replication区别"><a href="#PXC集群方案与Replication区别" class="headerlink" title="PXC集群方案与Replication区别"></a>PXC集群方案与Replication区别</h2><ul><li>PXC集群方案所有节点都是可读可写的，Replication从节点不能写入（主从同步是单向的，无法从slave节点向master节点同步）</li><li>PXC同步机制是同步进行的，这也是它能保证数据强一致性的根本原因，Replication同步机制是异步进行的，如果从节点停止同步，依然可以向主节点插入数据，正确返回，但会造成数据不一致问题</li><li>PXC是用性能的牺牲换取数据一致性，Replication在性能上是高于PXC的</li><li>两者用途不一致：<ul><li>Replication用于一般信息的存储，能够容忍数据丢失，如：购物车，用户行为日志等</li><li>PXC是用于重要信息存储，如：订单，用户信息</li></ul></li></ul><h2 id="部署安装"><a href="#部署安装" class="headerlink" title="部署安装"></a>部署安装</h2><div class="table-container"><table><thead><tr><th>节点</th><th>端口</th><th>容器名称</th><th>数据卷</th></tr></thead><tbody><tr><td>node1</td><td>13306</td><td>pxc_node1</td><td>v1</td></tr><tr><td>node2</td><td>13307</td><td>pxc_node2</td><td>v2</td></tr><tr><td>node3</td><td>13308</td><td>pxc_node3</td><td>v3</td></tr></tbody></table></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据卷（存储路径：/var/lib/docker/volumes）</span></span><br><span class="line">docker volume create v1</span><br><span class="line">docker volume create v2</span><br><span class="line">docker volume create v3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取镜像</span></span><br><span class="line">docker pull percona/percona-xtradb-cluster:5.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重命名</span></span><br><span class="line">docker tag percona/percona-xtradb-cluster:5.7 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建网络</span></span><br><span class="line">docker network create --subnet=172.30.0.0/24 pxc-network</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一节点</span></span><br><span class="line">docker create -p 13306:3306 -v v1:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --name=pxc_node1 --net=pxc-network --ip=172.30.0.2 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二节点（增加了CLUSTER_JOIN参数）</span></span><br><span class="line">docker create -p 13307:3306 -v v2:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --name=pxc_node2 -e CLUSTER_JOIN=pxc_node1 --net=pxc-network --ip=172.30.0.3 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第三节点（增加了CLUSTER_JOIN参数）</span></span><br><span class="line">docker create -p 13308:3306 -v v3:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --name=pxc_node3 -e CLUSTER_JOIN=pxc_node1 --net=pxc-network --ip=172.30.0.4 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">docker create pxc_node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看集群节点</span></span><br><span class="line">show status like &#x27;wsrep_cluster%&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516162732043.png" alt></p><blockquote><p>先启动第一个结点，等到mysql客户端可以连接到服务后，再启动其他节点</p></blockquote><ul><li>启动第一个节点，PXC集群会进行初始化，集群初始化完成后，其他节点才能加入到集群中</li></ul><p><img src="/posts/585434688/image-20210516165359586.png" alt="image-20210516165359586"></p><h2 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_ad` (</span><br><span class="line">`id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`type` int(10) DEFAULT NULL COMMENT &#x27;广告类型&#x27;,</span><br><span class="line">`title` varchar(100) DEFAULT NULL COMMENT &#x27;描述&#x27;,</span><br><span class="line">`url` varchar(200) DEFAULT NULL COMMENT &#x27;图片URL地址&#x27;,</span><br><span class="line">`created` datetime DEFAULT NULL,</span><br><span class="line">`updated` datetime DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=&#x27;广告表&#x27;;</span><br><span class="line"></span><br><span class="line">INSERT INTO `tb_ad` (`id`, `type`, `title`, `url`, `created`, `updated`) VALUES (&#x27;1&#x27;,&#x27;1&#x27;, &#x27;UniCity万科天空之城&#x27;, &#x27;http://itcast-haoke.oss-cnqingdao.aliyuncs.com/images/2018/11/26/15432029097062227.jpg&#x27;, &#x27;2018-11-26 11:28:49&#x27;,&#x27;2018-11-26 11:28:51&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516165643429.png" alt="image-20210516165643429"></p><h1 id="haoke租房数据库集群"><a href="#haoke租房数据库集群" class="headerlink" title="haoke租房数据库集群"></a>haoke租房数据库集群</h1><p>好客租房项目采用混合架构的方式完善数据库集群</p><p><img src="/posts/585434688/集群方案.png" alt="集群方案"></p><ul><li>HAProxy 作为负载均衡器</li><li>部署了两个 Mycat 节点作为数据库中间件</li><li>部署两个 PXC 集群节点，作为2个Mycat分片，每个PXC集群中有两个节点，作为数据的同步存储，PXC集群做数据分片</li><li>部署一个主从复制集群</li><li>房源数据保存到PXC分片中，其余数据保存在主从架构中</li></ul><h2 id="部署PXC集群"><a href="#部署PXC集群" class="headerlink" title="部署PXC集群"></a>部署PXC集群</h2><p>集群一：</p><div class="table-container"><table><thead><tr><th>节点</th><th>端口</th><th>容器名称</th><th>数据卷</th></tr></thead><tbody><tr><td>node1</td><td>13306</td><td>pxc_node1</td><td>haoke-v1</td></tr><tr><td>node2</td><td>13307</td><td>pxc_node2</td><td>haoke-v2</td></tr></tbody></table></div><p>集群二：</p><div class="table-container"><table><thead><tr><th>节点</th><th>端口</th><th>容器名称</th><th>数据卷</th></tr></thead><tbody><tr><td>node3</td><td>13308</td><td>pxc_node3</td><td>haoke-v3</td></tr><tr><td>node4</td><td>13309</td><td>pxc_node4</td><td>haoke-v4</td></tr></tbody></table></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据卷（存储路径：/var/lib/docker/volumes）</span></span><br><span class="line">docker volume create haoke-v1</span><br><span class="line">docker volume create haoke-v2</span><br><span class="line">docker volume create haoke-v3</span><br><span class="line">docker volume create haoke-v4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">docker pull percona/percona-xtradb-cluster:5.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">镜像命名</span></span><br><span class="line">docker tag percona/percona-xtradb-cluster:5.7 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建网络</span></span><br><span class="line">docker network create --subnet=172.30.0.0/24 pxc-network</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群1，第一节点</span></span><br><span class="line">docker create --name=pxc-haoke-node1 -p 13306:3306 -v haoke-v1:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --net=pxc-network --ip=172.30.0.2 pxc</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二节点（增加了CLUSTER_JOIN参数）</span></span><br><span class="line">docker create --name=pxc-haoke-node2 -p 13307:3306 -v haoke-v2:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -eCLUSTER_NAME=pxc -e CLUSTER_JOIN=pxc-haoke-node1 --net=pxc-network --ip=172.30.0.3 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群2</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一节点</span></span><br><span class="line">docker create --name=pxc-haoke-node3 -p 13308:3306 -v haoke-v3:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --net=pxc-network --ip=172.30.0.4 pxc</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二节点（增加了CLUSTER_JOIN参数）</span></span><br><span class="line">docker create -p 13309:3306 -v haoke-v4:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -e CLUSTER_NAME=pxc --name=pxc-haoke-node4 -e CLUSTER_JOIN=pxc-haoke-node3 --net=pxc-network --ip=172.30.0.5 pxc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动 先pxc第一个结点启动成功后再启动第二个</span></span><br><span class="line">docker start pxc-haoke-node1 &amp;&amp; docker logs -f pxc-haoke-node1</span><br><span class="line">docker start pxc-haoke-node2 &amp;&amp; docker logs -f pxc-haoke-node2</span><br><span class="line">docker start pxc-haoke-node3 &amp;&amp; docker logs -f pxc-haoke-node3</span><br><span class="line">docker start pxc-haoke-node4 &amp;&amp; docker logs -f pxc-haoke-node4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看集群节点</span></span><br><span class="line">show status like &#x27;wsrep_cluster%&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516214829252.png" alt="image-20210516214829252"></p><h3 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h3><p><img src="/posts/585434688/image-20210516215025537.png" alt></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_house_resources` (</span><br><span class="line">    `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `title` varchar(100) DEFAULT NULL COMMENT &#x27;房源标题&#x27;,</span><br><span class="line">    `estate_id` bigint(20) DEFAULT NULL COMMENT &#x27;楼盘id&#x27;,</span><br><span class="line">    `building_num` varchar(5) DEFAULT NULL COMMENT &#x27;楼号（栋）&#x27;,</span><br><span class="line">    `building_unit` varchar(5) DEFAULT NULL COMMENT &#x27;单元号&#x27;,</span><br><span class="line">    `building_floor_num` varchar(5) DEFAULT NULL COMMENT &#x27;门牌号&#x27;,</span><br><span class="line">    `rent` int(10) DEFAULT NULL COMMENT &#x27;租金&#x27;,</span><br><span class="line">    `rent_method` tinyint(1) DEFAULT NULL COMMENT &#x27;租赁方式，1-整租，2-合租&#x27;,</span><br><span class="line">    `payment_method` tinyint(1) DEFAULT NULL COMMENT &#x27;支付方式，1-付一押一，2-付三押一，3-付六押一，4-年付押一，5-其它&#x27;,</span><br><span class="line">    `house_type` varchar(255) DEFAULT NULL COMMENT &#x27;户型，如：2室1厅1卫&#x27;,</span><br><span class="line">    `covered_area` varchar(10) DEFAULT NULL COMMENT &#x27;建筑面积&#x27;,</span><br><span class="line">    `use_area` varchar(10) DEFAULT NULL COMMENT &#x27;使用面积&#x27;,</span><br><span class="line">    `floor` varchar(10) DEFAULT NULL COMMENT &#x27;楼层，如：8/26&#x27;,</span><br><span class="line">    `orientation` varchar(2) DEFAULT NULL COMMENT &#x27;朝向：东、南、西、北&#x27;,</span><br><span class="line">    `decoration` tinyint(1) DEFAULT NULL COMMENT &#x27;装修，1-精装，2-简装，3-毛坯&#x27;,</span><br><span class="line">    `facilities` varchar(50) DEFAULT NULL COMMENT &#x27;配套设施， 如：1,2,3&#x27;,</span><br><span class="line">    `pic` varchar(1000) DEFAULT NULL COMMENT &#x27;图片，最多5张&#x27;,</span><br><span class="line">    `house_desc` varchar(200) DEFAULT NULL COMMENT &#x27;描述&#x27;,</span><br><span class="line">    `contact` varchar(10) DEFAULT NULL COMMENT &#x27;联系人&#x27;,</span><br><span class="line">    `mobile` varchar(11) DEFAULT NULL COMMENT &#x27;手机号&#x27;,</span><br><span class="line">    `time` tinyint(1) DEFAULT NULL COMMENT &#x27;看房时间，1-上午，2-中午，3-下午，4-晚上，5-全天&#x27;,</span><br><span class="line">    `property_cost` varchar(10) DEFAULT NULL COMMENT &#x27;物业费&#x27;,</span><br><span class="line">    `created` datetime DEFAULT NULL,</span><br><span class="line">    `updated` datetime DEFAULT NULL,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=&#x27;房源表&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516215158759.png" alt="image-20210516215158759"></p><h2 id="部署主从复制集群"><a href="#部署主从复制集群" class="headerlink" title="部署主从复制集群"></a>部署主从复制集群</h2><h3 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建主库 配置文件和数据文件 路径</span></span><br><span class="line">mkdir -p /data/mysql/master01</span><br><span class="line">cd /data/mysql/master01</span><br><span class="line">mkdir conf data</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改当前文件夹读写权限</span></span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/master01/conf</span><br><span class="line">vim my.cnf</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启主从复制，主库的配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定主库serverid</span></span><br><span class="line">server-id=1# 同一集群 id不同</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">binlog_format=MIXED</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定同步的库，如果不指定则同步全部数据库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#binlog-do-db=my_test</span></span></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name percona-haoke-master01 -v /data/mysql/master01/data:/var/lib/mysql  -v /data/mysql/master01/conf:/etc/my.cnf.d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">docker start percona-haoke-master01 &amp;&amp; docker logs -f percona-haoke-master01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建同步账户以及授权</span></span><br><span class="line">create user &#x27;slave01&#x27;@&#x27;%&#x27; identified by &#x27;slave01&#x27;;</span><br><span class="line">grant replication slave on *.* to &#x27;slave01&#x27;@&#x27;%&#x27;;</span><br><span class="line">flush privileges;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看master状态</span></span><br><span class="line">show master status;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看二进制日志相关的配置项</span></span><br><span class="line">show global variables like &#x27;binlog%&#x27;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看server相关的配置项</span></span><br><span class="line">show global variables like &#x27;server%&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516222703096.png" alt="image-20210516222703096"></p><h3 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">搭建从库</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir /data/mysql/slave01</span><br><span class="line">cd /data/mysql/slave01</span><br><span class="line">mkdir conf data</span><br><span class="line">chmod 777 data -R</span><br><span class="line">chmod 777 conf </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建配置文件</span></span><br><span class="line">cd /data/mysql/slave01/conf</span><br><span class="line">vim my.cnf</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入如下内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2 #服务id，不可重复</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27;</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建容器</span></span><br><span class="line">docker create --name percona-haoke-slave01 -v /data/mysql/slave01/data:/var/lib/mysql -v /data/mysql/slave01/conf:/etc/my.cnf.d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root percona:5.7.23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">docker start percona-haoke-slave01 &amp;&amp; docker logs -f percona-haoke-slave01</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#设置master相关信息</span><br><span class="line">CHANGE MASTER TO</span><br><span class="line">	master_host=&#x27;8.140.130.91&#x27;,</span><br><span class="line">	master_user=&#x27;slave01&#x27;,</span><br><span class="line">	master_password=&#x27;slave01&#x27;,</span><br><span class="line">	master_port=3306,</span><br><span class="line">	master_log_file=&#x27;mysql-bin.000004&#x27;,</span><br><span class="line">	master_log_pos=154;</span><br><span class="line"></span><br><span class="line">#启动同步</span><br><span class="line">start slave;</span><br><span class="line">#查看master状态</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure><h3 id="测试-5"><a href="#测试-5" class="headerlink" title="测试"></a>测试</h3><p><img src="/posts/585434688/image-20210516223622529.png" alt="image-20210516223622529"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_ad` (</span><br><span class="line">`id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`type` int(10) DEFAULT NULL COMMENT &#x27;广告类型&#x27;,</span><br><span class="line">`title` varchar(100) DEFAULT NULL COMMENT &#x27;描述&#x27;,</span><br><span class="line">`url` varchar(200) DEFAULT NULL COMMENT &#x27;图片URL地址&#x27;,</span><br><span class="line">`created` datetime DEFAULT NULL,</span><br><span class="line">`updated` datetime DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=&#x27;广告表&#x27;;</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210516223734628.png" alt="image-20210516223734628"></p><h2 id="部署MyCat"><a href="#部署MyCat" class="headerlink" title="部署MyCat"></a>部署MyCat</h2><h3 id="节点一"><a href="#节点一" class="headerlink" title="节点一"></a>节点一</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /data/</span><br><span class="line">mkdir mycat</span><br><span class="line">cd mycat</span><br><span class="line">cp /haoke/mycat . -R</span><br><span class="line">mv mycat/ mycat-node1</span><br></pre></td></tr></table></figure><h4 id="server-xml-1"><a href="#server-xml-1" class="headerlink" title="server.xml"></a>server.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:server <span class="keyword">SYSTEM</span> <span class="string">&quot;server.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:server</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nonePasswordLogin&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useHandshakeV10&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useSqlStat&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useGlobleTableCheck&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;subqueryRelationshipCheck&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;processorBufferPoolType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;handleDistributedTransactions&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useOffHeapForMerge&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;memoryPageSize&quot;</span>&gt;</span>64k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;spillsFileBufferSize&quot;</span>&gt;</span>1k<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useStreamOutput&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;systemReserveMemorySize&quot;</span>&gt;</span>384m<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useZKSwitch&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置服务端口以及管理端口--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serverPort&quot;</span>&gt;</span>18067<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;managerPort&quot;</span>&gt;</span>19067<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里是设置 Mycat 用户mycat 和虚拟逻辑库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;mycat&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>mycat<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>haoke<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:server</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="schema-xml-2"><a href="#schema-xml-2" class="headerlink" title="schema.xml"></a>schema.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据表--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;haoke&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_house_resources&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_ad&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置分片关系--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;cluster3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;haoke&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置连接信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:13306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W1R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:13307&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:13308&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W2R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:13309&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;cluster3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;W3&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;W3R1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;8.140.130.91:3307&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">password</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="rule-xml-2"><a href="#rule-xml-2" class="headerlink" title="rule.xml"></a>rule.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="设置端口及启动"><a href="#设置端口及启动" class="headerlink" title="设置端口及启动"></a>设置端口及启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim wrapper.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置jmx端口</span></span><br><span class="line">wrapper.java.additional.7=-Dcom.sun.management.jmxremote.port=11984</span><br><span class="line"></span><br><span class="line">./mycat console</span><br><span class="line">./startup_nowrap.sh &amp;&amp; tail -f ../logs/mycat.log</span><br></pre></td></tr></table></figure><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><blockquote><p>连接</p></blockquote><p><img src="/posts/585434688/image-20210517085633599.png" alt></p><blockquote><p>插入数据</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `tb_house_resources` (`id`, `title`, `estate_id`, `building_num`,`building_unit`, `building_floor_num`, `rent`, `rent_method`, `payment_method`,`house_type`, `covered_area`, `use_area`, `floor`, `orientation`, `decoration`,`facilities`, `pic`, `house_desc`, `contact`, `mobile`, `time`, `property_cost`,`created`, `updated`) VALUES (&#x27;1&#x27;, &#x27;东方曼哈顿 3室2厅 16000元&#x27;, &#x27;1005&#x27;, &#x27;2&#x27;, &#x27;1&#x27;, &#x27;1&#x27;,&#x27;1111&#x27;, &#x27;1&#x27;, &#x27;1&#x27;, &#x27;1室1厅1卫1厨1阳台&#x27;, &#x27;2&#x27;, &#x27;2&#x27;, &#x27;1/2&#x27;, &#x27;南&#x27;, &#x27;1&#x27;, &#x27;1,2,3,8,9&#x27;, NULL, &#x27;这个经纪人很懒，没写核心卖点&#x27;, &#x27;张三&#x27;, &#x27;11111111111&#x27;, &#x27;1&#x27;, &#x27;11&#x27;, &#x27;2021-05-16 01:16:00&#x27;,&#x27;2021-05-16 01:16:00&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210517090516179.png" alt="image-20210517090516179"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `tb_house_resources` (`id`, `title`, `estate_id`, `building_num`,`building_unit`, `building_floor_num`, `rent`, `rent_method`, `payment_method`,`house_type`, `covered_area`, `use_area`, `floor`, `orientation`, `decoration`,`facilities`, `pic`, `house_desc`, `contact`, `mobile`, `time`, `property_cost`,`created`, `updated`) VALUES (&#x27;2&#x27;, &#x27;康城 3室2厅1卫&#x27;, &#x27;1002&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;2000&#x27;, &#x27;1&#x27;,&#x27;2&#x27;, &#x27;3室2厅1卫1厨2阳台&#x27;, &#x27;100&#x27;, &#x27;80&#x27;, &#x27;2/20&#x27;, &#x27;南&#x27;, &#x27;1&#x27;, &#x27;1,2,3,7,6&#x27;, NULL, &#x27;拎包入住&#x27;,&#x27;张三&#x27;, &#x27;18888888888&#x27;, &#x27;5&#x27;, &#x27;1.5&#x27;, &#x27;2021-05-16 01:16:00&#x27;,&#x27;2021-05-16 01:16:00&#x27;);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `tb_ad` (`id`, `type`, `title`, `url`, `created`, `updated`) VALUES (&#x27;1&#x27;,&#x27;1&#x27;, &#x27;UniCity万科天空之城&#x27;, &#x27;http://itcast-haoke.oss-cnqingdao.aliyuncs.com/images/2018/11/26/15432029097062227.jpg&#x27;, &#x27;2021-05-16 01:16:00&#x27;,&#x27;2021-05-16 01:16:00&#x27;);</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210517090620374.png" alt="image-20210517090620374"></p><h3 id="节点二"><a href="#节点二" class="headerlink" title="节点二"></a>节点二</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cp mycat-node1/ mycat-node2 -R</span><br><span class="line"></span><br><span class="line">vim wrapper.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置jmx端口</span></span><br><span class="line">wrapper.java.additional.7=-Dcom.sun.management.jmxremote.port=11986</span><br><span class="line"></span><br><span class="line">vim server.xml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置服务端口以及管理端口</span></span><br><span class="line">&lt;property name=&quot;serverPort&quot;&gt;18068&lt;/property&gt;</span><br><span class="line">&lt;property name=&quot;managerPort&quot;&gt;19068&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">./mycat console</span><br><span class="line">./startup_nowrap.sh &amp;&amp; tail -f ../logs/mycat.log</span><br></pre></td></tr></table></figure><h2 id="部署HAProxy"><a href="#部署HAProxy" class="headerlink" title="部署HAProxy"></a>部署HAProxy</h2><p>修改配置文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改文件</span></span><br><span class="line">vim /haoke/haproxy/haproxy.cfg</span><br><span class="line"></span><br><span class="line">global</span><br><span class="line">    log 127.0.0.1 local2</span><br><span class="line">    maxconn 4000</span><br><span class="line">    daemon</span><br><span class="line">    </span><br><span class="line">defaults</span><br><span class="line">	mode	http</span><br><span class="line">	log 	global</span><br><span class="line">	option	 httplog</span><br><span class="line">	option 	dontlognull</span><br><span class="line">	option 	http-server-close</span><br><span class="line">	option 	forwardfor except 127.0.0.0/8</span><br><span class="line">	option 	redispatch</span><br><span class="line">	retries 	3</span><br><span class="line">	timeout 	http-request 10s</span><br><span class="line">	timeout 	queue 1m</span><br><span class="line">	timeout 	connect 10s</span><br><span class="line">	timeout 	client 1m</span><br><span class="line">	timeout 	server 1m</span><br><span class="line">	timeout 	http-keep-alive 10s</span><br><span class="line">	timeout 	check 10s</span><br><span class="line">	maxconn 	3000</span><br><span class="line">	</span><br><span class="line">listen admin_stats</span><br><span class="line">	bind 	0.0.0.0:4001</span><br><span class="line">	mode 	http</span><br><span class="line">	stats	 uri /dbs</span><br><span class="line">	stats	 realm Global\ statistics</span><br><span class="line">	stats	 auth admin:admin</span><br><span class="line">	</span><br><span class="line">listen proxy-mysql</span><br><span class="line">	bind 0.0.0.0:4002</span><br><span class="line">	mode tcp</span><br><span class="line">	balance roundrobin</span><br><span class="line">	option tcplog</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">代理mycat服务</span></span><br><span class="line">		server mycat_1 8.140.130.91:18067 check port 18067 maxconn 2000</span><br><span class="line">		server mycat_2 8.140.130.91:18068 check port 18068 maxconn 2000</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker create --name haproxy --net host -v /data/haproxy:/usr/local/etc/haproxy haproxy:1.9.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器</span></span><br><span class="line">docker start haproxy &amp;&amp; docker logs haproxy</span><br></pre></td></tr></table></figure><p><img src="/posts/585434688/image-20210517103523017.png" alt="image-20210517103523017"></p><p><img src="/posts/585434688/image-20210517095921185.png" alt="image-20210517095921185"></p><p><img src="/posts/585434688/image-20210517100036048.png" alt="image-20210517100036048"></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/585434688/" title="数据库集群">https://amostian.github.io/posts/585434688/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tags"></i> 开发</a> <a href="/tags/Java%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="fa fa-tags"></i> Java项目</a> <a href="/tags/%E6%AF%95%E8%AE%BE%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="fa fa-tags"></i> 毕设项目</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1776729057/" rel="prev" title="RocketMQ"><i class="fa fa-chevron-left"></i> RocketMQ</a></div><div class="post-nav-item"><a href="/posts/855804072/" rel="next" title="前台系统">前台系统 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">系统架构存在的问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mysql-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88"><span class="nav-text">Mysql 数据库的集群方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84"><span class="nav-text">读写分离架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="nav-text">PXC集群架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B7%E5%90%88%E6%9E%B6%E6%9E%84"><span class="nav-text">混合架构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%9E%B6%E6%9E%84"><span class="nav-text">搭建主从复制架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="nav-text">主从复制原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="nav-text">主库配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">主库配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%BB%E5%BA%93"><span class="nav-text">创建主库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E4%B8%BB%E5%BA%93%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%90%8C%E6%AD%A5%E7%94%A8%E6%88%B7"><span class="nav-text">在主库中创建同步用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%BB%E5%BA%93%E7%8A%B6%E6%80%81"><span class="nav-text">查看主库状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="nav-text">从库配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%BA%93%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">从库配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8"><span class="nav-text">创建容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEmaster%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-text">设置master相关信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%87%8D%E5%90%AF%E5%90%8E%EF%BC%8C%E4%B8%BB%E4%BB%8E%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%96%AD%E5%BC%80%E5%90%8C%E6%AD%A5%EF%BC%8Cslave-sql-running%E4%B8%BAfalse"><span class="nav-text">1. 服务器重启后，主从可能会断开同步，slave_sql_running为false</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-World-writable-config-file-%E2%80%98-etc-my-cnf%E2%80%99-is-ignored"><span class="nav-text">2. World-writable config file ‘&#x2F;etc&#x2F;my.cnf’ is ignored</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="nav-text">主从复制三种模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8MIXED%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F"><span class="nav-text">使用MIXED主从复制模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MyCat%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">MyCat中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-text">读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#server-xml"><span class="nav-text">server.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#schema-xml"><span class="nav-text">schema.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rule-xml"><span class="nav-text">rule.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8mycat"><span class="nav-text">启动mycat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-text">测试读写分离</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="nav-text">数据分片</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEmaster02"><span class="nav-text">配置master02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEslave02"><span class="nav-text">配置slave02</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="nav-text">设置主节点信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8"><span class="nav-text">创建数据库和表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEMyCat"><span class="nav-text">配置MyCat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#schema-xml-1"><span class="nav-text">schema.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rule-xml-1"><span class="nav-text">rule.xml</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8Mycat"><span class="nav-text">启动Mycat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mycat%E9%9B%86%E7%BE%A4"><span class="nav-text">Mycat集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-1"><span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85HAProxy"><span class="nav-text">部署安装HAProxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PXC%E9%9B%86%E7%BE%A4"><span class="nav-text">PXC集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F"><span class="nav-text">注意</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PXC%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E4%B8%8EReplication%E5%8C%BA%E5%88%AB"><span class="nav-text">PXC集群方案与Replication区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85"><span class="nav-text">部署安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#haoke%E7%A7%9F%E6%88%BF%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4"><span class="nav-text">haoke租房数据库集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2PXC%E9%9B%86%E7%BE%A4"><span class="nav-text">部署PXC集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%9B%86%E7%BE%A4"><span class="nav-text">部署主从复制集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%BA%93"><span class="nav-text">主库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%BA%93"><span class="nav-text">从库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2MyCat"><span class="nav-text">部署MyCat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%B8%80"><span class="nav-text">节点一</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#server-xml-1"><span class="nav-text">server.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#schema-xml-2"><span class="nav-text">schema.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rule-xml-2"><span class="nav-text">rule.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%AB%AF%E5%8F%A3%E5%8F%8A%E5%90%AF%E5%8A%A8"><span class="nav-text">设置端口及启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="nav-text">测试：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%BA%8C"><span class="nav-text">节点二</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2HAProxy"><span class="nav-text">部署HAProxy</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">353</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">58</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">74</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">761.9k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">31:52</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>