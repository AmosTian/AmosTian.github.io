<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="前置知识： ElasticSearch ElasticStack   地图查房 关键字搜索"><meta property="og:type" content="article"><meta property="og:title" content="前台系统"><meta property="og:url" content="https://amostian.github.io/posts/855804072/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="前置知识： ElasticSearch ElasticStack   地图查房 关键字搜索"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210407175717290.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210407222714946.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210407222725102.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210407220512638.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210407223154903.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210408093346102.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210408094919920.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210408095647842.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210502161518576.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210502161522600.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/api-login.2fcc9f35.jpg"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210425144056602.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510190142733.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510213628178.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510213307353.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510214302766.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510222652620.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210510222722357.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511103424592.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511103544854-164899647862999.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511104219512.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511114338173.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511122036312.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511123356880.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511124752691.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511130730069.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511173821935.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511220314214.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210511220503406.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512104946763.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512105552768.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512105625790.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512111246026.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512121556520.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512195722246.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512195736461.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512205047571.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512205145518-1648996510312100.png"><meta property="og:image" content="https://amostian.github.io/posts/855804072/image-20210512210038640.png"><meta property="article:published_time" content="2022-04-03T03:26:07.000Z"><meta property="article:modified_time" content="2023-03-23T17:26:08.619Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="开发"><meta property="article:tag" content="Java项目"><meta property="article:tag" content="毕设项目"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/855804072/image-20210407175717290.png"><link rel="canonical" href="https://amostian.github.io/posts/855804072/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>前台系统 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">58</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">74</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">359</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/855804072/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">前台系统</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2022-04-03 11:26:07" itemprop="dateCreated datePublished" datetime="2022-04-03T11:26:07+08:00">2022-04-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2023-03-24 01:26:08" itemprop="dateModified" datetime="2023-03-24T01:26:08+08:00">2023-03-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">开发</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/Java%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">Java项目</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91/Java%E9%A1%B9%E7%9B%AE/%E6%AF%95%E8%AE%BE%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">毕设项目</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">11.2k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>55 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>前置知识：</p><p><a href="https://amostian.github.io/posts/3565236947/">ElasticSearch</a></p><p><a href="https://amostian.github.io/posts/2161105653/">ElasticStack</a></p></blockquote><ul><li>地图查房</li><li>关键字搜索</li></ul><span id="more"></span><h1 id="前台"><a href="#前台" class="headerlink" title="前台"></a>前台</h1><h2 id="地图查房"><a href="#地图查房" class="headerlink" title="地图查房"></a>地图查房</h2><p>文档：<a target="_blank" rel="noopener" href="http://lbsyun.baidu.com/index.php?title=jspopular3.0">http://lbsyun.baidu.com/index.php?title=jspopular3.0</a></p><h3 id="导入BMap"><a href="#导入BMap" class="headerlink" title="导入BMap"></a>导入BMap</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://api.map.baidu.com/api?v=3.0&amp;ak=q60ejYQeO2qZO6dYhWPOHea4aY0bhrqG&amp;s=1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>若在子模块直接使用BMap,会出现未定义的错误，原因是组件未加载</p><p>需要在 public/index.html 中，先将BMap和BMapLib载入到window</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">BMap</span> = <span class="title class_">BMap</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">BMapLib</span> = <span class="title class_">BMapLib</span>;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210407175717290.png" alt></p><h3 id="使用自定义OverFlowIcon"><a href="#使用自定义OverFlowIcon" class="headerlink" title="使用自定义OverFlowIcon"></a>使用自定义OverFlowIcon</h3><p><img src="/posts/855804072/image-20210407222714946.png" alt></p><p><img src="/posts/855804072/image-20210407222725102.png" alt></p><h3 id="修改数据加载逻辑"><a href="#修改数据加载逻辑" class="headerlink" title="修改数据加载逻辑"></a>修改数据加载逻辑</h3><h4 id="graphql接口"><a href="#graphql接口" class="headerlink" title="graphql接口"></a>graphql接口</h4><figure class="highlight graphql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">schema</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="symbol">query</span><span class="punctuation">:</span> HaokeQuery</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HaokeQuery<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">#分页查询房源信息-应用于前台房源信息</span></span><br><span class="line">    HouseResourcesList<span class="punctuation">(</span><span class="symbol">page</span><span class="punctuation">:</span>Int, <span class="symbol">pageSize</span><span class="punctuation">:</span>Int<span class="punctuation">)</span><span class="punctuation">:</span>TableResult</span><br><span class="line">    <span class="comment"># 通过Id查询房源信息</span></span><br><span class="line">    HouseResources<span class="punctuation">(</span><span class="symbol">id</span><span class="punctuation">:</span>ID<span class="punctuation">)</span><span class="punctuation">:</span> HouseResources</span><br><span class="line"></span><br><span class="line">    <span class="comment">#首页广告图-应用于前台首页</span></span><br><span class="line">    <span class="symbol">IndexAdList</span><span class="punctuation">:</span> IndexAdResult</span><br><span class="line"></span><br><span class="line">    <span class="comment">#地图查房房源数据</span></span><br><span class="line">    <span class="symbol">MapHouseData</span><span class="punctuation">:</span>MapHouseDataResult</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MapHouseDataResult<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="symbol">list</span><span class="punctuation">:</span><span class="punctuation">[</span>MapHouseXY<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MapHouseXY<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="symbol">x</span><span class="punctuation">:</span>Float</span><br><span class="line">    <span class="symbol">y</span><span class="punctuation">:</span>Float</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="编写MapHouseDataResult、MapHouseXY"><a href="#编写MapHouseDataResult、MapHouseXY" class="headerlink" title="编写MapHouseDataResult、MapHouseXY"></a>编写MapHouseDataResult、MapHouseXY</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.vo.map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapHouseDataResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MapHouseXY&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.vo.map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapHouseXY</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Float x;</span><br><span class="line">    <span class="keyword">private</span> Float y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MapHouseDataFetcher-Graphql接口"><a href="#MapHouseDataFetcher-Graphql接口" class="headerlink" title="MapHouseDataFetcher Graphql接口"></a>MapHouseDataFetcher Graphql接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.graphql.myDataFetcherImpl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapHouseDataFetcher</span> <span class="keyword">implements</span> <span class="title class_">MyDataFetcher</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fieldName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MapHouseData&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">dataFetcher</span><span class="params">(DataFetchingEnvironment environment)</span> &#123;</span><br><span class="line">        List&lt;MapHouseXY&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.43244f</span>,<span class="number">39.929986f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.424355f</span>,<span class="number">39.92982f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.423349f</span>,<span class="number">39.935214f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.350444f</span>,<span class="number">39.931645f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.351684f</span>,<span class="number">39.91867f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.353983f</span>,<span class="number">39.913855f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.357253f</span>,<span class="number">39.923152f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.349168f</span>,<span class="number">39.923152f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.36232f</span>,<span class="number">39.938339f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.374249f</span>,<span class="number">39.94625f</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(<span class="number">116.380178f</span>,<span class="number">39.953053f</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapHouseDataResult</span>(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试Graphql接口"><a href="#测试Graphql接口" class="headerlink" title="测试Graphql接口"></a>测试Graphql接口</h4><p><img src="/posts/855804072/image-20210407220512638.png" alt="image-20210407220512638"></p><h4 id="整合前端"><a href="#整合前端" class="headerlink" title="整合前端"></a>整合前端</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApolloClient</span>, gql , <span class="title class_">InMemoryCache</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@apollo/client&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">ApolloClient</span>(&#123;</span><br><span class="line">  <span class="attr">uri</span>: <span class="string">&quot;http://127.0.0.1:9091/graphql&quot;</span>,</span><br><span class="line">  <span class="attr">cache</span>: <span class="keyword">new</span> <span class="title class_">InMemoryCache</span>()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义查询</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GET_MAP_HOUSE</span> = gql`<span class="language-graphql"></span></span><br><span class="line"><span class="language-graphql">  <span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">    MapHouseData <span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">      list <span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">        x </span></span><br><span class="line"><span class="language-graphql">        y</span></span><br><span class="line"><span class="language-graphql">      <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">    <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">  <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">`</span>;</span><br><span class="line"></span><br><span class="line">client.<span class="title function_">query</span>(&#123;<span class="attr">query</span>: <span class="variable constant_">GET_MAP_HOUSE</span>&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> xys = result.<span class="property">data</span>.<span class="property">MapHouseData</span>.<span class="property">list</span>;</span><br><span class="line">    <span class="keyword">var</span> markers = [];</span><br><span class="line">    <span class="keyword">var</span> pt = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> xys) &#123;</span><br><span class="line">        pt = <span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Point</span>(xys[i].<span class="property">x</span>, xys[i].<span class="property">y</span>);</span><br><span class="line">        markers.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Marker</span>(pt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地图上覆盖物的聚合效果</span></span><br><span class="line">    <span class="keyword">var</span> markerClusterer = <span class="keyword">new</span> <span class="title class_">BMapLib</span>.<span class="title class_">MarkerClusterer</span>(map, &#123;</span><br><span class="line">        <span class="attr">markers</span>: markers,</span><br><span class="line">        <span class="attr">girdSize</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">styles</span>: [&#123;</span><br><span class="line">            <span class="attr">background</span>: <span class="string">&#x27;rgba(12,181,106,0.9)&#x27;</span>,</span><br><span class="line">            <span class="attr">size</span>: <span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Size</span>(<span class="number">92</span>, <span class="number">92</span>),</span><br><span class="line">            <span class="attr">textSize</span>: <span class="string">&#x27;16&#x27;</span>,</span><br><span class="line">            <span class="attr">textColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">            <span class="attr">borderRadius</span>: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">        &#125;],</span><br><span class="line">    &#125;);</span><br><span class="line">    markerClusterer.<span class="title function_">setMaxZoom</span>(<span class="number">50</span>);</span><br><span class="line">    markerClusterer.<span class="title function_">setGridSize</span>(<span class="number">50</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="整合前端测试"><a href="#整合前端测试" class="headerlink" title="整合前端测试"></a>整合前端测试</h4><p>测试后，数据是从后端传来的，则数据加载逻辑修改成功</p><p><img src="/posts/855804072/image-20210407223154903.png" alt="image-20210407223154903"></p><h3 id="增加拖动事件"><a href="#增加拖动事件" class="headerlink" title="增加拖动事件"></a>增加拖动事件</h3><p>在地图拖动后，增加事件，获取中心位置的坐标，以便后续的查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">map.addEventListener(<span class="string">&quot;dragend&quot;</span>, function <span class="title function_">showInfo</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">cp</span> <span class="operator">=</span> map.getCenter();</span><br><span class="line">    <span class="type">let</span> <span class="variable">zoom</span> <span class="operator">=</span> map.getZoom(); <span class="comment">//缩放级别</span></span><br><span class="line">    console.log(cp.lng + <span class="string">&quot;,&quot;</span> + cp.lat+<span class="string">&quot; --&gt; &quot;</span> + zoom);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>百度地图缩放比例：</p><div class="table-container"><table><thead><tr><th>级别</th><th>比例尺</th></tr></thead><tbody><tr><td>19级</td><td>20m</td></tr><tr><td>18级</td><td>50m</td></tr><tr><td>17级</td><td>100m</td></tr><tr><td>16级</td><td>200m</td></tr><tr><td>15级</td><td>500m</td></tr><tr><td>14级</td><td>1km</td></tr><tr><td>13级</td><td>2km</td></tr><tr><td>12级</td><td>5km</td></tr><tr><td>11级</td><td>10km</td></tr><tr><td>10级</td><td>20km</td></tr><tr><td>9级</td><td>25km</td></tr><tr><td>8级</td><td>50km</td></tr><tr><td>7级</td><td>100km</td></tr><tr><td>6级</td><td>200km</td></tr><tr><td>5级</td><td>500km</td></tr><tr><td>4级</td><td>1000km</td></tr><tr><td>3级</td><td>2000km</td></tr><tr><td>2级</td><td>5000km</td></tr><tr><td>1级</td><td>10000km</td></tr></tbody></table></div><h3 id="传递经纬度和缩放比例参数"><a href="#传递经纬度和缩放比例参数" class="headerlink" title="传递经纬度和缩放比例参数"></a>传递经纬度和缩放比例参数</h3><p><img src="/posts/855804072/image-20210408093346102.png" alt></p><h4 id="实现目标"><a href="#实现目标" class="headerlink" title="实现目标"></a>实现目标</h4><p>拖动地图，更新范围内的房源数据</p><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><ol><li>拖动地图</li><li>获取地图中心点</li><li>将当前中心点的经纬度传及缩放比传递到后台</li><li>后台根据计算出的搜索范围，查询数据</li></ol><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><h5 id="定义graphql接口"><a href="#定义graphql接口" class="headerlink" title="定义graphql接口"></a>定义graphql接口</h5><figure class="highlight graphql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HaokeQuery<span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">#分页查询房源信息-应用于前台房源信息</span></span><br><span class="line">    HouseResourcesList<span class="punctuation">(</span><span class="symbol">page</span><span class="punctuation">:</span>Int, <span class="symbol">pageSize</span><span class="punctuation">:</span>Int<span class="punctuation">)</span><span class="punctuation">:</span>TableResult</span><br><span class="line">    <span class="comment"># 通过Id查询房源信息</span></span><br><span class="line">    HouseResources<span class="punctuation">(</span><span class="symbol">id</span><span class="punctuation">:</span>ID<span class="punctuation">)</span><span class="punctuation">:</span> HouseResources</span><br><span class="line"></span><br><span class="line">    <span class="comment">#首页广告图-应用于前台首页</span></span><br><span class="line">    <span class="symbol">IndexAdList</span><span class="punctuation">:</span> IndexAdResult</span><br><span class="line"></span><br><span class="line">    <span class="comment">#地图查房房源数据</span></span><br><span class="line">    MapHouseData<span class="punctuation">(</span><span class="symbol">lng</span><span class="punctuation">:</span>Float,<span class="symbol">lat</span><span class="punctuation">:</span>Float,<span class="symbol">zoom</span><span class="punctuation">:</span>Int<span class="punctuation">)</span><span class="punctuation">:</span>MapHouseDataResult</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="keyword">query</span> queryMapHouseData<span class="punctuation">(</span><span class="variable">$lng</span>:Float,<span class="variable">$lat</span>:Float,<span class="variable">$zoom</span>:Int<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  MapHouseData<span class="punctuation">(</span><span class="symbol">lng</span><span class="punctuation">:</span><span class="variable">$lng</span>,<span class="symbol">lat</span><span class="punctuation">:</span><span class="variable">$lat</span>,<span class="symbol">zoom</span><span class="punctuation">:</span><span class="variable">$zoom</span>)<span class="punctuation">&#123;</span></span><br><span class="line">    list<span class="punctuation">&#123;</span></span><br><span class="line">      x</span><br><span class="line">      y</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">---</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="string">&quot;lng&quot;</span><span class="punctuation">:</span><span class="number">116.54461241348382</span>,</span><br><span class="line">	<span class="string">&quot;lat&quot;</span><span class="punctuation">:</span><span class="number">39.91201079295558</span>,</span><br><span class="line">	<span class="string">&quot;zoom&quot;</span><span class="punctuation">:</span><span class="number">12</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="后台接口接收参数"><a href="#后台接口接收参数" class="headerlink" title="后台接口接收参数"></a>后台接口接收参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.graphql.myDataFetcherImpl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapHouseDataFetcher</span> <span class="keyword">implements</span> <span class="title class_">MyDataFetcher</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fieldName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MapHouseData&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">dataFetcher</span><span class="params">(DataFetchingEnvironment environment)</span> &#123;</span><br><span class="line">        <span class="type">Float</span> <span class="variable">lat</span> <span class="operator">=</span> environment.getArgument(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">        <span class="type">Float</span> <span class="variable">lng</span> <span class="operator">=</span> environment.getArgument(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">zoom</span> <span class="operator">=</span> environment.getArgument(<span class="string">&quot;zoom&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;lat -&gt; &quot;</span>+ lat);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210408094919920.png" alt="image-20210408094919920"></p><p><strong>修改为</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Float</span> <span class="variable">lat</span> <span class="operator">=</span> ((Double)environment.getArgument(<span class="string">&quot;lat&quot;</span>)).floatValue();</span><br><span class="line"><span class="type">Float</span> <span class="variable">lng</span> <span class="operator">=</span> ((Double)environment.getArgument(<span class="string">&quot;lng&quot;</span>)).floatValue();</span><br><span class="line"><span class="type">Integer</span> <span class="variable">zoom</span> <span class="operator">=</span> environment.getArgument(<span class="string">&quot;zoom&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;lat -&gt; &quot;</span>+ lat);</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210408095647842.png" alt></p><h5 id="前端代码修改"><a href="#前端代码修改" class="headerlink" title="前端代码修改"></a>前端代码修改</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Icon</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;semantic-ui-react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApolloClient</span>, gql , <span class="title class_">InMemoryCache</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;@apollo/client&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">ApolloClient</span>(&#123;</span><br><span class="line">  <span class="attr">uri</span>: <span class="string">&quot;http://127.0.0.1:9091/graphql&quot;</span>,</span><br><span class="line">  <span class="attr">cache</span>: <span class="keyword">new</span> <span class="title class_">InMemoryCache</span>()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义查询</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GET_MAP_HOUSE</span> = gql`<span class="language-graphql"></span></span><br><span class="line"><span class="language-graphql">  <span class="keyword">query</span> queryMapHouseData<span class="punctuation">(</span><span class="variable">$lng</span>:Float,<span class="variable">$lat</span>:Float,<span class="variable">$zoom</span>:Int<span class="punctuation">)</span><span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">    MapHouseData<span class="punctuation">(</span><span class="symbol">lng</span><span class="punctuation">:</span><span class="variable">$lng</span>,<span class="symbol">lat</span><span class="punctuation">:</span><span class="variable">$lat</span>,<span class="symbol">zoom</span><span class="punctuation">:</span><span class="variable">$zoom</span>)<span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">      list<span class="punctuation">&#123;</span></span></span><br><span class="line"><span class="language-graphql">        x</span></span><br><span class="line"><span class="language-graphql">        y</span></span><br><span class="line"><span class="language-graphql">      <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">    <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">  <span class="punctuation">&#125;</span></span></span><br><span class="line"><span class="language-graphql">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 百度地图API功能</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BMap</span> = <span class="variable language_">window</span>.<span class="property">BMap</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BMapLib</span> = <span class="variable language_">window</span>.<span class="property">BMapLib</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">showMapMarker</span> =(<span class="params">xys,map</span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> markers = [];</span><br><span class="line">  <span class="keyword">let</span> pt = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> xys) &#123;</span><br><span class="line">    pt = <span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Point</span>(xys[i].<span class="property">x</span>, xys[i].<span class="property">y</span>);</span><br><span class="line">    markers.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Marker</span>(pt));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 地图上覆盖物的聚合效果</span></span><br><span class="line">  <span class="keyword">var</span> markerClusterer = <span class="keyword">new</span> <span class="title class_">BMapLib</span>.<span class="title class_">MarkerClusterer</span>(map, &#123;</span><br><span class="line">    <span class="attr">markers</span>: markers,</span><br><span class="line">    <span class="attr">girdSize</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">styles</span>: [&#123;</span><br><span class="line">      <span class="attr">background</span>: <span class="string">&#x27;rgba(12,181,106,0.9)&#x27;</span>,</span><br><span class="line">      <span class="attr">size</span>: <span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Size</span>(<span class="number">92</span>, <span class="number">92</span>),</span><br><span class="line">      <span class="attr">textSize</span>: <span class="string">&#x27;16&#x27;</span>,</span><br><span class="line">      <span class="attr">textColor</span>: <span class="string">&#x27;#fff&#x27;</span>,</span><br><span class="line">      <span class="attr">borderRadius</span>: <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;);</span><br><span class="line">  markerClusterer.<span class="title function_">setMaxZoom</span>(<span class="number">50</span>);</span><br><span class="line">  markerClusterer.<span class="title function_">setGridSize</span>(<span class="number">50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MapHouse</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置初始中心点</span></span><br><span class="line">    <span class="keyword">let</span> defaultX = <span class="number">121.48130241985999</span>;</span><br><span class="line">    <span class="keyword">let</span> defaultY = <span class="number">31.235156971414239</span>;</span><br><span class="line">    <span class="keyword">let</span> defaultZoom = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Map实例</span></span><br><span class="line">    <span class="keyword">let</span> map = <span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Map</span>(<span class="string">&quot;allmap&quot;</span>);</span><br><span class="line">    <span class="comment">// 初始化地图,设置中心点坐标和地图级别</span></span><br><span class="line">    map.<span class="title function_">centerAndZoom</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">Point</span>(defaultX,defaultY), defaultZoom);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启鼠标滚轮缩放</span></span><br><span class="line">    map.<span class="title function_">enableScrollWheelZoom</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加地图类型控件</span></span><br><span class="line">    map.<span class="title function_">addControl</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">MapTypeControl</span>());</span><br><span class="line">    <span class="comment">// 设置地图缩放比例尺控件</span></span><br><span class="line">    map.<span class="title function_">addControl</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">ScaleControl</span>(&#123;</span><br><span class="line">      <span class="attr">anchor</span>: <span class="variable language_">window</span>.<span class="property">BMAP_NAVIGATION_CONTROL_ZOOM</span></span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">// 设置地图导航</span></span><br><span class="line">    map.<span class="title function_">addControl</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">NavigationControl</span>(&#123;</span><br><span class="line">      <span class="attr">enableGeolocation</span>: <span class="literal">true</span></span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="comment">// 设置缩略图控件。</span></span><br><span class="line">    map.<span class="title function_">addControl</span>(<span class="keyword">new</span> <span class="title class_">BMap</span>.<span class="title class_">OverviewMapControl</span>());</span><br><span class="line">    <span class="comment">// 设置地图显示的城市 此项是必须设置的</span></span><br><span class="line">    map.<span class="title function_">setCurrentCity</span>(<span class="string">&quot;上海&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*拖拽事件，更新范围内房源</span></span><br><span class="line"><span class="comment">    * 获取中心点，取数据，更新地图</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">showInfo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> cp = map.<span class="title function_">getCenter</span>();</span><br><span class="line">      <span class="keyword">let</span> zoom = map.<span class="title function_">getZoom</span>(); <span class="comment">//缩放级别</span></span><br><span class="line">      <span class="comment">// console.log(cp.lng + &quot;,&quot; + cp.lat+&quot; --&gt; &quot; + zoom);</span></span><br><span class="line">      client.<span class="title function_">query</span>(&#123;<span class="attr">query</span>: <span class="variable constant_">GET_MAP_HOUSE</span>, <span class="attr">variables</span>: &#123;<span class="string">&quot;lng&quot;</span>:cp.<span class="property">lng</span>,<span class="string">&quot;lat&quot;</span>:cp.<span class="property">lat</span>,<span class="string">&quot;zoom&quot;</span>:zoom&#125;&#125;).<span class="title function_">then</span>(</span><br><span class="line">          <span class="function"><span class="params">result</span> =&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">let</span> xys = result.<span class="property">data</span>.<span class="property">MapHouseData</span>.<span class="property">list</span>;</span><br><span class="line">            <span class="title function_">showMapMarker</span>(xys,map);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map.<span class="title function_">addEventListener</span>(<span class="string">&quot;dragstart&quot;</span>,<span class="function">()=&gt;</span>&#123;map.<span class="title function_">clearOverlays</span>();&#125;); <span class="comment">//拖动开始事件</span></span><br><span class="line">    map.<span class="title function_">addEventListener</span>(<span class="string">&quot;dragend&quot;</span>,showInfo); <span class="comment">//拖动结束事件</span></span><br><span class="line">    map.<span class="title function_">addEventListener</span>(<span class="string">&quot;zoomstart&quot;</span>, <span class="function">()=&gt;</span>&#123;map.<span class="title function_">clearOverlays</span>();&#125;); <span class="comment">//缩放开始事件</span></span><br><span class="line">    map.<span class="title function_">addEventListener</span>(<span class="string">&quot;zoomend&quot;</span>,showInfo); <span class="comment">//缩放结束事件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*初始化*/</span></span><br><span class="line">    client.<span class="title function_">query</span>(&#123;<span class="attr">query</span>: <span class="variable constant_">GET_MAP_HOUSE</span>,<span class="attr">variables</span>: &#123;<span class="string">&quot;lng&quot;</span>:defaultX,<span class="string">&quot;lat&quot;</span>:defaultY,<span class="string">&quot;zoom&quot;</span>:defaultZoom&#125;&#125;).<span class="title function_">then</span>(</span><br><span class="line">        <span class="function"><span class="params">result</span> =&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> xys = result.<span class="property">data</span>.<span class="property">MapHouseData</span>.<span class="property">list</span>;</span><br><span class="line">      <span class="title function_">showMapMarker</span>(xys,map)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> ( </span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span> = <span class="string">&#x27;map-house&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span> = <span class="string">&quot;map-house-title&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">onClick</span> = <span class="string">&#123;this.props.hideMap&#125;</span> <span class="attr">name</span> = <span class="string">&#x27;angle left&#x27;</span> <span class="attr">size</span> = <span class="string">&#x27;large&#x27;</span>/&gt;</span> 地图找房 </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span> = <span class="string">&quot;map-house-content&quot;</span> <span class="attr">id</span>=<span class="string">&#x27;allmap&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MapHouse</span>;</span><br></pre></td></tr></table></figure><h3 id="MongoDB的地理位置索引"><a href="#MongoDB的地理位置索引" class="headerlink" title="MongoDB的地理位置索引"></a>MongoDB的地理位置索引</h3><p>在MongoDB中，支持存储位置的经纬度，可以对其索引，通过算子操作，进行查找附近的数据，如：查找附近的人，附近的建筑</p><p><strong>将房源数据导入到MongoDB</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##进入容器</span></span></span><br><span class="line">docker exec -it mongodb /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##进入mongo</span></span></span><br><span class="line">mongo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##切换数据库</span></span></span><br><span class="line">use haoke</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##创建索引</span></span></span><br><span class="line">db.house.createIndex(&#123;loc:&#x27;2d&#x27;&#125;) #为house表的loc字段创建地理2d索引</span><br><span class="line">db.house.createIndex(&#123;estate:1&#125;,&#123;unique:true&#125;) #为house表的hid字段创建唯一索引</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过百度api查询地址的经纬度</span></span><br><span class="line">http://api.map.baidu.com/geocoding/v3/?address=上海&amp;output=json&amp;ak=q60ejYQeO2qZO6dYhWPOHea4aY0bhrqG&amp;callback=showLocation</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##插入数据</span></span></span><br><span class="line">db.house.insert(&#123;hid:1,title:&#x27;整租 · 南丹大楼 1居室 7500&#x27;,loc:[121.4482236974557,31.196523937504549]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:2,title:&#x27;陆家嘴板块，精装设计一室一厅，可拎包入住诚意租。&#x27;,loc:[121.51804613891443,31.238878702131506]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:3,title:&#x27;整租 · 健安坊 1居室 4050&#x27;,loc:[121.4148310693774,31.16507733043528]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:4,title:&#x27;整租 · 中凯城市之光+视野开阔+景色秀丽+拎包入住&#x27;,loc:[121.43528282056717,31.198687949417815]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:5,title:&#x27;整租 · 南京西路品质小区 21213三轨交汇 配套齐* 拎包入住&#x27;,loc:[121.43528282056717,31.198687949417815]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:6,title:&#x27;祥康里 简约风格 *南户型 拎包入住 看房随时&#x27;,loc:[121.47521508401232,31.23859308719981]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:7,title:&#x27;整租 · 桃源新村 1室0厅 5500元&#x27;,loc:[121.488377804633,31.23113867155927]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:8,title:&#x27;整租 · 中山公园品质小区，两房朝南厅朝南，家电家具精装*配&#x27;,loc:[121.42038642151562,31.225078800208654]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:9,title:&#x27;整租 · 近地铁2号线，精装1房1厅，高区朝南，享受阳光好房&#x27;,loc:[121.42933310871683,31.221943586471036]&#125;)</span><br><span class="line">db.house.insert(&#123;hid:10,title:&#x27;整租 · 2.3.4号中山公园地铁，背靠来福士，采光好，诚意出租&#x27;,loc:[121.42063977421182,31.221023374982044]&#125;)</span><br></pre></td></tr></table></figure><p><strong>mongodb地理位置的索引</strong></p><p>注意距离要除以111.2（1度=111.2km），跟普通查找的区别仅仅是多了两个算子 <code>\$near</code> 和 <code>\$maxDistance</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查询上海人民广场附近5公里的房源，人民广场的坐标为：121.48130241985999,31.235156971414239</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.house.find(&#123;loc:&#123;<span class="variable">$near</span>:[121.48130241985999,31.235156971414239],<span class="variable">$maxDistance</span>:5/111.12 &#125;&#125;)</span></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6eb7c34903ae9b73d0dd&quot;), &quot;hid&quot; : 6, &quot;title&quot; : &quot;祥康里 简约风格 *南户型 拎包入住 看房随时&quot;, &quot;loc&quot; : [ 121.47521508401232, 31.23859308719981 ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6ebfc34903ae9b73d0de&quot;), &quot;hid&quot; : 7, &quot;title&quot; : &quot;整租 · 桃源新村 1室0厅 5500元&quot;, &quot;loc&quot; : [ 121.488377804633, 31.23113867155927 ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6e95c34903ae9b73d0d9&quot;), &quot;hid&quot; : 2, &quot;title&quot; : &quot;陆家嘴板块，精装设计一室一厅，可拎包入住诚意租。&quot;, &quot;loc&quot; : [ 121.51804613891443, 31.238878702131505 ] &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查询上海中山公园附近2公里的房源，中山公园的坐标为：121.42261657004589,31.229111410235285</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.house.find(&#123;loc:&#123;<span class="variable">$near</span>:[121.42261657004589,31.229111410235285],<span class="variable">$maxDistance</span>:2/111.12 &#125;&#125;)</span></span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6ec3c34903ae9b73d0df&quot;), &quot;hid&quot; : 8, &quot;title&quot; : &quot;整租 · 中山公园品质小区，两房朝南厅朝南，家电家具精装*配&quot;, &quot;loc&quot; : [ 121.42038642151562, 31.225078800208653 ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6ecdc34903ae9b73d0e1&quot;), &quot;hid&quot; : 10, &quot;title&quot; : &quot;整租 · 2.3.4号中山公园地铁，背靠来福士，采光好，诚意出租&quot;, &quot;loc&quot; : [ 121.42063977421182, 31.221023374982042 ] &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;606e6ec8c34903ae9b73d0e0&quot;), &quot;hid&quot; : 9, &quot;title&quot; : &quot;整租 · 近地铁2号线，精装1房1厅，高区朝南，享受阳光好房&quot;, &quot;loc&quot; : [ 121.42933310871683, 31.221943586471035 ] &#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210502161518576.png" alt></p><p><img src="/posts/855804072/image-20210502161522600.png" alt></p><h3 id="实现基于MongoDB的查询"><a href="#实现基于MongoDB的查询" class="headerlink" title="实现基于MongoDB的查询"></a>实现基于MongoDB的查询</h3><h4 id="mongo依赖"><a href="#mongo依赖" class="headerlink" title="mongo依赖"></a>mongo依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--mongo依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mongodb配置</span></span><br><span class="line"><span class="attr">spring.data.mongodb.uri</span>=<span class="string">mongodb://8.140.130.91:6379:27017/haoke</span></span><br></pre></td></tr></table></figure><h4 id="Mapper层代码"><a href="#Mapper层代码" class="headerlink" title="Mapper层代码"></a>Mapper层代码</h4><h5 id="pojo"><a href="#pojo" class="headerlink" title="pojo"></a>pojo</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.pojo;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(collection = &quot;house&quot;)</span><span class="comment">//指定表名称</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoHouse</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@JsonSerialize(using = ToStringSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long hid;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Float[] loc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="service"><a href="#service" class="headerlink" title="service"></a>service</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoHouseService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, Double&gt; BAIDU_ZOOM = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">19</span>, <span class="number">20d</span> / <span class="number">1000</span>); <span class="comment">//单位为km</span></span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">18</span>, <span class="number">50d</span> / <span class="number">1000</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">17</span>, <span class="number">100d</span> / <span class="number">1000</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">16</span>, <span class="number">200d</span> / <span class="number">1000</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">15</span>, <span class="number">500d</span> / <span class="number">1000</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">14</span>, <span class="number">1d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">13</span>, <span class="number">2d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">12</span>, <span class="number">5d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">11</span>, <span class="number">10d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">10</span>, <span class="number">20d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">9</span>, <span class="number">25d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">8</span>, <span class="number">50d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">7</span>, <span class="number">100d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">6</span>, <span class="number">200d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">5</span>, <span class="number">500d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">4</span>, <span class="number">1000d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">3</span>, <span class="number">2000d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">2</span>, <span class="number">5000d</span>);</span><br><span class="line">        BAIDU_ZOOM.put(<span class="number">1</span>, <span class="number">10000d</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 从mongo中产讯数据，返回地图房源数据</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> MapHouseDataResult <span class="title function_">queryHouseData</span><span class="params">(Float lng,Float lat,Integer zoom)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> BAIDU_ZOOM.get(zoom)*<span class="number">1.5</span>/<span class="number">111.12</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;loc&quot;</span>).near(<span class="keyword">new</span> <span class="title class_">Point</span>(lng,lat)).maxDistance(distance));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询数据</span></span><br><span class="line">        List&lt;MongoHouse&gt; mongoHouses = <span class="built_in">this</span>.mongoTemplate.find(query, MongoHouse.class);</span><br><span class="line"></span><br><span class="line">        List&lt;MapHouseXY&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MongoHouse mongoHouse : mongoHouses) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(mongoHouse.getLoc()[<span class="number">0</span>], mongoHouse.getLoc()[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapHouseDataResult</span>(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.graphql.myDataFetcherImpl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapHouseDataFetcher</span> <span class="keyword">implements</span> <span class="title class_">MyDataFetcher</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoHouseService mongoHouseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fieldName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MapHouseData&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">dataFetcher</span><span class="params">(DataFetchingEnvironment environment)</span> &#123;</span><br><span class="line">        <span class="type">Float</span> <span class="variable">lat</span> <span class="operator">=</span> ((Double)environment.getArgument(<span class="string">&quot;lat&quot;</span>)).floatValue();</span><br><span class="line">        <span class="type">Float</span> <span class="variable">lng</span> <span class="operator">=</span> ((Double)environment.getArgument(<span class="string">&quot;lng&quot;</span>)).floatValue();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">zoom</span> <span class="operator">=</span> environment.getArgument(<span class="string">&quot;zoom&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;lat -&gt; &quot;</span>+ lat);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoHouseService.queryHouseData(lng,lat,zoom);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="小程序用户登录"><a href="#小程序用户登录" class="headerlink" title="小程序用户登录"></a>小程序用户登录</h2><p><img src="/posts/855804072/api-login.2fcc9f35.jpg" alt></p><ol><li><p>调用 <code>wx.login()</code> 获取 <strong>临时登录凭证code</strong> ,并回传到开发者服务器</p><p>wx.login()[<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html</a>]</p></li><li><p>调用 <code>code2Session</code> 接口，换取 <strong>用户唯一标识 OpenId</strong> 和 <strong>会话密钥 session_key</strong></p><ul><li><p>用户在当前小程序的唯一标识（openid）</p></li><li><p>微信开放平台帐号下的唯一标识（unionid，若当前小程序已绑定到微信开放平台帐号）</p></li><li>本次登录的会话密钥（session_key）</li></ul></li></ol><p><strong>注意</strong></p><blockquote><ol><li>会话密钥 <code>session_key</code> 是对用户数据进行 [加密签名][<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html</a>] 的密钥。为了应用自身的数据安全，开发者服务器 <strong>不应该把会话密钥下发到小程序，也不应该对外提供这个密钥</strong></li><li>临时登录凭证 code 只能使用一次</li></ol></blockquote><h3 id="编写登录服务"><a href="#编写登录服务" class="headerlink" title="编写登录服务"></a>编写登录服务</h3><h4 id="1-wx-login-获取code"><a href="#1-wx-login-获取code" class="headerlink" title="1. wx.login()获取code"></a>1. wx.login()获取code</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;view <span class="keyword">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">bindtap</span>=<span class="string">&quot;login&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/view&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Page</span>(&#123;</span><br><span class="line">  <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">    wx.<span class="title function_">login</span>(&#123;</span><br><span class="line">      <span class="title function_">success</span>(<span class="params">res</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(res.<span class="property">code</span>)&#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">code</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-从微信服务器获取用户相关信息"><a href="#2-从微信服务器获取用户相关信息" class="headerlink" title="2.  从微信服务器获取用户相关信息"></a>2. 从微信服务器获取用户相关信息</h4><p>请求微信的API地址[<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html">https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html</a>]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.weixin.qq.com/sns/jscode2session?</span><br><span class="line">appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code</span><br></pre></td></tr></table></figure><p><strong>返回值示例</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;session_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;y/tucPVvjeLvKwayZqE8cA==&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;openid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;o4Grc5fzn_KKpmOXZeQ-E2bMboLg&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="number">40163</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;code been used, hints: [ req_id: ZEmBy24ce-iV.NGA ]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;errcode&quot;</span><span class="punctuation">:</span> <span class="number">40029</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;errmsg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;invalid code, hints: [ req_id: ZEmBN.iCe-yFGI4a ]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-Bean——RestTemplate、JAVA的HTTP工具类"><a href="#3-Bean——RestTemplate、JAVA的HTTP工具类" class="headerlink" title="3. Bean——RestTemplate、JAVA的HTTP工具类"></a>3. Bean——RestTemplate、JAVA的HTTP工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 杂配置</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HaokeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-Controller"><a href="#4-Controller" class="headerlink" title="4. Controller"></a>4. Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;wx&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxLoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String ,String &gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">wxLogin</span><span class="params">(<span class="meta">@RequestBody</span> HashMap&lt;String, String&gt; param)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">appid</span> <span class="operator">=</span> <span class="string">&quot;wx47b56adca7411314&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">secret</span> <span class="operator">=</span> <span class="string">&quot;2b68f0eb4c8ecfcbec4929f3eee5aee8&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://api.weixin.qq.com/sns/jscode2session?&quot;</span> +</span><br><span class="line">                <span class="string">&quot;appid=&quot;</span>+ appid +</span><br><span class="line">                <span class="string">&quot;&amp;secret=&quot;</span>+ secret +</span><br><span class="line">                <span class="string">&quot;&amp;js_code=&quot;</span>+param.get(<span class="string">&quot;code&quot;</span>)+</span><br><span class="line">                <span class="string">&quot;&amp;grant_type=authorization_code&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">resData</span> <span class="operator">=</span> <span class="built_in">this</span>.restTemplate.getForObject(url,String.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.contains(resData,<span class="string">&quot;errcode&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//登录失败</span></span><br><span class="line">            result.put(<span class="string">&quot;status&quot;</span>,<span class="string">&quot;500&quot;</span>);</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;登录失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">ticket</span> <span class="operator">=</span> DigestUtils.md5Hex(resData);</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;WX_MINIPRO_LOGIN&quot;</span>+ticket;</span><br><span class="line">        <span class="comment">//保存七天</span></span><br><span class="line">        <span class="built_in">this</span>.redisTemplate.opsForValue().set(redisKey,resData, Duration.ofDays(<span class="number">7</span>));</span><br><span class="line">        result.put(<span class="string">&quot;data&quot;</span>,ticket);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-session是否失效"><a href="#5-session是否失效" class="headerlink" title="5. session是否失效"></a>5. session是否失效</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.html">wx.checkSession(Object object)</a></p><p>用户越久未使用小程序，用户登录态越有可能失效。反之如果用户一直在使用小程序，则用户登录态一直保持有效。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">checkLogin</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="variable language_">this</span></span><br><span class="line">    wx.<span class="title function_">checkSession</span>(&#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// session_key 未过期，并且在本生命周期一直有效</span></span><br><span class="line">            wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;处于登录状态&#x27;</span>,</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">                <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">fail</span>(<span class="params"></span>) &#123;</span><br><span class="line">            wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;登录已失效!&#x27;</span>,</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">                <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">            &#125;);</span><br><span class="line">            _this.<span class="title function_">login</span>() <span class="comment">// 重新登录</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="6-登录测试"><a href="#6-登录测试" class="headerlink" title="6. 登录测试"></a>6. 登录测试</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">    wx.<span class="title function_">login</span>(&#123;</span><br><span class="line">        <span class="title function_">success</span>(<span class="params">res</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">            <span class="keyword">if</span>(res.<span class="property">code</span>)&#123;</span><br><span class="line">                <span class="comment">//发送临时凭证code，向服务端请求用户标识</span></span><br><span class="line">                wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">                    <span class="attr">url</span>: <span class="string">&#x27;http://127.0.0.1:9091/wx/login&#x27;</span>,</span><br><span class="line">                    <span class="attr">method</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                    <span class="attr">header</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;content-type&quot;</span>:<span class="string">&quot;application/json&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">data</span>: &#123;</span><br><span class="line">                        <span class="attr">code</span>: res.<span class="property">code</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="title function_">success</span>(<span class="params">res</span>)&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">                        <span class="keyword">if</span>(res.<span class="property">data</span>.<span class="property">status</span> == <span class="number">200</span>)&#123;</span><br><span class="line">                            wx.<span class="title function_">setStorage</span>(&#123;</span><br><span class="line">                                <span class="attr">key</span>: <span class="string">&#x27;TICKET&#x27;</span>,</span><br><span class="line">                                <span class="attr">data</span>: res.<span class="property">data</span>.<span class="property">data</span></span><br><span class="line">                            &#125;);</span><br><span class="line">                            wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                                <span class="attr">title</span>: <span class="string">&#x27;登录成功&#x27;</span>,</span><br><span class="line">                                <span class="attr">icon</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">                                <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            wx.<span class="title function_">removeStorage</span>(&#123;</span><br><span class="line">                                <span class="attr">key</span>: <span class="string">&#x27;TICKET&#x27;</span></span><br><span class="line">                            &#125;);</span><br><span class="line">                            wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                                <span class="attr">title</span>: <span class="string">&#x27;登录失败!&#x27;</span>,</span><br><span class="line">                                <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">                                <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210425144056602.png" alt="image-20210425144056602"></p><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p><a target="_blank" rel="noopener" href="https://gitee.com/dgx/wx-jq">wx-jq: wx-jq一套完全原创的微信小程序插件集合库,微信小程序插件,wx-jq (gitee.com)</a></p><h2 id="WebMagic-amp-房源搜索"><a href="#WebMagic-amp-房源搜索" class="headerlink" title="WebMagic &amp; 房源搜索"></a>WebMagic &amp; 房源搜索</h2><p>WebMagic是一个简单灵活的Java爬虫框架。基于WebMagic，你可以快速开发出一个高效、易维护的爬虫。</p><p><img src="/posts/855804072/image-20210510190142733.png" alt="image-20210510190142733"></p><ul><li>简单的API，可快速上手</li><li>模块化的结构，可轻松扩展</li><li>提供多线程和分布式支持</li></ul><h3 id="使用WebMagic-抓取数据"><a href="#使用WebMagic-抓取数据" class="headerlink" title="使用WebMagic 抓取数据"></a>使用WebMagic 抓取数据</h3><h4 id="0-爬虫流程"><a href="#0-爬虫流程" class="headerlink" title="0. 爬虫流程"></a>0. 爬虫流程</h4><ol><li><p>访问列表页面，将当前列表页的房源详情页面添加到 <code>list</code> ，作为待爬取页面</p><ul><li><p>列表页</p><p><img src="/posts/855804072/image-20210510213628178.png" alt="image-20210510213628178"></p></li><li><p>当前列表的详情页链接</p><p><img src="/posts/855804072/image-20210510213307353.png" alt></p></li></ul></li><li><p>将其余列表页放入到待爬取链接 <code>list</code> 中</p><p><img src="/posts/855804072/image-20210510214302766.png" alt="image-20210510214302766"></p><blockquote><p><code>WebMagic</code> 内部有去重操作，已爬取过的页面不做重复操作</p></blockquote></li><li><p>去详情页面爬取信息</p><ul><li><p>调试查看变量</p><p><img src="/posts/855804072/image-20210510222652620.png" alt="image-20210510222652620"></p></li><li><p>对应的控制台输出</p><p><img src="/posts/855804072/image-20210510222722357.png" alt="image-20210510222722357"></p></li></ul><blockquote><p>信息被存在 <code>page</code> 变量中，默认是输出到控制台，可以编写 <code>Pipeline</code> 对 <code>page</code> 自行处理</p></blockquote><ol><li><p>当 <code>LianjiaPageProcessor.process()</code> 方法处理后，会调用 <code>MyPipeline</code> 进行处理</p><p><img src="/posts/855804072/image-20210511103424592.png" alt="image-20210511103424592"><img src="/posts/855804072/image-20210511103544854-164899647862999.png" alt="image-20210511103544854"></p><p><img src="/posts/855804072/image-20210511104219512.png" alt="image-20210511104219512"></p></li></ol></li></ol><h4 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1. 导入依赖"></a>1. 导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-爬取逻辑"><a href="#2-爬取逻辑" class="headerlink" title="2. 爬取逻辑"></a>2. 爬取逻辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.elasticsearch.wm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Page;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Site;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Spider;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.processor.PageProcessor;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.selector.Html;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 1. 获取爬取的链接</span></span><br><span class="line"><span class="comment">* 2. 从目标网页上获取信息</span></span><br><span class="line"><span class="comment">* 3. 拼接从网页上获取的信息</span></span><br><span class="line"><span class="comment">* 4. 将数据存储到JSON文件，将图片存储到指定文件夹</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LianjiaPageProcessor</span> <span class="keyword">implements</span> <span class="title class_">PageProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Site</span> <span class="variable">site</span> <span class="operator">=</span> Site.me().setRetryTimes(<span class="number">3</span>).setSleepTime(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Page page)</span> &#123;</span><br><span class="line">        <span class="type">Html</span> <span class="variable">html</span> <span class="operator">=</span> page.getHtml();</span><br><span class="line"></span><br><span class="line">        <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> html.css(<span class="string">&quot;.content__list--item--title&quot;</span>).links().all();</span><br><span class="line">        page.addTargetRequests(list);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> html.xpath(<span class="string">&quot;//div[@class=&#x27;content clear w1150&#x27;]/p/text()&quot;</span>).toString();</span><br><span class="line">        page.putField(<span class="string">&quot;title&quot;</span>,title);</span><br><span class="line">        <span class="type">String</span> <span class="variable">rent</span> <span class="operator">=</span> html.xpath(<span class="string">&quot;//div[@class=&#x27;content__aside--title&#x27;]/span/text()&quot;</span>).toString();</span><br><span class="line">        page.putField(<span class="string">&quot;rent&quot;</span>,rent);</span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> html.xpath(<span class="string">&quot;//ul[@class=&#x27;content__aside__list&#x27;]/allText()&quot;</span>).toString();</span><br><span class="line">        page.putField(<span class="string">&quot;type&quot;</span>,type);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pic</span> <span class="operator">=</span> html.xpath(<span class="string">&quot;//div[@class=&#x27;content__article__slide__item&#x27;]/img&quot;</span>).toString();</span><br><span class="line">        page.putField(<span class="string">&quot;pic&quot;</span>,pic);<span class="comment">//从根标签下找</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(page.getResultItems().get(<span class="string">&quot;title&quot;</span>)==<span class="literal">null</span>)&#123;</span><br><span class="line">            page.setSkip(<span class="literal">true</span>);<span class="comment">//表示当前页是列表页 或者 没有房源信息，跳过爬取</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//排除列表页</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">                page.addTargetRequest(<span class="string">&quot;https://ty.lianjia.com/zufang/pg&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Site <span class="title function_">getSite</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Spider.create(<span class="keyword">new</span> <span class="title class_">LianjiaPageProcessor</span>())</span><br><span class="line">                .addUrl(<span class="string">&quot;https://ty.lianjia.com/zufang/&quot;</span>)</span><br><span class="line">                .thread(<span class="number">1</span>)</span><br><span class="line">            .addPipeline(<span class="keyword">new</span> <span class="title class_">MyPipeline</span>())<span class="comment">//对爬取到信息的自定义处理</span></span><br><span class="line">                .run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-MyPipeline对信息处理"><a href="#3-MyPipeline对信息处理" class="headerlink" title="3. MyPipeline对信息处理"></a>3. MyPipeline对信息处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.elasticsearch.wm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.ResultItems;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.Task;</span><br><span class="line"><span class="keyword">import</span> us.codecraft.webmagic.pipeline.Pipeline;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Auspice Tian</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 2021-05-10 22:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@current</span> elasticSearch-com.elasticsearch.wm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPipeline</span> <span class="keyword">implements</span> <span class="title class_">Pipeline</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">MAPPER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(ResultItems resultItems, Task task)</span> &#123;</span><br><span class="line">        Map&lt;String,Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        data.put(<span class="string">&quot;url&quot;</span>,resultItems.getRequest().getUrl());<span class="comment">//目标链接</span></span><br><span class="line">        data.put(<span class="string">&quot;title&quot;</span>,resultItems.get(<span class="string">&quot;title&quot;</span>));<span class="comment">//title</span></span><br><span class="line">        data.put(<span class="string">&quot;rent&quot;</span>, resultItems.get(<span class="string">&quot;rent&quot;</span>));<span class="comment">//租金</span></span><br><span class="line"></span><br><span class="line">        String[] types = StringUtils.split(resultItems.get(<span class="string">&quot;type&quot;</span>), <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        data.put(<span class="string">&quot;rentMethod&quot;</span>, types[<span class="number">0</span>]);<span class="comment">//租赁方式</span></span><br><span class="line">        data.put(<span class="string">&quot;houseType&quot;</span>, types[<span class="number">1</span>]);<span class="comment">//户型，如：2室1厅1卫</span></span><br><span class="line">        data.put(<span class="string">&quot;orientation&quot;</span>, types[<span class="number">2</span>]);<span class="comment">//朝向</span></span><br><span class="line"></span><br><span class="line">        String[] infos = StringUtils.split(resultItems.get(<span class="string">&quot;info&quot;</span>), <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String info : infos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.startsWith(info, <span class="string">&quot;看房：&quot;</span>)) &#123;</span><br><span class="line">                data.put(<span class="string">&quot;time&quot;</span>, StringUtils.split(info, <span class="string">&#x27;：&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.startsWith(info, <span class="string">&quot;楼层：&quot;</span>)) &#123;</span><br><span class="line">                data.put(<span class="string">&quot;floor&quot;</span>, StringUtils.split(info, <span class="string">&#x27;：&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; imageList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        String[] pics = StringUtils.split(resultItems.get(<span class="string">&quot;pic&quot;</span>), <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">baseName</span> <span class="operator">=</span> StringUtils.substringBefore(StringUtils.substringAfterLast(resultItems.getRequest().getUrl(), <span class="string">&quot;/&quot;</span>), <span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pic</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pics.length; i++) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> StringUtils.join(StringUtils.split(pics[i], <span class="string">&#x27;&quot;&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line">               <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> baseName + <span class="string">&quot;_&quot;</span> +i + <span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">               <span class="built_in">this</span>.downloadFile(url, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;F:\\idea\\graduateProject\\images\\&quot;</span> + newName));</span><br><span class="line">               imageList.add(newName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">imageUrl</span> <span class="operator">=</span> StringUtils.join(imageList,<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            data.put(<span class="string">&quot;image&quot;</span>,imageUrl);</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> MAPPER.writeValueAsString(data);</span><br><span class="line">            FileUtils.write(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;F:\\idea\\graduateProject\\data.json&quot;</span>), json + <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 文件url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dest 目标目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downloadFile</span><span class="params">(String url, File dest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HttpClientBuilder.create().build().execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.writeByteArrayToFile(dest, IOUtils.toByteArray(response.getEntity().getContent()));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-将图片上传到COS"><a href="#4-将图片上传到COS" class="headerlink" title="4. 将图片上传到COS"></a>4. 将图片上传到COS</h4><p><img src="/posts/855804072/image-20210511114338173.png" alt="image-20210511114338173"></p><h3 id="将数据导入ES"><a href="#将数据导入ES" class="headerlink" title="将数据导入ES"></a>将数据导入ES</h3><h4 id="1-设置ik分词器"><a href="#1-设置ik分词器" class="headerlink" title="1. 设置ik分词器"></a>1. 设置ik分词器</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd /data/es-cluster-data/ik</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将IK的zip压缩包解压到该目录</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止、删除现有容器</span></span><br><span class="line">docker stop es-node01 es-node02 es-node03</span><br><span class="line">docker rm es-node01 es-node02 es-node03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新创建容器，挂在ik目录</span></span><br><span class="line">docker create --name es-node01 --net host -v /data/es-cluster-data/node01/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node01/jvm.options:/usr/share/elasticsearch/config/jvm.options -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/node01/data:/usr/share/elasticsearch/data elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">docker create --name es-node02 --net host -v /data/es-cluster-data/node02/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node02/jvm.options:/usr/share/elasticsearch/config/jvm.options -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/node02/data:/usr/share/elasticsearch/data elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">docker create --name es-node03 --net host -v /data/es-cluster-data/node03/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node03/jvm.options:/usr/share/elasticsearch/config/jvm.options -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/node03/data:/usr/share/elasticsearch/data elasticsearch:6.5.4</span><br></pre></td></tr></table></figure><p>测试ik分词器</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/_analyze</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我是中国人&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国人&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中国&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;国人&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="2-文档mapping"><a href="#2-文档mapping" class="headerlink" title="2. 文档mapping"></a>2. 文档mapping</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 新建索引</span><br><span class="line">PUT http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;house&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><ul><li><code>dynamic</code><ul><li>参数来控制字段的新增</li><li>true：默认值，表示允许自动新增字段</li><li>false：不允许自动新增字段，但文档可以正常写入，但无法对字段进行查询</li><li>strict：严格模式，文档不能写入，报错</li></ul></li><li><code>index</code><ul><li>控制当前字段是否被索引，默认为 true，false表示不记录，即不可被搜索</li></ul></li></ul></blockquote><p><img src="/posts/855804072/image-20210511122036312.png" alt="image-20210511122036312"></p><h4 id="3-测试ES集群"><a href="#3-测试ES集群" class="headerlink" title="3. 测试ES集群"></a>3. 测试ES集群</h4><p><strong>新增数据</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke/house</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2760703226025353216_0.jpg,TY2760703226025353216_1.jpg,TY2760703226025353216_2.jpg,TY2760703226025353216_3.jpg,TY2760703226025353216_4.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：4室0厅2卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：合租&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;随时可看&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 合租·翰府 4居室 西卧 &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;800&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4/25层&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://ty.lianjia.com/zufang/TY2760703226025353216.html&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210511123356880.png" alt="image-20210511123356880"></p><hr><p><strong>测试搜索</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke/house/_search</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;合租&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">54</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;haoke&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;house&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XTazWXkBRTe_j_yGOSnN&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">0.2876821</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2760703226025353216_0.jpg,TY2760703226025353216_1.jpg,TY2760703226025353216_2.jpg,TY2760703226025353216_3.jpg,TY2760703226025353216_4.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：4室0厅2卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：合租&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;随时可看&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 合租·翰府 4居室 西卧 &quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;800&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4/25层&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://ty.lianjia.com/zufang/TY2760703226025353216.html&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="string">&quot;&lt;em&gt;合租&lt;/em&gt;·翰府 4居室 西卧&quot;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><p><strong>测试未被索引字段</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4室0厅2卫&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210511124752691.png" alt="image-20210511124752691"></p><p><code>index</code> 被设置为false的字段不能进行搜索操作</p><h4 id="4-将数据批量导入ES"><a href="#4-将数据批量导入ES" class="headerlink" title="4. 将数据批量导入ES"></a>4. 将数据批量导入ES</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 批量插入数据</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bulk</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;/haoke/house/_bulk&quot;</span>);</span><br><span class="line">    List&lt;String&gt; lines = FileUtils.readLines(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\idea\\graduateProject\\tylj-data.json&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    <span class="comment">//data.json中  每一行都是一个文档</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">createStr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;index\&quot;: &#123;\&quot;_index\&quot;:\&quot;haoke\&quot;,\&quot;_type\&quot;:\&quot;house\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">        sb.append(createStr + <span class="string">&quot;\n&quot;</span> + line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (count &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            request.setJsonEntity(sb.toString());</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="built_in">this</span>.restClient.performRequest(request);</span><br><span class="line"></span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">            sb = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke/house/_search</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span><span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;整租&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210511130730069.png" alt="image-20210511130730069"></p><h3 id="房源搜索功能"><a href="#房源搜索功能" class="headerlink" title="房源搜索功能"></a>房源搜索功能</h3><h4 id="房源搜索接口"><a href="#房源搜索接口" class="headerlink" title="房源搜索接口"></a>房源搜索接口</h4><h5 id="1-导入依赖-1"><a href="#1-导入依赖-1" class="headerlink" title="1. 导入依赖"></a>1. 导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ElasticSearch依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="2-添加配置"><a href="#2-添加配置" class="headerlink" title="2. 添加配置"></a>2. 添加配置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># elasticsearch配置</span></span><br><span class="line"><span class="attr">spring.data.elasticsearch.cluster-name</span>=<span class="string">es-haoke-cluster</span></span><br><span class="line"><span class="attr">spring.data.elasticsearch.cluster-nodes</span>=<span class="string">8.140.130.91:9300,8.140.130.91:9301,8.140.130.91:9302</span></span><br></pre></td></tr></table></figure><h5 id="3-编写vo——HouseData、SearchResult"><a href="#3-编写vo——HouseData、SearchResult" class="headerlink" title="3. 编写vo——HouseData、SearchResult"></a>3. 编写vo——HouseData、SearchResult</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;haoke&quot;,type = &quot;house&quot;,createIndex = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HouseData</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String rent;</span><br><span class="line">    <span class="keyword">private</span> String floor;</span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line">    <span class="keyword">private</span> String orientation;</span><br><span class="line">    <span class="keyword">private</span> String houseType;</span><br><span class="line">    <span class="keyword">private</span> String rentMethod;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESSearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer totalPage;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HouseData&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-编写Controller"><a href="#4-编写Controller" class="headerlink" title="4. 编写Controller"></a>4. 编写Controller</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.controller.frontController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.haoke.api.service.ESSearchService;</span><br><span class="line"><span class="keyword">import</span> com.haoke.api.vo.ESSearchResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;search&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ESSearchService esSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ESSearchResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestParam(&quot;keyword&quot;)</span>String keyword,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@RequestParam(value = &quot;page&quot;,defaultValue = &quot;1&quot;)</span>Integer page)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(page &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            page = <span class="number">1</span>;<span class="comment">//防止爬取过多数据</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.esSearchService.search(keyword,page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="5-编写Service"><a href="#5-编写Service" class="headerlink" title="5. 编写Service"></a>5. 编写Service</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESSearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ROWS</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ESSearchResult <span class="title function_">search</span><span class="params">(String keyword, Integer page)</span> &#123;</span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page-<span class="number">1</span>,ROWS);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">                .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>,keyword).operator(Operator.AND))</span><br><span class="line">                .withPageable(pageRequest)</span><br><span class="line">                .withHighlightFields(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        AggregatedPage&lt;HouseData&gt; houseData = <span class="built_in">this</span>.elasticsearchTemplate.queryForPage(searchQuery, HouseData.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ESSearchResult</span>(houseData.getTotalPages(),houseData.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="6-启动"><a href="#6-启动" class="headerlink" title="6. 启动"></a>6. 启动</h5><p><img src="/posts/855804072/image-20210511173821935.png" alt="image-20210511173821935"></p><blockquote><p>整合Redis后，引发了netty冲突，需要在启动类中加入</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DubboApiApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        SpringApplication.run(DubboApiApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="7-测试"><a href="#7-测试" class="headerlink" title="7. 测试"></a>7. 测试</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">GET http<span class="punctuation">:</span><span class="comment">//127.0.0.1:9091/housing/search?keyWord=整租&amp;page=1</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;totalPage&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XzbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·中正·锦城 1室0厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1200&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;低楼层/18层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2744161905324064768_0.jpg,TY2744161905324064768_1.jpg,TY2744161905324064768_2.jpg,TY2744161905324064768_3.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室0厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HKzLWXkBbSHXsITPqKGk&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·华润大厦 1室1厅 北 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1500&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中楼层/30层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;43㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gzbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·大马新村 2室1厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1700&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中楼层/6层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2765003811390234624_0.jpg,TY2765003811390234624_1.jpg,TY2765003811390234624_2.jpg,TY2765003811390234624_3.jpg,TY2765003811390234624_4.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;40㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：2室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C6zLWXkBbSHXsITPqKGk&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·王村小区 1室1厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1980&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;高楼层/12层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2779698262129508352_0.jpg,TY2779698262129508352_1.jpg,TY2779698262129508352_2.jpg,TY2779698262129508352_3.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;45㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fjbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·景观新贵 2室1厅 东 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2000&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中楼层/18层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2777610759704674304_0.jpg,TY2777610759704674304_1.jpg,TY2777610759704674304_2.jpg,TY2777610759704674304_3.jpg,TY2777610759704674304_4.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;98㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：2室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ZKzLWXkBbSHXsITPqKGk&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·国际公寓 1室1厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1700&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;低楼层/19层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2762195172271341568_0.jpg,TY2762195172271341568_1.jpg,TY2762195172271341568_2.jpg,TY2762195172271341568_3.jpg,TY2762195172271341568_4.jpg,TY2762195172271341568_5.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;67㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7lrLWXkB95epjtTKoTab&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·文锦世家 2室0厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2200&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;高楼层/28层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;75㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：2室0厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bDbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·佳地花园 2室1厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1600&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;低楼层/6层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2762299531344486400_0.jpg,TY2762299531344486400_1.jpg,TY2762299531344486400_2.jpg,TY2762299531344486400_3.jpg,TY2762299531344486400_4.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;58㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：2室1厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ijbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·汾河景观360 1室0厅 北 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1500&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;高楼层/33层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2778104741962448896_0.jpg,TY2778104741962448896_1.jpg,TY2778104741962448896_2.jpg,TY2778104741962448896_3.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室0厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;wFrLWXkB95epjtTKoTab&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot; 整租·富力湾 3室2厅 南 &quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3000&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中楼层/34层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2565750322844663808_0.jpg,TY2565750322844663808_1.jpg,TY2565750322844663808_2.jpg,TY2565750322844663808_3.jpg,TY2565750322844663808_4.jpg,TY2565750322844663808_5.jpg,TY2565750322844663808_6.jpg,TY2565750322844663808_7.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;120㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：3室2厅2卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="房源搜索整合前端"><a href="#房源搜索整合前端" class="headerlink" title="房源搜索整合前端"></a>房源搜索整合前端</h4><p>流程：</p><ul><li><p>输入框聚焦，<code>this.state/searchBarFlag = true</code> ，则显示 <code>SearchBar</code></p></li><li><p>输入框失焦，<code>this.state/searchBarFlag = false</code> ，则隐藏 <code>SearchBar</code></p></li></ul><p><img src="/posts/855804072/image-20210511220314214.png" alt="image-20210511220314214"></p><p><img src="/posts/855804072/image-20210511220503406.png" alt="image-20210511220503406"></p><h5 id="home-js"><a href="#home-js" class="headerlink" title="home.js"></a>home.js</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">class Home extends React.Component &#123;</span><br><span class="line">    componentDidMount = () =&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">        Promise.all([swipe, menu, info, faq, house]).then((result)=&gt;&#123;</span><br><span class="line">            this.setState(&#123;</span><br><span class="line">                swipeData: result[0],</span><br><span class="line">                menuData: result[1],</span><br><span class="line">                infoData: result[2],</span><br><span class="line">                faqData: result[3],</span><br><span class="line">                houseData: result[4],</span><br><span class="line">                menuLoading: true,</span><br><span class="line">                swipeLoading: true,</span><br><span class="line">                infoLoading: true,</span><br><span class="line">                faqLoading: true,</span><br><span class="line">                houseLoading: true,</span><br><span class="line">                globalLoading: false,</span><br><span class="line">                searchBarFlag:false,</span><br><span class="line">                searchData:[]</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hideSearchBar = () =&gt; &#123;</span><br><span class="line">        this.setState(&#123;searchBarFlag:false&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    searchHandle = () =&gt; &#123;</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">            searchBarFlag: true</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    search = (event, data) =&gt;&#123;</span><br><span class="line">        let value = data.value;</span><br><span class="line">        let _this =this;</span><br><span class="line">        _this.searchHandle();</span><br><span class="line">        axios.get(&#x27;http://127.0.0.1:9091/housing/search?keyWord=&#x27;+value+&#x27;&amp;page=1&#x27;).then((data)=&gt;&#123;</span><br><span class="line">            console.log(data)</span><br><span class="line">            if(data.list.length != 0)</span><br><span class="line">                _this.setState(&#123;searchData:data.list&#125;);</span><br><span class="line">            else</span><br><span class="line">                _this.setState(&#123;searchData:[]&#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        ...</span><br><span class="line">        return (</span><br><span class="line">            &lt;div className=&#x27;home-container&#x27;&gt;</span><br><span class="line">                &#123;this.state.mapShowFlag?&lt;MapHouse hideMap=&#123;this.hideMap&#125;/&gt;:null&#125;</span><br><span class="line">                &#123;this.state.calcShowFlag?&lt;Calculator hideCalc=&#123;this.hideCalc&#125;/&gt;:null&#125;</span><br><span class="line">                &#123;this.state.searchBarFlag</span><br><span class="line">                    ? &lt;SearchBar hideSearchBar=&#123;this.hideSearchBar&#125; searchData=&#123;this.state.searchData&#125;/&gt;</span><br><span class="line">                    : null&#125;</span><br><span class="line">                &lt;div className=&quot;home-topbar&quot;&gt;</span><br><span class="line">                    &#123;/*onChange=&#123;this.search.bind(this) &#125;*/&#125;</span><br><span class="line">                    &#123;/*onBlur=&#123;this.hideSearchBar&#125; onClick=&#123;this.searchHandle&#125;*/&#125;</span><br><span class="line">                    &lt;Input fluid onChange=&#123;this.search.bind(this) &#125; icon=&#123;&#123; name: &#x27;search&#x27;, circular: true, link: true &#125;&#125; placeholder=&#x27;搜房源...&#x27; /&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            ...</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">export default withRouter(Home);</span><br></pre></td></tr></table></figure><h5 id="home-css"><a href="#home-css" class="headerlink" title="home.css"></a>home.css</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">···</span><br><span class="line"><span class="selector-class">.search-bar</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">50px</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">38px</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">9999</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto; <span class="comment">/**这里做了修改，y轴方向有滚动条**/</span></span><br><span class="line">&#125;</span><br><span class="line">···</span><br></pre></td></tr></table></figure><h5 id="SearchBar-js"><a href="#SearchBar-js" class="headerlink" title="SearchBar.js"></a>SearchBar.js</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line">// import &#123; Icon&#125; from &#x27;semantic-ui-react&#x27;</span><br><span class="line">import &#123; Icon,Item &#125; from &#x27;semantic-ui-react&#x27;;</span><br><span class="line">import &quot;./search.css&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SearchBar extends React.Component &#123;</span><br><span class="line"></span><br><span class="line">    hideSearchBar = () =&gt; &#123;</span><br><span class="line">        this.props.hideSearchBar();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        return (</span><br><span class="line">            &lt;div className = &#x27;search-bar&#x27; &gt;</span><br><span class="line">                &lt;Icon onClick=&#123;this.hideSearchBar&#125; name = &#x27;angle left&#x27; size = &#x27;large&#x27;/&gt;</span><br><span class="line">                &lt;div className = &quot;search-bar-content&quot;&gt;</span><br><span class="line">                    &lt;Item.Group divided unstackable&gt;</span><br><span class="line">                        &#123;</span><br><span class="line">                            this.props.searchData.map(item =&gt; &#123;</span><br><span class="line">                                return (</span><br><span class="line">                                    &lt;Item key=&#123;item.id&#125;&gt;</span><br><span class="line">                                        &lt;Item.Image</span><br><span class="line">                                            src=&#123;&quot;https://haoke-1257323542.cos.ap-beijing.myqcloud.com/tylj-images/&quot;</span><br><span class="line">                                            + item.pic.split(&quot;,&quot;)[0]&#125;/&gt;</span><br><span class="line">                                        &lt;Item.Content&gt;</span><br><span class="line">                                            &lt;Item.Header&gt;&lt;div className=&#x27;house-title&#x27;&gt;</span><br><span class="line">                                                &#123;item.title&#125;&lt;/div&gt;&lt;/Item.Header&gt;</span><br><span class="line">                                            &lt;Item.Meta&gt;</span><br><span class="line">                                    &lt;span className=&#x27;cinema&#x27;&gt;</span><br><span class="line">&#123;item.orientation&#125;/&#123;item.rentMethod&#125;/&#123;item.houseType&#125;&lt;/span&gt;</span><br><span class="line">                                            &lt;/Item.Meta&gt;</span><br><span class="line">                                            &lt;Item.Description&gt;</span><br><span class="line">                                                上海</span><br><span class="line">                                            &lt;/Item.Description&gt;</span><br><span class="line">                                            &lt;Item.Description&gt;&#123;item.rent&#125;</span><br><span class="line">                                            &lt;/Item.Description&gt;</span><br><span class="line">                                        &lt;/Item.Content&gt;</span><br><span class="line">                                    &lt;/Item&gt;</span><br><span class="line">                                )</span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &lt;/Item.Group&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default SearchBar;</span><br></pre></td></tr></table></figure><h5 id="search-css"><a href="#search-css" class="headerlink" title="search.css"></a>search.css</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.house-title</span>&#123;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="房源搜索——高亮"><a href="#房源搜索——高亮" class="headerlink" title="房源搜索——高亮"></a>房源搜索——高亮</h3><p><img src="/posts/855804072/image-20210512104946763.png" alt="image-20210512104946763"></p><p><img src="/posts/855804072/image-20210512105552768.png" alt="image-20210512105552768"></p><p><img src="/posts/855804072/image-20210512105625790.png" alt="image-20210512105625790"></p><h4 id="后台实现"><a href="#后台实现" class="headerlink" title="后台实现"></a>后台实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.haoke.api.vo.ESSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.haoke.api.vo.es.HouseData;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.reflect.FieldUtils;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.text.Text;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.Operator;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightField;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.core.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.SearchResultMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.aggregation.AggregatedPage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.aggregation.impl.AggregatedPageImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.SearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESSearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ROWS</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ESSearchResult <span class="title function_">search</span><span class="params">(String keyword, Integer page)</span> &#123;</span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page-<span class="number">1</span>,ROWS);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">                .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>,keyword).operator(Operator.AND))</span><br><span class="line">                .withPageable(pageRequest)</span><br><span class="line">                .withHighlightFields(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 高亮显示，需要指定属性映射，此时不会进行自动映射，所有的属性都必须手动因难割舍</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        AggregatedPage&lt;HouseData&gt; houseData = <span class="built_in">this</span>.elasticsearchTemplate.queryForPage(searchQuery, HouseData.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">SearchResultMapper</span>() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * searchResponse : 返回结果</span></span><br><span class="line"><span class="comment">                    * aClass         : ES类型</span></span><br><span class="line"><span class="comment">                    * pageable       : 分页信息</span></span><br><span class="line"><span class="comment">                    * */</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> &lt;T&gt; AggregatedPage&lt;T&gt; <span class="title function_">mapResults</span><span class="params">(SearchResponse searchResponse, Class&lt;T&gt; aClass, Pageable pageable)</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//返回结果</span></span><br><span class="line">                        List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//返回空结果</span></span><br><span class="line">                        <span class="keyword">if</span>(searchResponse.getHits().totalHits==<span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregatedPageImpl</span>&lt;&gt;(Collections.emptyList(),pageable,<span class="number">0L</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//查询结果不为空</span></span><br><span class="line">                        <span class="keyword">for</span> (SearchHit hit : searchResponse.getHits()) &#123;</span><br><span class="line">                            <span class="comment">//对每个结果进行处理</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment">//通过反射机制，创建ORM的java对象</span></span><br><span class="line">                            <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> (T) ReflectUtils.newInstance(aClass);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">//将 id 写入</span></span><br><span class="line">                                FieldUtils.writeField(obj,<span class="string">&quot;id&quot;</span>,hit.getId(),<span class="literal">true</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            * ES数据</span></span><br><span class="line"><span class="comment">                            * &#123;</span></span><br><span class="line"><span class="comment">                                    &quot;_index&quot;: &quot;haoke&quot;,</span></span><br><span class="line"><span class="comment">                                    &quot;_type&quot;: &quot;house&quot;,</span></span><br><span class="line"><span class="comment">                                    &quot;_id&quot;: &quot;XjbLWXkBRTe_j_yGmSm3&quot;,</span></span><br><span class="line"><span class="comment">                                    &quot;_version&quot;: 1,</span></span><br><span class="line"><span class="comment">                                    &quot;_score&quot;: 1,</span></span><br><span class="line"><span class="comment">                                    &quot;_source&quot;: &#123;</span></span><br><span class="line"><span class="comment">                                        &quot;pic&quot;: &quot;TY2760703226025353216_0.jpg,TY2760703226025353216_1.jpg,TY2760703226025353216_2.jpg,TY2760703226025353216_3.jpg,TY2760703226025353216_4.jpg&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;orientation&quot;: &quot;30㎡&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;houseType&quot;: &quot;房屋类型：4室0厅2卫&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;rentMethod&quot;: &quot;租赁方式：合租&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;time&quot;: &quot;随时可看&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;title&quot;: &quot; 合租·翰府 4居室 西卧 &quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;rent&quot;: &quot;800&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;floor&quot;: &quot;4/25层&quot;,</span></span><br><span class="line"><span class="comment">                                        &quot;url&quot;: &quot;https://ty.lianjia.com/zufang/TY2760703226025353216.html&quot;</span></span><br><span class="line"><span class="comment">                                    &#125;</span></span><br><span class="line"><span class="comment">                                &#125;</span></span><br><span class="line"><span class="comment">                            * */</span></span><br><span class="line">                            Map&lt;String ,Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : sourceAsMap.entrySet()) &#123;</span><br><span class="line">                                <span class="comment">//对每个键值对进行映射</span></span><br><span class="line">                                <span class="keyword">if</span>(<span class="literal">null</span> == FieldUtils.getField(aClass, entry.getKey(), <span class="literal">true</span>))&#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">//向 obj 中写入键值对</span></span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    FieldUtils.writeField(obj, entry.getKey(), entry.getValue(),<span class="literal">true</span>);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//处理高亮字段 覆盖</span></span><br><span class="line">                            <span class="keyword">for</span> (Map.Entry&lt;String, HighlightField&gt; stringHighlightFieldEntry : hit.getHighlightFields().entrySet()) &#123;</span><br><span class="line">                                Text[] fragments = stringHighlightFieldEntry.getValue().fragments();</span><br><span class="line"></span><br><span class="line">                                <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                                <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">                                    sb.append(fragment.toString());</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    FieldUtils.writeField(obj,stringHighlightFieldEntry.getKey(),sb.toString(),<span class="literal">true</span>);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            result.add(obj);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregatedPageImpl</span>&lt;&gt;(result,pageable, searchResponse.getHits().totalHits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ESSearchResult</span>(houseData.getTotalPages(),houseData.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;totalPage&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;XzbLWXkBRTe_j_yGmSm3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;整&lt;/em&gt;&lt;em&gt;租&lt;/em&gt;·中正·锦城 1室0厅 南&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1200&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;低楼层/18层&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TY2744161905324064768_0.jpg,TY2744161905324064768_1.jpg,TY2744161905324064768_2.jpg,TY2744161905324064768_3.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30㎡&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;房屋类型：1室0厅1卫&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="string">&quot;租赁方式：整租&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需提前预约&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="整合前端-1"><a href="#整合前端-1" class="headerlink" title="整合前端"></a>整合前端</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Item.Header</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;house-title&#x27;</span> <span class="attr">dangerouslySetInnerHTML</span>=</span></span><br><span class="line"><span class="tag"><span class="string">&#123;&#123;__html:item.title&#125;&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">Item.Header</span>&gt;</span></span><br><span class="line"></span><br><span class="line">.house-title em&#123;</span><br><span class="line">    font-style: normal;</span><br><span class="line">    color: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210512111246026.png" alt></p><h3 id="房源搜索——分页"><a href="#房源搜索——分页" class="headerlink" title="房源搜索——分页"></a>房源搜索——分页</h3><h4 id="分页组件"><a href="#分页组件" class="headerlink" title="分页组件"></a>分页组件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Icon,Item,Pagination &#125; from &#x27;semantic-ui-react&#x27;;</span><br></pre></td></tr></table></figure><h4 id="searchBar-js"><a href="#searchBar-js" class="headerlink" title="searchBar.js"></a>searchBar.js</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">handlePageChange = (e, &#123; activePage &#125;) =&gt;&#123;</span><br><span class="line">    this.props.searchPage(null,&#123;</span><br><span class="line">        page:activePage</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">    return (</span><br><span class="line">        &#123;</span><br><span class="line">            this.props.totalPage &gt; 1?(</span><br><span class="line">            &lt;Pagination</span><br><span class="line">                defaultActivePage=&#123;1&#125;</span><br><span class="line">                firstItem=&#123;null&#125;</span><br><span class="line">                lastItem=&#123;null&#125;</span><br><span class="line">                totalPages=&#123;this.props.totalPage&#125;</span><br><span class="line">                onPageChange=&#123;this.handlePageChange&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">            ):null</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="home-js-1"><a href="#home-js-1" class="headerlink" title="home.js"></a>home.js</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">search = (event, data) =&gt;&#123;</span><br><span class="line">    let value = data.value ? data.value : this.state.searchKeyWord;</span><br><span class="line">    let _this =this;</span><br><span class="line">    let page = data.page ? data.page: 1;</span><br><span class="line"></span><br><span class="line">    _this.searchHandle();</span><br><span class="line">    axios.get(&#x27;http://127.0.0.1:9091/housing/search?keyWord=&#x27;+value+&#x27;&amp;page=&#x27;+page).then((data)=&gt;&#123;</span><br><span class="line">        if(data.list.length != 0)</span><br><span class="line">            _this.setState(&#123;searchData:data.list&#125;);</span><br><span class="line">        else</span><br><span class="line">            _this.setState(&#123;searchData:[]&#125;);</span><br><span class="line"></span><br><span class="line">        _this.setState(&#123;</span><br><span class="line">            totalPage:data.totalPage,</span><br><span class="line">            searchKeyWord: value</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;this.state.searchBarFlag</span><br><span class="line">    ? &lt;SearchBar hideSearchBar=&#123;this.hideSearchBar&#125; searchPage=&#123;this.search&#125; searchData=&#123;this.state.searchData&#125; totalPage=&#123;this.state.totalPage&#125; /&gt;</span><br><span class="line">    : null&#125;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210512121556520.png" alt></p><h3 id="房源搜索——热词搜索"><a href="#房源搜索——热词搜索" class="headerlink" title="房源搜索——热词搜索"></a>房源搜索——热词搜索</h3><p>需求：当无搜索结果或搜索结果只有一页时，显示搜索热词，最多显示5个热词</p><p>热词：按照用户搜索的关键字以及搜索到的结果数量进行排序，结果数量越多的排到越前面</p><h4 id="实现分析"><a href="#实现分析" class="headerlink" title="实现分析"></a>实现分析</h4><p><img src="/posts/855804072/未命名文件.png" alt="未命名文件"></p><ol><li><p>用户搜索数据，首先进行ES搜索</p></li><li><p>在搜索完成后，进行判断，是否需要显示热词</p><ul><li><p>如果不需要，直接返回用户请求的数据</p></li><li><p>如果需要，则进行在 <code>Redis</code> 中查询热词</p></li></ul></li><li><p>对于用户搜索词的处理有两种方案</p><ul><li>同步方案：在程序中进行处理，并且把搜索词以及命中的数据数量存到 <code>Redis</code> 中</li><li>异步方案：将查询信息记录到日志文件中，由后续的程序做处理，然后再写入到Redis中</li></ul></li></ol><h4 id="后台"><a href="#后台" class="headerlink" title="后台"></a>后台</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.haoke.api.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.logger.Logger;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.logger.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> com.haoke.api.service.ESSearchService;</span><br><span class="line"><span class="keyword">import</span> com.haoke.api.vo.ESSearchResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;housing/search&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ESController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ESSearchService esSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(ESController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ESSearchResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestParam(&quot;keyWord&quot;)</span> String keyWord,</span></span><br><span class="line"><span class="params">                                 <span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> Integer page)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(page &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            page = <span class="number">1</span>;<span class="comment">//防止爬取过多数据</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ESSearchResult</span> <span class="variable">search</span> <span class="operator">=</span> <span class="built_in">this</span>.esSearchService.search(keyWord, page);</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;HAOKE_HOT_WORD&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(search.getTotalPage() &lt;= <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//需要查询热词，按照得分，获取前5条</span></span><br><span class="line">            Set&lt;String&gt; set = <span class="built_in">this</span>.redisTemplate.opsForZSet().reverseRange(redisKey,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">            search.setHotWord(set);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理热词</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> (Math.max(search.getTotalPage(),<span class="number">1</span>) - <span class="number">1</span>)*esSearchService.ROWS +search.getList().size();</span><br><span class="line">        <span class="comment">//采用zset方式进行存储。值是的数量计算的得分</span></span><br><span class="line">        <span class="built_in">this</span>.redisTemplate.opsForZSet().add(redisKey,keyWord,count);</span><br><span class="line"></span><br><span class="line">        LOGGER.info(<span class="string">&quot;[Search]搜索关键字为：&quot;</span> + keyWord + <span class="string">&quot;，结果数量为：&quot;</span> + count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> search;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="前台-1"><a href="#前台-1" class="headerlink" title="前台"></a>前台</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># search.js</span><br><span class="line">handleHotSearch = (e,data) =&gt;&#123;</span><br><span class="line">    this.props.searchPage(null,&#123;value:data.children&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    this.props.hotWord ? (</span><br><span class="line">        &lt;Container&gt;搜索结果较少，建议搜索：&lt;br/&gt;</span><br><span class="line">            &lt;span&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    this.props.hotWord.map(item =&gt; &#123;</span><br><span class="line">                        return (</span><br><span class="line">                            &lt;Label onClick=&#123;this.handleHotSearch&#125;&gt;&#123;item&#125;</span><br><span class="line">                            &lt;/Label&gt;</span><br><span class="line">                        )</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">        &lt;/Container&gt;</span><br><span class="line">    ): null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># home.js</span><br><span class="line">hideSearchBar = () =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">        searchBarFlag:false,</span><br><span class="line">        searchKeyWord:&quot;&quot;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">search = (event, data) =&gt;&#123;</span><br><span class="line">    let value = data.value ? data.value : this.state.searchKeyWord;</span><br><span class="line">    let _this =this;</span><br><span class="line">    let page = data.page ? data.page: 1;</span><br><span class="line"></span><br><span class="line">    this.setState(&#123;</span><br><span class="line">        searchKeyWord:value</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    _this.searchHandle();</span><br><span class="line">    axios.get(&#x27;http://127.0.0.1:9091/housing/search?keyWord=&#x27;+value+&#x27;&amp;page=&#x27;+page).then((data)=&gt;&#123;</span><br><span class="line">        if(data.list.length != 0)</span><br><span class="line">            _this.setState(&#123;searchData:data.list&#125;);</span><br><span class="line">        else</span><br><span class="line">            _this.setState(&#123;searchData:[]&#125;);</span><br><span class="line"></span><br><span class="line">        _this.setState(&#123;</span><br><span class="line">            totalPage:data.totalPage,</span><br><span class="line">            hotWord: data.hotWord</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">searchHandle = () =&gt; &#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">        searchBarFlag: true</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;this.state.searchBarFlag</span><br><span class="line">    ? &lt;SearchBar hideSearchBar=&#123;this.hideSearchBar&#125; hotWord=&#123;this.state.hotWord&#125;  searchPage=&#123;this.search&#125;</span><br><span class="line">          searchData=&#123;this.state.searchData&#125; totalPage=&#123;this.state.totalPage&#125; /&gt;</span><br><span class="line">    : null&#125;</span><br><span class="line"></span><br><span class="line">&lt;div className=&quot;home-topbar&quot;&gt;</span><br><span class="line">    &#123;/*onChange=&#123;this.search.bind(this) &#125;*/&#125;</span><br><span class="line">    &#123;/*onBlur=&#123;this.hideSearchBar&#125; onClick=&#123;this.searchHandle&#125;*/&#125;</span><br><span class="line">    &lt;Input fluid onChange=&#123;this.search.bind(this) &#125; value=&#123;this.state.searchKeyWord&#125;</span><br><span class="line">        icon=&#123;&#123; name: &#x27;search&#x27;, circular: true, link: true ,&#125;&#125; placeholder=&#x27;搜房源...&#x27; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210512195722246.png" alt></p><p><img src="/posts/855804072/image-20210512195736461.png" alt></p><h3 id="房源搜索——拼音搜索"><a href="#房源搜索——拼音搜索" class="headerlink" title="房源搜索——拼音搜索"></a>房源搜索——拼音搜索</h3><p>ES拼音插件地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p><h4 id="1-ES集群引入拼音插件"><a href="#1-ES集群引入拼音插件" class="headerlink" title="1. ES集群引入拼音插件"></a>1. ES集群引入拼音插件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将zip压缩包，解压到/data/es-cluster-data/pinyin</span></span><br><span class="line">unzip elasticsearch-analysis-pinyin-6.5.4.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重新创建容器</span></span><br><span class="line">docker stop es-node01 es-node02 es-node03</span><br><span class="line">docker rm es-node01 es-node02 es-node03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新创建容器，挂在ik目录</span></span><br><span class="line">docker create --name es-node01 --net host -v /data/es-cluster-data/node01/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node01/jvm.options:/usr/share/elasticsearch/config/jvm.options  -v /data/es-cluster-data/node01/data:/usr/share/elasticsearch/data -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/pinyin:/usr/share/elasticsearch/plugins/pinyin elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">docker create --name es-node02 --net host -v /data/es-cluster-data/node02/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node02/jvm.options:/usr/share/elasticsearch/config/jvm.options -v /data/es-cluster-data/node02/data:/usr/share/elasticsearch/data -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/pinyin:/usr/share/elasticsearch/plugins/pinyin elasticsearch:6.5.4</span><br><span class="line"></span><br><span class="line">docker create --name es-node03 --net host -v /data/es-cluster-data/node03/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/es-cluster-data/node03/jvm.options:/usr/share/elasticsearch/config/jvm.options -v /data/es-cluster-data/node03/data:/usr/share/elasticsearch/data -v /data/es-cluster-data/ik:/usr/share/elasticsearch/plugins/ik -v /data/es-cluster-data/pinyin:/usr/share/elasticsearch/plugins/pinyin elasticsearch:6.5.4</span><br></pre></td></tr></table></figure><h4 id="2-测试拼音分词"><a href="#2-测试拼音分词" class="headerlink" title="2. 测试拼音分词"></a>2. 测试拼音分词</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT /medcl/</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span># 新建索引</span><br><span class="line">		<span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span># 指定分词器</span><br><span class="line">			<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;pinyin_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_pinyin&quot;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span># 分词器限制</span><br><span class="line">				<span class="attr">&quot;my_pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;keep_separate_first_letter&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;keep_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;keep_original&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;limit_first_letter_length&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;keep_first_letter&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span># 词汇拼音首字母搜索</span><br><span class="line">					<span class="attr">&quot;lowercase&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;remove_duplicated_term&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>测试分词</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">GET /medcl/_analyze</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;刘德华&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;tokens&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;liu&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;刘德华&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldh&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;de&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hua&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;start_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;end_offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;word&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;position&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-添加拼音分词支持"><a href="#3-添加拼音分词支持" class="headerlink" title="3. 添加拼音分词支持"></a>3. 添加拼音分词支持</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /medcl/folks/_mapping</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;folks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;term_vector&quot;</span><span class="punctuation">:</span> <span class="string">&quot;with_offsets&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;boost&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>这里使用的是name的子字段，通过fields指定</p></blockquote><p><strong>插入数据</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /medcl/folks/andy</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;刘德华&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210512205047571.png" alt><img src="/posts/855804072/image-20210512205145518-1648996510312100.png" alt></p><h4 id="4-haoke索引添加拼音支持"><a href="#4-haoke索引添加拼音支持" class="headerlink" title="4. haoke索引添加拼音支持"></a>4. haoke索引添加拼音支持</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">PUT http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke/</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;analysis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>#配置拼音分词器</span><br><span class="line">				<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;pinyin_analyzer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_pinyin&quot;</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;my_pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin&quot;</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;keep_separate_first_letter&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;keep_full_pinyin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;keep_original&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;limit_first_letter_length&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;lowercase&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">						<span class="attr">&quot;remove_duplicated_term&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;house&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;dynamic&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">						<span class="attr">&quot;pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span># 子属性</span><br><span class="line">							<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">							<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span></span><br><span class="line">						<span class="punctuation">&#125;</span></span><br><span class="line">					<span class="punctuation">&#125;</span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;houseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;rentMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;rent&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;floor&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//8.140.130.91:9200/haoke/house/_search</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;地铁kou&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;title&quot;</span><span class="punctuation">,</span> <span class="string">&quot;title.pinyin&quot;</span><span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;title.pinyin&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/posts/855804072/image-20210512210038640.png" alt></p><h4 id="5-修改ESControler查询逻辑"><a href="#5-修改ESControler查询逻辑" class="headerlink" title="5. 修改ESControler查询逻辑"></a>5. 修改ESControler查询逻辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">    .withQuery(</span><br><span class="line">    	QueryBuilders.multiMatchQuery(keyWord, <span class="string">&quot;title&quot;</span>,<span class="string">&quot;title.pinyin&quot;</span>)</span><br><span class="line">    .operator(Operator.AND)) <span class="comment">// multiMatch 批量查询</span></span><br><span class="line">	.withPageable(pageRequest)</span><br><span class="line">	.withHighlightFields(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>)) <span class="comment">// 设置高亮</span></span><br><span class="line">.build();</span><br></pre></td></tr></table></figure></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/855804072/" title="前台系统">https://amostian.github.io/posts/855804072/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%BC%80%E5%8F%91/" rel="tag"><i class="fa fa-tags"></i> 开发</a> <a href="/tags/Java%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="fa fa-tags"></i> Java项目</a> <a href="/tags/%E6%AF%95%E8%AE%BE%E9%A1%B9%E7%9B%AE/" rel="tag"><i class="fa fa-tags"></i> 毕设项目</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/2393724542/" rel="prev" title="MongoDB"><i class="fa fa-chevron-left"></i> MongoDB</a></div><div class="post-nav-item"><a href="/posts/585434688/" rel="next" title="数据库集群">数据库集群 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0"><span class="nav-text">前台</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E5%9B%BE%E6%9F%A5%E6%88%BF"><span class="nav-text">地图查房</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5BMap"><span class="nav-text">导入BMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89OverFlowIcon"><span class="nav-text">使用自定义OverFlowIcon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E9%80%BB%E8%BE%91"><span class="nav-text">修改数据加载逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#graphql%E6%8E%A5%E5%8F%A3"><span class="nav-text">graphql接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99MapHouseDataResult%E3%80%81MapHouseXY"><span class="nav-text">编写MapHouseDataResult、MapHouseXY</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MapHouseDataFetcher-Graphql%E6%8E%A5%E5%8F%A3"><span class="nav-text">MapHouseDataFetcher Graphql接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Graphql%E6%8E%A5%E5%8F%A3"><span class="nav-text">测试Graphql接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88%E5%89%8D%E7%AB%AF"><span class="nav-text">整合前端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95"><span class="nav-text">整合前端测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%8B%96%E5%8A%A8%E4%BA%8B%E4%BB%B6"><span class="nav-text">增加拖动事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E9%80%92%E7%BB%8F%E7%BA%AC%E5%BA%A6%E5%92%8C%E7%BC%A9%E6%94%BE%E6%AF%94%E4%BE%8B%E5%8F%82%E6%95%B0"><span class="nav-text">传递经纬度和缩放比例参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%AE%E6%A0%87"><span class="nav-text">实现目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89graphql%E6%8E%A5%E5%8F%A3"><span class="nav-text">定义graphql接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E6%8E%A5%E5%8F%A3%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0"><span class="nav-text">后台接口接收参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="nav-text">前端代码修改</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MongoDB%E7%9A%84%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95"><span class="nav-text">MongoDB的地理位置索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8EMongoDB%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="nav-text">实现基于MongoDB的查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mongo%E4%BE%9D%E8%B5%96"><span class="nav-text">mongo依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mapper%E5%B1%82%E4%BB%A3%E7%A0%81"><span class="nav-text">Mapper层代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#pojo"><span class="nav-text">pojo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#service"><span class="nav-text">service</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="nav-text">接口实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="nav-text">小程序用户登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="nav-text">编写登录服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-wx-login-%E8%8E%B7%E5%8F%96code"><span class="nav-text">1. wx.login()获取code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BB%8E%E5%BE%AE%E4%BF%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-text">2. 从微信服务器获取用户相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Bean%E2%80%94%E2%80%94RestTemplate%E3%80%81JAVA%E7%9A%84HTTP%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-text">3. Bean——RestTemplate、JAVA的HTTP工具类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Controller"><span class="nav-text">4. Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-session%E6%98%AF%E5%90%A6%E5%A4%B1%E6%95%88"><span class="nav-text">5. session是否失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E7%99%BB%E5%BD%95%E6%B5%8B%E8%AF%95"><span class="nav-text">6. 登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6"><span class="nav-text">插件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebMagic-amp-%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2"><span class="nav-text">WebMagic &amp; 房源搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8WebMagic-%E6%8A%93%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-text">使用WebMagic 抓取数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#0-%E7%88%AC%E8%99%AB%E6%B5%81%E7%A8%8B"><span class="nav-text">0. 爬虫流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-text">1. 导入依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%88%AC%E5%8F%96%E9%80%BB%E8%BE%91"><span class="nav-text">2. 爬取逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-MyPipeline%E5%AF%B9%E4%BF%A1%E6%81%AF%E5%A4%84%E7%90%86"><span class="nav-text">3. MyPipeline对信息处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%B0%86%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E5%88%B0COS"><span class="nav-text">4. 将图片上传到COS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5ES"><span class="nav-text">将数据导入ES</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%AE%BE%E7%BD%AEik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-text">1. 设置ik分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%96%87%E6%A1%A3mapping"><span class="nav-text">2. 文档mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%B5%8B%E8%AF%95ES%E9%9B%86%E7%BE%A4"><span class="nav-text">3. 测试ES集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%B0%86%E6%95%B0%E6%8D%AE%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5ES"><span class="nav-text">4. 将数据批量导入ES</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="nav-text">房源搜索功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3"><span class="nav-text">房源搜索接口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="nav-text">1. 导入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="nav-text">2. 添加配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E7%BC%96%E5%86%99vo%E2%80%94%E2%80%94HouseData%E3%80%81SearchResult"><span class="nav-text">3. 编写vo——HouseData、SearchResult</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E7%BC%96%E5%86%99Controller"><span class="nav-text">4. 编写Controller</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E7%BC%96%E5%86%99Service"><span class="nav-text">5. 编写Service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-%E5%90%AF%E5%8A%A8"><span class="nav-text">6. 启动</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-%E6%B5%8B%E8%AF%95"><span class="nav-text">7. 测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E6%95%B4%E5%90%88%E5%89%8D%E7%AB%AF"><span class="nav-text">房源搜索整合前端</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#home-js"><span class="nav-text">home.js</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#home-css"><span class="nav-text">home.css</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SearchBar-js"><span class="nav-text">SearchBar.js</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-css"><span class="nav-text">search.css</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E2%80%94%E2%80%94%E9%AB%98%E4%BA%AE"><span class="nav-text">房源搜索——高亮</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">后台实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88%E5%89%8D%E7%AB%AF-1"><span class="nav-text">整合前端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E2%80%94%E2%80%94%E5%88%86%E9%A1%B5"><span class="nav-text">房源搜索——分页</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E7%BB%84%E4%BB%B6"><span class="nav-text">分页组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#searchBar-js"><span class="nav-text">searchBar.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#home-js-1"><span class="nav-text">home.js</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E2%80%94%E2%80%94%E7%83%AD%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-text">房源搜索——热词搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="nav-text">实现分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0"><span class="nav-text">后台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0-1"><span class="nav-text">前台</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E6%BA%90%E6%90%9C%E7%B4%A2%E2%80%94%E2%80%94%E6%8B%BC%E9%9F%B3%E6%90%9C%E7%B4%A2"><span class="nav-text">房源搜索——拼音搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ES%E9%9B%86%E7%BE%A4%E5%BC%95%E5%85%A5%E6%8B%BC%E9%9F%B3%E6%8F%92%E4%BB%B6"><span class="nav-text">1. ES集群引入拼音插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%B5%8B%E8%AF%95%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D"><span class="nav-text">2. 测试拼音分词</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%B7%BB%E5%8A%A0%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E6%94%AF%E6%8C%81"><span class="nav-text">3. 添加拼音分词支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-haoke%E7%B4%A2%E5%BC%95%E6%B7%BB%E5%8A%A0%E6%8B%BC%E9%9F%B3%E6%94%AF%E6%8C%81"><span class="nav-text">4. haoke索引添加拼音支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E4%BF%AE%E6%94%B9ESControler%E6%9F%A5%E8%AF%A2%E9%80%BB%E8%BE%91"><span class="nav-text">5. 修改ESControler查询逻辑</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">359</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">58</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">74</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">832.9k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">34:54</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>