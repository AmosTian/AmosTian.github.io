<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="[TOC]"><meta property="og:type" content="article"><meta property="og:title" content="5.存储配置"><meta property="og:url" content="https://amostian.github.io/posts/30934922/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="[TOC]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423100309821.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240424015543853.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423115746284.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423115801278.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423215726912.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423215900896.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423220028750.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423220250108.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423220330144.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423220754587.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240424021222677.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423132945409.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240424030727092.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423221447871.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423222058555.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240423222156128.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240424025322420.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240424031046905.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240425135902182.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240425140004253.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240425141038172.png"><meta property="og:image" content="https://amostian.github.io/posts/30934922/image-20240425141127811.png"><meta property="article:published_time" content="2023-11-06T16:23:43.000Z"><meta property="article:modified_time" content="2024-05-05T14:24:45.685Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="分布式"><meta property="article:tag" content="分布式存储"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/30934922/image-20240423100309821.png"><link rel="canonical" href="https://amostian.github.io/posts/30934922/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>5.存储配置 | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">61</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">78</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">382</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/30934922/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">5.存储配置</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2023-11-07 00:23:43" itemprop="dateCreated datePublished" datetime="2023-11-07T00:23:43+08:00">2023-11-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2024-05-05 22:24:45" itemprop="dateModified" datetime="2024-05-05T22:24:45+08:00">2024-05-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">8.1k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>26 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>[TOC]</p><span id="more"></span><h2 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a>系统设置</h2><h3 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br></pre></td></tr></table></figure><h3 id="用户名、密码"><a href="#用户名、密码" class="headerlink" title="用户名、密码"></a>用户名、密码</h3><ul><li><strong>一定要设置root密码</strong></li><li>nodexx 主机名，用户密码，</li></ul><p>用户名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hostname #查看系统主机名称</span><br><span class="line">node01@ hostnamectl set-hostname node01</span><br><span class="line">node02@ hostnamectl set-hostname node02</span><br><span class="line"></span><br><span class="line">hostnamectl set-hostname xx #修改主机名称	</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">执行命令之后，会自动修改 /etc/hostname 文件</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">执行命令之后，会立即生效，且重启系统也会生效</span></span><br><span class="line">cat /etc/hostname	#查看 /etc/hostname 文件内容，里面配置的就是系统主机名称</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">sudo gedit /etc/passwd # 找到原先的用户名，将其改为自己的用户名（一行全部都改）</span><br><span class="line">sudo  gedit /etc/shadow #找到原先用户名（所有的名字都要改），改为自己的用户名</span><br><span class="line">sudo gedit /etc/group #你应该发现你的用户名在很多个组中，全部修改！</span><br><span class="line">mv /home/原用户名/ /home/新用户名</span><br><span class="line"></span><br><span class="line">mv /home/ceph_admin/ /home/</span><br></pre></td></tr></table></figure><p>密码（登录用户需要修改）</p><ol><li>进入Ubuntu，打开一个终端，输入 sudo su转为root用户。 注意，必须先转为root用户！！！</li><li>sudo passwd user(user 是对应的用户名)</li><li>输入新密码，确认密码。</li><li>修改密码成功，重启，输入新密码进入Ubuntu。</li></ol><h3 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ens33：NAT网络 VMnet8 公网ip设定为192.168.192.0/24 网段</span><br><span class="line">ens37：仅主机 VMnet1 私有ip设定为10.168.192.0/24 网段，提供ceph集群内网络</span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>主机名</th><th>role</th><th>公有网络</th><th>私有网络</th><th>磁盘</th></tr></thead><tbody><tr><td>node1</td><td>admin/mon/mgr/osd1</td><td>192.168.192.156</td><td>10.168.192.156</td><td>sda50GB,sdb/sdc20GB</td></tr><tr><td>node2</td><td>mon/mgr/osd3/osd4</td><td>192.168.192.157</td><td>10.168.192.157</td><td>sda50GB,sdb/sdc20GB</td></tr></tbody></table></div><h4 id="主机名ip映射"><a href="#主机名ip映射" class="headerlink" title="主机名ip映射"></a>主机名ip映射</h4><p>在所有主机下配置以下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">public network</span></span><br><span class="line">192.168.192.156 node01</span><br><span class="line">192.168.192.157 node02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster network</span></span><br><span class="line">10.168.192.156 node01-cl</span><br><span class="line">10.168.192.157 node02-cl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">manage network</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat /etc/hosts</span><br></pre></td></tr></table></figure><h4 id="静态ip"><a href="#静态ip" class="headerlink" title="静态ip"></a>静态ip</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apt upgrade -y</span><br><span class="line">sudo apt install -y net-tools   </span><br><span class="line">ifconfig #查看网卡名称</span><br><span class="line">ip a</span><br><span class="line"></span><br><span class="line">cd /etc/netplan</span><br><span class="line">sudo gedit 01-network-manager-all.yaml</span><br><span class="line"></span><br><span class="line">network: </span><br><span class="line"> version: 2</span><br><span class="line"> renderer: NetworkManager</span><br><span class="line"> ethernets:</span><br><span class="line">  ens33:</span><br><span class="line">   dhcp4: false</span><br><span class="line">   addresses: [192.168.192.156/24]</span><br><span class="line">   gateway4: 192.168.192.2</span><br><span class="line">   nameservers:</span><br><span class="line">    addresses: [192.168.192.2]</span><br><span class="line">  ens34:</span><br><span class="line">  	dhcp4: false</span><br><span class="line">  	addresses: [10.168.192.156/24]</span><br><span class="line">  	nameservers:</span><br><span class="line">     addresses: [10.168.192.2]</span><br><span class="line"></span><br><span class="line">network: </span><br><span class="line"> version: 2</span><br><span class="line"> renderer: NetworkManager</span><br><span class="line"> ethernets:</span><br><span class="line">  ens33:</span><br><span class="line">   dhcp4: false</span><br><span class="line">   addresses: [192.168.192.157/24]</span><br><span class="line">   gateway4: 192.168.192.2</span><br><span class="line">   nameservers:</span><br><span class="line">    addresses: [192.168.192.2]</span><br><span class="line">  ens34:</span><br><span class="line">  	dhcp4: false</span><br><span class="line">  	addresses: [10.168.192.157/24]</span><br><span class="line">  	nameservers:</span><br><span class="line">     addresses: [10.168.192.2]</span><br><span class="line">    </span><br><span class="line">sudo netplan apply </span><br></pre></td></tr></table></figure><h3 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><p>在所有虚拟机上安装并配置ntp（时间同步服务）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y ntp</span><br><span class="line">sudo apt install -y vim</span><br><span class="line"></span><br><span class="line">sudo vim /etc/ntp.conf</span><br><span class="line">将下面这行注释掉：</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">pool 0.ubuntu.pool.ntp.org iburst</span></span><br><span class="line">在文件末尾添加以下内容：</span><br><span class="line">server ntp.ubuntu.com</span><br><span class="line"></span><br><span class="line">重启ntp</span><br><span class="line">sudo systemctl start ntp</span><br><span class="line">检查 NTP 服务状态</span><br><span class="line">sudo systemctl status ntp</span><br><span class="line">客户端安装ntpdate</span><br><span class="line">sudo apt install -y ntpdate</span><br><span class="line">同步时间</span><br><span class="line">sudo ntpdate 192.168.192.156</span><br><span class="line"></span><br><span class="line">ntpdate pool.ntp.org</span><br></pre></td></tr></table></figure><h3 id="防火墙与SELinux"><a href="#防火墙与SELinux" class="headerlink" title="防火墙与SELinux"></a>防火墙与SELinux</h3><p>确保为monitor的6789端口添加防火墙策略，</p><p>确保为monitor的6789端口添加防火墙策略，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop ufw.service</span><br><span class="line">sudo systemctl disable ufw.service</span><br><span class="line">sudo ufw status</span><br><span class="line"></span><br><span class="line">sudo apt -y install firewalld</span><br><span class="line">firewall-cmd --zone=public --add-port=6789/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=6800-7100/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --zone=public --list-all</span><br></pre></td></tr></table></figure><p>若只是测试环境，可以关闭防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">ufw stop</span><br><span class="line">ufw disable</span><br><span class="line">防火墙在系统启动时自动禁用</span><br></pre></td></tr></table></figure><p>所有虚拟主机上禁用SELINUX</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apt install -y selinux-utils</span><br><span class="line"></span><br><span class="line">sudo apt install -y selinux-basics</span><br><span class="line">sudo selinux-activate --disable</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时禁用</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久禁用</span></span><br><span class="line">vim /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /etc/selinux/config</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">SELINUXTYPE=targeted</span><br><span class="line">SETLOCALDEFS=0</span><br><span class="line"></span><br><span class="line">node02@node02:~$ sestatus</span><br><span class="line">SELinux status:                 disabled</span><br></pre></td></tr></table></figure><h2 id="节点间ssh免密登录"><a href="#节点间ssh免密登录" class="headerlink" title="节点间ssh免密登录"></a>节点间ssh免密登录</h2><h3 id="实现基于ssh-key的验证"><a href="#实现基于ssh-key的验证" class="headerlink" title="实现基于ssh key的验证"></a>实现基于ssh key的验证</h3><h4 id="实现root用户的ssh免密登录"><a href="#实现root用户的ssh免密登录" class="headerlink" title="实现root用户的ssh免密登录"></a>实现root用户的ssh免密登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-server -y</span><br><span class="line"></span><br><span class="line">ssh</span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow Root Login</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line"></span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423100309821.png" alt="image-20240423100309821"></p><h4 id="通过sshpass为每个主机生成sshkey并推送给hosts中已知主机"><a href="#通过sshpass为每个主机生成sshkey并推送给hosts中已知主机" class="headerlink" title="通过sshpass为每个主机生成sshkey并推送给hosts中已知主机"></a>通过sshpass为每个主机生成sshkey并推送给hosts中已知主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install sshpass</span><br><span class="line">vim ssh_key_push.sh</span><br></pre></td></tr></table></figure><p>在每个主机root用户下执行以下脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#********************************************************************</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Author:            wangxiaochun</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">QQ:                29308620</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Date:              2021-05-08</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">FileName:          ssh_key_push.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">URL:               http://www.wangxiaochun.com</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Description:       多主机基于ssh key 互相验证</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Copyright (C):     2021 All rights reserved</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">********************************************************************</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前用户密码</span></span><br><span class="line">PASS=admin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置网段最小和最大的地址的尾数</span></span><br><span class="line">BEGIN=156</span><br><span class="line">END=157</span><br><span class="line"></span><br><span class="line">IP=`ip a s ens33 | awk -F&#x27;[ /]+&#x27; &#x27;NR==4&#123;print $3&#125;&#x27;`</span><br><span class="line">NET=$&#123;IP%.*&#125;.</span><br><span class="line"></span><br><span class="line">scan_host() &#123;</span><br><span class="line">    [ -e ./SCANIP.log ] &amp;&amp; rm -f SCANIP.log</span><br><span class="line">    for((i=$BEGIN;i&lt;=&quot;$END&quot;;i++));do</span><br><span class="line">        ping -c 1 -w 1  $&#123;NET&#125;$i &amp;&gt; /dev/null  &amp;&amp; echo &quot;$&#123;NET&#125;$i&quot; &gt;&gt; SCANIP.log &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push_ssh_key() &#123;</span><br><span class="line">   	#生成ssh key </span><br><span class="line">    [ -e ~/.ssh/id_rsa ] || ssh-keygen -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line">    sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no root@$IP  &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    ip_list=(`sort -t . -k 4 -n  SCANIP.log`)</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        sshpass -p $PASS scp -o StrictHostKeyChecking=no -r ~/.ssh root@$&#123;ip&#125;: &amp;&gt;/dev/null</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    #把.ssh/known_hosts拷贝到所有主机，使它们第一次互相访问时不需要输入yes回车</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        scp ~/.ssh/known_hosts @$&#123;ip&#125;:.ssh/   &amp;&gt;/dev/null</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scan_host</span><br><span class="line">push_ssh_key</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ssh_key_push.sh</span><br></pre></td></tr></table></figure><h3 id="所有主机通过cephadm实现免密登录"><a href="#所有主机通过cephadm实现免密登录" class="headerlink" title="所有主机通过cephadm实现免密登录"></a>所有主机通过cephadm实现免密登录</h3><h4 id="创建cephadm用户"><a href="#创建cephadm用户" class="headerlink" title="创建cephadm用户"></a>创建cephadm用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用脚本实现批量创建用户</span></span><br><span class="line">cat &gt; create_cephadm.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定普通用户</span></span><br><span class="line">useradd -m -s /bin/bash cephadm</span><br><span class="line">echo cephadm:admin | chpasswd</span><br><span class="line">echo &quot;cephadm ALL=(ALL) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/cephadm</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephadm</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo &quot;cephadm ALL=(ALL) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">批量执行</span></span><br><span class="line">for i in &#123;150..152&#125;; do ssh root@192.168.192.$i bash &lt; create_cephadm.sh ; done</span><br></pre></td></tr></table></figure><p>检测是否创建用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll /etc/passwd</span><br><span class="line">cat /etc/passwd</span><br></pre></td></tr></table></figure><h4 id="跨主机免密登录"><a href="#跨主机免密登录" class="headerlink" title="跨主机免密登录"></a>跨主机免密登录</h4><p>每台主机依次执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">su - cephadm</span><br><span class="line">ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line">PASS=admin</span><br><span class="line">for i in &#123;150..152&#125;;do</span><br><span class="line">	sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no cephadm@192.168.192.$i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for i in &#123;153..155&#125;;do</span><br><span class="line">	sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no cephadm@192.168.192.$i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">root@node1:~# PASS=admin</span><br><span class="line">root@node1:~# for i in &#123;150..152&#125;;do</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sshpass -p <span class="variable">$PASS</span> ssh-copy-id -o StrictHostKeyChecking=no root@192.168.192.<span class="variable">$i</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="keyword">done</span></span></span><br></pre></td></tr></table></figure><h2 id="ceph-deploy"><a href="#ceph-deploy" class="headerlink" title="ceph-deploy"></a>ceph-deploy</h2><h3 id="admin节点安装ceph-deploy工具"><a href="#admin节点安装ceph-deploy工具" class="headerlink" title="admin节点安装ceph-deploy工具"></a>admin节点安装ceph-deploy工具</h3><p>切到cephadm用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">cephadm@admin:~$sudo apt-cache madison ceph-deploy # 查看版本</span><br><span class="line">cephadm@admin:~$sudo apt -y install ceph-deploy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证成功和查看版本</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --version</span><br><span class="line">2.0.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助手册</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --help</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">new：开始部署一个新的ceph 存储集群，并生成CLUSTER.conf 集群配置文件和keyring 认证文件。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">install: 在远程主机上安装ceph 相关的软件包, 可以通过--release 指定安装的版本。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rgw：管理RGW 守护程序(RADOSGW,对象存储网关)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mgr：管理MGR 守护程序(ceph-mgr,Ceph Manager DaemonCeph 管理器守护程序)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mds：管理MDS 守护程序(Ceph Metadata Server，ceph 源数据服务器)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon：管理MON 守护程序(ceph-mon,ceph 监视器)。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">gatherkeys：从指定的获取提供新节点验证keys，这些keys 会在添加新的MON/OSD/MD 加入的时候使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disk：管理远程主机磁盘。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd：在远程主机准备数据磁盘，即将指定远程主机的指定磁盘添加到ceph 集群作为osd 使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">repo： 远程主机仓库管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">admin：推送ceph集群配置文件和client.admin 认证文件到远程主机。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">config：将ceph.conf 配置文件推送到远程主机或从远程主机拷贝。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uninstall：从远端主机删除安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">urgedata：从/var/lib/ceph 删除ceph 数据,会删除/etc/ceph 下的内容。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">purge: 删除远端主机的安装包和所有数据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">forgetkeys：从本地主机删除所有的验证keyring, 包括client.admin, monitor, bootstrap 等认证文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pkg： 管理远端主机的安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calamari：安装并配置一个calamari web 节点，calamari 是一个web 监控平台。</span></span><br></pre></td></tr></table></figure><h3 id="ceph-deploy对集群初始化"><a href="#ceph-deploy对集群初始化" class="headerlink" title="ceph-deploy对集群初始化"></a>ceph-deploy对集群初始化</h3><p>生成集群配置，并未做实际安装</p><p>初始化第一个mon节点的命令格式为 <code>ceph-deploy new &#123;initial-monitor-node(s)&#125;</code></p><ul><li><p>ceph-mon 即为第一个monitor节点名称，其名称必须与节点当前实际使用的主机名称( <code>uname -n</code> ) 保持一致，即可以是短名称，也可以是长名称</p><p>但短名称会导致错误： ceph-deploy new: error: hostname: xxx is not resolvable</p></li><li><p>推荐使用完整写法：<code>hostname:fqdn</code> 如：<code>ceph-mon:ceph-mon.wang.org</code></p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">首先在管理节点上以cephadm用户创建集群相关的配置文件目录</span></span><br><span class="line">cephadm@node1:~$ mkdir ceph-cluster &amp;&amp; cd ceph-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看主机名</span></span><br><span class="line">cephadm@node1:~$ mkdir ceph-cluster &amp;&amp; cd ceph-cluster</span><br><span class="line">node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行如下命令即可生成初始配置：</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy new --public-network 192.168.192.0/24 --cluster-network 192.168.252.0/24 node1:node1.wang.org</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy new --public-network 192.168.192.0/24 --cluster-network 192.168.252.0/24 node1:node1.wang.org</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.conf <span class="comment">#自动生成的配置文件</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph-deploy-ceph.log <span class="comment">#初始化日志</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.mon.keyring <span class="comment">#用于ceph mon 节点内部通讯认证的秘钥环文件</span></span></span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240424015543853.png" alt="image-20240424015543853"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = 96a78567-2c73-4b65-adf1-fb8a3c18766a</span><br><span class="line">public_network = 192.168.192.0/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = node1</span><br><span class="line">mon_host = 192.168.192.150</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果部署过程出现问题，需要清空</span></span><br><span class="line">ceph-deploy forgetkeys</span><br><span class="line">ceph-deploy purge node1 node1 node1</span><br><span class="line">ceph-deploy purgedata node1 node1 node1</span><br><span class="line">rm ceph.*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果想要一下子将所有的mon节点都部署出来，我们可以执行下面的命令</span></span><br><span class="line">ceph-deploy new --public-network 192.168.192.130/24 --cluster-network 192.168.252.0/24 mon01:mon01.wang.org mon02:mon02.wang.org mon03:mon03.wang.org</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><h3 id="ceph包的安装——不推荐用ceph-deploy-install"><a href="#ceph包的安装——不推荐用ceph-deploy-install" class="headerlink" title="ceph包的安装——不推荐用ceph-deploy install"></a>ceph包的安装——不推荐用ceph-deploy install</h3><h4 id="为所有节点配置ceph包安装源"><a href="#为所有节点配置ceph包安装源" class="headerlink" title="为所有节点配置ceph包安装源"></a>为所有节点配置ceph包安装源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在管理节点准备脚本,注意以root身份执行</span></span><br><span class="line">root@node1:cat &gt; ceph_repo.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为所有节点都会依赖于这些apt源信息，需要进行同步</span></span><br><span class="line">[root@admin ~]for i in &#123;150..152&#125;;do ssh -o StrictHostKeyChecking=no 192.168.192.$i bash &lt; ceph_repo.sh;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">去其他结点查看</span></span><br><span class="line">cat /etc/apt/sources.list.d/ceph.list</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423115746284.png" alt="image-20240423115746284"></p><p><img src="/posts/30934922/image-20240423115801278.png" alt="image-20240423115801278"></p><h4 id="ceph-deploy-install指令介绍"><a href="#ceph-deploy-install指令介绍" class="headerlink" title="ceph-deploy install指令介绍"></a>ceph-deploy install指令介绍</h4><p>初始化节点相当于在存储节点安装了ceph 及ceph-rodsgw</p><ul><li>默认情况下，ceph-deploy会安装最新版本的ceph，若需要指定ceph版本，添加参数 <code>--release &#123;ceph-release-name&#125;</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令格式：</span></span><br><span class="line">ceph-deploy install --&#123;role&#125; &#123;node&#125; [&#123;node&#125; ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：这里主要是ceph的工作角色的的节点</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:使用ceph-deploy命令能够以远程的方式连入Ceph集群各节点完成程序包安装等操作</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般情况下，不推荐使用这种直接的方法来进行安装，效率太低，实际上也是在各节点上执行方法2</span></span><br><span class="line">ceph-deploy install --mon mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:上述指令等价在每个ceph-node节点安装 ceph-&#123;role&#125;</span></span><br><span class="line">apt install -y ceph ceph-osd ceph-mds ceph-mon radosgw</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423215726912.png" alt="image-20240423215726912"></p><p><img src="/posts/30934922/image-20240423215900896.png" alt="image-20240423215900896"></p><p><img src="/posts/30934922/image-20240423220028750.png" alt="image-20240423220028750"></p><h3 id="mon节点"><a href="#mon节点" class="headerlink" title="mon节点"></a>mon节点</h3><h4 id="安装mon节点依赖"><a href="#安装mon节点依赖" class="headerlink" title="安装mon节点依赖"></a>安装mon节点依赖</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在admin主机上，向mon节点安装mon组件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --no-adjust-repos --nogpgcheck --mon mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者直接在mon节点安装软件</span></span><br><span class="line">[root@ceph-mon ~] apt -y install ceph-mon</span><br></pre></td></tr></table></figure><p>安装完成后，发现自动创建了ceph用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ getent passwd ceph</span><br><span class="line">ceph:x:64045:64045:Ceph storage service:/var/lib/ceph:/usr/sbin/nologin</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423220250108.png" alt="image-20240423220250108"></p><p>验证在mon 节点已经自动安装并启动了ceph-mon 服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ dpkg -l |grep ceph</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423220330144.png" alt="image-20240423220330144"></p><h4 id="初始化mon节点生成配置信息"><a href="#初始化mon节点生成配置信息" class="headerlink" title="初始化mon节点生成配置信息"></a>初始化mon节点生成配置信息</h4><p>确定集群配置信息，根据集群规划修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim ceph.conf</span><br><span class="line"></span><br><span class="line">若是3mon节点</span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"></span><br><span class="line">单mon节点</span><br><span class="line">[global]</span><br><span class="line">fsid = 7d8af3fe-089e-40ee-85d0-2854ff3c1631</span><br><span class="line">public_network = 192.168.192.0/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = ceph-mon</span><br><span class="line">mon_host = 192.168.192.120</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p>初始化集群mon节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy --overwrite-conf mon create-initial</span><br></pre></td></tr></table></figure><p>查看生成的配置文件</p><ul><li>节点初始化会生成一些ceph.bootstrap -mds/mgr/osd/rgw 等服务的keyring 认证文件，这些初始化文件拥有对ceph 集群的最高权限，所以一定要保存好。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ll</span><br><span class="line"></span><br><span class="line">ceph.bootstrap-mds.keyring 引导启动 mds的密钥文件</span><br><span class="line">ceph.bootstrap-mgr.keyring 引导启动 mgr的密钥文件</span><br><span class="line">ceph.bootstrap-osd.keyring 引导启动 osd的密钥文件</span><br><span class="line">ceph.bootstrap-rgw.keyring 引导启动 rgw的密钥文件</span><br><span class="line">ceph.client.admin.keyring ceph客户端和管理端通信的认证密钥，是最重要的</span><br><span class="line">ceph.conf</span><br><span class="line">ceph-deploy-ceph.log</span><br><span class="line">ceph.mon.keyring</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这里生成了一系列的与ceph集群相关的 认证文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：ceph.client.admin.keyring 拥有ceph集群的所有权限，一定不能有误。</span></span><br></pre></td></tr></table></figure><ul><li>此时在mon节点启动了一些进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">到mon的节点上查看mon的自动开启相应的守护进程</span></span><br><span class="line">[root@mon01 ~]ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423220754587.png" alt="image-20240423220754587"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmp_knw2l2z</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240424021222677.png" alt="image-20240424021222677"></p><h4 id="向admin节点推送admin密钥"><a href="#向admin节点推送admin密钥" class="headerlink" title="向admin节点推送admin密钥"></a>向admin节点推送admin密钥</h4><p>在admin角色的主机上，把配置文件和admin密钥拷贝到Ceph集群各监控角色节点mon</p><ul><li><p>注意：原则上要求：所有mon节点上的 ceph.conf 内容必须一致，如果不一致的话，可以通过下面命令同步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群admin节点的认证文件分发到admin节点</span></span><br><span class="line">ceph-deploy admin &#123;admin-node&#125;</span><br><span class="line"></span><br><span class="line">ceph-deploy admin --help</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">usage: ceph-deploy admin [-h] HOST [HOST ...]</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Push configuration and client.admin key to a remote host.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">positional arguments:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	HOST 	host to configure <span class="keyword">for</span> Ceph administration</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">optional arguments:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	-h, --<span class="built_in">help</span> show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure></li></ul><p>在mon节点实现集群管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分发admin认证前，</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmpaagml4w1</span><br><span class="line"></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy admin node1</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmpaagml4w1</span><br><span class="line"></span><br><span class="line">结果显示：这里多了一个 ceph的客户端与服务端进行认证的密钥文件了</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.client.admin.keyring 主要用于ceph节点与管理端的一个通信认证。</span></span><br></pre></td></tr></table></figure><p>问题：虽然我们把认证文件传递给对应的admin主机了，但是admin节点是通过普通用户cephadm来进行交流的。而默认情况下，传递过去的认证文件，cephadm普通用户是无法正常访问的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cephadm用户执行命令因文件权限会出错</span></span><br><span class="line">[root@node1 ~] su - cephadm</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423132945409.png" alt="image-20240423132945409"></p><p>在集群中需要运行ceph指令的节点上，为cephadm用户设置/etc/ceph/ceph.client.admin.keyring文件权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ sudo apt install acl</span><br><span class="line">cephadm@node1:~/ceph-cluster$ sudo setfacl -m u:cephadm:r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure><p>此时cephadm用户有了集群的管理权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">消除 mon is allowing insecure global_id reclaim的报警信息</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph config set mon auth_allow_insecure_global_id_reclaim false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次查看没有告警信息</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240424030727092.png" alt="image-20240424030727092"></p><h3 id="mgr节点"><a href="#mgr节点" class="headerlink" title="mgr节点"></a>mgr节点</h3><p>Ceph-MGR工作的模式是事件驱动型的，简单来说，就是等待事件，事件来了则处理事件返回结果，又继续等待。</p><p>对于测试环境其实一个就能够正常使用了</p><h4 id="安装mgr节点依赖"><a href="#安装mgr节点依赖" class="headerlink" title="安装mgr节点依赖"></a>安装mgr节点依赖</h4><p><img src="/posts/30934922/image-20240423221447871.png" alt="image-20240423221447871"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install --mgr node2</span><br><span class="line">cephadm@node2:~$ getent passwd ceph</span><br><span class="line"></span><br><span class="line">dpkg -l |grep ceph# 之前是没有的，安装之后，多了</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240423222058555.png" alt="image-20240423222058555"></p><p>且进程启动</p><p><img src="/posts/30934922/image-20240423222156128.png" alt="image-20240423222156128"></p><h4 id="将mgr节点加入集群"><a href="#将mgr节点加入集群" class="headerlink" title="将mgr节点加入集群"></a>将mgr节点加入集群</h4><p>在 admin 节点的 /ceph-cluster 目录下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cephadm@ceph-mon:~/ceph-cluster$ ceph-deploy mgr create node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动在mgr01节点生成配置文件和用户</span></span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyxnhr/p/10539740.html">https://www.cnblogs.com/zyxnhr/p/10539740.html</a></p><p>防火墙没关</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disabled  firewalld</span><br><span class="line">systemctl disable  firewalld</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240424025322420.png" alt="image-20240424025322420"></p><p><img src="/posts/30934922/image-20240424031046905.png" alt="image-20240424031046905"></p><h3 id="osd节点"><a href="#osd节点" class="headerlink" title="osd节点"></a>osd节点</h3><p>要设置OSD环境，一般执行下面步骤：</p><ul><li>要知道对应的主机上有哪些磁盘可以提供给主机来进行正常的使用。</li><li>格式化磁盘(非必须)</li><li>ceph擦除磁盘上的数据</li><li>添加osd</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有的存储节点主机都准备了两块额外的磁盘，</span></span><br><span class="line">[root@store01 ~] lsblk</span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0    7:0    0  63.3M  1 loop /snap/core20/1828</span><br><span class="line">loop1    7:1    0     4K  1 loop /snap/bare/5</span><br><span class="line">loop2    7:2    0  63.5M  1 loop /snap/core20/2015</span><br><span class="line">loop3    7:3    0 346.3M  1 loop /snap/gnome-3-38-2004/119</span><br><span class="line">loop4    7:4    0 349.7M  1 loop /snap/gnome-3-38-2004/143</span><br><span class="line">loop5    7:5    0  91.7M  1 loop /snap/gtk-common-themes/1535</span><br><span class="line">loop6    7:6    0    46M  1 loop /snap/snap-store/638</span><br><span class="line">loop7    7:7    0  49.9M  1 loop /snap/snapd/18357</span><br><span class="line">loop8    7:8    0  40.9M  1 loop /snap/snapd/20290</span><br><span class="line">sda      8:0    0    20G  0 disk </span><br><span class="line">├─sda1   8:1    0   512M  0 part /boot/efi</span><br><span class="line">├─sda2   8:2    0     1K  0 part </span><br><span class="line">└─sda5   8:5    0  19.5G  0 part /</span><br><span class="line">sdb      8:16   0    20G  0 disk </span><br><span class="line">sdc      8:32   0    20G  0 disk </span><br><span class="line">sr0     11:0    1   4.1G  0 rom  /media/store01/Ubuntu 20.04.6 LTS amd64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果不想查看大量无效设备的话，可以执行下面清理操作</span></span><br><span class="line">sudo apt autoremove --purge snapd -y</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdX&quot;</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdd&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span></span><br><span class="line">sgdisk --zap-all $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present</span></span></span><br><span class="line">dd if=/dev/zero of=&quot;$DISK&quot; bs=1M count=100 oflag=direct,dsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># SSDs may be better cleaned with blkdiscard instead of dd</span></span></span><br><span class="line">blkdiscard $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Inform the OS of partition table changes</span></span></span><br><span class="line">partprobe $DISK</span><br></pre></td></tr></table></figure><h4 id="安装osd依赖"><a href="#安装osd依赖" class="headerlink" title="安装osd依赖"></a>安装osd依赖</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 确认仓库配置</span></span><br><span class="line">[root@store01 ~] cat /etc/apt/sources.list.d/ceph.listdeb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific/ focal main wget -q -O- https://download.ceph.com/keys/release.asc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装OSD相关软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1: 在管理节点远程安装</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --release pacific --osd store01 </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2: 在OSD主机手动安装</span></span><br><span class="line">[root@store01 ~] apt -y install ceph-osd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 确认安装结果</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动生成用户ceph</span></span><br><span class="line">[root@store01 ~] tail -n1 /etc/passwd</span><br><span class="line">[root@store01 ~] dpkg -l |grep ceph</span><br><span class="line"></span><br><span class="line">ls /etc/ceph/</span><br><span class="line">ps aux|grep ceph</span><br></pre></td></tr></table></figure><h4 id="查看所有可用的osd磁盘"><a href="#查看所有可用的osd磁盘" class="headerlink" title="查看所有可用的osd磁盘"></a>查看所有可用的osd磁盘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查并列出OSD节点上所有可用的磁盘的相关信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy disk list node3</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240425135902182.png" alt="image-20240425135902182"></p><p>报错原因是 python 版本问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改375行,将 <span class="keyword">if</span> line.startswith(<span class="string">&#x27;Disk /&#x27;</span>): 更改为 <span class="keyword">if</span> line.startswith(b<span class="string">&#x27;Disk /&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只在<span class="string">&#x27;Disk前加一个字母 b 即可</span></span></span><br><span class="line">cephadm@admin:~$sudo vim +375 /usr/lib/python3/dist-packages/ceph_deploy/osd.py</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240425140004253.png" alt="image-20240425140004253"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy disk list node3</span><br><span class="line">很奇怪，权限问题</span><br><span class="line">setfacl -m u:cephadm:rw /home/cephadm/ceph-cluster/*</span><br></pre></td></tr></table></figure><p><img src="/posts/30934922/image-20240425141038172.png" alt="image-20240425141038172"></p><p>修改权限后可看</p><p><img src="/posts/30934922/image-20240425141127811.png" alt="image-20240425141127811"></p><h5 id="清除OSD磁盘"><a href="#清除OSD磁盘" class="headerlink" title="清除OSD磁盘"></a>清除OSD磁盘</h5><p>在管理节点上使用ceph-deploy命令擦除计划专用于OSD磁盘上的所有分区表和数据以便用于OSD</p><p>注意: 如果硬盘是无数据的新硬盘此步骤可以不做</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk zap [-h] [--debug] [HOST] DISK [DISK ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">说明此操操作本质上就是执行<span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=disk bs=1M count=10</span></span><br><span class="line"></span><br><span class="line">for i in &#123;0..2&#125;;do ceph-deploy disk zap 192.168.192.15$i /dev/sdb;done</span><br></pre></td></tr></table></figure><h4 id="集群添加osd节点"><a href="#集群添加osd节点" class="headerlink" title="集群添加osd节点"></a>集群添加osd节点</h4><p>对于OSD的相关操作，可以通过 <code>ceph-deploy osd</code> 命令来进行，帮助信息如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">帮助显示：这里提示了两类的存储机制：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认情况下用的就是 bluestore类型</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于bluestore来说，它主要包括三类数据：</span></span><br><span class="line">--data /path/to/data #ceph 保存的对象数据</span><br><span class="line">--block-db /path/to/db-device #数据库,即为元数据</span><br><span class="line">--block-wal /path/to/wal-device #数据库的 wal 日志</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生产建议data和wal日志分别存放</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于filestore来说，它主要包括两类数据</span></span><br><span class="line">--data /path/to/data #ceph的文件数据</span><br><span class="line">--journal /path/to/journal #文件系统日志数据</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于 osd来说，它主要有两个动作：</span></span><br><span class="line">list 列出osd相关的信息</span><br><span class="line">create 创建osd设备</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf osd create node1 --data /dev/sdb</span><br><span class="line">ceph-deploy --overwrite-conf osd create node2 --data /dev/sdb</span><br><span class="line">ceph-deploy --overwrite-conf osd create node3 --data /dev/sdb</span><br></pre></td></tr></table></figure><h3 id="高可用扩展"><a href="#高可用扩展" class="headerlink" title="高可用扩展"></a>高可用扩展</h3><h4 id="mgr扩展"><a href="#mgr扩展" class="headerlink" title="mgr扩展"></a>mgr扩展</h4><p>当前只有一个Mgr节点主机,存在SPOF,添加新的Mgr节点实现高可用</p><p>Ceph Manager守护进程以Active/Standby模式运行，部署其它ceph-mgr守护程序可确保在Active节点或其上的ceph-mgr守护进程故障时，其中的一个Standby实例可以在不中断服务的情况下接管其任务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新mgr结点上安装mgr软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在管理节点远程在mgr02节点上安装Mgr软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mgr mgr02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mgr02节点手动安装软件</span></span><br><span class="line">[root@mgr02 ~]#apt -y install ceph-mgr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加第二个 Mgr节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mgr create mgr02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：mgr01节点就是主角色节点，mgr02是从角色节点。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭mgr01节点,mgr02节点自动成为active节点</span></span><br><span class="line">[root@mgr01 ~]#reboot</span><br><span class="line">[root@admin ~]#ceph -s</span><br></pre></td></tr></table></figure><h4 id="mon扩展"><a href="#mon扩展" class="headerlink" title="mon扩展"></a>mon扩展</h4><p>当前只有一个mon结点主机，存在SPOF，添加新的mon结点实现高可用</p><p>如果 $n$ 个结点，至少需要保证 $\frac{n}{2}$ 个以上的健康mon结点，ceph集群才能正常使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先在新mon节点安装mon软件</span></span><br><span class="line">ceph-deploy install --mon mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加后续的mon节点命令</span></span><br><span class="line">ceph-deploy mon add mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果add换成destroy，则变成移除mon节点</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新的mon结点安装mon软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在mon02节点上安装mon软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mon02节点手动安装mon软件也可以</span></span><br><span class="line">[root@mon02 ~] apt -y install ceph-mon</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加在mon02节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 添加mon03节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon03</span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 修改ceph配置添加后续的Mon节点信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$vim ceph.conf</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步ceph配置文件到所有ceph节点主机</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf config push admin mon0&#123;1,2,3&#125; mgr0&#123;1,2&#125; store0&#123;1,2,3&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 重新生成初始化配置信息</span></span><br><span class="line">ceph-deploy --overwrite-conf mon create-initial</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：为了避免因为认证方面导致的通信失败，推荐使用 --overwrite-conf 参数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果是在一个现有的环境上部署业务，可以先推送基准配置文件</span></span><br><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><h2 id="cephadm"><a href="#cephadm" class="headerlink" title="cephadm"></a>cephadm</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gengduc/article/details/134900065">https://blog.csdn.net/gengduc/article/details/134900065</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rookie23rook/article/details/128510437">https://blog.csdn.net/rookie23rook/article/details/128510437</a></p><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><h4 id="下载containerd和docker"><a href="#下载containerd和docker" class="headerlink" title="下载containerd和docker"></a>下载containerd和docker</h4><p>在每台主机上操作</p><p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/releases">下载页</a></p><p>直接下载：cri-containerd-1.7.2-linux-amd64.tar.gz，该包里面包含了containerd、 ctr、crictl、containerd-shim等二进制文件，还有启动命令等，只要在/下解压即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf cri-containerd-1.7.2-linux-amd64.tar.gz -C /</span><br><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">runtime-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h5 id="生成containerd配置文件"><a href="#生成containerd配置文件" class="headerlink" title="生成containerd配置文件"></a>生成containerd配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><p>修改 /etc/containerd/config.toml，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 用于从安全上下文中提取设备所有权信息，kubevirt cdi依赖该参数，不设置该参数可能出现无权限</span></span></span><br><span class="line">device_ownership_from_security_context = true</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 调整日志</span></span></span><br><span class="line">max_container_log_line_size = 163840</span><br><span class="line">SystemdCgroup = true</span><br></pre></td></tr></table></figure><p>修改/etc/systemd/system/containerd.service，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/containerd.service</span><br><span class="line">将`LimitNOFILE=infinity`改为`LimitNOFILE=655360` </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable containerd &amp;&amp; systemctl restart containerd</span><br><span class="line"></span><br><span class="line">使用 crictl info 查看配置是否生效</span><br></pre></td></tr></table></figure><h5 id="其他节点只需将相关文件拷贝过去启动即可"><a href="#其他节点只需将相关文件拷贝过去启动即可" class="headerlink" title="其他节点只需将相关文件拷贝过去启动即可"></a>其他节点只需将相关文件拷贝过去启动即可</h5><p>在node01上操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..3&#125;;do scp -rp /usr/local/bin node0$i:/usr/local/;scp -rp /usr/local/sbin node0$i:/usr/local/;scp /etc/containerd node0$i:/etc/; scp /etc/systemd/system/containerd.service node0$i:/etc/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp -rp /usr/local/bin node0$i:/usr/local/;scp -rp /usr/local/sbin node0$i:/usr/local/;scp /etc/containerd node0$i:/etc/; scp /etc/systemd/system/containerd.service node0$i:/etc/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do cmd=$(systemctl daemon-reload &amp;&amp; systemctl enable containerd &amp;&amp; systemctl restart containerd);ssh node0$i &quot;$cmd&quot;;done</span><br></pre></td></tr></table></figure><h4 id="docker-1"><a href="#docker-1" class="headerlink" title="docker"></a>docker</h4><p>下载docker安装包 ：<a target="_blank" rel="noopener" href="https://download.docker.com/linux/static/stable/x86_64/docker-20.10.23.tgz">https://download.docker.com/linux/static/stable/x86_64/docker-20.10.23.tgz</a></p><p>解压</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf docker-20.10.23.tgz</span><br></pre></td></tr></table></figure><p>需要用到的二进制文件包括：docker 和 dockerd，拷贝到 /usr/bin/目录下即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv docker/docker* /usr/bin/</span><br></pre></td></tr></table></figure><p>创建 docker 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果docker组存在，则使用</span> </span><br><span class="line">useradd -s /sbin/nologin docker -g docker</span><br></pre></td></tr></table></figure><p>启动的配置文件 docker.serivce 和 docker.socket 拷贝到 /usr/lib/systemd/system/，daemon.json文件放到/etc/docker目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service  &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target docker.socket firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the default is not to use systemd <span class="keyword">for</span> cgroups because the delegate issues still</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">exists and systemd currently does not support the cgroup feature <span class="built_in">set</span> required</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> containers run by docker</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ExecStart=/usr/bin/dockerd --graph=/data/docker -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug</span><br><span class="line">ExecReload=/bin/kill -s HUP \$MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that StartLimit* options were moved from <span class="string">&quot;Service&quot;</span> to <span class="string">&quot;Unit&quot;</span> <span class="keyword">in</span> systemd 229.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Both the old, and new location are accepted by systemd 229 and up, so using the old location</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to make them work <span class="keyword">for</span> either version of systemd.</span></span><br><span class="line">StartLimitBurst=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that StartLimitInterval was renamed to StartLimitIntervalSec <span class="keyword">in</span> systemd 230.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this option work <span class="keyword">for</span> either version of systemd.</span></span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> the kernel. We recommend using cgroups to <span class="keyword">do</span> container-local accounting.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可能会出现错误：<span class="string">&quot;Failed at step LIMITS spawning /usr/bin/dockerd: Operation not permitted&quot;</span>，则需要将LimitNOFILE=infinity 改成：LimitNOFILE=65530</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Comment TasksMax <span class="keyword">if</span> your systemd version does not support it.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Only systemd 226 and above support this option.</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> delegate <span class="built_in">yes</span> so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line">Delegate=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">kill</span> only the docker process, not all processes <span class="keyword">in</span> the cgroup</span></span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Socket for the API</span><br><span class="line">PartOf=docker.service</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/var/run/docker.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>启动docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable docker --now</span><br></pre></td></tr></table></figure><p>配置镜像加速和私有仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://vty0b0ux.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;500m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.demo.com&quot;,&quot;192.168.59.249:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>重启docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>将node01上的docker配置文件复制到其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;2..5&#125;;do scp /usr/bin/docker* ceph0$i:/usr/bin/;scp -rp /etc/docker ceph0$i:/etc/;scp /usr/lib/systemd/system/docker.service ceph0$i:/usr/lib/systemd/system/;scp /usr/lib/systemd/system/docker.socket ceph0$i:/usr/lib/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp /usr/bin/docker* node0$i:/usr/bin/;scp -rp /etc/docker node0$i:/etc/;scp /usr/lib/systemd/system/docker.service node0$i:/usr/lib/systemd/system/;scp /usr/lib/systemd/system/docker.socket node0$i:/usr/lib/systemd/system/;done</span><br></pre></td></tr></table></figure><p>在ceph02-05上操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin docker </span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable docker --now</span><br></pre></td></tr></table></figure><h3 id="cephadm-1"><a href="#cephadm-1" class="headerlink" title="cephadm"></a>cephadm</h3><h4 id="修改ceph源"><a href="#修改ceph源" class="headerlink" title="修改ceph源"></a>修改ceph源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在管理节点准备脚本,注意以root身份执行</span></span><br><span class="line">root@node1:cat &gt; ceph_repo.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">bash ceph_repo.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为所有节点都会依赖于这些apt源信息，需要进行同步</span></span><br><span class="line">[root@admin ~]for i in &#123;156..157&#125;;do ssh -o StrictHostKeyChecking=no 192.168.192.$i bash &lt; ceph_repo.sh;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">去其他结点查看</span></span><br><span class="line">root@node02:/# cat /etc/apt/sources.list.d/ceph.list</span><br><span class="line">deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ focal main</span><br></pre></td></tr></table></figure><h4 id="管理节点安装cephadm"><a href="#管理节点安装cephadm" class="headerlink" title="管理节点安装cephadm"></a>管理节点安装cephadm</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt install -y cephadm</span><br><span class="line"></span><br><span class="line">whereis cephadm # 检查安装情况</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出如下内容</span></span><br><span class="line">root@node01:/# whereis cephadm</span><br><span class="line">cephadm: /usr/sbin/cephadm /usr/share/man/man8/cephadm.8.gz</span><br></pre></td></tr></table></figure><h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>检查ceph各节点是否满足安装ceph集群，该命令需要在当前节点执行，比如要判断ceph02是否支持安装ceph集群，则在ceph02上执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cephadm check-host --expect-hostname node01</span><br><span class="line"></span><br><span class="line">docker (/usr/bin/docker) is present</span><br><span class="line">systemctl is present</span><br><span class="line">lvcreate is present</span><br><span class="line">Unit chronyd.service is enabled and running</span><br><span class="line">Hostname &quot;ceph02&quot; matches what is expected.</span><br><span class="line">Host looks OK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 也可以使用以下命令检查</span></span></span><br><span class="line">cephadm check-host --expect-hostname `hostname`</span><br></pre></td></tr></table></figure><h3 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h3><p>cephadm bootstrap 过程是在单一节点上创建一个小型的ceph集群，包括一个ceph monitor和一个ceph mgr，监控组件包括prometheus、node-exporter等。</p><p>然后向集群中添加主机以扩展集群，进而部署其他服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cephadm bootstrap --mon-ip 192.168.192.156 --cluster-network 10.168.192.0/24 --initial-dashboard-user admin --initial-dashboard-password admin</span><br><span class="line"></span><br><span class="line">cephadm bootstrap --mon-ip 192.168.192.156 --cluster-network 10.168.192.0/24 --allow-overwrite --skip-dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会卡很久</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">tail -f /var/log/ceph/cephadm.log</span><br></pre></td></tr></table></figure><p>初始化时，指定了mon-ip、集群网段、dashboard初始用户名和密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">--mon-ip 192.168.59.241 \</span><br><span class="line">--cluster-network 10.168.192.0/24 \</span><br><span class="line">指定dashboard用户名和密码  </span><br><span class="line">--initial-dashboard-user admin \</span><br><span class="line">--initial-dashboard-password admin \</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  指定私钥和公钥</span></span></span><br><span class="line">--ssh-private-key /root/.ssh/id_rsa \</span><br><span class="line">--ssh-public-key /root/.ssh/id_rsa.pub \</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 启动前不拉取默认镜像</span></span></span><br><span class="line">--skip-pull</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定私有镜像仓库</span></span></span><br><span class="line">--registry-url registry.demo.com \</span><br><span class="line">--registry-username admin \</span><br><span class="line">--registry-password Harbor12345 </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 需要指定监控组件镜像</span></span></span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_prometheus registry.demo.com/prometheus/prometheus:v2.33.4</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_grafana registry.demo.com/ceph/ceph-grafana:8.3.5</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_alertmanager registry.demo.com/prometheus/alertmanager:v0.23.0</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_node_exporter registry.demo.com/prometheus/node-exporter:v1.3.1</span><br></pre></td></tr></table></figure><p>进入容器 执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/cephadm shell --fsid 2e1228b0-0781-11ee-aa8a-000c2921faf1 -c /etc/ceph/ceph.conf -k /etc/ceph/ceph.client.admin.keyring</span><br><span class="line"></span><br><span class="line">Or, if you are only running a single cluster on this host:</span><br><span class="line"></span><br><span class="line">        sudo /usr/sbin/cephadm shell</span><br><span class="line"></span><br><span class="line">退出容器执行</span><br><span class="line">cephadm shell ceph -s</span><br><span class="line"></span><br><span class="line">安装ceph-common工具，使bash支持原生命令</span><br><span class="line">cephadm install ceph-common</span><br><span class="line"></span><br><span class="line">ceph -s</span><br><span class="line">ceph version</span><br></pre></td></tr></table></figure><p>查看集群配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/ceph/</span><br><span class="line"></span><br><span class="line">ceph.client.admin.keyring  是具有ceph管理员的秘钥</span><br><span class="line">ceph.conf  是最小化配置文件</span><br><span class="line">ceph.pub  是一个公钥，拷贝到其他节点后，可以免密登录。</span><br></pre></td></tr></table></figure><h4 id="查看组件运行状态"><a href="#查看组件运行状态" class="headerlink" title="查看组件运行状态"></a>查看组件运行状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph orch ps</span><br><span class="line"></span><br><span class="line">ceph orch ls</span><br><span class="line"></span><br><span class="line">ceph orch ls mgr</span><br></pre></td></tr></table></figure><h4 id="删除不必要组件"><a href="#删除不必要组件" class="headerlink" title="删除不必要组件"></a>删除不必要组件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph orch rm prometheus</span><br><span class="line">ceph orch rm grafana</span><br><span class="line">ceph orch rm alertmanager</span><br><span class="line">ceph orch rm node-exporter</span><br></pre></td></tr></table></figure><h4 id="ceph镜像导出"><a href="#ceph镜像导出" class="headerlink" title="ceph镜像导出"></a>ceph镜像导出</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images  |grep -v &quot;REPOSITORY&quot; |awk &#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27; |xargs docker save -o ceph-images.tar</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp ceph-images.tar node0$i:/root/;done</span><br></pre></td></tr></table></figure><p>其他节点导入镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i ceph-images.tar</span><br></pre></td></tr></table></figure><p>将ceph.pub公钥拷贝到其他ceph节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -f -i /etc/ceph/ceph.pub node02</span><br><span class="line"></span><br><span class="line">for i in &#123;2..5&#125;;do ssh-copy-id -f -i /etc/ceph/ceph.pub ceph0$i;done</span><br></pre></td></tr></table></figure><h3 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h3><p>使用cephadm将主机添加到存储集群中,执行添加节点命令后，会在目标节点拉到ceph/node-exporter镜像，需要一定时间，所以可提前在节点上将镜像导入。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cephadm shell ceph orch host add node02 192.168.192.157 --labels=mon,mgr,osd</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error EINVAL: check-host failed:</span><br><span class="line">docker (/usr/bin/docker) is present</span><br><span class="line">systemctl is present</span><br><span class="line">Unit ntp.service is enabled and running</span><br><span class="line">Hostname &quot;node02&quot; matches what is expected.</span><br><span class="line">ERROR: lvcreate binary does not appear to be installed</span><br></pre></td></tr></table></figure><p>在其他节点安装依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install lvm2</span><br></pre></td></tr></table></figure><p>查看加入集群的其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@node01:/# ceph orch host ls</span><br><span class="line">HOST    ADDR             LABELS       STATUS  </span><br><span class="line">node01  192.168.192.156  _admin               </span><br><span class="line">node02  192.168.192.157  mon,mgr,osd          </span><br><span class="line">2 hosts in cluster</span><br></pre></td></tr></table></figure><h4 id="节点打标签"><a href="#节点打标签" class="headerlink" title="节点打标签"></a>节点打标签</h4><p>给节点打上指标标签后，后续可以按标签进行编排。</p><p>给节点打 <code>_admin</code> 标签，默认情况下，<code>_admin</code> 标签应用于存储集群中的 bootstrapped 主机， client.admin密钥被分发到该主机(ceph orch client-keyring {ls|set|rm})。<br>将这个标签添加到其他主机后，其他主机的/etc/ceph下也将有client.admin密钥。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 给 ceph02、ceph03加上 _admin 标签</span></span>  </span><br><span class="line">ceph orch host label add ceph02 _admin</span><br><span class="line">ceph orch host label add ceph03 _admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 给 ceph01-ceph04加上 mon 标签</span></span> </span><br><span class="line">ceph orch host label add ceph01 mon</span><br><span class="line">ceph orch host label add ceph02 mon</span><br><span class="line">ceph orch host label add ceph03 mon</span><br><span class="line">ceph orch host label add ceph04 mon</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host label add node01 mon,mgr,osd</span><br><span class="line"></span><br><span class="line">ceph orch host ls</span><br><span class="line"></span><br><span class="line">root@node01:/# ceph orch host ls</span><br><span class="line">HOST    ADDR             LABELS              STATUS  </span><br><span class="line">node01  192.168.192.156  _admin,mon,mgr,osd          </span><br><span class="line">node02  192.168.192.157  mon,mgr,osd                 </span><br><span class="line">2 hosts in cluster</span><br></pre></td></tr></table></figure><h5 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h5><p>删除节点上的_admin标签，并不会删除该节点上已有的<code>ceph.client.admin.keyring</code>密钥文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host label rm ceph03 label=_admin</span><br></pre></td></tr></table></figure><h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host rm &lt;host&gt; # 从集群中删除主机</span><br></pre></td></tr></table></figure><h3 id="添加osd"><a href="#添加osd" class="headerlink" title="添加osd"></a>添加osd</h3><ul><li>设备必须没有分区。</li><li>设备不得具有任何 LVM 状态。</li><li>不得安装设备。</li><li>设备不能包含文件系统。</li><li>设备不得包含 Ceph BlueStore OSD。</li><li>设备必须大于 5 GB。</li></ul><h4 id="初始化磁盘"><a href="#初始化磁盘" class="headerlink" title="初始化磁盘"></a>初始化磁盘</h4><p>添加OSD时，建议将磁盘先格式化为无分区的原始磁盘</p><p><a target="_blank" rel="noopener" href="https://rook.github.io/docs/rook/v1.10/Getting-Started/ceph-teardown/?h=sgdisk#zapping-devices">https://rook.github.io/docs/rook/v1.10/Getting-Started/ceph-teardown/?h=sgdisk#zapping-devices</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DISK=&quot;/dev/sdX&quot;</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdd&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span></span><br><span class="line">sgdisk --zap-all $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present</span></span></span><br><span class="line">dd if=/dev/zero of=&quot;$DISK&quot; bs=1M count=100 oflag=direct,dsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># SSDs may be better cleaned with blkdiscard instead of dd</span></span></span><br><span class="line">blkdiscard $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Inform the OS of partition table changes</span></span></span><br><span class="line">partprobe $DISK</span><br></pre></td></tr></table></figure><p>若 <code>AVAILABLE</code> 为 no，使用zap清除数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看各ceph节点有哪些磁盘是可用的，关注`AVAILABLE`列</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看设备列表，显示可用作OSD的设备</span></span><br><span class="line">ceph orch device ls [--hostname=...] [--wide] [--refresh]</span><br><span class="line"></span><br><span class="line">ceph orch device ls</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph orch device zap &lt;hostname&gt; &lt;path&gt; # 擦除设备（清除设备）</span><br><span class="line">ceph orch device zap --force node01 /dev/sdd</span><br></pre></td></tr></table></figure><h4 id="添加OSD"><a href="#添加OSD" class="headerlink" title="添加OSD"></a>添加OSD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建新的OSD</span></span><br><span class="line">ceph orch daemon add osd &lt;host&gt;:&lt;device-path&gt; [--verbose]</span><br><span class="line"></span><br><span class="line">ceph orch daemon add osd node01:/dev/sdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量创建OSD</span></span><br><span class="line">ceph orch apply osd --all-available-devices</span><br></pre></td></tr></table></figure><h3 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动删除</span></span><br><span class="line">ceph orch rm &lt;service-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动删除</span></span><br><span class="line">ceph orch daemon rm &lt;daemon name&gt;... [--force]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>tail -f /var</p><h3 id="删除集群"><a href="#删除集群" class="headerlink" title="删除集群"></a>删除集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/ceph/ceph.conf</span><br><span class="line"></span><br><span class="line">cephadm rm-cluster --fsid [] --force</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现相关依赖被删除</span></span><br><span class="line">docker ps -a </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清理cephadm日志</span></span><br><span class="line">rm -rf cephadm.log</span><br></pre></td></tr></table></figure><p>remapped应该是不允许数据放在同一hosts上</p><p><a target="_blank" rel="noopener" href="https://lihaijing.gitbooks.io/ceph-handbook/content/Troubleshooting/troubleshooting_pg.html">https://lihaijing.gitbooks.io/ceph-handbook/content/Troubleshooting/troubleshooting_pg.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">osd crush chooseleaf type</span><br><span class="line"></span><br><span class="line">Description</span><br><span class="line">The bucket type to use for chooseleaf in a CRUSH rule. Uses ordinal rank rather than name.</span><br><span class="line"></span><br><span class="line">Type</span><br><span class="line">32-bit Integer</span><br><span class="line"></span><br><span class="line">Default</span><br><span class="line">1. Typically a host containing one or more Ceph OSD Daemons.</span><br></pre></td></tr></table></figure><h3 id="池副本数"><a href="#池副本数" class="headerlink" title="池副本数"></a>池副本数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ceph 池副本数</span></span><br><span class="line">ceph osd dump | grep size</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改池副本数</span></span><br><span class="line">ceph osd pool setsize</span><br></pre></td></tr></table></figure><p>ceph.conf 文件不再用作存储集群配置的中心位置，取而代之的是配置数据库</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_67736058/article/details/137922219">https://blog.csdn.net/qq_67736058/article/details/137922219</a></p><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/36c2d5682d87">分布式存储Ceph之PG状态详解</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aa18855953229/article/details/127399801">Ceph的管理监控和故障排查</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/30934922/" title="5.存储配置">https://amostian.github.io/posts/30934922/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tags"></i> 分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/3254666707/" rel="prev" title="1. Ceph架构与组件"><i class="fa fa-chevron-left"></i> 1. Ceph架构与组件</a></div><div class="post-nav-item"><a href="/posts/30934922/" rel="next" title="5.存储配置">5.存储配置 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE"><span class="nav-text">系统设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">查看版本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%90%8D%E3%80%81%E5%AF%86%E7%A0%81"><span class="nav-text">用户名、密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E5%88%92"><span class="nav-text">规划</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8Dip%E6%98%A0%E5%B0%84"><span class="nav-text">主机名ip映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81ip"><span class="nav-text">静态ip</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-text">时间同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E4%B8%8ESELinux"><span class="nav-text">防火墙与SELinux</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%97%B4ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">节点间ssh免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8Essh-key%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="nav-text">实现基于ssh key的验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0root%E7%94%A8%E6%88%B7%E7%9A%84ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">实现root用户的ssh免密登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87sshpass%E4%B8%BA%E6%AF%8F%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%94%9F%E6%88%90sshkey%E5%B9%B6%E6%8E%A8%E9%80%81%E7%BB%99hosts%E4%B8%AD%E5%B7%B2%E7%9F%A5%E4%B8%BB%E6%9C%BA"><span class="nav-text">通过sshpass为每个主机生成sshkey并推送给hosts中已知主机</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87cephadm%E5%AE%9E%E7%8E%B0%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">所有主机通过cephadm实现免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAcephadm%E7%94%A8%E6%88%B7"><span class="nav-text">创建cephadm用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">跨主机免密登录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ceph-deploy"><span class="nav-text">ceph-deploy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#admin%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85ceph-deploy%E5%B7%A5%E5%85%B7"><span class="nav-text">admin节点安装ceph-deploy工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-deploy%E5%AF%B9%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">ceph-deploy对集群初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph%E5%8C%85%E7%9A%84%E5%AE%89%E8%A3%85%E2%80%94%E2%80%94%E4%B8%8D%E6%8E%A8%E8%8D%90%E7%94%A8ceph-deploy-install"><span class="nav-text">ceph包的安装——不推荐用ceph-deploy install</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AEceph%E5%8C%85%E5%AE%89%E8%A3%85%E6%BA%90"><span class="nav-text">为所有节点配置ceph包安装源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ceph-deploy-install%E6%8C%87%E4%BB%A4%E4%BB%8B%E7%BB%8D"><span class="nav-text">ceph-deploy install指令介绍</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mon%E8%8A%82%E7%82%B9"><span class="nav-text">mon节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85mon%E8%8A%82%E7%82%B9%E4%BE%9D%E8%B5%96"><span class="nav-text">安装mon节点依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96mon%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="nav-text">初始化mon节点生成配置信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%91admin%E8%8A%82%E7%82%B9%E6%8E%A8%E9%80%81admin%E5%AF%86%E9%92%A5"><span class="nav-text">向admin节点推送admin密钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mgr%E8%8A%82%E7%82%B9"><span class="nav-text">mgr节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85mgr%E8%8A%82%E7%82%B9%E4%BE%9D%E8%B5%96"><span class="nav-text">安装mgr节点依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86mgr%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-text">将mgr节点加入集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#osd%E8%8A%82%E7%82%B9"><span class="nav-text">osd节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85osd%E4%BE%9D%E8%B5%96"><span class="nav-text">安装osd依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%8F%AF%E7%94%A8%E7%9A%84osd%E7%A3%81%E7%9B%98"><span class="nav-text">查看所有可用的osd磁盘</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B8%85%E9%99%A4OSD%E7%A3%81%E7%9B%98"><span class="nav-text">清除OSD磁盘</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%B7%BB%E5%8A%A0osd%E8%8A%82%E7%82%B9"><span class="nav-text">集群添加osd节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%89%A9%E5%B1%95"><span class="nav-text">高可用扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mgr%E6%89%A9%E5%B1%95"><span class="nav-text">mgr扩展</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mon%E6%89%A9%E5%B1%95"><span class="nav-text">mon扩展</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cephadm"><span class="nav-text">cephadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker"><span class="nav-text">docker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDcontainerd%E5%92%8Cdocker"><span class="nav-text">下载containerd和docker</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%9F%E6%88%90containerd%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">生成containerd配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%8F%AA%E9%9C%80%E5%B0%86%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E8%BF%87%E5%8E%BB%E5%90%AF%E5%8A%A8%E5%8D%B3%E5%8F%AF"><span class="nav-text">其他节点只需将相关文件拷贝过去启动即可</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-1"><span class="nav-text">docker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cephadm-1"><span class="nav-text">cephadm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9ceph%E6%BA%90"><span class="nav-text">修改ceph源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85cephadm"><span class="nav-text">管理节点安装cephadm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5"><span class="nav-text">检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="nav-text">初始化集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="nav-text">查看组件运行状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="nav-text">删除不必要组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ceph%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA"><span class="nav-text">ceph镜像导出</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA"><span class="nav-text">添加主机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E6%89%93%E6%A0%87%E7%AD%BE"><span class="nav-text">节点打标签</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%A0%87%E7%AD%BE"><span class="nav-text">删除标签</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-text">删除节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0osd"><span class="nav-text">添加osd</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A3%81%E7%9B%98"><span class="nav-text">初始化磁盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0OSD"><span class="nav-text">添加OSD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1"><span class="nav-text">删除服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E9%9B%86%E7%BE%A4"><span class="nav-text">删除集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B1%A0%E5%89%AF%E6%9C%AC%E6%95%B0"><span class="nav-text">池副本数</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">382</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">78</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">998.4k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">41:08</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"live2d-widget-model-hijiki"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1})</script></body></html>