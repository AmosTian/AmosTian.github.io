<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa:300,300italic,400,400italic,700,700italic|Ma Shan Zheng:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"amostian.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="[TOC]"><meta property="og:type" content="article"><meta property="og:title" content="基于ceph-depoy和cephadm安装ceph"><meta property="og:url" content="https://amostian.github.io/posts/4007999911/index.html"><meta property="og:site_name" content="AmosTian"><meta property="og:description" content="[TOC]"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231020162129750.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231020171033087.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231108150709863.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231022112928488.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240604181258344.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231021110501138.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423100309821.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231022193050105.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240424015543853.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231021170352538.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231021171607107-17305478470151.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423115746284.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423115801278.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423215726912.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423215900896.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423220028750.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423220250108.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423220330144.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423220754587.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240424021222677.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423132945409.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240424030727092.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423221447871.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423222058555.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240423222156128.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240424025322420.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240424031046905.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240425135902182.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240425140004253.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240425141038172.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240425141127811.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20231021235858359.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240608185248481.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240608185227794.png"><meta property="og:image" content="https://amostian.github.io/posts/4007999911/image-20240608194858189.png"><meta property="article:published_time" content="2024-06-07T16:16:44.000Z"><meta property="article:modified_time" content="2025-10-19T02:33:06.569Z"><meta property="article:author" content="AmosTian"><meta property="article:tag" content="存储"><meta property="article:tag" content="分布式存储"><meta property="article:tag" content="Ceph"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://amostian.github.io/posts/4007999911/image-20231020162129750.png"><link rel="canonical" href="https://amostian.github.io/posts/4007999911/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>基于ceph-depoy和cephadm安装ceph | AmosTian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">AmosTian</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">68</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">84</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">234</span></a></li><li class="menu-item menu-item-essay"><a href="/categories/%E9%9A%8F%E7%AC%94/" rel="section"><i class="fa fa-fw fa-pied-piper"></i>随笔</a></li><li class="menu-item menu-item-dynamic-resume"><a href="/dynamic-resume/" rel="section"><i class="fa fa-fw fa-cog"></i>动态简历</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AmosTian" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://amostian.github.io/posts/4007999911/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="AmosTian"><meta itemprop="description" content="知道的越多，不知道的越多"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="AmosTian"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">基于ceph-depoy和cephadm安装ceph</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间 2024-06-08 00:16:44" itemprop="dateCreated datePublished" datetime="2024-06-08T00:16:44+08:00">2024-06-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间 2025-10-19 10:33:06" itemprop="dateModified" datetime="2025-10-19T10:33:06+08:00">2025-10-19</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a> </span>> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AD%98%E5%82%A8/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/Ceph/" itemprop="url" rel="index"><span itemprop="name">Ceph</span></a></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数 </span><span title="本文字数">15.3k字 </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>45 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>[TOC]</p><span id="more"></span><h1 id="部署前置知识"><a href="#部署前置知识" class="headerlink" title="部署前置知识"></a>部署前置知识</h1><h2 id="2-0-1-Ceph存储机制"><a href="#2-0-1-Ceph存储机制" class="headerlink" title="2.0.1 Ceph存储机制"></a>2.0.1 Ceph存储机制</h2><p>将待管理的数据流切分为一到多个固定大小的对象数据，并以其为原子单元完成数据存储</p><p>Ceph通过内部的Crush机制，实时计算出一个文件应该存储到哪个存储对象中，从而实现快速查找对象的方式</p><p><img src="/posts/4007999911/image-20231020162129750.png" alt="image-20231020162129750"></p><h2 id="2-0-2-各组件的硬件需求"><a href="#2-0-2-各组件的硬件需求" class="headerlink" title="2.0.2 各组件的硬件需求"></a>2.0.2 各组件的硬件需求</h2><p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/start/hardware-recommendations/">硬件推荐</a></p><p><strong>底层硬件决定系统性能的上限</strong></p><p>Ceph的优点之一是支持异构硬件，集群可以运行在来自多个厂商的硬件上，不存在因为硬件问题被厂商锁定的情况。在创建Ceph的底层基础设施时，客户可以根据预算及性能需求自行使用任何硬件，对于硬件的选用拥有完全的自主权和决策权。</p><p><img src="/posts/4007999911/image-20231020171033087.png" alt="image-20231020171033087"></p><p>无论想向云平台提供Ceph对象存储和块设备、文件系统，或者将Ceph用于其他目的，所有的ceph集群部署都从设置每个Ceph节点的网络开始</p><p>一个Ceph存储集群至少一个Ceph Monitor、Ceph Manager 和 Ceph OSD，如果有运行文件系统的客户端，还需要配置MDSs</p><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>Ceph的一些组件不是CPU依赖型</p><p><strong>monitor守护进程</strong> 对CPU是轻量依赖的，只负责保持集群的状态而不给用户提供任何数据</p><ul><li>不参与数据存储，不频繁利用内存，占用资源较少</li><li>单核CPU就可以完成，需要确保monitor有足够的内存、网络与磁盘空间</li><li>对于小集群，monitor可以与其他组件放在一起</li></ul><p><strong>OSD进程</strong> 需要大量的CPU资源（直接提供数据给客户端），需要进行一些数据处理</p><ul><li><p>CPU(1GHz)和内存(2GB)：建议在早期多配置内存和CPU资源，因为在JBOD系统中，可以随时为主机增加硬盘</p></li><li><p>建议双核CPU。若以纠删码的方式使用OSD，则需要四核处理器（纠删码需要大量计算）</p></li><li><p>当集群处于recovery状态时，OSD守护进程对处理器的占用很大</p><script type="math/tex;mode=display">\frac{CPU线程数\times CPU每线程占核数\times CPU时钟频率(GHz)}{OSD数}\ge 1</script></li></ul><p><strong>MDS守护进程</strong> 是CPU密集型。需要动态地分配负载</p><ul><li>建议四核CPU</li></ul><h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><blockquote><p>当集群处于recovery状态时，内存消耗会明显增加</p></blockquote><p>monitor和元数据守护进程需要快速对外响应，必须有足够的内存处理</p><ul><li>从性能角度，为每个monitor和元数据守护进程必须大于2GB</li></ul><p>OSD不是内存密集型</p><ul><li><p>一般的工作负载情况下，每个OSD守护进程分配1GB内存就足够了</p></li><li><p>从性能角度，若OSD进程使用一整块磁盘，分配2GB。</p><p>若OSD使用多个磁盘，内存需求需要同步增加</p></li></ul><h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p><strong>monitor硬件需求</strong></p><ul><li>若 日志信息(log) 存储在本地monitor节点，就要确保monitor节点上有 <strong>足够的磁盘空间</strong> 来存放日志文件</li></ul><p><strong>OSD硬件需求</strong> OSD是Ceph 中主要存储单元，需要配置足够的硬盘</p><ul><li><p>为集群节点中的每一块物理硬盘创建一个OSD进程</p><p>OSD支持灵活部署，可以为每块物理硬盘创建一个OSD，也可以为每个RAID创建OSD进程</p></li><li><p>硬盘容量越大，每GB的成本越低，内存也需要相应越大</p></li></ul><h3 id="网络需求"><a href="#网络需求" class="headerlink" title="网络需求"></a>网络需求</h3><p><strong>带宽</strong></p><blockquote><p>以太网、InfiniBand网络、10G网络或更高带宽的网络</p></blockquote><p>对于百TB级别的中等规模集群而言，1Gbit/s的网络也能正常工作。若考虑到未来的纵向扩展带来的工作负载(ROI/性能)，建议为数据和集群管理分别采用10Gbit/s的物理隔离网络</p><p>当集群规模较大，需要为多个客户端提供服务，则应有10G以上的带宽</p><p>对于几百TB的超大Ceph集群，需要400Gbit/s的带宽</p><p><strong>内外网络隔离</strong></p><blockquote><p>集群网络和客户端网络应该接在物理上隔离的交换机上：</p><ul><li>公共网络（客户端网络）允许客户端与Ceph集群通信并访问集群中存储的数据</li><li>内部网络（集群网络）负责集群内诸如复制、恢复、再平衡和心跳检查等需要高带宽的操作</li></ul></blockquote><p><img src="/posts/4007999911/image-20231108150709863.png" alt="image-20231108150709863"></p><p>大多数情况下，集群内部网络流量更大（Ceph的OSD节点在内部使用）：</p><ul><li>数据冗余备份：若对于一个客户端的写入动作，数据备份了N次，则Ceph集群需要写N次。所有的冗余数据基于集群网络在对等节点间进行传输</li><li>数据的恢复和再平衡</li></ul><p><strong>冗余配置</strong></p><p>在网络配置的各层采用冗余设计，如：网卡，端口，交换机和路由器</p><p>monitor硬件需求：1Gbit/s的双网卡</p><ul><li>网络级别的冗余对于monitor很重要，因为monitor节点间需要进行仲裁</li></ul><h3 id="MDS需求"><a href="#MDS需求" class="headerlink" title="MDS需求"></a>MDS需求</h3><p>相较于Ceph的monitor与OSD，Ceph MDS比较占资源。</p><p><strong>硬件需求</strong></p><ul><li>更强的CPU处理能力，四核或者更高</li><li>MDS依赖大量的数据缓存，需要更大的RAM资源</li></ul><h2 id="2-0-3-规划集群"><a href="#2-0-3-规划集群" class="headerlink" title="2.0.3 规划集群"></a>2.0.3 规划集群</h2><h3 id="限制条件"><a href="#限制条件" class="headerlink" title="限制条件"></a>限制条件</h3><p>Ceph的各种组件应该避免复用。组件角色复用会给集群的运维和性能带来很大的影响。可以避免集群运行带来的不稳定因素，在考虑安全性与可靠性的前提下，必须满足一些限制条件：</p><ul><li>至少配置3个monitor节点</li><li>每个节点至少配置3个OSD</li><li>至少配置两个manager节点</li><li>所有的OSD节点配置相同</li><li>若使用CephFS，至少配置2个配置完全相同的MDS节点</li><li>若使用Ceph 网关，至少配置2个不同的RGW节点</li></ul><h3 id="关于功能特性的备注"><a href="#关于功能特性的备注" class="headerlink" title="关于功能特性的备注"></a>关于功能特性的备注</h3><p>并不是支持所有的Ceph功能，即不是所有的功能都是稳定的，表中的几种指标及配置是经过企业落地实践校验的</p><div class="table-container"><table><thead><tr><th>特性</th><th>数量</th><th>备注</th></tr></thead><tbody><tr><td>副本策略</td><td>SSD：支持2副本，最低1副本<br>HDD：支持3副本，最低2副本，</td><td>副本数少，影响数据可靠性</td></tr><tr><td>纠删码</td><td>K+M的支持配比：8+3，8+4，4+2<br>存储节点最少为k+m+1</td><td>支持在RGW和RBD两种模式下使用，MDS不支持纠删码</td></tr><tr><td>RGW多站点</td><td></td><td>多站点配置中不支持Indexless Bucket</td></tr><tr><td>Disk Size</td><td>最大容量12TB</td><td>不支持磁带</td></tr><tr><td>每个节点OSD数量</td><td>单节点最多配置36个OSD</td><td></td></tr><tr><td>单集群OSD数量</td><td>单集群最多配置2500个OSD</td><td></td></tr><tr><td>Snapshot</td><td>单个RBD镜像支持512个快照，</td><td>RGW不支持快照</td></tr><tr><td>BlueStore</td><td></td><td>必须使用默认的磁盘空间分配器Allocator</td></tr></tbody></table></div><h3 id="硬件选型"><a href="#硬件选型" class="headerlink" title="硬件选型"></a>硬件选型</h3><p>在选型Ceph服务器时，必须确定Ceph的使用场景，不同的使用场景下有不同的配置考量，常见的Ceph使用场景有</p><ul><li>追求良好IOPS</li><li>追求良好的吞吐量</li><li>追求低成本、高容量</li></ul><h4 id="追求良好的IOPS"><a href="#追求良好的IOPS" class="headerlink" title="追求良好的IOPS"></a>追求良好的IOPS</h4><p>随着闪存使用的增加，企业越来越多地将IOPS敏感型工作负载依托在Ceph集群，以便提高私有云存储解决方案的性能。在此场景下，可以把MySQL、MariaDB或PostgreSQL托管在Ceph集群，以支持结构化数据</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个NVMe SSD使用6核或者每个非NVMe使用2核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>NVMe SSD</td></tr><tr><td>BlueStore WAL/DB</td><td>可与NVMe SSD分配两个OSD</td></tr><tr><td>磁盘控制器</td><td>PCIe</td></tr><tr><td>OSD进程数</td><td>每个NVMe分配2个OSD进程</td></tr><tr><td>网络</td><td>每2个OSD使用10GB带宽网络</td></tr></tbody></table></div><h4 id="追求良好吞吐量"><a href="#追求良好吞吐量" class="headerlink" title="追求良好吞吐量"></a>追求良好吞吐量</h4><p>Ceph集群通常可以存储半结构化数据，一般是顺序读写比较大的文件，需要提供很大的带宽。存储服务器上的磁盘可以使用SSD做日志加快HDD</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个HDD使用0.5核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>7200RPM的HDD、SATA、SAS</td></tr><tr><td>BlueStore WAL/DB</td><td>使用独立的NVMe SSD 或 SAS SSD作为加速盘</td></tr><tr><td>磁盘控制器</td><td>HBA（JBOD）</td></tr><tr><td>OSD进程数</td><td>每个HDD分配1个OSD进程</td></tr><tr><td>网络</td><td>每12个OSD使用10GB带宽网络</td></tr></tbody></table></div><h4 id="最求低成本、高容量场景"><a href="#最求低成本、高容量场景" class="headerlink" title="最求低成本、高容量场景"></a>最求低成本、高容量场景</h4><p>低成本和高容量的解决方案用于处理存储容量较大、存储时间较长的数据，且按块顺序读写。数据可以是结构化或半结构化。存储内容包括媒体文件、大数据分析文件和磁盘镜像备份等。为了获得更高的效益，OSD与日志通常都托管在HDD。</p><div class="table-container"><table><thead><tr><th>硬件</th><th>配置</th></tr></thead><tbody><tr><td>CPU</td><td>主频2GHz,则每个HDD使用0.5核</td></tr><tr><td>RAM</td><td>16GB+5GB*OSD（16GB为基准，每增加一个OSD增加5GB）</td></tr><tr><td>数据盘</td><td>NVMe SSD</td></tr><tr><td>BlueStore WAL/DB</td><td>可与HDD数据盘同步</td></tr><tr><td>磁盘控制器</td><td>HBA（JBOD）</td></tr><tr><td>OSD进程数</td><td>每个HDD分配1个OSD进程</td></tr><tr><td>网络</td><td>每两个OSD使用10GB带宽网络</td></tr></tbody></table></div><h2 id="2-0-4-版本选型与安装工具"><a href="#2-0-4-版本选型与安装工具" class="headerlink" title="2.0.4 版本选型与安装工具"></a>2.0.4 版本选型与安装工具</h2><h3 id="版本选型"><a href="#版本选型" class="headerlink" title="版本选型"></a>版本选型</h3><p>每个Ceph版本都有一个英文名称和一个数字形式的版本编号</p><p>x.0.z - 开发版</p><p>x.1.z - 候选版</p><p>x.2.z - 稳定、修正版</p><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/releases/">https://docs.ceph.com/en/latest/releases/</a></p><h3 id="推荐方法"><a href="#推荐方法" class="headerlink" title="推荐方法"></a>推荐方法</h3><h4 id="Cephadm"><a href="#Cephadm" class="headerlink" title="Cephadm"></a>Cephadm</h4><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/quincy/cephadm/install/#cephadm-deploying-new-cluster">Cephadm</a>是一个可用于安装和管理 Ceph 集群的工具。</p><ul><li>cephadm 仅支持 Octopus 和较新版本。</li><li>cephadm 与业务流程 API 完全集成，并完全支持用于管理集群部署的 CLI 和仪表板功能。</li><li>cephadm 需要容器支持（以 Podman 或 Docker 的形式）和 Python 3。</li></ul><p><a target="_blank" rel="noopener" href="https://rook.io/">Rook</a>可部署和管理在 Kubernetes 中运行的 Ceph 集群，同时还支持通过 Kubernetes API 管理存储资源和配置。我们建议使用 Rook 在 Kubernetes 中运行 Ceph 或将现有 Ceph 存储集群连接到 Kubernetes。</p><ul><li>Rook 仅支持 Nautilus 和较新版本的 Ceph。</li><li>Rook 是在 Kubernetes 上运行 Ceph 或将 Kubernetes 集群连接到现有（外部）Ceph 集群的首选方法。</li><li>Rook 支持 Orchestrator API。CLI 和仪表板中的管理功能完全受支持。</li></ul><h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/ceph-ansible/">ceph-ansible</a>使用 Ansible 部署和管理 Ceph 集群。# python</p><ul><li>ceph-ansible 被广泛部署。</li><li>ceph-ansible 未与 Nautilus 和 Octopus 中引入的编排器 API (orchestrator APIs)集成，这意味着 Nautilus 和 Octopus 中引入的管理功能和仪表板集成在通过 ceph-ansible 部署的 Ceph 集群中不可用。</li></ul><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/projects/ceph-deploy/en/latest/">ceph-deploy</a>是一款可用于快速部署集群的工具。现已弃用。# python+shell</p><blockquote><p>ceph-deploy 并未得到积极维护。它未在 Nautilus 以上版本的 Ceph 上进行测试。它不支持 RHEL8、CentOS 8 或更新的操作系统。</p></blockquote><p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-salt">ceph-salt</a>使用 Salt 和 cephadm 安装 Ceph。 #python</p><p><a target="_blank" rel="noopener" href="https://jaas.ai/ceph-mon">jaas.ai/ceph-mon</a>使用 Juju 安装 Ceph。</p><p>ceph-container：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-container">https://github.com/ceph/ceph-container</a> #shell</p><p>ceph-chef：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-chef">https://github.com/ceph/ceph-chef</a> #Ruby</p><p><a target="_blank" rel="noopener" href="https://github.com/openstack/puppet-ceph">github.com/openstack/puppet-ceph</a> 通过 Puppet 安装 Ceph。</p><p><a target="_blank" rel="noopener" href="https://docs.opennebula.io/stable/provision_clusters/hci_clusters/overview.html">OpenNebula HCI集群</a>在各种云平台上部署Ceph。</p><p>Ceph 也可以<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/quincy/install/index_manual/#install-manual">手动安装</a>。</p><h2 id="2-0-5-参考"><a href="#2-0-5-参考" class="headerlink" title="2.0.5 参考"></a>2.0.5 参考</h2><div class="table-container"><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>cephadm 15.2.2</td><td><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zttong/p/17463837">https://www.cnblogs.com/zttong/p/17463837</a></td><td>centos8</td></tr><tr><td>cephadm离线安装v15.2.7</td><td><a target="_blank" rel="noopener" href="https://blog.csdn.net/nanhai_happy/article/details/131934493">https://blog.csdn.net/nanhai_happy/article/details/131934493</a></td><td>kylin linux</td></tr><tr><td>时间同步chronyc</td><td><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_64334766/article/details/128536776">https://blog.csdn.net/weixin_64334766/article/details/128536776</a></td><td></td></tr><tr><td>ceph-deploy指定源安装</td><td><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zphj1987/p/13575358.html">https://www.cnblogs.com/zphj1987/p/13575358.html</a></td><td>centos</td></tr><tr><td>ceph-deploy mimic版本13.2.5</td><td><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zyxnhr/p/10539740.html">https://www.cnblogs.com/zyxnhr/p/10539740.html</a></td><td>CentOS Linux release 7.6</td></tr><tr><td>ceph-deploy kylin N版</td><td><a target="_blank" rel="noopener" href="https://blog.csdn.net/wsl12105/article/details/128777912">https://blog.csdn.net/wsl12105/article/details/128777912</a></td><td>kylin linux</td></tr><tr><td>手动安装ceph</td><td><a target="_blank" rel="noopener" href="https://www.cnblogs.com/freeweb/p/13542285.html">https://www.cnblogs.com/freeweb/p/13542285.html</a></td><td>cephos 7/8</td></tr></tbody></table></div><h1 id="2-1-操作系统设置"><a href="#2-1-操作系统设置" class="headerlink" title="2.1 操作系统设置"></a>2.1 操作系统设置</h1><h2 id="2-1-1-查看版本信息"><a href="#2-1-1-查看版本信息" class="headerlink" title="2.1.1 查看版本信息"></a>2.1.1 查看版本信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看系统信息命令</span></span><br><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure><h2 id="2-1-2-修改用户名一定要修改密码"><a href="#2-1-2-修改用户名一定要修改密码" class="headerlink" title="2.1.2 修改用户名一定要修改密码"></a>2.1.2 修改用户名一定要修改密码</h2><ul><li><strong>一定要设置root密码</strong></li><li>nodexx 主机名，用户密码</li></ul><p>用户名</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hostname #查看系统主机名称</span><br><span class="line">node01@ hostnamectl set-hostname node01</span><br><span class="line">node02@ hostnamectl set-hostname node02</span><br><span class="line"></span><br><span class="line">hostnamectl set-hostname xx #修改主机名称	</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">执行命令之后，会自动修改 /etc/hostname 文件</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">执行命令之后，会立即生效，且重启系统也会生效</span></span><br><span class="line">cat /etc/hostname	#查看 /etc/hostname 文件内容，里面配置的就是系统主机名称</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">sudo gedit /etc/passwd # 找到原先的用户名，将其改为自己的用户名（一行全部都改）</span><br><span class="line">sudo  gedit /etc/shadow #找到原先用户名（所有的名字都要改），改为自己的用户名</span><br><span class="line">sudo gedit /etc/group #你应该发现你的用户名在很多个组中，全部修改！</span><br><span class="line">mv /home/原用户名/ /home/新用户名</span><br><span class="line"></span><br><span class="line">mv /home/ceph_admin/ /home/</span><br></pre></td></tr></table></figure><p>密码（登录用户需要修改）</p><ol><li>进入Ubuntu，打开一个终端，输入 sudo su转为root用户。 注意，必须先转为root用户！！！</li><li>sudo passwd user(user 是对应的用户名)</li><li>输入新密码，确认密码。</li><li>修改密码成功，重启，输入新密码进入Ubuntu。</li></ol><h2 id="2-1-3-规划"><a href="#2-1-3-规划" class="headerlink" title="2.1.3 规划"></a>2.1.3 规划</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ens33：NAT网络 VMnet8 公网ip设定为192.168.192.0/24 网段</span><br><span class="line">ens37：仅主机 VMnet1 私有ip设定为10.168.192.0/24 网段，提供ceph集群内网络</span><br></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>主机名</th><th>role</th><th>公有网络</th><th>私有网络</th><th>磁盘</th></tr></thead><tbody><tr><td>node1</td><td>admin/mon/mgr/osd1</td><td>192.168.192.156</td><td>10.168.192.156</td><td>sda50GB,sdb/sdc20GB</td></tr><tr><td>node2</td><td>mon/mgr/osd3/osd4</td><td>192.168.192.157</td><td>10.168.192.157</td><td>sda50GB,sdb/sdc20GB</td></tr></tbody></table></div><p><img src="/posts/4007999911/image-20231022112928488.png" alt="image-20231022112928488"></p><h3 id="主机名ip映射"><a href="#主机名ip映射" class="headerlink" title="主机名ip映射"></a>主机名ip映射</h3><p>在所有主机下配置以下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">public network</span></span><br><span class="line">192.168.192.156 node01</span><br><span class="line">192.168.192.157 node02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster network</span></span><br><span class="line">10.168.192.156 node01-cl</span><br><span class="line">10.168.192.157 node02-cl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">manage network</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="静态ip"><a href="#静态ip" class="headerlink" title="静态ip"></a>静态ip</h3><p>配置ip与网关</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前网关 ip</span></span><br><span class="line">netstat -rn</span><br><span class="line">ip a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加DNS解析，任意添加一个</span></span><br><span class="line">vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apt upgrade -y</span><br><span class="line">sudo apt install -y net-tools   </span><br><span class="line">ifconfig #查看网卡名称</span><br><span class="line">ip a</span><br><span class="line"></span><br><span class="line">cd /etc/netplan</span><br><span class="line">sudo gedit 01-network-manager-all.yaml</span><br><span class="line"></span><br><span class="line">network: </span><br><span class="line"> version: 2</span><br><span class="line"> renderer: NetworkManager</span><br><span class="line"> ethernets:</span><br><span class="line">  ens33:</span><br><span class="line">   dhcp4: false</span><br><span class="line">   addresses: [192.168.192.156/24]</span><br><span class="line">   gateway4: 192.168.192.2</span><br><span class="line">   nameservers:</span><br><span class="line">    addresses: [192.168.192.2]</span><br><span class="line">  ens34:</span><br><span class="line">  	dhcp4: false</span><br><span class="line">  	addresses: [10.168.192.156/24]</span><br><span class="line">  	nameservers:</span><br><span class="line">     addresses: [10.168.192.2]</span><br><span class="line"></span><br><span class="line">network: </span><br><span class="line"> version: 2</span><br><span class="line"> renderer: NetworkManager</span><br><span class="line"> ethernets:</span><br><span class="line">  ens33:</span><br><span class="line">   dhcp4: false</span><br><span class="line">   addresses: [192.168.192.157/24]</span><br><span class="line">   gateway4: 192.168.192.2</span><br><span class="line">   nameservers:</span><br><span class="line">    addresses: [192.168.192.2]</span><br><span class="line">  ens34:</span><br><span class="line">  	dhcp4: false</span><br><span class="line">  	addresses: [10.168.192.157/24]</span><br><span class="line">  	nameservers:</span><br><span class="line">     addresses: [10.168.192.2]</span><br><span class="line">    </span><br><span class="line">sudo netplan apply </span><br></pre></td></tr></table></figure><h2 id="2-1-4-时间同步"><a href="#2-1-4-时间同步" class="headerlink" title="2.1.4 时间同步"></a>2.1.4 时间同步</h2><blockquote><p>Ceph默认要求各节点的时间误差不超过50ms</p></blockquote><p>所有节点都安装chrony</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">systemctl enable chronyd</span><br></pre></td></tr></table></figure><p>ceph01作为时间同步服务端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pool 2.centos.pool.ntp.org iburst</span></span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst</span><br><span class="line">server 2.centos.pool.ntp.org iburst</span><br><span class="line">server 3.centos.pool.ntp.org iburst</span><br><span class="line">pool ntp1.aliyun.com iburst</span><br><span class="line">pool ntp2.aliyun.com iburst</span><br><span class="line">pool ntp3.aliyun.com iburst</span><br><span class="line">pool ntp4.aliyun.com iburst</span><br><span class="line">pool ntp5.aliyun.com iburst</span><br><span class="line">pool ntp6.aliyun.com iburst</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Record the rate at <span class="built_in">which</span> the system clock gains/losses time.</span></span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow the system clock to be stepped <span class="keyword">in</span> the first three updates</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> its offset is larger than 1 second.</span></span><br><span class="line">makestep 1.0 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Enable kernel synchronization of the real-time clock (RTC).</span></span><br><span class="line">rtcsync</span><br><span class="line"></span><br><span class="line">local stratum 10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow NTP client access from <span class="built_in">local</span> network.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将自身当做服务器</span></span><br><span class="line">allow 192.168.0.0/16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Serve time even <span class="keyword">if</span> not synchronized to a time <span class="built_in">source</span>.</span></span><br></pre></td></tr></table></figure><p>重启服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redhat</span></span><br><span class="line">systemctl enable chronyd</span><br><span class="line">systemctl restart chronyd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">debian 重启服务</span></span><br><span class="line">systemctl restart chrony</span><br><span class="line">systemctl status chrony</span><br><span class="line">systemctl enable chrony</span><br><span class="line"></span><br><span class="line">chronyc sources</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240604181258344.png" alt="image-20240604181258344"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph01 ~]# timedatectl</span><br><span class="line">               Local time: 二 2024-06-04 18:10:34 CST</span><br><span class="line">           Universal time: 二 2024-06-04 10:10:34 UTC</span><br><span class="line">                 RTC time: 二 2024-06-04 10:10:33</span><br><span class="line">                Time zone: Asia/Shanghai (CST, +0800)</span><br><span class="line">System clock synchronized: yes # 主要看这里</span><br><span class="line">              NTP service: active</span><br><span class="line">          RTC in local TZ: no</span><br><span class="line">[root@ceph01 ~]# date</span><br><span class="line">2024年 06月 04日 星期二 18:10:41 CST</span><br></pre></td></tr></table></figure><p>ceph2及其他后续节点作为客户端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/chrony.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line">pool ceph01 iburst</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Record the rate at <span class="built_in">which</span> the system clock gains/losses time.</span></span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow the system clock to be stepped <span class="keyword">in</span> the first three updates</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">if</span> its offset is larger than 1 second.</span></span><br><span class="line">makestep 1.0 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Enable kernel synchronization of the real-time clock (RTC).</span></span><br><span class="line">rtcsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Enable hardware timestamping on all interfaces that support it.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">hwtimestamp *</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Increase the minimum number of selectable sources required to adjust</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the system clock.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">minsources 2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow NTP client access from <span class="built_in">local</span> network.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">allow 192.168.0.0/16</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Serve time even <span class="keyword">if</span> not synchronized to a time <span class="built_in">source</span>.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">local</span> stratum 10</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Specify file containing keys <span class="keyword">for</span> NTP authentication.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">keyfile /etc/chrony.keys</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Get TAI-UTC offset and leap seconds from the system tz database.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">leapsectz right/UTC</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Specify directory <span class="keyword">for</span> <span class="built_in">log</span> files.</span></span><br><span class="line">logdir /var/log/chrony</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Select <span class="built_in">which</span> information is logged.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">log</span> measurements statistics tracking</span></span><br></pre></td></tr></table></figure><p>其他节点重启服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart chronyd</span><br></pre></td></tr></table></figure><p>使用时间服务的客户端进行验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">chronyc sources -v</span><br><span class="line">[root@ceph02 ~]# chronyc sources -v</span><br><span class="line">210 Number of sources = 1</span><br><span class="line"></span><br><span class="line">  .-- Source mode  &#x27;^&#x27; = server, &#x27;=&#x27; = peer, &#x27;#&#x27; = local clock.</span><br><span class="line"> / .- Source state &#x27;*&#x27; = current synced, &#x27;+&#x27; = combined , &#x27;-&#x27; = not combined,</span><br><span class="line">| /   &#x27;?&#x27; = unreachable, &#x27;x&#x27; = time may be in error, &#x27;~&#x27; = time too variable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||      Reachability register (octal) -.           |  xxxx = adjusted offset,</span><br><span class="line">||      Log2(Polling interval) --.      |          |  yyyy = measured offset,</span><br><span class="line">||                                \     |          |  zzzz = estimated error.</span><br><span class="line">||                                 |    |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^* ceph01-cl                     3   6    17     5   -215ns[-1620ns] +/-   73ms</span><br></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_64334766/article/details/128536776">https://blog.csdn.net/weixin_64334766/article/details/128536776</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*表示chronyd当前已经同步到的源。</span><br><span class="line"></span><br><span class="line">+表示可接受的信号源，与选定的信号源组合在一起。</span><br><span class="line"></span><br><span class="line">-表示被合并算法排除的可接受源</span><br><span class="line"></span><br><span class="line">？指已失去连接性或者其数据包未通过所有测试的源。</span><br><span class="line"></span><br><span class="line">x表示chronyd认为时虚假行情的时钟，即标记该时间与其他多数时间不一致</span><br><span class="line"></span><br><span class="line">~表示时间似乎具有太多可变性</span><br></pre></td></tr></table></figure><h3 id="设置时区"><a href="#设置时区" class="headerlink" title="设置时区"></a>设置时区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ubuntu</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h2 id="2-1-5-防火墙与SELinux"><a href="#2-1-5-防火墙与SELinux" class="headerlink" title="2.1.5 防火墙与SELinux"></a>2.1.5 防火墙与SELinux</h2><p>详见 <a href="../7-环境与工具/Linux.md#firewall">LInux防火墙</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若ubuntu上不支持，可先安装sudo apt install -y firewalld</span></span><br><span class="line">firewall-cmd --state</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确保为monitor的6789端口添加防火墙策略</span></span><br><span class="line">sudo apt -y install firewalld</span><br><span class="line">firewall-cmd --zone=public --add-port=6789/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=6800-7100/tcp --permanent</span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --add-port=80/tcp</span><br><span class="line">firewall-cmd --zone=public --add-port=443/tcp</span><br><span class="line"></span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --zone=public --list-all</span><br></pre></td></tr></table></figure><p>若只是测试环境，可以关闭防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ubuntu</span></span><br><span class="line">sudo systemctl disable ufw.service</span><br><span class="line"></span><br><span class="line">sudo ufw status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">ufw stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">防火墙在系统启动时自动禁用</span></span><br><span class="line">ufw disable</span><br></pre></td></tr></table></figure><p>所有虚拟主机上禁用SELINUX</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apt install -y selinux-utils</span><br><span class="line"></span><br><span class="line">sudo apt install -y selinux-basics</span><br><span class="line">sudo selinux-activate --disable</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时禁用</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久禁用</span></span><br><span class="line">vim /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /etc/selinux/config</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">SELINUXTYPE=targeted</span><br><span class="line">SETLOCALDEFS=0</span><br><span class="line"></span><br><span class="line">node02@node02:~$ sestatus</span><br><span class="line">SELinux status:                 disabled</span><br></pre></td></tr></table></figure><h2 id="2-1-6-centos源配置"><a href="#2-1-6-centos源配置" class="headerlink" title="2.1.6 centos源配置"></a>2.1.6 centos源配置</h2><p>安装epel相关repo包</p><p><span id="ch_yum_source"></span></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除epel</span></span><br><span class="line">rpm -e epel-release</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新centos8对应repo</span></span><br><span class="line">wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新centos7对应repo</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过rpm安装epel</span></span><br><span class="line">rpm -ivh --nodeps epel-release-latest-8.noarch.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -ivh --nodeps epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将repo配置中的地址替换为清华源</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://mirrors.tuna.tsinghua.edu.cn/help/epel/</span></span><br><span class="line">sed -e &#x27;s!^metalink=!#metalink=!g&#x27; \</span><br><span class="line">    -e &#x27;s!^#baseurl=!baseurl=!g&#x27; \</span><br><span class="line">    -e &#x27;s!https\?://download\.fedoraproject\.org/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g&#x27; \</span><br><span class="line">    -e &#x27;s!https\?://download\.example/pub/epel!https://mirrors.tuna.tsinghua.edu.cn/epel!g&#x27; \</span><br><span class="line">    -i /etc/yum.repos.d/epel&#123;,-testing&#125;.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载epel配置包</span></span><br><span class="line">yum install epel-release -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装好EPEL 源后，检查是否添加到源列表</span></span><br><span class="line">[root@ceph01 yum.repos.d]# yum repolist</span><br><span class="line">repo id                                 repo name</span><br><span class="line">epel                                    Extra Packages for Enterprise Linux 8 - aarch64</span><br><span class="line">ks10-adv-cdrom                          Kylin Linux Advanced Server 10 - cdrom</span><br><span class="line">ks10-adv-os                             Kylin Linux Advanced Server 10 - Os</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装好后，需要清除 yum 缓存、生成新的 yum 缓存、更新 yum</span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum update</span><br></pre></td></tr></table></figure><ul><li>EL 是 Red Hat Enterprise Linux（EL）的缩写<ul><li>EL5 是 Red Hat 5. X，CentOS 5. X</li><li>EL6 是 Red Hat 6. X，CentOS 6. X</li><li>EL7 是 Red Hat 7. X，CentOS 7. X</li><li>EL8 是 Red Hat 8. X，CentOS 8. X</li></ul></li><li><p>在 Linux 环境中，RPM 包分为几种不同的架构，包括 <code>aarch64</code>、<code>noarch</code> 和 <code>x86_64</code></p><ul><li><strong>srpms</strong> ：包含软件源代码的 RPM 包</li><li><strong>aarch64</strong> ：64 位的 ARM CPU 架构，通常用于 ARM 架构的处理器。</li><li><strong>x86_64</strong> ： 64 位的 CPU 架构，主要用于 AMD 和 Intel 生产的处理器</li><li><p><strong>noarch</strong> ：表示软件包不依赖于任何特定的硬件架构</p><p>通常不包含可执行的二进制文件，适用于那些不依赖于硬件架构的软件包</p></li></ul></li></ul><h2 id="2-1-7-节点间ssh免密登录"><a href="#2-1-7-节点间ssh免密登录" class="headerlink" title="2.1.7 节点间ssh免密登录"></a>2.1.7 节点间ssh免密登录</h2><h3 id="主机名和解析"><a href="#主机名和解析" class="headerlink" title="主机名和解析"></a>主机名和解析</h3><p>为所有主机下配置主机名与ip映射</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">192.168.192.130 admin.wang.org admin</span><br><span class="line">192.168.192.131 mon01.wang.org mon01</span><br><span class="line">192.168.192.132 mon02.wang.org mon02</span><br><span class="line">192.168.192.133 mon03.wang.org mon03</span><br><span class="line">192.168.192.134 mgr01.wang.org mgr01</span><br><span class="line">192.168.192.135 mgr02.wang.org mgr02</span><br><span class="line">192.168.192.136 store01.wang.org store01</span><br><span class="line">192.168.192.137 store02.wang.org store02</span><br><span class="line">192.168.192.138 store03.wang.org store03</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20231021110501138.png" alt="image-20231021110501138"></p><p>随着生产中主机节点越来越多，通过手工定制主机名的方式不适合主机管理。在企业中，主机名相关信息，倾向于通过内网dns来进行管理</p><p>radosgw，需要通过泛域名解析的机制来实现更加强大的面向客户端的主机名解析管理体系</p><h3 id="实现基于ssh-key的免密登录"><a href="#实现基于ssh-key的免密登录" class="headerlink" title="实现基于ssh key的免密登录"></a>实现基于ssh key的免密登录</h3><h4 id="实现root用户的ssh免密登录"><a href="#实现root用户的ssh免密登录" class="headerlink" title="实现root用户的ssh免密登录"></a>实现root用户的ssh免密登录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install openssh-server -y</span><br><span class="line"></span><br><span class="line">ssh</span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Allow Root Login</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启ssh服务进程</span></span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423100309821.png" alt="image-20240423100309821"></p><h4 id="通过sshpass为每个主机生成sshkey并推送给hosts中已知主机"><a href="#通过sshpass为每个主机生成sshkey并推送给hosts中已知主机" class="headerlink" title="通过sshpass为每个主机生成sshkey并推送给hosts中已知主机"></a>通过sshpass为每个主机生成sshkey并推送给hosts中已知主机</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install sshpass</span><br><span class="line">vim ssh_key_push.sh</span><br></pre></td></tr></table></figure><p><strong>原理</strong> ：</p><ol><li><p><code>scan_host</code> 生成已知主机的IP，记录到 <code>SCANIP.log</code> 中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SCANIP.<span class="built_in">log</span></span></span><br><span class="line">192.168.5.210</span><br><span class="line">192.168.5.211</span><br></pre></td></tr></table></figure><p>本例中 <code>SCANIP.log</code> 只使用与ubuntu，对于其他系统，若是NIC信息输出格式不一致，也可手动生成 ，并删除bash中的调用</p></li><li><p><code>push_ssh_key</code> 读取IP列表，并利用sshpass将当前主机的公钥和免输 “yes” 配置推送到列表中的所有主机</p></li></ol><p>在每个主机root用户下执行以下脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#********************************************************************</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Author:            wangxiaochun</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">QQ:                29308620</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Date:              2021-05-08</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">FileName:          ssh_key_push.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">URL:               http://www.wangxiaochun.com</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Description:       多主机基于ssh key 互相验证</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Copyright (C):     2021 All rights reserved</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">********************************************************************</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前用户密码</span></span><br><span class="line">PASS=admin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置网段最小和最大的地址的尾数</span></span><br><span class="line">BEGIN=156</span><br><span class="line">END=157</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网卡名</span></span><br><span class="line">NIC=ens33</span><br><span class="line"></span><br><span class="line">IP=`ip a s $&#123;NIC&#125; | awk -F&#x27;[ /]+&#x27; &#x27;NR==4&#123;print $3&#125;&#x27;`</span><br><span class="line">NET=$&#123;IP%.*&#125;.</span><br><span class="line"></span><br><span class="line">scan_host() &#123;</span><br><span class="line">    [ -e ./SCANIP.log ] &amp;&amp; rm -f SCANIP.log</span><br><span class="line">    for((i=$BEGIN;i&lt;=&quot;$END&quot;;i++));do</span><br><span class="line">        ping -c 1 -w 1  $&#123;NET&#125;$i &amp;&gt; /dev/null  &amp;&amp; echo &quot;$&#123;NET&#125;$i&quot; &gt;&gt; SCANIP.log &amp;</span><br><span class="line">    done</span><br><span class="line">    wait</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">push_ssh_key() &#123;</span><br><span class="line">   	#生成ssh key </span><br><span class="line">    [ -e ~/.ssh/id_rsa ] || ssh-keygen -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line">    sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no root@$IP  &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    ip_list=(`sort -t . -k 4 -n  SCANIP.log`)</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        sshpass -p $PASS scp -o StrictHostKeyChecking=no -r ~/.ssh root@$&#123;ip&#125;: &amp;&gt;/dev/null</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    #把.ssh/known_hosts拷贝到所有主机，使它们第一次互相访问时不需要输入yes回车</span><br><span class="line">    for ip in $&#123;ip_list[*]&#125;;do</span><br><span class="line">        scp ~/.ssh/known_hosts @$&#123;ip&#125;:.ssh/   &amp;&gt;/dev/null</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scan_host</span><br><span class="line">push_ssh_key</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要再所有主机上执行</span></span><br><span class="line">bash ssh_key_push.sh</span><br></pre></td></tr></table></figure><h3 id="所有主机通过cephadm实现免密登录"><a href="#所有主机通过cephadm实现免密登录" class="headerlink" title="所有主机通过cephadm实现免密登录"></a>所有主机通过cephadm实现免密登录</h3><h4 id="创建cephadm用户"><a href="#创建cephadm用户" class="headerlink" title="创建cephadm用户"></a>创建cephadm用户</h4><p>基于安全考虑，不用root用户管理</p><p>倾向与用一个普通用户来操作，由于后续安装软件，涉及root用户权限，所以这个普通用户最好具备 sudo 的权限</p><blockquote><p>此管理用户名称不能使用ceph名称，ceph后续会自动创建此用户</p></blockquote><p><strong>只需要在一台主机上执行</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用脚本实现批量创建用户</span></span><br><span class="line">cat &gt; create_cephadm.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设定普通用户</span></span><br><span class="line">useradd -m -s /bin/bash cephadm</span><br><span class="line">echo cephadm:admin | chpasswd</span><br><span class="line">echo &quot;cephadm ALL=(ALL) NOPASSWD:ALL&quot; &gt; /etc/sudoers.d/cephadm</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephadm</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">批量执行</span></span><br><span class="line">for i in &#123;150..152&#125;; do ssh root@192.168.192.$i bash &lt; create_cephadm.sh ; done</span><br></pre></td></tr></table></figure><p>检测是否创建用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ll /etc/passwd</span><br><span class="line">cat /etc/passwd</span><br></pre></td></tr></table></figure><h4 id="跨主机免密登录"><a href="#跨主机免密登录" class="headerlink" title="跨主机免密登录"></a>跨主机免密登录</h4><p><strong>只需要在一台主机上执行</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">su - cephadm</span><br><span class="line">ssh-keygen -t rsa -P &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line">PASS=admin</span><br><span class="line">for i in &#123;150..152&#125;;do</span><br><span class="line">	sshpass -p $PASS ssh-copy-id -o StrictHostKeyChecking=no cephadm@192.168.192.$i</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">root@node1:~# PASS=admin</span><br><span class="line">root@node1:~# for i in &#123;150..152&#125;;do</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sshpass -p <span class="variable">$PASS</span> ssh-copy-id -o StrictHostKeyChecking=no root@192.168.192.<span class="variable">$i</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="keyword">done</span></span></span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20231022193050105.png" alt="image-20231022193050105"></p><h1 id="2-2-Ceph手动安装"><a href="#2-2-Ceph手动安装" class="headerlink" title="2.2 Ceph手动安装"></a>2.2 Ceph手动安装</h1><h2 id="2-2-1-获取软件包"><a href="#2-2-1-获取软件包" class="headerlink" title="2.2.1 获取软件包"></a>2.2.1 获取软件包</h2><p>访问官网获取RPM包以及第三方库</p><p>通过添加Ceph安装包的存储库，使用包管理工具下载</p><ul><li>Dibian APT</li><li>RHEL：YUM</li></ul><h3 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name=</span><br><span class="line">baseurl=&#123;ceph-release&#125;/&#123;distro&#125;</span><br><span class="line">ceph-release:有效的Cep发行版名称</span><br><span class="line">distro:Linux的发行版信息</span><br></pre></td></tr></table></figure><h2 id="2-2-2-安装依赖"><a href="#2-2-2-安装依赖" class="headerlink" title="2.2.2 安装依赖"></a>2.2.2 安装依赖</h2><p>安装RHEL库</p><p>安装Ceph需要的第三方二进制文件</p><p>创建Ceph存储库文件用于描述Ceph版本</p><p>安装Ceph软件包</p><p>验证软件包是否安装成功</p><h2 id="2-2-3-部署Ceph集群"><a href="#2-2-3-部署Ceph集群" class="headerlink" title="2.2.3 部署Ceph集群"></a>2.2.3 部署Ceph集群</h2><ul><li>ceph.xxx.keyring：xxx级的密钥，负责同一集群的认证、各级对等节点间的相互认证</li></ul><h3 id="monitor部署"><a href="#monitor部署" class="headerlink" title="monitor部署"></a>monitor部署</h3><p>monmap负责集群中各组件关系的软件定义</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 为Ceph创建一个目录，且创建Ceph集群配置文件</span></span><br><span class="line">mkdir /etc/ceph</span><br><span class="line">touch /etc/ceph/ceph.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 为集群生成fsid</span></span><br><span class="line">uuidgen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.创建集群配置文件</span></span><br><span class="line">默认集群名称为ceph。配置文件名称为/etc/ceph/ceph.conf</span><br><span class="line">使用uuid作为配置文件中的fsid参数</span><br><span class="line">vim /etc/ceph/ceph.conf</span><br><span class="line">[mon.ceph-node2]</span><br><span class="line">mon_addr=</span><br><span class="line">host=ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 为集群创建密钥环，生成monitor的密钥</span></span><br><span class="line">ceph-authtool --creat-keyring /tmp/ceph.mon.keyring --gen-key -n mon. —-cap mon ‘allow *’</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 创建client.admin用户</span></span><br><span class="line">ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon ‘allow *’ --cap osd ‘allow *’ --cap mds ‘allow *’</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.将client.admin密钥添加到ceph.mon.keyring中</span></span><br><span class="line">ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 为第一个monitor生成monitor.map</span></span><br><span class="line">monmaptool --create --add &#123;hostname&#125; &#123;ip-address&#125; --fsid &#123;uuid&#125; /tmp/monmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 为monitor创建类似路径/cluster_name-monitor_node格式的目录</span></span><br><span class="line">mkdir /var/lib/ceph/mon/ceph-ceph-node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.填入第一个monitor守护进程信息</span></span><br><span class="line">ceph-mon --mkfs -i &#123;hostname&#125; --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">10.启动monitor服务</span></span><br><span class="line">service ceph start</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">11.查看Ceph集群状态及默认池</span></span><br><span class="line">ceph osd lspools</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">12. 将ceph.conf和ceph.client.admin.keyring 文件复制到ceph-node2,ceph-node3，让mon2,mon3可以发出集群命令</span></span><br><span class="line">scp /etc/ceph/ceph.* ceph-node2:/etc/ceph</span><br><span class="line">scp /etc/ceph/ceph.* ceph-node3:/etc/ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若上述步骤出现 Error Connecting to cluster的错误，需要为Ceph monitor守护进程关闭防火墙或修改防火墙规则</span></span><br></pre></td></tr></table></figure><h3 id="创建OSD"><a href="#创建OSD" class="headerlink" title="创建OSD"></a>创建OSD</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 检查系统中的可用磁盘</span></span><br><span class="line">cep-disk list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. Ceph OSD基于GUID分区表(GPT)工作，需要将分区表改为GPT</span></span><br><span class="line">parted /dev/sdb mklabel GPT</span><br><span class="line">parted /dev/sdc mklabel GPT</span><br><span class="line">parted /dev/sdd mklabel GPT</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 提供集群以及文件系统信息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ceph-disk prepare --cluster &#123;cluster-name&#125; --cluster-uuid &#123;fid&#125; --fs-type &#123;ext4/xfs/btrfs&#125; &#123;data-path&#125; [&#123;journal-path&#125;]</span></span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdb</span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdc</span><br><span class="line">ceph-disk prepare --cluster ceph --cluster-uuid &#123;fid&#125; --fs-type ext4 /dev/sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 激活OSD</span></span><br><span class="line">ceph-disk activate /dev/sdb</span><br><span class="line">ceph-disk activate /dev/sdc</span><br><span class="line">ceph-disk activate /dev/sdd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.激活OSD</span></span><br><span class="line">ceph -s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">硬盘的正常工作状态为 IN和UP</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 检查OSD树，给出关于OSD及其所在物理节点的信息</span></span><br><span class="line">ceph tree</span><br></pre></td></tr></table></figure><h3 id="扩展集群"><a href="#扩展集群" class="headerlink" title="扩展集群"></a>扩展集群</h3><p>为保证集群节点的高可靠和高可用，需要配置冗余节点</p><ul><li>$集群正常工作节点数&gt;\frac{n}{2}$ ，即推荐奇数个节点才能避免在其他系统上看到Ceph集群的脑裂状态</li></ul><p><strong>扩展monitor</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 登陆ceph-node2并创建目录</span></span><br><span class="line">mkdir -p /var/lib/ceph/mon/ceph-ceph-node2 /tmp/ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 编辑/etc/ceph/ceph.conf 文件，修改节点信息</span></span><br><span class="line">vim /etc/ceph/ceph.conf</span><br><span class="line">[mon.ceph-node2]</span><br><span class="line">mon_addr=</span><br><span class="line">host=ceph-node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 从Ceph集群中提取密钥环的信息</span></span><br><span class="line">ceph auth get mon. -o /tmp/ceph-node2/monkeyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 从Ceph集群中获取monitor map信息</span></span><br><span class="line">ceph mon getmap -o /tmp/ceph-node2/monmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 使用密钥和已有的monmap，构建一个新的集群</span></span><br><span class="line">ceph-mon -i ceph-node2 --mkfs --monmap /tmp/ceph-node2/monmap --keyring /tmp/ceph-node2/monkeyring</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.添加新的monitor到集群</span></span><br><span class="line">ceph mon add ceph-node2 [ip_address]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7. 检查集群状态，配置NTP以同步时间信息</span></span><br><span class="line">ceph -s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8. 添加ceph-node3作为第三个monitor</span></span><br></pre></td></tr></table></figure><h1 id="2-3-ceph-deploy"><a href="#2-3-ceph-deploy" class="headerlink" title="2.3 ceph-deploy"></a>2.3 ceph-deploy</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">无法获得锁 /var/lib/dpkg/lock-frontend</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查进程：检查是否有其他 dpkg 或 apt 进程正在运行：</span></span><br><span class="line">sudo lsof /var/lib/dpkg/lock-frontend</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结束进程：如果有进程正在运行，您可以选择等待它完成，或者如果您确定它是卡住的，可以尝试结束该进程：</span></span><br><span class="line">sudo kill &lt;PID&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清理锁定文件，如果进程已经结束，但锁定文件仍然存在，可能是因为上次操作没有正确清理。在这种情况下，您可以尝试手动删除锁定文件：</span></span><br><span class="line">sudo rm /var/lib/dpkg/lock-frontend</span><br></pre></td></tr></table></figure><h2 id="2-3-1-ceph-deploy介绍"><a href="#2-3-1-ceph-deploy介绍" class="headerlink" title="2.3.1 ceph-deploy介绍"></a>2.3.1 ceph-deploy介绍</h2><h3 id="ceph-deploy文档"><a href="#ceph-deploy文档" class="headerlink" title="ceph-deploy文档"></a>ceph-deploy文档</h3><p><strong>安装N版及以下的版本，照着<a target="_blank" rel="noopener" href="https://www.cnblogs.com/renato/p/12841005.html就行">https://www.cnblogs.com/renato/p/12841005.html就行</a></strong></p><p><strong>安装O版需要先用epel8，安装ceph-deploy 2.0.1，再换回el7，套用上述安装步骤</strong></p><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/pacific/man/8/ceph-deploy/#cmdoption-ceph-deploy-repo-url">https://docs.ceph.com/en/pacific/man/8/ceph-deploy/#cmdoption-ceph-deploy-repo-url</a></p><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/projects/ceph-deploy/en/latest/#python-package-index">https://docs.ceph.com/projects/ceph-deploy/en/latest/#python-package-index</a></p><h3 id="admin节点安装ceph-deploy工具"><a href="#admin节点安装ceph-deploy工具" class="headerlink" title="admin节点安装ceph-deploy工具"></a>admin节点安装ceph-deploy工具</h3><p>切到cephadm用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">cephadm@admin:~$sudo apt-cache madison ceph-deploy # 查看版本</span><br><span class="line">cephadm@admin:~$sudo apt -y install ceph-deploy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证成功和查看版本</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --version</span><br><span class="line">2.0.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助手册</span></span><br><span class="line">cephadm@admin:~$ceph-deploy --help</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">new：开始部署一个新的ceph 存储集群，并生成CLUSTER.conf 集群配置文件和keyring 认证文件。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">install: 在远程主机上安装ceph 相关的软件包, 可以通过--release 指定安装的版本。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rgw：管理RGW 守护程序(RADOSGW,对象存储网关)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mgr：管理MGR 守护程序(ceph-mgr,Ceph Manager DaemonCeph 管理器守护程序)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mds：管理MDS 守护程序(Ceph Metadata Server，ceph 源数据服务器)。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mon：管理MON 守护程序(ceph-mon,ceph 监视器)。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">gatherkeys：从指定的获取提供新节点验证keys，这些keys 会在添加新的MON/OSD/MD 加入的时候使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">disk：管理远程主机磁盘。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">osd：在远程主机准备数据磁盘，即将指定远程主机的指定磁盘添加到ceph 集群作为osd 使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">repo： 远程主机仓库管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">admin：推送ceph集群配置文件和client.admin 认证文件到远程主机。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">config：将ceph.conf 配置文件推送到远程主机或从远程主机拷贝。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uninstall：从远端主机删除安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">urgedata：从/var/lib/ceph 删除ceph 数据,会删除/etc/ceph 下的内容。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">purge: 删除远端主机的安装包和所有数据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">forgetkeys：从本地主机删除所有的验证keyring, 包括client.admin, monitor, bootstrap 等认证文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pkg： 管理远端主机的安装包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calamari：安装并配置一个calamari web 节点，calamari 是一个web 监控平台。</span></span><br></pre></td></tr></table></figure><h2 id="2-3-2-ceph-deploy对集群初始化"><a href="#2-3-2-ceph-deploy对集群初始化" class="headerlink" title="2.3.2 ceph-deploy对集群初始化"></a>2.3.2 ceph-deploy对集群初始化</h2><p>生成集群配置，并未做实际安装</p><p>初始化第一个mon节点的命令格式为 <code>ceph-deploy new &#123;initial-monitor-node(s)&#125;</code></p><ul><li><p>ceph-mon 即为第一个monitor节点名称，其名称必须与节点当前实际使用的主机名称( <code>uname -n</code> ) 保持一致，即可以是短名称，也可以是长名称</p><p>但短名称会导致错误： ceph-deploy new: error: hostname: xxx is not resolvable</p></li><li><p>推荐使用完整写法：<code>hostname:fqdn</code> 如：<code>ceph-mon:ceph-mon.wang.org</code></p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">首先在管理节点上以cephadm用户创建集群相关的配置文件目录</span></span><br><span class="line">cephadm@node1:~$ mkdir ceph-cluster &amp;&amp; cd ceph-cluster</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看主机名</span></span><br><span class="line">cephadm@node1:~$ mkdir ceph-cluster &amp;&amp; cd ceph-cluster</span><br><span class="line">node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行如下命令即可生成初始配置：</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy new --public-network 192.168.192.0/24 --cluster-network 192.168.252.0/24 node1 node2 node3</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy new --public-network 192.168.192.0/24 --cluster-network 192.168.252.0/24 node1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.conf <span class="comment">#自动生成的配置文件</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph-deploy-ceph.log <span class="comment">#初始化日志</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.mon.keyring <span class="comment">#用于ceph mon 节点内部通讯认证的秘钥环文件</span></span></span><br><span class="line"></span><br><span class="line">若是el7安装N及O，出现need_ssh</span><br><span class="line">--no-ssh-copykey</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240424015543853.png" alt="image-20240424015543853"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = 96a78567-2c73-4b65-adf1-fb8a3c18766a</span><br><span class="line">public_network = 192.168.192.0/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = node1</span><br><span class="line">mon_host = 192.168.192.150</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果想要一下子将所有的mon节点都部署出来，我们可以执行下面的命令</span></span><br><span class="line">ceph-deploy new --public-network 192.168.192.130/24 --cluster-network 192.168.252.0/24 mon01 mon02 mon03</span><br><span class="line"></span><br><span class="line">cephadm@admin:~/ceph-cluster$ cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p>没出这个问题</p><ul><li><p><img src="/posts/4007999911/image-20231021170352538.png" alt="image-20231021170352538"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">原因分析：因为 python3.8 已经没有这个方法了</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ dpkg -l python3</span><br><span class="line">期望状态=未知(u)/安装(i)/删除(r)/清除(p)/保持(h)</span><br><span class="line">| 状态=未安装(n)/已安装(i)/仅存配置(c)/仅解压缩(U)/配置失败(F)/不完全安装(H)/触发器等待</span><br><span class="line">(W)/触发器未决(T)</span><br><span class="line">|/ 错误?=(无)/须重装(R) (状态，错误：大写=故障)</span><br><span class="line">||/ 名称 版本 体系结构 描述</span><br><span class="line">+++-==============-==============-============-</span><br><span class="line">=========================================================================</span><br><span class="line">ii python3 3.8.2-0ubuntu2 amd64 interactive high-level objectoriented</span><br><span class="line">language (default python3 version)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解决方法：</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$sudo vim /usr/lib/python3/dist-packages/ceph_deploy/hosts/remotes.py</span><br><span class="line"></span><br><span class="line">def platform_information(_linux_distribution=None):</span><br><span class="line">	&quot;&quot;&quot; detect platform information from remote host &quot;&quot;&quot;</span><br><span class="line">	行首加#号注释下面两行</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">linux_distribution = _linux_distribution or platform.linux_distribution</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">distro, release, codename = linux_distribution()</span></span><br><span class="line">	</span><br><span class="line">	在上面两行下面添加下面6行</span><br><span class="line">	distro = release = codename = None</span><br><span class="line">	try:</span><br><span class="line">		linux_distribution = _linux_distribution or platform.linux_distribution</span><br><span class="line">		distro, release, codename = linux_distribution()</span><br><span class="line">	except AttributeError:</span><br><span class="line">		pass</span><br><span class="line">	.......</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20231021171607107-17305478470151.png" alt="image-20231021171607107"></p></li></ul><h3 id="2-3-3-ceph包的安装——不推荐用ceph-deploy-install"><a href="#2-3-3-ceph包的安装——不推荐用ceph-deploy-install" class="headerlink" title="2.3.3 ceph包的安装——不推荐用ceph-deploy install"></a>2.3.3 ceph包的安装——不推荐用ceph-deploy install</h3><h4 id="为所有节点配置ceph包安装源"><a href="#为所有节点配置ceph包安装源" class="headerlink" title="为所有节点配置ceph包安装源"></a>为所有节点配置ceph包安装源</h4><p><strong>ubuntu</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在管理节点准备脚本,注意以root身份执行</span></span><br><span class="line">root@node1:cat &gt; ceph_repo.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为所有节点都会依赖于这些apt源信息，需要进行同步</span></span><br><span class="line">[root@admin ~]for i in &#123;150..152&#125;;do ssh -o StrictHostKeyChecking=no 192.168.192.$i bash &lt; ceph_repo.sh;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">去其他结点查看</span></span><br><span class="line">cat /etc/apt/sources.list.d/ceph.list</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423115746284.png" alt="image-20240423115746284"></p><p><img src="/posts/4007999911/image-20240423115801278.png" alt="image-20240423115801278"></p><p><strong>centos</strong></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zphj1987/p/13575358.html">https://www.cnblogs.com/zphj1987/p/13575358.html</a></p><p>修改ceph源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm --import <span class="string">&#x27;https://download.ceph.com/keys/release.asc&#x27;</span></span></span><br><span class="line">rpm --import &#x27;https://mirrors.tuna.tsinghua.edu.cn/ceph/keys/release.asc&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -ivh https://download.ceph.com/rpm-17.2.7/el8/noarch/ceph-release-1-1.el8.noarch.rpm</span></span><br><span class="line">rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-17.2.7/el8/noarch/ceph-release-1-1.el8.noarch.rpm</span><br><span class="line">rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-nautilus/el7/noarch/ceph-release-1-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure><p>配置ceph.repo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[ceph]</span><br><span class="line">name=ceph</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-17.2.7/el8/x86_64/</span><br><span class="line">gpgcheck=0</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[ceph-noarch]</span><br><span class="line">name=cephnoarch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">baseurl=https://mirrors.aliyun.com/ceph/rpm-pacific/el8/noarch/</span></span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-17.2.7/el8/noarch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-17.2.7/el8/SRPMS</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">priority=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.tuna.tsinghua.edu.cn/ceph/keys/release.asc</span><br></pre></td></tr></table></figure><h4 id="ceph-deploy-install指令介绍"><a href="#ceph-deploy-install指令介绍" class="headerlink" title="ceph-deploy install指令介绍"></a>ceph-deploy install指令介绍</h4><p>初始化节点相当于在存储节点安装了ceph 及ceph-rodsgw</p><ul><li>默认情况下，ceph-deploy会安装最新版本的ceph，若需要指定ceph版本，添加参数 <code>--release &#123;ceph-release-name&#125;</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令格式：</span></span><br><span class="line">ceph-deploy install --&#123;role&#125; &#123;node&#125; [&#123;node&#125; ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：这里主要是ceph的工作角色的的节点</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:使用ceph-deploy命令能够以远程的方式连入Ceph集群各节点完成程序包安装等操作</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般情况下，不推荐使用这种直接的方法来进行安装，效率太低，实际上也是在各节点上执行方法2</span></span><br><span class="line">ceph-deploy install --mon mon01 mon02 mon03</span><br><span class="line"></span><br><span class="line">ceph-deploy install --repo-url=http://mirrors.aliyun.com/ceph/rpm-&lt;版本号&gt;/el7/ --gpg-url=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7 &lt;host-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:上述指令等价在每个ceph-node节点安装 ceph-&#123;role&#125;</span></span><br><span class="line">apt install -y ceph ceph-osd ceph-mds ceph-mon radosgw</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423215726912.png" alt="image-20240423215726912"></p><p><img src="/posts/4007999911/image-20240423215900896.png" alt="image-20240423215900896"></p><p><img src="/posts/4007999911/image-20240423220028750.png" alt="image-20240423220028750"></p><h2 id="2-3-4-mon节点"><a href="#2-3-4-mon节点" class="headerlink" title="2.3.4 mon节点"></a>2.3.4 mon节点</h2><h3 id="安装mon节点依赖"><a href="#安装mon节点依赖" class="headerlink" title="安装mon节点依赖"></a>安装mon节点依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在admin主机上，向mon节点安装mon组件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --no-adjust-repos --nogpgcheck --mon mon01 mon02 mon03</span><br><span class="line"></span><br><span class="line">[root@lab8106 ~]# ceph-deploy install kylin01 --repo-url=https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-quincy/el8/ --gpg-url=https://mirrors.tuna.tsinghua.edu.cn/ceph/keys/release.gpg</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者直接在mon节点安装软件</span></span><br><span class="line">[root@ceph-mon ~] apt -y install ceph-mon</span><br></pre></td></tr></table></figure><p>安装完成后，发现自动创建了ceph用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ getent passwd ceph</span><br><span class="line">ceph:x:64045:64045:Ceph storage service:/var/lib/ceph:/usr/sbin/nologin</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423220250108.png" alt="image-20240423220250108"></p><p>验证在mon 节点已经自动安装并启动了ceph-mon 服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ dpkg -l |grep ceph</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423220330144.png" alt="image-20240423220330144"></p><h3 id="初始化mon节点生成配置信息"><a href="#初始化mon节点生成配置信息" class="headerlink" title="初始化mon节点生成配置信息"></a>初始化mon节点生成配置信息</h3><p>确定集群配置信息，根据集群规划修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim ceph.conf</span><br><span class="line"></span><br><span class="line">若是3mon节点</span><br><span class="line">[global]</span><br><span class="line">fsid = a168efb2-3012-48b3-aac7-31a11c232235</span><br><span class="line">public_network = 192.168.192.130/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = mon01, mon02, mon03</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line"></span><br><span class="line">单mon节点</span><br><span class="line">[global]</span><br><span class="line">fsid = 7d8af3fe-089e-40ee-85d0-2854ff3c1631</span><br><span class="line">public_network = 192.168.192.0/24</span><br><span class="line">cluster_network = 192.168.252.0/24</span><br><span class="line">mon_initial_members = ceph-mon</span><br><span class="line">mon_host = 192.168.192.120</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p><strong>初始化集群mon节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy --overwrite-conf mon create-initial</span><br></pre></td></tr></table></figure><p>查看生成的配置文件</p><ul><li>节点初始化会生成一些ceph.bootstrap -mds/mgr/osd/rgw 等服务的keyring 认证文件，这些初始化文件拥有对ceph 集群的最高权限，所以一定要保存好。</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ll</span><br><span class="line"></span><br><span class="line">ceph.bootstrap-mds.keyring 引导启动 mds的密钥文件</span><br><span class="line">ceph.bootstrap-mgr.keyring 引导启动 mgr的密钥文件</span><br><span class="line">ceph.bootstrap-osd.keyring 引导启动 osd的密钥文件</span><br><span class="line">ceph.bootstrap-rgw.keyring 引导启动 rgw的密钥文件</span><br><span class="line">ceph.client.admin.keyring ceph客户端和管理端通信的认证密钥，是最重要的</span><br><span class="line">ceph.conf</span><br><span class="line">ceph-deploy-ceph.log</span><br><span class="line">ceph.mon.keyring</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这里生成了一系列的与ceph集群相关的 认证文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：ceph.client.admin.keyring 拥有ceph集群的所有权限，一定不能有误。</span></span><br></pre></td></tr></table></figure><ul><li>此时在mon节点启动了一些进程</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">到mon的节点上查看mon的自动开启相应的守护进程</span></span><br><span class="line">[root@mon01 ~]ps aux|grep ceph</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423220754587.png" alt="image-20240423220754587"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmp_knw2l2z</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240424021222677.png" alt="image-20240424021222677"></p><h3 id="向admin节点推送admin密钥"><a href="#向admin节点推送admin密钥" class="headerlink" title="向admin节点推送admin密钥"></a>向admin节点推送admin密钥</h3><p>在admin角色的主机上，把配置文件和admin密钥拷贝到Ceph集群各监控角色节点mon</p><ul><li><p>注意：原则上要求：所有mon节点上的 ceph.conf 内容必须一致，如果不一致的话，可以通过下面命令同步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf config push node1 node2 node3 n</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群admin节点的认证文件分发到admin节点</span></span><br><span class="line">ceph-deploy admin &#123;admin-node&#125;</span><br><span class="line"></span><br><span class="line">ceph-deploy admin --help</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">usage: ceph-deploy admin [-h] HOST [HOST ...]</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Push configuration and client.admin key to a remote host.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">positional arguments:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	HOST 	host to configure <span class="keyword">for</span> Ceph administration</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">optional arguments:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	-h, --<span class="built_in">help</span> show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure></li></ul><p>在mon节点实现集群管理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分发admin认证前，</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmpaagml4w1</span><br><span class="line"></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy admin node1</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ls /etc/ceph/</span><br><span class="line">ceph.client.admin.keyring  ceph.conf  rbdmap  tmpaagml4w1</span><br><span class="line"></span><br><span class="line">结果显示：这里多了一个 ceph的客户端与服务端进行认证的密钥文件了</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph.client.admin.keyring 主要用于ceph节点与管理端的一个通信认证。</span></span><br></pre></td></tr></table></figure><p>问题：虽然我们把认证文件传递给对应的admin主机了，但是admin节点是通过普通用户cephadm来进行交流的。而默认情况下，传递过去的认证文件，cephadm普通用户是无法正常访问的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cephadm用户执行命令因文件权限会出错</span></span><br><span class="line">[root@node1 ~] su - cephadm</span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423132945409.png" alt="image-20240423132945409"></p><p>在集群中需要运行ceph指令的节点上，为cephadm用户设置/etc/ceph/ceph.client.admin.keyring文件权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ sudo apt install acl</span><br><span class="line">cephadm@node1:~/ceph-cluster$ sudo setfacl -m u:cephadm:r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure><p>此时cephadm用户有了集群的管理权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">消除 mon is allowing insecure global_id reclaim的报警信息</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph config set mon auth_allow_insecure_global_id_reclaim false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次查看没有告警信息</span></span><br><span class="line">cephadm@node1:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240424030727092.png" alt="image-20240424030727092"></p><h2 id="2-3-5-mgr节点"><a href="#2-3-5-mgr节点" class="headerlink" title="2.3.5 mgr节点"></a>2.3.5 mgr节点</h2><p>Ceph-MGR工作的模式是事件驱动型的，简单来说，就是等待事件，事件来了则处理事件返回结果，又继续等待。</p><p>Ceph MGR 是自从 Ceph 12.2 依赖主推的功能之一，是负责 Ceph 集群管理的组件，它主要功能是把集群的一些指标暴露给外界使用。根据官方的架构原则上来说，mgr要有两个节点来进行工作。</p><p>对于测试环境其实一个就能够正常使用了,暂时先安装一个节点，后面再安装第二个节点。</p><h3 id="安装mgr节点依赖"><a href="#安装mgr节点依赖" class="headerlink" title="安装mgr节点依赖"></a>安装mgr节点依赖</h3><p><img src="/posts/4007999911/image-20240423221447871.png" alt="image-20240423221447871"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install --mgr node2</span><br><span class="line">apt -y install ceph-mgr</span><br><span class="line"></span><br><span class="line">cephadm@node2:~$ getent passwd ceph</span><br><span class="line"></span><br><span class="line">dpkg -l |grep ceph# 之前是没有的，安装之后，多了</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240423222058555.png" alt="image-20240423222058555"></p><p>且进程启动</p><p><img src="/posts/4007999911/image-20240423222156128.png" alt="image-20240423222156128"></p><h3 id="将mgr节点加入集群"><a href="#将mgr节点加入集群" class="headerlink" title="将mgr节点加入集群"></a>将mgr节点加入集群</h3><p>在 admin 节点的 /ceph-cluster 目录下执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cephadm@ceph-mon:~/ceph-cluster$ ceph-deploy mgr create node2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动在mgr01节点生成配置文件和用户</span></span><br><span class="line">[root@mgr01 ~] ls /etc/ceph/</span><br><span class="line">ceph.conf  rbdmap  tmp8zt3kkj8</span><br><span class="line"></span><br><span class="line">[root@mgr01 ~] getent passwd ceph</span><br><span class="line">ceph:x:64045:64045:Ceph storage service:/var/lib/ceph:/usr/sbin/nologin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启相关进程</span></span><br><span class="line">[root@mgr01 ~] ps aux|grep ceph</span><br><span class="line">ceph       35476  0.0  0.5  24468 11532 ?        Ss   20:45   0:00 /usr/bin/python3 /usr/bin/ceph-crash</span><br><span class="line">ceph       43250  8.3  8.9 897816 176364 ?       Ssl  20:54   0:05 /usr/bin/ceph-mgr -f --cluster ceph --id mgr01 --setuser ceph --setgroup ceph</span><br><span class="line">root       43375  0.0  0.0  12000   720 pts/2    S+   20:55   0:00 grep --color=auto ceph</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看集群状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：这个时候，service上，多了一个mgr的服务，在mgr01节点上，服务状态是 active。</span></span><br></pre></td></tr></table></figure><p>防火墙没关</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disabled  firewalld</span><br><span class="line">systemctl disable  firewalld</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240424025322420.png" alt="image-20240424025322420"></p><p><img src="/posts/4007999911/image-20240424031046905.png" alt="image-20240424031046905"></p><h2 id="2-3-6-osd节点"><a href="#2-3-6-osd节点" class="headerlink" title="2.3.6 osd节点"></a>2.3.6 osd节点</h2><p>要设置OSD环境，一般执行下面步骤：</p><ul><li>要知道对应的主机上有哪些磁盘可以提供给主机来进行正常的使用。</li><li>格式化磁盘(非必须)</li><li>ceph擦除磁盘上的数据</li><li>添加osd</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有的存储节点主机都准备了两块额外的磁盘，</span></span><br><span class="line">[root@store01 ~] lsblk</span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0    7:0    0  63.3M  1 loop /snap/core20/1828</span><br><span class="line">loop1    7:1    0     4K  1 loop /snap/bare/5</span><br><span class="line">loop2    7:2    0  63.5M  1 loop /snap/core20/2015</span><br><span class="line">loop3    7:3    0 346.3M  1 loop /snap/gnome-3-38-2004/119</span><br><span class="line">loop4    7:4    0 349.7M  1 loop /snap/gnome-3-38-2004/143</span><br><span class="line">loop5    7:5    0  91.7M  1 loop /snap/gtk-common-themes/1535</span><br><span class="line">loop6    7:6    0    46M  1 loop /snap/snap-store/638</span><br><span class="line">loop7    7:7    0  49.9M  1 loop /snap/snapd/18357</span><br><span class="line">loop8    7:8    0  40.9M  1 loop /snap/snapd/20290</span><br><span class="line">sda      8:0    0    20G  0 disk </span><br><span class="line">├─sda1   8:1    0   512M  0 part /boot/efi</span><br><span class="line">├─sda2   8:2    0     1K  0 part </span><br><span class="line">└─sda5   8:5    0  19.5G  0 part /</span><br><span class="line">sdb      8:16   0    20G  0 disk </span><br><span class="line">sdc      8:32   0    20G  0 disk </span><br><span class="line">sr0     11:0    1   4.1G  0 rom  /media/store01/Ubuntu 20.04.6 LTS amd64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果不想查看大量无效设备的话，可以执行下面清理操作</span></span><br><span class="line">sudo apt autoremove --purge snapd -y</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DISK=&quot;/dev/sdX&quot;</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdd&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span></span><br><span class="line">sgdisk --zap-all $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present</span></span></span><br><span class="line">dd if=/dev/zero of=&quot;$DISK&quot; bs=1M count=100 oflag=direct,dsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># SSDs may be better cleaned with blkdiscard instead of dd</span></span></span><br><span class="line">blkdiscard $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Inform the OS of partition table changes</span></span></span><br><span class="line">partprobe $DISK</span><br></pre></td></tr></table></figure><h3 id="安装osd依赖"><a href="#安装osd依赖" class="headerlink" title="安装osd依赖"></a>安装osd依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 确认仓库配置</span></span><br><span class="line">[root@store01 ~] cat /etc/apt/sources.list.d/ceph.listdeb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific/ focal main wget -q -O- https://download.ceph.com/keys/release.asc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 安装OSD相关软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1: 在管理节点远程安装</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --release quincy --osd store01 </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2: 在OSD主机手动安装</span></span><br><span class="line">[root@store01 ~] apt -y install ceph-osd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 确认安装结果</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动生成用户ceph</span></span><br><span class="line">[root@store01 ~] tail -n1 /etc/passwd</span><br><span class="line">[root@store01 ~] dpkg -l |grep ceph</span><br><span class="line"></span><br><span class="line">ls /etc/ceph/</span><br><span class="line">ps aux|grep ceph</span><br></pre></td></tr></table></figure><h3 id="查看所有可用的osd磁盘"><a href="#查看所有可用的osd磁盘" class="headerlink" title="查看所有可用的osd磁盘"></a>查看所有可用的osd磁盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查并列出OSD节点上所有可用的磁盘的相关信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy disk list node3</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240425135902182.png" alt="image-20240425135902182"></p><p>报错原因是 python 版本问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改375行,将 <span class="keyword">if</span> line.startswith(<span class="string">&#x27;Disk /&#x27;</span>): 更改为 <span class="keyword">if</span> line.startswith(b<span class="string">&#x27;Disk /&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">只在<span class="string">&#x27;Disk前加一个字母 b 即可</span></span></span><br><span class="line">cephadm@admin:~$sudo vim +375 /usr/lib/python3/dist-packages/ceph_deploy/osd.py</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240425140004253.png" alt="image-20240425140004253"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cephadm@node1:~/ceph-cluster$ ceph-deploy disk list node3</span><br><span class="line">很奇怪，权限问题</span><br><span class="line">setfacl -m u:cephadm:rw /home/cephadm/ceph-cluster/*</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240425141038172.png" alt="image-20240425141038172"></p><p>修改权限后可看</p><p><img src="/posts/4007999911/image-20240425141127811.png" alt="image-20240425141127811"></p><h3 id="清除OSD磁盘"><a href="#清除OSD磁盘" class="headerlink" title="清除OSD磁盘"></a>清除OSD磁盘</h3><p>在管理节点上使用ceph-deploy命令擦除计划专用于OSD磁盘上的所有分区表和数据以便用于OSD</p><p>注意: 如果硬盘是无数据的新硬盘此步骤可以不做</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk zap [-h] [--debug] [HOST] DISK [DISK ...]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">说明此操操作本质上就是执行<span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=disk bs=1M count=10</span></span><br><span class="line"></span><br><span class="line">for i in &#123;0..2&#125;;do ceph-deploy disk zap 192.168.192.15$i /dev/sdb;done</span><br></pre></td></tr></table></figure><h3 id="集群添加osd节点"><a href="#集群添加osd节点" class="headerlink" title="集群添加osd节点"></a>集群添加osd节点</h3><p>对于OSD的相关操作，可以通过 <code>ceph-deploy osd</code> 命令来进行，帮助信息如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看帮助</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd --help</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">帮助显示：这里提示了两类的存储机制：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认情况下用的就是 bluestore类型</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于bluestore来说，它主要包括三类数据：</span></span><br><span class="line">--data /path/to/data #ceph 保存的对象数据</span><br><span class="line">--block-db /path/to/db-device #数据库,即为元数据</span><br><span class="line">--block-wal /path/to/wal-device #数据库的 wal 日志</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生产建议data和wal日志分别存放</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于filestore来说，它主要包括两类数据</span></span><br><span class="line">--data /path/to/data #ceph的文件数据</span><br><span class="line">--journal /path/to/journal #文件系统日志数据</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于 osd来说，它主要有两个动作：</span></span><br><span class="line">list 列出osd相关的信息</span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy osd list store01</span><br><span class="line">create 创建osd设备</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy --overwrite-conf osd create node1 --data /dev/sdb</span><br><span class="line">ceph-deploy --overwrite-conf osd create node2 --data /dev/sdb</span><br><span class="line">ceph-deploy --overwrite-conf osd create node3 --data /dev/sdb</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看命令执行后的ceph的集群状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看osd状态</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph osd status</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20231021235858359.png" alt="image-20231021235858359"></p><ul><li>每个磁盘生成对应的一个逻辑卷</li><li>每个osd磁盘生成一个service</li></ul><h2 id="2-3-7-高可用扩展"><a href="#2-3-7-高可用扩展" class="headerlink" title="2.3.7 高可用扩展"></a>2.3.7 高可用扩展</h2><h3 id="mgr扩展"><a href="#mgr扩展" class="headerlink" title="mgr扩展"></a>mgr扩展</h3><p>当前只有一个Mgr节点主机,存在SPOF,添加新的Mgr节点实现高可用</p><p>Ceph Manager守护进程以Active/Standby模式运行，部署其它ceph-mgr守护程序可确保在Active节点或其上的ceph-mgr守护进程故障时，其中的一个Standby实例可以在不中断服务的情况下接管其任务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新mgr结点上安装mgr软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在管理节点远程在mgr02节点上安装Mgr软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mgr mgr02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mgr02节点手动安装软件</span></span><br><span class="line">[root@mgr02 ~]#apt -y install ceph-mgr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加第二个 Mgr节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mgr create mgr02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">结果显示：mgr01节点就是主角色节点，mgr02是从角色节点。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭mgr01节点,mgr02节点自动成为active节点</span></span><br><span class="line">[root@mgr01 ~]#reboot</span><br><span class="line">[root@admin ~]#ceph -s</span><br></pre></td></tr></table></figure><h3 id="mon扩展"><a href="#mon扩展" class="headerlink" title="mon扩展"></a>mon扩展</h3><p>当前只有一个mon结点主机，存在SPOF，添加新的mon结点实现高可用</p><p>如果 $n$ 个结点，至少需要保证 $\frac{n}{2}$ 个以上的健康mon结点，ceph集群才能正常使用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先在新mon节点安装mon软件</span></span><br><span class="line">ceph-deploy install --mon mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加后续的mon节点命令</span></span><br><span class="line">ceph-deploy mon add mon节点名称</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果add换成destroy，则变成移除mon节点</span></span><br></pre></td></tr></table></figure><p>如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 在新的mon结点安装mon软件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法1:在mon02节点上安装mon软件</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方法2:在mon02节点手动安装mon软件也可以</span></span><br><span class="line">[root@mon02 ~] apt -y install ceph-mon</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 添加在mon02节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3. 添加mon03节点</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy install --mon mon03</span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy mon add mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4. 修改ceph配置添加后续的Mon节点信息</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$vim ceph.conf</span><br><span class="line">mon_host = 192.168.192.131,192.168.192.132,192.168.192.133</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步ceph配置文件到所有ceph节点主机</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph-deploy --overwrite-conf config push admin mon0&#123;1,2,3&#125; mgr0&#123;1,2&#125; store0&#123;1,2,3&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5. 重新生成初始化配置信息</span></span><br><span class="line">ceph-deploy --overwrite-conf mon create-initial</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：为了避免因为认证方面导致的通信失败，推荐使用 --overwrite-conf 参数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果是在一个现有的环境上部署业务，可以先推送基准配置文件</span></span><br><span class="line">ceph-deploy --overwrite-conf config push mon01 mon02 mon03</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6. 查看</span></span><br><span class="line">cephadm@admin:~/ceph-cluster$ ceph -s</span><br></pre></td></tr></table></figure><h2 id="2-3-8-删除集群"><a href="#2-3-8-删除集群" class="headerlink" title="2.3.8 删除集群"></a>2.3.8 删除集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果部署过程出现问题，需要清空</span></span><br><span class="line">ceph-deploy forgetkeys</span><br><span class="line">ceph-deploy purge node1 node2 node3</span><br><span class="line">ceph-deploy purgedata node1 node2 node3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入集群配置文件 ceph-cluster</span></span><br><span class="line">rm ceph.*</span><br><span class="line"></span><br><span class="line">lvremove /dev/ceph-ff361b38-a44c-4d83-93ec-3362fbc57f96/osd-block-7819f40f-4157-4165-8f53-4be9de2e231f</span><br><span class="line"></span><br><span class="line">vgremove ceph-ff361b38-a44c-4d83-93ec-3362fbc57f96</span><br><span class="line"></span><br><span class="line">pvremove /dev/sdb</span><br></pre></td></tr></table></figure><h1 id="2-4-cephadm"><a href="#2-4-cephadm" class="headerlink" title="2.4 cephadm"></a>2.4 cephadm</h1><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>Cephadm 通过引导单个主机、扩展集群以包含任何其他主机，然后部署所需的服务来创建新的 Ceph 集群。</p><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><ul><li>Python 3</li><li>Systemd</li><li>Podman or Docker for running containers</li><li>Time synchronization (such as Chrony or the legacy <code>ntpd</code>)</li><li>LVM2 for provisioning storage devices</li></ul><p>任何现代 Linux 发行版都应该足够了。依赖项由下面的引导过程自动安装。</p><p>有关与 Podman 兼容的 Ceph 版本表，请参阅<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/quincy/cephadm/compatibility/#cephadm-compatibility-with-podman">与 Podman 版本的兼容性</a>部分。并非每个版本的 Podman 都与 Ceph 兼容。</p><p><strong>ubuntu</strong></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gengduc/article/details/134900065">https://blog.csdn.net/gengduc/article/details/134900065</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rookie23rook/article/details/128510437">https://blog.csdn.net/rookie23rook/article/details/128510437</a></p><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><h3 id="在线安装"><a href="#在线安装" class="headerlink" title="在线安装"></a>在线安装</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ilyucs/article/details/106742754">https://blog.csdn.net/ilyucs/article/details/106742754</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-engine</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若安装报错，可能是podman冲突</span></span><br><span class="line">yum erase podman buildah</span><br></pre></td></tr></table></figure><h3 id="下载containerd和docker"><a href="#下载containerd和docker" class="headerlink" title="下载containerd和docker"></a>下载containerd和docker</h3><p><strong>离线安装</strong></p><p>在每台主机上操作</p><p><a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/releases">下载页</a></p><p>直接下载：cri-containerd-1.7.2-linux-amd64.tar.gz，该包里面包含了containerd、 ctr、crictl、containerd-shim等二进制文件，还有启动命令等，只要在/下解压即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf cri-containerd-1.7.2-linux-amd64.tar.gz -C /</span><br><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">runtime-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="生成containerd配置文件"><a href="#生成containerd配置文件" class="headerlink" title="生成containerd配置文件"></a>生成containerd配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><p>修改 /etc/containerd/config.toml，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 用于从安全上下文中提取设备所有权信息，kubevirt cdi依赖该参数，不设置该参数可能出现无权限</span></span></span><br><span class="line">device_ownership_from_security_context = true</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 调整日志</span></span></span><br><span class="line">max_container_log_line_size = 163840</span><br><span class="line">SystemdCgroup = true</span><br></pre></td></tr></table></figure><p>修改/etc/systemd/system/containerd.service，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/containerd.service</span><br><span class="line">将`LimitNOFILE=infinity`改为`LimitNOFILE=655360` </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable containerd &amp;&amp; systemctl restart containerd</span><br><span class="line"></span><br><span class="line">使用 crictl info 查看配置是否生效</span><br></pre></td></tr></table></figure><h4 id="其他节点只需将相关文件拷贝过去启动即可"><a href="#其他节点只需将相关文件拷贝过去启动即可" class="headerlink" title="其他节点只需将相关文件拷贝过去启动即可"></a>其他节点只需将相关文件拷贝过去启动即可</h4><p>在node01上操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..3&#125;;do scp -rp /usr/local/bin node0$i:/usr/local/;scp -rp /usr/local/sbin node0$i:/usr/local/;scp /etc/containerd node0$i:/etc/; scp /etc/systemd/system/containerd.service node0$i:/etc/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp -rp /usr/local/bin node0$i:/usr/local/;scp -rp /usr/local/sbin node0$i:/usr/local/;scp /etc/containerd node0$i:/etc/; scp /etc/systemd/system/containerd.service node0$i:/etc/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do cmd=$(systemctl daemon-reload &amp;&amp; systemctl enable containerd &amp;&amp; systemctl restart containerd);ssh node0$i &quot;$cmd&quot;;done</span><br></pre></td></tr></table></figure><h3 id="docker-1"><a href="#docker-1" class="headerlink" title="docker"></a>docker</h3><p>下载docker安装包 ：<a target="_blank" rel="noopener" href="https://download.docker.com/linux/static/stable/x86_64/docker-20.10.23.tgz">https://download.docker.com/linux/static/stable/x86_64/docker-20.10.23.tgz</a></p><p>解压</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xf docker-20.10.23.tgz</span><br></pre></td></tr></table></figure><p>需要用到的二进制文件包括：docker 和 dockerd，拷贝到 /usr/bin/目录下即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv docker/docker* /usr/bin/</span><br></pre></td></tr></table></figure><p>创建 docker 用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果docker组存在，则使用</span> </span><br><span class="line">useradd -s /sbin/nologin docker -g docker</span><br></pre></td></tr></table></figure><p>启动的配置文件 docker.serivce 和 docker.socket 拷贝到 /usr/lib/systemd/system/，daemon.json文件放到/etc/docker目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.service  &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target docker.socket firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the default is not to use systemd <span class="keyword">for</span> cgroups because the delegate issues still</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">exists and systemd currently does not support the cgroup feature <span class="built_in">set</span> required</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> containers run by docker</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ExecStart=/usr/bin/dockerd --graph=/data/docker -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --cri-containerd --debug</span><br><span class="line">ExecReload=/bin/kill -s HUP \$MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that StartLimit* options were moved from <span class="string">&quot;Service&quot;</span> to <span class="string">&quot;Unit&quot;</span> <span class="keyword">in</span> systemd 229.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Both the old, and new location are accepted by systemd 229 and up, so using the old location</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to make them work <span class="keyword">for</span> either version of systemd.</span></span><br><span class="line">StartLimitBurst=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Note that StartLimitInterval was renamed to StartLimitIntervalSec <span class="keyword">in</span> systemd 230.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this option work <span class="keyword">for</span> either version of systemd.</span></span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> the kernel. We recommend using cgroups to <span class="keyword">do</span> container-local accounting.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可能会出现错误：<span class="string">&quot;Failed at step LIMITS spawning /usr/bin/dockerd: Operation not permitted&quot;</span>，则需要将LimitNOFILE=infinity 改成：LimitNOFILE=65530</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Comment TasksMax <span class="keyword">if</span> your systemd version does not support it.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Only systemd 226 and above support this option.</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> delegate <span class="built_in">yes</span> so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line">Delegate=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">kill</span> only the docker process, not all processes <span class="keyword">in</span> the cgroup</span></span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Socket for the API</span><br><span class="line">PartOf=docker.service</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/var/run/docker.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>启动docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable docker --now</span><br></pre></td></tr></table></figure><p>配置镜像加速和私有仓库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://vty0b0ux.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;500m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.demo.com&quot;,&quot;192.168.59.249:5000&quot;],</span><br><span class="line">  &quot;experimental&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>重启docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>将node01上的docker配置文件复制到其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;2..5&#125;;do scp /usr/bin/docker* ceph0$i:/usr/bin/;scp -rp /etc/docker ceph0$i:/etc/;scp /usr/lib/systemd/system/docker.service ceph0$i:/usr/lib/systemd/system/;scp /usr/lib/systemd/system/docker.socket ceph0$i:/usr/lib/systemd/system/;done</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp /usr/bin/docker* node0$i:/usr/bin/;scp -rp /etc/docker node0$i:/etc/;scp /usr/lib/systemd/system/docker.service node0$i:/usr/lib/systemd/system/;scp /usr/lib/systemd/system/docker.socket node0$i:/usr/lib/systemd/system/;done</span><br></pre></td></tr></table></figure><p>在ceph02-05上操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin docker </span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl enable docker --now</span><br></pre></td></tr></table></figure><h2 id="cephadm"><a href="#cephadm" class="headerlink" title="cephadm"></a>cephadm</h2><h3 id="修改ceph源"><a href="#修改ceph源" class="headerlink" title="修改ceph源"></a>修改ceph源</h3><p><strong>ubuntu LTS22</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在管理节点准备脚本,注意以root身份执行</span></span><br><span class="line">root@node1:cat &gt; ceph_repo.sh &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新ceph的软件源信息</span></span><br><span class="line">echo &quot;deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ceph.list </span><br><span class="line">wget -q -O- &#x27;https://download.ceph.com/keys/release.asc&#x27; | apt-key add - </span><br><span class="line">apt update</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">bash ceph_repo.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为所有节点都会依赖于这些apt源信息，需要进行同步</span></span><br><span class="line">[root@admin ~]for i in &#123;156..157&#125;;do ssh -o StrictHostKeyChecking=no 192.168.192.$i bash &lt; ceph_repo.sh;done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">去其他结点查看</span></span><br><span class="line">root@node02:/# cat /etc/apt/sources.list.d/ceph.list</span><br><span class="line">deb https://mirror.tuna.tsinghua.edu.cn/ceph/debian-quincy/ focal main</span><br></pre></td></tr></table></figure><h3 id="管理节点安装cephadm"><a href="#管理节点安装cephadm" class="headerlink" title="管理节点安装cephadm"></a>管理节点安装cephadm</h3><p><strong>ubuntu LTS22</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apt install -y cephadm</span><br><span class="line"></span><br><span class="line">whereis cephadm # 检查安装情况</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出如下内容</span></span><br><span class="line">root@node01:/# whereis cephadm</span><br><span class="line">cephadm: /usr/sbin/cephadm /usr/share/man/man8/cephadm.8.gz</span><br></pre></td></tr></table></figure><p><strong>kylin linux</strong></p><p><strong>15的依赖是有的，16以上的依赖不全，不能安装cephadm</strong></p><p>el8的没依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget http://mirrors.163.com/ceph/rpm-octopus/el8/noarch/cephadm-15.2.17-0.el8.noarch.rpm</span> </span><br><span class="line">wget http://mirrors.163.com/ceph/rpm-octopus/el7/noarch/cephadm-15.2.17-0.el7.noarch.rpm </span><br><span class="line">wget http://mirrors.163.com/ceph/rpm-quincy/el8/noarch/cephadm-17.2.7-0.el8.noarch.rpm </span><br><span class="line"></span><br><span class="line">chmod 600 /var/log/tallylog</span><br><span class="line">rpm -ivh cephadm-15.2.17-0.el7.noarch.rpm</span><br><span class="line">rpm -ivh </span><br><span class="line"></span><br><span class="line">切换cephadm版本</span><br><span class="line">rpm -e cephadm</span><br><span class="line"></span><br><span class="line">[root@ceph01 ~]# rpm -ivh cephadm-17.2.6-0.el8.noarch.rpm</span><br><span class="line">错误：依赖检测失败：</span><br><span class="line">	/usr/libexec/platform-python 被 cephadm-2:17.2.6-0.el8.noarch 需要</span><br></pre></td></tr></table></figure><h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><p>检查ceph各节点是否满足安装ceph集群，该命令需要在当前节点执行，比如要判断ceph02是否支持安装ceph集群，则在ceph02上执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cephadm check-host --expect-hostname node01</span><br><span class="line"></span><br><span class="line">docker (/usr/bin/docker) is present</span><br><span class="line">systemctl is present</span><br><span class="line">lvcreate is present</span><br><span class="line">Unit chronyd.service is enabled and running</span><br><span class="line">Hostname &quot;ceph02&quot; matches what is expected.</span><br><span class="line">Host looks OK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 也可以使用以下命令检查</span></span></span><br><span class="line">cephadm check-host --expect-hostname `hostname`</span><br></pre></td></tr></table></figure><h2 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h2><h3 id="先将docker镜像拉到本地"><a href="#先将docker镜像拉到本地" class="headerlink" title="先将docker镜像拉到本地"></a>先将docker镜像拉到本地</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker images --digests</span><br><span class="line">docker pull --platform=linux/arm64 quay.io/ceph/ceph:v17.2.6</span><br><span class="line">docker pull --platform=linux/amd64 quay.io/ceph/ceph:v17.2.6</span><br><span class="line">docker pull --platform=linux/amd64 quay.io/ceph/ceph:v15.2.17</span><br><span class="line">v14.2.22</span><br></pre></td></tr></table></figure><h3 id="改cephadm的一些代码"><a href="#改cephadm的一些代码" class="headerlink" title="改cephadm的一些代码"></a>改cephadm的一些代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/sbin/cephadm</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240608185248481.png" alt="image-20240608185248481"></p><p><img src="/posts/4007999911/image-20240608185227794.png" alt="image-20240608185227794"></p><p>还有要改的，没改完全会报下面的错</p><h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><p>cephadm bootstrap 过程是在单一节点上创建一个小型的ceph集群，包括一个ceph monitor和一个ceph mgr，监控组件包括prometheus、node-exporter等。</p><p>然后向集群中添加主机以扩展集群，进而部署其他服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cephadm bootstrap --mon-ip 192.168.192.156 --cluster-network 10.168.192.0/24 --initial-dashboard-user admin --initial-dashboard-password admin</span><br><span class="line"></span><br><span class="line">cephadm bootstrap --mon-ip 192.168.5.210 --cluster-network 10.168.192.0/24 --allow-overwrite --skip-dashboard</span><br><span class="line"></span><br><span class="line">cephadm bootstrap --mon-ip 192.168.192.161 --allow-overwrite</span><br><span class="line"></span><br><span class="line">cephadm bootstrap --mon-ip 192.168.3.233 --allow-overwrite</span><br><span class="line"></span><br><span class="line">cephadm bootstrap --mon-ip 192.168.192.156 --cluster-network 10.168.192.0/24 --allow-overwrite --skip-dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会卡很久</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">tail -f /var/log/ceph/cephadm.log</span><br></pre></td></tr></table></figure><p><img src="/posts/4007999911/image-20240608194858189.png" alt="image-20240608194858189"></p><p>初始化时，指定了mon-ip、集群网段、dashboard初始用户名和密码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">--mon-ip 192.168.59.241 \</span><br><span class="line">--cluster-network 10.168.192.0/24 \</span><br><span class="line">指定dashboard用户名和密码  </span><br><span class="line">--initial-dashboard-user admin \</span><br><span class="line">--initial-dashboard-password admin \</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  指定私钥和公钥</span></span></span><br><span class="line">--ssh-private-key /root/.ssh/id_rsa \</span><br><span class="line">--ssh-public-key /root/.ssh/id_rsa.pub \</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 启动前不拉取默认镜像</span></span></span><br><span class="line">--skip-pull</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 指定私有镜像仓库</span></span></span><br><span class="line">--registry-url registry.demo.com \</span><br><span class="line">--registry-username admin \</span><br><span class="line">--registry-password Harbor12345 </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 需要指定监控组件镜像</span></span></span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_prometheus registry.demo.com/prometheus/prometheus:v2.33.4</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_grafana registry.demo.com/ceph/ceph-grafana:8.3.5</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_alertmanager registry.demo.com/prometheus/alertmanager:v0.23.0</span><br><span class="line">ceph config set mgr mgr/cephadm/container_image_node_exporter registry.demo.com/prometheus/node-exporter:v1.3.1</span><br></pre></td></tr></table></figure><p>进入容器 执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/cephadm shell --fsid 2e1228b0-0781-11ee-aa8a-000c2921faf1 -c /etc/ceph/ceph.conf -k /etc/ceph/ceph.client.admin.keyring</span><br><span class="line"></span><br><span class="line">Or, if you are only running a single cluster on this host:</span><br><span class="line"></span><br><span class="line">        sudo /usr/sbin/cephadm shell</span><br><span class="line"></span><br><span class="line">退出容器执行</span><br><span class="line">cephadm shell ceph -s</span><br><span class="line"></span><br><span class="line">安装ceph-common工具，使bash支持原生命令</span><br><span class="line">cephadm install ceph-common</span><br><span class="line"></span><br><span class="line">ceph -s</span><br><span class="line">ceph version</span><br></pre></td></tr></table></figure><p>查看集群配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/ceph/</span><br><span class="line"></span><br><span class="line">ceph.client.admin.keyring  是具有ceph管理员的秘钥</span><br><span class="line">ceph.conf  是最小化配置文件</span><br><span class="line">ceph.pub  是一个公钥，拷贝到其他节点后，可以免密登录。</span><br></pre></td></tr></table></figure><h3 id="查看组件运行状态"><a href="#查看组件运行状态" class="headerlink" title="查看组件运行状态"></a>查看组件运行状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ceph orch ps</span><br><span class="line"></span><br><span class="line">ceph orch ls</span><br><span class="line"></span><br><span class="line">ceph orch ls mgr</span><br></pre></td></tr></table></figure><h3 id="删除不必要组件"><a href="#删除不必要组件" class="headerlink" title="删除不必要组件"></a>删除不必要组件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph orch rm prometheus</span><br><span class="line">ceph orch rm grafana</span><br><span class="line">ceph orch rm alertmanager</span><br><span class="line">ceph orch rm node-exporter</span><br></pre></td></tr></table></figure><h3 id="ceph镜像导出"><a href="#ceph镜像导出" class="headerlink" title="ceph镜像导出"></a>ceph镜像导出</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images  |grep -v &quot;REPOSITORY&quot; |awk &#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27; |xargs docker save -o ceph-images.tar</span><br><span class="line"></span><br><span class="line">for i in &#123;2..2&#125;;do scp ceph-images.tar node0$i:/root/;done</span><br></pre></td></tr></table></figure><p>解压离线镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i ceph-images.tar</span><br></pre></td></tr></table></figure><h2 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Log: Opening SSH connection to 192.168.192.237, port 22</span><br><span class="line">[conn=2] Connected to SSH server at 192.168.192.237, port 22</span><br><span class="line">[conn=2]   Local address: 192.168.192.233, port 48926</span><br><span class="line">[conn=2]   Peer address: 192.168.192.237, port 22</span><br><span class="line">[conn=2] Beginning auth for user root</span><br><span class="line">[conn=2] Auth failed for user root</span><br><span class="line">[conn=2] Connection failure: Permission denied</span><br><span class="line">[conn=2] Aborting connection</span><br><span class="line"></span><br><span class="line">ssh-copy-id -f -i /etc/ceph/ceph.pub root@node237</span><br></pre></td></tr></table></figure><p>将ceph.pub公钥拷贝到其他ceph节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -f -i /etc/ceph/ceph.pub node02</span><br><span class="line"></span><br><span class="line">for i in &#123;2..5&#125;;do ssh-copy-id -f -i /etc/ceph/ceph.pub ceph0$i;done</span><br></pre></td></tr></table></figure><h3 id="指定镜像"><a href="#指定镜像" class="headerlink" title="指定镜像"></a>指定镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker images --digests</span><br><span class="line">docker pull --platform=linux/arm64 quay.io/ceph/ceph:v17.2.6</span><br><span class="line">docker pull --platform=linux/amd64 quay.io/ceph/ceph:v17.2.6</span><br></pre></td></tr></table></figure><p>使用cephadm将主机添加到存储集群中,执行添加节点命令后，会在目标节点拉到ceph/node-exporter镜像，需要一定时间，所以可提前在节点上将镜像导入。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cephadm shell ceph orch host add node02 192.168.192.157 --labels=mon,mgr,osd</span><br><span class="line">ceph orch host add node237 192.168.3.237 --labels=mon,mgr,osd</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error EINVAL: check-host failed:</span><br><span class="line">docker (/usr/bin/docker) is present</span><br><span class="line">systemctl is present</span><br><span class="line">Unit ntp.service is enabled and running</span><br><span class="line">Hostname &quot;node02&quot; matches what is expected.</span><br><span class="line">ERROR: lvcreate binary does not appear to be installed</span><br></pre></td></tr></table></figure><p>在其他节点安装依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install lvm2</span><br></pre></td></tr></table></figure><p>查看加入集群的其他节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@node01:/# ceph orch host ls</span><br><span class="line">HOST    ADDR             LABELS       STATUS  </span><br><span class="line">node01  192.168.192.156  _admin               </span><br><span class="line">node02  192.168.192.157  mon,mgr,osd          </span><br><span class="line">2 hosts in cluster</span><br></pre></td></tr></table></figure><h3 id="节点打标签"><a href="#节点打标签" class="headerlink" title="节点打标签"></a>节点打标签</h3><p>给节点打上指标标签后，后续可以按标签进行编排。</p><p>给节点打 <code>_admin</code> 标签，默认情况下，<code>_admin</code> 标签应用于存储集群中的 bootstrapped 主机， client.admin密钥被分发到该主机(ceph orch client-keyring {ls|set|rm})。<br>将这个标签添加到其他主机后，其他主机的/etc/ceph下也将有client.admin密钥。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 给 ceph02、ceph03加上 _admin 标签</span></span>  </span><br><span class="line">ceph orch host label add ceph02 _admin</span><br><span class="line">ceph orch host label add ceph03 _admin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 给 ceph01-ceph04加上 mon 标签</span></span> </span><br><span class="line">ceph orch host label add ceph01 mon</span><br><span class="line">ceph orch host label add ceph02 mon</span><br><span class="line">ceph orch host label add ceph03 mon</span><br><span class="line">ceph orch host label add ceph04 mon</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host label add node01 mon,mgr,osd</span><br><span class="line"></span><br><span class="line">ceph orch host ls</span><br><span class="line"></span><br><span class="line">root@node01:/# ceph orch host ls</span><br><span class="line">HOST    ADDR             LABELS              STATUS  </span><br><span class="line">node01  192.168.192.156  _admin,mon,mgr,osd          </span><br><span class="line">node02  192.168.192.157  mon,mgr,osd                 </span><br><span class="line">2 hosts in cluster</span><br></pre></td></tr></table></figure><h4 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h4><p>删除节点上的_admin标签，并不会删除该节点上已有的<code>ceph.client.admin.keyring</code>密钥文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host label rm ceph03 label=_admin</span><br></pre></td></tr></table></figure><p>新主机加入集群后，mon和mgr会自动扩展，最多5个mon，2个mgr</p><h3 id="手动调整"><a href="#手动调整" class="headerlink" title="手动调整"></a>手动调整</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph1 ~]# ceph orch apply mon ceph1,ceph2,ceph3</span><br><span class="line">Scheduled mon update...</span><br><span class="line">[root@ceph1 ~]# ceph orch apply mgr ceph1,ceph2,ceph3</span><br><span class="line">Scheduled mon update...</span><br></pre></td></tr></table></figure><h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph orch host rm &lt;host&gt; # 从集群中删除主机</span><br></pre></td></tr></table></figure><h2 id="添加mon"><a href="#添加mon" class="headerlink" title="添加mon"></a>添加mon</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph orch apply mon node237</span><br></pre></td></tr></table></figure><h2 id="添加osd"><a href="#添加osd" class="headerlink" title="添加osd"></a>添加osd</h2><ul><li>设备必须没有分区</li><li>设备不得具有任何 LVM 状态</li><li>设备不能被挂载</li><li>设备不能包含文件系统</li><li>设备不得包含 Ceph BlueStore OSD</li><li>设备容量必须大于 5 GB</li></ul><h3 id="初始化磁盘"><a href="#初始化磁盘" class="headerlink" title="初始化磁盘"></a>初始化磁盘</h3><p>添加OSD时，建议将磁盘先格式化为无分区的原始磁盘</p><p><a target="_blank" rel="noopener" href="https://rook.github.io/docs/rook/v1.10/Getting-Started/ceph-teardown/?h=sgdisk#zapping-devices">https://rook.github.io/docs/rook/v1.10/Getting-Started/ceph-teardown/?h=sgdisk#zapping-devices</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DISK=&quot;/dev/sdX&quot;</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdd&quot;</span><br><span class="line"></span><br><span class="line">DISK=&quot;/dev/sdb&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span></span><br><span class="line">sgdisk --zap-all $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Wipe a large portion of the beginning of the disk to remove more LVM metadata that may be present</span></span></span><br><span class="line">dd if=/dev/zero of=&quot;$DISK&quot; bs=1M count=100 oflag=direct,dsync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># SSDs may be better cleaned with blkdiscard instead of dd</span></span></span><br><span class="line">blkdiscard $DISK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Inform the OS of partition table changes</span></span></span><br><span class="line">partprobe $DISK</span><br></pre></td></tr></table></figure><p>若 <code>AVAILABLE</code> 为 no，使用zap清除数据</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看各ceph节点有哪些磁盘是可用的，关注`AVAILABLE`列</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看设备列表，显示可用作OSD的设备</span></span><br><span class="line">ceph orch device ls [--hostname=...] [--wide] [--refresh]</span><br><span class="line"></span><br><span class="line">ceph orch device ls</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph orch device zap &lt;hostname&gt; &lt;path&gt; # 擦除设备（清除设备）</span><br><span class="line">ceph orch device zap --force node01 /dev/sdd</span><br></pre></td></tr></table></figure><p><strong>GPT headers found</strong></p><p>之前磁盘被分区过，虽然删掉了分区，但是还存在 GPT 数据结构，使用 <code>sgdisk</code> 删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sgdisk --zap-all /dev/sdX</span><br></pre></td></tr></table></figure><h3 id="添加OSD"><a href="#添加OSD" class="headerlink" title="添加OSD"></a>添加OSD</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建新的OSD</span></span><br><span class="line">ceph orch daemon add osd &lt;host&gt;:&lt;device-path&gt; [--verbose]</span><br><span class="line"></span><br><span class="line">ceph orch daemon add osd node01:/dev/sdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量创建OSD</span></span><br><span class="line">ceph orch apply osd --all-available-devices</span><br></pre></td></tr></table></figure><h2 id="删除服务"><a href="#删除服务" class="headerlink" title="删除服务"></a>删除服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自动删除</span></span><br><span class="line">ceph orch rm &lt;service-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动删除</span></span><br><span class="line">ceph orch daemon rm &lt;daemon name&gt;... [--force]</span><br></pre></td></tr></table></figure><h2 id="cephadm删除集群"><a href="#cephadm删除集群" class="headerlink" title="cephadm删除集群"></a>cephadm删除集群</h2><p><strong>在每台主机上执行</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用自动扩展</span></span><br><span class="line">ceph mgr module disable cephadm</span><br><span class="line"></span><br><span class="line">cat /etc/ceph/ceph.conf</span><br><span class="line"></span><br><span class="line">cephadm rm-cluster --zap-osds --fsid [] --force</span><br><span class="line"></span><br><span class="line">lvremove /dev/ceph-ff361b38-a44c-4d83-93ec-3362fbc57f96/osd-block-7819f40f-4157-4165-8f53-4be9de2e231f</span><br><span class="line"></span><br><span class="line">vgremove ceph-ff361b38-a44c-4d83-93ec-3362fbc57f96</span><br><span class="line"></span><br><span class="line">pvremove /dev/sdb</span><br><span class="line"></span><br><span class="line">systemctl status ceph-osd.target</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现相关依赖被删除</span></span><br><span class="line">docker ps -a </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清理cephadm日志</span></span><br><span class="line">rm -rf cephadm.log</span><br></pre></td></tr></table></figure><h1 id="2-5-集群升级"><a href="#2-5-集群升级" class="headerlink" title="2.5 集群升级"></a>2.5 集群升级</h1><p>只需要安装升级Ceph安装包，依次升级安装</p><ol><li>monitor</li><li>MGR</li><li>OSD</li><li>MDS</li><li>RADOS网关</li></ol><p>升级完同一类型的守护进程后再升级其他类型，最后重启服务（通常不需要关闭存储服务）</p><ol><li><p>检查Ceph守护进程的当前版本</p><p><code>service ceph status</code></p></li><li><p>升级Ceph源至期望的版本（如firefly）</p><p>只需在 /etc/yum.repos.d/ceph.repo 文件中更新Ceph发行版的名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ceph]</span><br><span class="line">name=Ceph package for $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-noarch]</span><br><span class="line">name=Ceph noarch $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph nosource $basearch</span><br><span class="line">baseurl=http://ceph.com/rpm-firefly/e16/SRMPS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc</span><br></pre></td></tr></table></figure></li><li><p>更新ceph软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update ceph</span><br></pre></td></tr></table></figure></li><li><p>重启monitor守护进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ceph restart mon osd</span><br></pre></td></tr></table></figure></li><li><p>检查monitor,osd守护进程版本</p></li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------<i class="fa fa-hand-peace-o"></i>本文结束-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者 </strong>AmosTian</li><li class="post-copyright-link"><strong>本文链接 </strong><a href="https://amostian.github.io/posts/4007999911/" title="基于ceph-depoy和cephadm安装ceph">https://amostian.github.io/posts/4007999911/</a></li><li class="post-copyright-license"><strong>版权声明 </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 存储</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tags"></i> 分布式存储</a> <a href="/tags/Ceph/" rel="tag"><i class="fa fa-tags"></i> Ceph</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/3896019112/" rel="prev" title="Ceph文档-mgr"><i class="fa fa-chevron-left"></i> Ceph文档-mgr</a></div><div class="post-nav-item"><a href="/posts/500250356/" rel="next" title="Ceph文档-cephadm">Ceph文档-cephadm <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">部署前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-1-Ceph%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-text">2.0.1 Ceph存储机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-2-%E5%90%84%E7%BB%84%E4%BB%B6%E7%9A%84%E7%A1%AC%E4%BB%B6%E9%9C%80%E6%B1%82"><span class="nav-text">2.0.2 各组件的硬件需求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU"><span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98"><span class="nav-text">内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A3%81%E7%9B%98"><span class="nav-text">磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%9C%80%E6%B1%82"><span class="nav-text">网络需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MDS%E9%9C%80%E6%B1%82"><span class="nav-text">MDS需求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-3-%E8%A7%84%E5%88%92%E9%9B%86%E7%BE%A4"><span class="nav-text">2.0.3 规划集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6"><span class="nav-text">限制条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7%E7%9A%84%E5%A4%87%E6%B3%A8"><span class="nav-text">关于功能特性的备注</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%80%89%E5%9E%8B"><span class="nav-text">硬件选型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%BD%E6%B1%82%E8%89%AF%E5%A5%BD%E7%9A%84IOPS"><span class="nav-text">追求良好的IOPS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%BD%E6%B1%82%E8%89%AF%E5%A5%BD%E5%90%9E%E5%90%90%E9%87%8F"><span class="nav-text">追求良好吞吐量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E6%B1%82%E4%BD%8E%E6%88%90%E6%9C%AC%E3%80%81%E9%AB%98%E5%AE%B9%E9%87%8F%E5%9C%BA%E6%99%AF"><span class="nav-text">最求低成本、高容量场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-4-%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B%E4%B8%8E%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7"><span class="nav-text">2.0.4 版本选型与安装工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E9%80%89%E5%9E%8B"><span class="nav-text">版本选型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E6%96%B9%E6%B3%95"><span class="nav-text">推荐方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Cephadm"><span class="nav-text">Cephadm</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="nav-text">其他方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-5-%E5%8F%82%E8%80%83"><span class="nav-text">2.0.5 参考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE"><span class="nav-text">2.1 操作系统设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-1-%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">2.1.1 查看版本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-2-%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E5%90%8D%E4%B8%80%E5%AE%9A%E8%A6%81%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81"><span class="nav-text">2.1.2 修改用户名一定要修改密码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-3-%E8%A7%84%E5%88%92"><span class="nav-text">2.1.3 规划</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8Dip%E6%98%A0%E5%B0%84"><span class="nav-text">主机名ip映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81ip"><span class="nav-text">静态ip</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-4-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-text">2.1.4 时间同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%97%B6%E5%8C%BA"><span class="nav-text">设置时区</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-5-%E9%98%B2%E7%81%AB%E5%A2%99%E4%B8%8ESELinux"><span class="nav-text">2.1.5 防火墙与SELinux</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-6-centos%E6%BA%90%E9%85%8D%E7%BD%AE"><span class="nav-text">2.1.6 centos源配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-7-%E8%8A%82%E7%82%B9%E9%97%B4ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">2.1.7 节点间ssh免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8D%E5%92%8C%E8%A7%A3%E6%9E%90"><span class="nav-text">主机名和解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8Essh-key%E7%9A%84%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">实现基于ssh key的免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0root%E7%94%A8%E6%88%B7%E7%9A%84ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">实现root用户的ssh免密登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87sshpass%E4%B8%BA%E6%AF%8F%E4%B8%AA%E4%B8%BB%E6%9C%BA%E7%94%9F%E6%88%90sshkey%E5%B9%B6%E6%8E%A8%E9%80%81%E7%BB%99hosts%E4%B8%AD%E5%B7%B2%E7%9F%A5%E4%B8%BB%E6%9C%BA"><span class="nav-text">通过sshpass为每个主机生成sshkey并推送给hosts中已知主机</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E4%B8%BB%E6%9C%BA%E9%80%9A%E8%BF%87cephadm%E5%AE%9E%E7%8E%B0%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">所有主机通过cephadm实现免密登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAcephadm%E7%94%A8%E6%88%B7"><span class="nav-text">创建cephadm用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="nav-text">跨主机免密登录</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-2-Ceph%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="nav-text">2.2 Ceph手动安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-1-%E8%8E%B7%E5%8F%96%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="nav-text">2.2.1 获取软件包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85%E6%BA%90"><span class="nav-text">配置安装源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-text">2.2.2 安装依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-3-%E9%83%A8%E7%BD%B2Ceph%E9%9B%86%E7%BE%A4"><span class="nav-text">2.2.3 部署Ceph集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#monitor%E9%83%A8%E7%BD%B2"><span class="nav-text">monitor部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAOSD"><span class="nav-text">创建OSD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E9%9B%86%E7%BE%A4"><span class="nav-text">扩展集群</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-3-ceph-deploy"><span class="nav-text">2.3 ceph-deploy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-1-ceph-deploy%E4%BB%8B%E7%BB%8D"><span class="nav-text">2.3.1 ceph-deploy介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-deploy%E6%96%87%E6%A1%A3"><span class="nav-text">ceph-deploy文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#admin%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85ceph-deploy%E5%B7%A5%E5%85%B7"><span class="nav-text">admin节点安装ceph-deploy工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-2-ceph-deploy%E5%AF%B9%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2.3.2 ceph-deploy对集群初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-ceph%E5%8C%85%E7%9A%84%E5%AE%89%E8%A3%85%E2%80%94%E2%80%94%E4%B8%8D%E6%8E%A8%E8%8D%90%E7%94%A8ceph-deploy-install"><span class="nav-text">2.3.3 ceph包的安装——不推荐用ceph-deploy install</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AEceph%E5%8C%85%E5%AE%89%E8%A3%85%E6%BA%90"><span class="nav-text">为所有节点配置ceph包安装源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ceph-deploy-install%E6%8C%87%E4%BB%A4%E4%BB%8B%E7%BB%8D"><span class="nav-text">ceph-deploy install指令介绍</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-4-mon%E8%8A%82%E7%82%B9"><span class="nav-text">2.3.4 mon节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85mon%E8%8A%82%E7%82%B9%E4%BE%9D%E8%B5%96"><span class="nav-text">安装mon节点依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96mon%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="nav-text">初始化mon节点生成配置信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91admin%E8%8A%82%E7%82%B9%E6%8E%A8%E9%80%81admin%E5%AF%86%E9%92%A5"><span class="nav-text">向admin节点推送admin密钥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-5-mgr%E8%8A%82%E7%82%B9"><span class="nav-text">2.3.5 mgr节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85mgr%E8%8A%82%E7%82%B9%E4%BE%9D%E8%B5%96"><span class="nav-text">安装mgr节点依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86mgr%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-text">将mgr节点加入集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-6-osd%E8%8A%82%E7%82%B9"><span class="nav-text">2.3.6 osd节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85osd%E4%BE%9D%E8%B5%96"><span class="nav-text">安装osd依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E5%8F%AF%E7%94%A8%E7%9A%84osd%E7%A3%81%E7%9B%98"><span class="nav-text">查看所有可用的osd磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E9%99%A4OSD%E7%A3%81%E7%9B%98"><span class="nav-text">清除OSD磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%B7%BB%E5%8A%A0osd%E8%8A%82%E7%82%B9"><span class="nav-text">集群添加osd节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-7-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%89%A9%E5%B1%95"><span class="nav-text">2.3.7 高可用扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mgr%E6%89%A9%E5%B1%95"><span class="nav-text">mgr扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mon%E6%89%A9%E5%B1%95"><span class="nav-text">mon扩展</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-8-%E5%88%A0%E9%99%A4%E9%9B%86%E7%BE%A4"><span class="nav-text">2.3.8 删除集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-4-cephadm"><span class="nav-text">2.4 cephadm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-text">文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%81%E6%B1%82"><span class="nav-text">要求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker"><span class="nav-text">docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E5%AE%89%E8%A3%85"><span class="nav-text">在线安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDcontainerd%E5%92%8Cdocker"><span class="nav-text">下载containerd和docker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90containerd%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">生成containerd配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%8F%AA%E9%9C%80%E5%B0%86%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E8%BF%87%E5%8E%BB%E5%90%AF%E5%8A%A8%E5%8D%B3%E5%8F%AF"><span class="nav-text">其他节点只需将相关文件拷贝过去启动即可</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-1"><span class="nav-text">docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cephadm"><span class="nav-text">cephadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9ceph%E6%BA%90"><span class="nav-text">修改ceph源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85cephadm"><span class="nav-text">管理节点安装cephadm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5"><span class="nav-text">检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="nav-text">初始化集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%88%E5%B0%86docker%E9%95%9C%E5%83%8F%E6%8B%89%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="nav-text">先将docker镜像拉到本地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9cephadm%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BB%A3%E7%A0%81"><span class="nav-text">改cephadm的一些代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-text">创建集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81"><span class="nav-text">查看组件运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="nav-text">删除不必要组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA"><span class="nav-text">ceph镜像导出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA"><span class="nav-text">添加主机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E9%95%9C%E5%83%8F"><span class="nav-text">指定镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E6%89%93%E6%A0%87%E7%AD%BE"><span class="nav-text">节点打标签</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%A0%87%E7%AD%BE"><span class="nav-text">删除标签</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E8%B0%83%E6%95%B4"><span class="nav-text">手动调整</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-text">删除节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0mon"><span class="nav-text">添加mon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0osd"><span class="nav-text">添加osd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A3%81%E7%9B%98"><span class="nav-text">初始化磁盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0OSD"><span class="nav-text">添加OSD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1"><span class="nav-text">删除服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cephadm%E5%88%A0%E9%99%A4%E9%9B%86%E7%BE%A4"><span class="nav-text">cephadm删除集群</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-5-%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7"><span class="nav-text">2.5 集群升级</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="AmosTian" src="/images/avatar.png"><p class="site-author-name" itemprop="name">AmosTian</p><div class="site-description" itemprop="description">知道的越多，不知道的越多</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">234</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">68</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">84</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AmosTian" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;AmosTian" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/qq_40479037?type=blog" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_40479037?type&#x3D;blog" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>CSDN</a> </span><span class="links-of-author-item"><a href="mailto:17636679561@163.com" title="E-Mail → mailto:17636679561@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("01/27/2022 15:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-grav"></i> </span><span class="author" itemprop="copyrightHolder">AmosTian</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数 </span><span title="站点总字数">1249.6k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">50:22</span></div></div></footer></div><script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'neutral',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}</script><script>if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }</script><script async src="/js/cursor/fireworks.js"></script><script src="/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,document.body.addEventListener("input",POWERMODE)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body></html>